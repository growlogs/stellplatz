<!DOCTYPE html>
    <html lang="de">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Inventar Scanner Pro</title>

        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="https://unpkg.com/html5-qrcode"></script>

        <script>
            // ---------------------------------------------------------
            // KONFIGURATION
            // ---------------------------------------------------------
            var APP_SUPABASE_URL = "https://sjhyvctidpnttqhenqoy.supabase.co"; 
            var APP_SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHl2Y3RpZHBudHRxaGVucW95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MzU3NTksImV4cCI6MjA4MDAxMTc1OX0.oXUA012J99W8fNNJi8Zxqn-2BUjf1QJOrXGYlPotaS4"; 
            
            // Initialisierung
            (function() {
                if (window['supabase']) {
                    window.appSupabaseClient = window['supabase'].createClient(APP_SUPABASE_URL, APP_SUPABASE_KEY);
                } else {
                    window.appSupabaseClient = null;
                    console.error("Supabase-Client konnte nicht initialisiert werden.");
                }
                window.lastCode = ""; 
                window.currentTabId = "scannerTab"; 
                window.currentUserRole = null; 
                window.currentClientId = null; // NEU: Tenant-ID
                window.offlineDB = null; // NEU: IndexedDB-Instanz
                window.isSyncing = false; // NEU: Synchronisations-Status
                window.isPinMode = false; // NEU: PIN-Login-Modus f√ºr Mitarbeiter
            })();
        </script>

        <style>
            /* --- GLOBALE STYLES & FONT --- */
            :root {
                --color-bg-dark: #0a0b10;
                --color-bg-card: #1d222e;
                --color-accent-blue: #007aff;
                --color-accent-green: #34c759;
                --color-error-red: #ff3b30;
                --color-border: rgba(255, 255, 255, 0.08);
                --transition-duration: 0.3s;
                --color-warning-yellow: #ffcc00; 
            }

            * {
                box-sizing: border-box;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            }

            body,
            html {
                margin: 0;
                padding: 0;
                background: var(--color-bg-dark);
                color: white;
                height: 100dvh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            /* --- LAYOUT & TRANSITIONEN --- */

            .app-view-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                transition: opacity var(--transition-duration) ease-in-out, transform var(--transition-duration) ease-in-out;
                opacity: 0;
                pointer-events: none;
                display: flex;
                flex-direction: column;
            }

            .app-view-container.active {
                opacity: 1;
                pointer-events: all;
            }

            #loginView {
                transform: translateY(0);
            }

            #appView {
                transform: translateY(100vh);
            }

            #loginView.active {
                transform: translateY(0);
            }

            #appView.active {
                transform: translateY(0);
            }
            
            #tabContentContainer {
                flex-grow: 1;
                position: relative;
                overflow: hidden; 
            }
            
            .tab-content {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: none !important; 
                flex-direction: column;
                overflow-y: auto; 
                background: var(--color-bg-dark); 
            }
            
            .tab-content.active {
                display: flex !important; 
            }


            /* --- HEADER --- */
            header {
                height: 55px;
                background: rgba(30, 30, 40, 0.9);
                backdrop-filter: blur(8px);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 15px;
                border-bottom: 1px solid var(--color-border);
                z-index: 10;
                flex-shrink: 0; 
            }

            header h1 {
                font-size: 1.1rem;
                font-weight: 600;
                margin: 0;
            }

            .header-button {
                padding: 5px 10px;
                font-size: 0.75em;
                background: rgba(255, 255, 255, 0.1);
                border: none;
                border-radius: 8px;
                color: white;
                cursor: pointer;
                transition: background 0.2s;
            }

             /* Icon Button f√ºr Settings */
            .header-icon-btn {
                background: none; border: none;
                font-size: 1.5rem; cursor: pointer;
                padding: 0 10px; margin-right: 5px;
                transition: transform 0.2s;
            }
            .header-icon-btn:active { transform: scale(0.9); }


            /* --- LOGIN VIEW --- */
            #loginView {
                justify-content: space-around;
                align-items: center;
                padding: 40px 20px;
                text-align: center;
            }

            .login-header {
                text-align: center;
                padding-top: 50px;
            }

            .app-icon {
                font-size: 3.5em;
                color: var(--color-accent-blue);
                margin-bottom: 15px;
            }

            .login-header h2 {
                font-size: 1.6rem;
                font-weight: 700;
                margin: 0;
            }

            #authError {
                color: var(--color-error-red);
                margin-top: 10px;
                height: 1.2em;
                font-weight: 500;
            }
            
            #loadingAuth {
                text-align: center;
                font-size: 1.1rem;
                opacity: 0.7;
                display: none; 
                margin-top: 40px;
            }

            #authForm {
                width: 100%;
                max-width: 320px;
                margin-top: 50px;
                display: block; 
            }
            
            #authForm .input-group input {
                width: 100%;
                padding: 12px;
                border-radius: 8px;
                border: 1px solid var(--color-border);
                background: var(--color-bg-card);
                color: white;
                font-size: 1rem;
                margin-bottom: 15px;
            }
            
            #authForm .input-group label {
                display: block;
                font-size: 0.9rem;
                margin-bottom: 5px;
                opacity: 0.8;
                text-align: left;
            }
            
            #authForm button[type="submit"] {
                width: 100%;
                padding: 12px;
                font-size: 1rem;
                font-weight: 600;
                background: var(--color-accent-blue);
                color: white;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                transition: background 0.2s;
            }
            
            #authForm button[type="submit"]:active {
                background: #0066cc;
            }
            
            #registerToggle {
                margin-top: 20px;
                color: var(--color-accent-blue);
                cursor: pointer;
                font-size: 0.9rem;
                opacity: 0.8;
                text-decoration: underline;
            }
            
            #pinIndicators, #keypad {
                display: none; 
            }


            /* --- APP VIEW / SCANNER --- */
            #scannerTab {
                position: relative;
                overflow: hidden;
            }

            #reader-container {
                flex-grow: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                overflow: hidden;
            }

            #reader {
                width: 100%;
                height: 100%;
                background: black;
                object-fit: cover;
            }
            
            #reader video {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }


            .scan-frame {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 70%;
                max-width: 300px;
                aspect-ratio: 1 / 1;
                border: 3px solid var(--color-accent-green);
                border-radius: 12px;
                box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.7);
                pointer-events: none;
            }

            #preScan {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: var(--color-bg-dark);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                z-index: 5;
            }

            .primary-button {
                padding: 12px 25px;
                font-size: 1rem;
                font-weight: 600;
                background: var(--color-accent-blue);
                color: white;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                transition: background 0.2s;
            }

            .primary-button:active {
                background: #0066cc;
            }


            /* --- Result Card --- */
            #result-card {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                background: var(--color-bg-card);
                border-top-left-radius: 20px;
                border-top-right-radius: 20px;
                padding: 20px;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.4);
                transform: translateY(100%);
                transition: transform var(--transition-duration) ease-out;
                z-index: 10;
            }

            #result-card.active {
                transform: translateY(0);
            }

            .card-handle {
                width: 40px;
                height: 4px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 2px;
                margin: 0 auto 15px;
            }

            #cardTitle {
                font-size: 1.4rem;
                font-weight: 700;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
            }

            #cardStatusIcon {
                margin-right: 10px;
                font-size: 1.1em;
            }

            #cardContent p {
                margin: 5px 0;
                font-size: 0.9rem;
                opacity: 0.8;
            }

            .action-button-group {
                display: flex;
                gap: 10px;
                margin-top: 15px;
            }

            .action-button {
                flex: 1;
                padding: 12px;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
            }

            .action-button.register {
                background: var(--color-accent-green);
                color: var(--color-bg-card);
            }
            .action-button.register:active {
                background: #2cb74b;
            }
            .action-button.cancel {
                background: rgba(255, 255, 255, 0.1);
                color: white;
            }
            .action-button.cancel:active {
                background: rgba(255, 255, 255, 0.2);
            }
            .action-button.delete {
                background: var(--color-error-red);
                color: white;
            }
            .action-button.delete:active {
                background: #cc2a22;
            }


            /* --- POPUPS --- */
            #popupOverlay, #adminEditPopupOverlay, #deleteConfirmPopupOverlay, #userEditPopupOverlay, #settingsPopupOverlay, #staffMemberCreatePopupOverlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(5px);
                z-index: 100;
                display: none;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.2s ease-in-out;
            }

            #popupOverlay.show, #adminEditPopupOverlay.show, #deleteConfirmPopupOverlay.show, #userEditPopupOverlay.show, #settingsPopupOverlay.show, #staffMemberCreatePopupOverlay.show {
                opacity: 1;
                display: flex; 
            }

            .popup-card {
                background: var(--color-bg-card);
                padding: 25px;
                border-radius: 15px;
                width: 90%;
                max-width: 400px;
                transform: translateY(20px);
                transition: transform 0.3s ease-in-out;
            }

            #popupOverlay.show .popup-card, #adminEditPopupOverlay.show .popup-card, #deleteConfirmPopupOverlay.show .popup-card, #userEditPopupOverlay.show .popup-card, #settingsPopupOverlay.show .popup-card, #staffMemberCreatePopupOverlay.show .popup-card {
                transform: translateY(0);
            }

            .popup-card h3 {
                margin-top: 0;
                font-size: 1.3rem;
                border-bottom: 1px solid var(--color-border);
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

            .input-group {
                margin-bottom: 15px;
            }
            
            .input-group textarea {
                resize: vertical;
                min-height: 80px;
            }

            .input-group label {
                display: block;
                font-size: 0.9rem;
                margin-bottom: 5px;
                opacity: 0.8;
            }

            .input-group input[type="text"],
            .input-group input[type="email"],
            .input-group input[type="number"],
            .input-group input[type="password"],
            .input-group select,
            .input-group textarea {
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid var(--color-border);
                background: var(--color-bg-dark);
                color: white;
                font-size: 1rem;
            }
            .input-group input:focus,
            .input-group select:focus,
            .input-group textarea:focus {
                outline: none;
                border-color: var(--color-accent-blue);
            }

            /* --- SETTINGS STYLES --- */
            .setting-row {
                display: flex; justify-content: space-between; align-items: center;
                margin-bottom: 20px; padding-bottom: 15px;
                border-bottom: 1px solid var(--color-border);
            }
            .setting-row:last-child { border-bottom: none; }

            .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
            .switch input { opacity: 0; width: 0; height: 0; }
            .slider {
                position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
                background-color: #3a3a44; transition: .4s; border-radius: 34px;
            }
            .slider:before {
                position: absolute; content: ""; height: 20px; width: 20px;
                left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;
            }
            input:checked + .slider { background-color: var(--color-accent-green); }
            input:checked + .slider:before { transform: translateX(22px); }

            /* Volume Slider */
            input[type=range] { width: 100%; margin-top: 10px; background: transparent; -webkit-appearance: none; }
            input[type=range]::-webkit-slider-thumb {
                -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
                background: var(--color-accent-blue); cursor: pointer; margin-top: -8px;
            }
            input[type=range]::-webkit-slider-runnable-track {
                width: 100%; height: 4px; cursor: pointer; background: #3a3a44; border-radius: 2px;
            }

            /* --- TOASTS --- */
            #toastContainer {
                position: fixed;
                top: 15px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 350px;
                z-index: 200;
                pointer-events: none;
            }

            .toast {
                background: var(--color-bg-card);
                color: white;
                padding: 10px 15px;
                border-radius: 10px;
                margin-bottom: 10px;
                opacity: 0;
                transform: translateY(20px);
                transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                font-size: 0.95rem;
                font-weight: 500;
            }

            .toast.show {
                opacity: 1;
                transform: translateY(0);
            }

            .toast-icon {
                margin-right: 10px;
                font-size: 1.2em;
            }

            .toast.success .toast-icon {
                color: var(--color-accent-green);
            }

            .toast.error .toast-icon {
                color: var(--color-error-red);
            }

            .toast.info .toast-icon {
                color: var(--color-accent-blue);
            }

            /* --- FOOTER / NAVIGATION --- */
            footer {
                display: flex;
                height: 70px;
                background: rgba(30, 30, 40, 0.9);
                backdrop-filter: blur(8px);
                border-top: 1px solid var(--color-border);
                flex-shrink: 0;
                z-index: 20;
            }

            .nav-item {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: rgba(255, 255, 255, 0.5);
                font-size: 0.8rem;
                cursor: pointer;
                transition: color 0.2s;
                user-select: none;
            }

            .nav-item.active {
                color: var(--color-accent-blue);
            }

            .nav-item svg {
                width: 24px;
                height: 24px;
                stroke: currentColor;
                fill: none;
                stroke-width: 2;
                margin-bottom: 2px;
            }
            
            /* --- ARTIKEL LIST VIEW STYLES / REUSABLE LIST STYLES --- */
            /* Padding in .list-content-container, da das Tab-Content nun auch den Search-Header enth√§lt */
            .list-content-container {
                overflow-y: auto; 
                padding: 15px 15px 80px 15px; 
            }
            
            /* NEU: Search Container Style */
            .search-container {
                padding: 15px; 
                flex-shrink: 0; 
                background: var(--color-bg-dark);
                border-bottom: 1px solid var(--color-border);
            }

            .search-container input {
                width: 100%;
                padding: 10px 15px;
                border-radius: 8px;
                border: 1px solid var(--color-border);
                background: var(--color-bg-card);
                color: white;
                font-size: 1rem;
            }
            
            /* Alte Paddings entfernt und durch list-content-container ersetzt */
            #listTab, #logTab, #usersTab { 
                padding: 0; /* Wichtig: Padding hier entfernen */
            }
            
            #articleList, #logList, #userList { 
                list-style: none;
                padding: 0;
                margin: 0;
            }
            
            #articleList li, #logList li, #userList li { 
                background: var(--color-bg-card);
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 10px;
                border-left: 5px solid var(--color-accent-blue); 
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: background 0.2s; 
            }
            
            #articleList li[data-role="admin-editable"]:active, #userList li[data-role="admin-editable"]:active {
                background: #2a303e; 
            }
            
            .user-role-admin { border-left-color: var(--color-warning-yellow) !important; }
            .user-is-blocked { border-left-color: var(--color-error-red) !important; }

            .item-details strong {
                display: block;
                font-size: 1.rem;
                font-weight: 600;
                margin-bottom: 2px;
            }
            
            .item-details span {
                font-size: 0.85rem;
                opacity: 0.7;
            }
            
            .item-count {
                text-align: center; 
                width: 50px; 
                height: 50px; 
                flex-shrink: 0;
                margin-left: 10px;
                display: flex; 
                flex-direction: column;
                justify-content: center;
                align-items: center;
                font-size: 0.8rem;
            }
            
            .item-count svg {
                width: 28px; 
                height: 28px;
                margin-bottom: 2px; 
            }

            .item-count .item-label {
                font-size: 0.6rem; 
                font-weight: 600;
                line-height: 1;
            }
            
            #logTab {
                display: flex; 
                flex-direction: column;
            }
            
            .user-edit-button {
                background: var(--color-accent-blue);
                color: white;
                padding: 8px 15px;
                border-radius: 8px;
                font-size: 0.8rem;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.2s;
            }

        </style>
    </head>
    <body>

        <div id="toastContainer"></div>
        
        <div id="popupOverlay">
            <form class="popup-card" onsubmit="event.preventDefault(); saveArticle();">
                <h3>Artikel Registrieren</h3>
                <div class="input-group">
                    <label for="popupBarcode">Barcode</label>
                    <input type="text" id="popupBarcode" readonly>
                </div>
                
                <div class="input-group">
                    <label for="popupBaseName">Basis-Name (z.B. T-Shirt, Wasserflasche)</label>
                    <input type="text" id="popupBaseName" required>
                </div>
                
                <div class="input-group">
                    <label for="popupSize">Gr√∂√üe / Volumen (Liter)</label>
                    <select id="popupSize">
                        <option value="">(Optional)</option>
                        <option value="0.33">0,33 Liter</option>
                        <option value="0.5">0,5 Liter</option>
                        <option value="0.7">0,7 Liter</option>
                        <option value="1.0">1,0 Liter</option>
                        <option value="1.5">1,5 Liter</option>
                        <option value="2.0">2,0 Liter</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="popupPlatz">Stellplatz (z.B. A-02-C)</label>
                    <input type="text" id="popupPlatz" required>
                </div>
                
                <div class="input-group">
                    <label for="popupBlocklager">Lagertyp</label>
                    <select id="popupBlocklager">
                        <option value="false">Regal / Fach</option>
                        <option value="true">Blocklager</option>
                    </select>
                </div>

                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hidePopup()">Abbrechen</button>
                    <button type="submit" class="action-button register">Speichern</button>
                </div>
            </form>
        </div>
        
        <div id="adminEditPopupOverlay">
            <form class="popup-card" onsubmit="event.preventDefault(); saveAdminEdit();">
                <h3>Artikel Bearbeiten (Admin)</h3>
                <div class="input-group">
                    <label for="adminEditName">Artikel Name</label>
                    <input type="text" id="adminEditName" readonly>
                </div>

                <div class="input-group">
                    <label for="adminEditBarcode">Barcode</label>
                    <input type="text" id="adminEditBarcode" readonly>
                </div>
                
                <div class="input-group">
                    <label for="adminEditPlatz">Neuer Stellplatz</label>
                    <input type="text" id="adminEditPlatz" required>
                </div>
                
                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hideAdminEditPopup()">Abbrechen</button>
                    <button type="submit" class="action-button register">Speichern</button>
                </div>

                <button type="button" class="action-button delete" style="width: 100%; margin-top: 15px;" onclick="deleteArticle()">
                    Artikel l√∂schen...
                </button>

                <p style="font-size: 0.75rem; opacity: 0.6; text-align: center; margin-top: 15px;">Sie sind als Administrator angemeldet und k√∂nnen den Stellplatz √§ndern.</p>
            </form>
        </div>

        <div id="deleteConfirmPopupOverlay">
            <div class="popup-card">
                <h3 id="deleteConfirmTitle">Artikel unwiderruflich l√∂schen</h3>
                <p id="deleteConfirmMessage" style="margin-bottom: 25px; text-align: center; font-weight: 500; font-size: 1.1rem; line-height: 1.4;"></p>

                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hideDeleteConfirmPopup()">Abbrechen</button>
                    <button type="button" class="action-button delete" onclick="confirmDeleteArticle()">Ja, unwiderruflich l√∂schen</button>
                </div>
            </div>
        </div>
        
        <div id="userEditPopupOverlay">
            <form class="popup-card" onsubmit="event.preventDefault(); saveUserEdit();">
                <h3>Benutzer bearbeiten (Admin)</h3>
                <div class="input-group">
                    <label for="userEditEmail">E-Mail</label>
                    <input type="text" id="userEditEmail" readonly>
                </div>
                <div class="input-group">
                    <label for="userEditRole">Rolle</label>
                    <select id="userEditRole" required>
                        <option value="user">Benutzer (Standard)</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="userEditBlocked">Sperrstatus</label>
                    <select id="userEditBlocked" required>
                        <option value="false">Nicht gesperrt</option>
                        <option value="true">Gesperrt</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="userEditNotes">Anmerkungen (nur f√ºr Admins sichtbar)</label>
                    <textarea id="userEditNotes" placeholder="Interne Anmerkungen..."></textarea>
                </div>
                
                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hideUserEditPopup()">Abbrechen</button>
                    <button type="submit" class="action-button register">√Ñnderungen speichern</button>
                </div>
            </form>
        </div>
        
        <div id="staffMemberCreatePopupOverlay">
            <form class="popup-card" onsubmit="event.preventDefault(); createStaffMember();">
                <h3>Neuen Mitarbeiter anlegen (Admin)</h3>
                <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 20px;">Dieser Benutzer meldet sich sp√§ter mit der Firmen-E-Mail (Admin-E-Mail) und seiner Personalnummer an. Die Personalnummer muss f√ºr diesen Admin-Kunden eindeutig sein.</p>
                
                <div class="input-group">
                    <label for="staffCreateName">Name des Mitarbeiters</label>
                    <input type="text" id="staffCreateName" required>
                </div>
                
                <div class="input-group">
                    <label for="staffCreatePersonalNumber">Personalnummer (1-4 Ziffern)</label>
                    <input type="number" id="staffCreatePersonalNumber" pattern="\d*" min="1" max="9999" placeholder="z.B. 01, 02..." required>
                </div>
                
                <div class="input-group">
                    <label for="staffCreatePin">Anfangs-PIN/Passwort (4-stellig)</label>
                    <input type="password" id="staffCreatePin" minlength="4" maxlength="4" required>
                </div>

                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hideStaffMemberCreatePopup()">Abbrechen</button>
                    <button type="submit" class="action-button register">Mitarbeiter anlegen</button>
                </div>
                
                <p style="font-size: 0.7rem; color: var(--color-error-red); margin-top: 15px;">**SICHERHEITSHINWEIS: Die PIN wird derzeit unverschl√ºsselt gespeichert und ist nur f√ºr dieses Beispiel gedacht.**</p>
            </form>
        </div>


        <div id="settingsPopupOverlay">
            <div class="popup-card">
                <h3>Einstellungen</h3>
                
                <div class="setting-row">
                    <label>Sound bei Scan</label>
                    <label class="switch">
                        <input type="checkbox" id="settingSound" onchange="saveSettings()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="setting-row" style="display:block;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <label>Lautst√§rke</label>
                        <span id="volValue">50%</span>
                    </div>
                    <input type="range" id="settingVolume" min="0" max="100" value="50" oninput="updateVolumeLabel()" onchange="saveSettings()">
                </div>

                <div class="setting-row">
                    <label>Vibration bei Scan</label>
                    <label class="switch">
                        <input type="checkbox" id="settingVibrate" onchange="saveSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <h4 style="margin-top: 30px; margin-bottom: 15px; font-weight: 600;">Datenmanagement (Admin)</h4>
                <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 15px;">Import/Export ist nur f√ºr Administratoren verf√ºgbar.</p>

                <div class="setting-row" style="border-bottom: none; flex-direction: column; align-items: flex-start;">
                    <div style="width: 100%;">
                        <label for="fileInput" class="primary-button" style="display: block; text-align: center; margin-bottom: 10px;">
                            Daten importieren (JSON/CSV)
                        </label>
                        <input type="file" id="fileInput" accept=".json,.csv" style="display: none;" onchange="handleImport(event)">
                    </div>
                    <button class="primary-button" style="width: 100%; margin-top: 10px;" onclick="exportData()">Daten exportieren (JSON)</button>
                </div>
            </div>
        </div>

        <div id="loginView" class="app-view-container active">
            <div class="login-header">
                <div class="app-icon">üì¶</div>
                <h2>Inventar Scanner Pro</h2>
            </div>

            <p id="authError"></p>
            <p id="loadingAuth">Wird geladen...</p>

            <form id="authForm" onsubmit="event.preventDefault(); authenticateUser(event);">
                
                <div id="emailPasswordLogin">
                    <div class="input-group">
                        <label for="authEmail">E-Mail</label>
                        <input type="email" id="authEmail" required>
                    </div>
                    <div class="input-group">
                        <label for="authPassword">Passwort</label>
                        <input type="password" id="authPassword" required>
                    </div>
                    <button type="submit" id="authSubmitButton" class="primary-button">Anmelden</button>
                </div>

                <div id="pinLoginFields" style="display: none;">
                    <div class="input-group">
                        <label for="authCompanyEmail">Firmen-E-Mail (Admin)</label>
                        <input type="email" id="authCompanyEmail" placeholder="z.B. info@lager.de" required>
                    </div>
                    <div class="input-group">
                        <label for="authPersonalNumber">Personalnummer</label>
                        <input type="number" id="authPersonalNumber" pattern="\d*" min="1" max="9999" maxlength="4" placeholder="z.B. 01, 02..." required>
                    </div>
                    <div class="input-group">
                        <label for="authPin">PIN/Passwort (4-stellig)</label>
                        <input type="password" id="authPin" minlength="4" maxlength="4" required> 
                    </div>
                    <button type="submit" id="pinSubmitButton" class="primary-button">Anmelden mit Personalnummer</button>
                </div>
                
                <div id="toggleAuthModeContainer" style="margin-top: 20px; text-align: center;">
                    <span id="switchToPin" style="color: var(--color-accent-blue); cursor: pointer; font-size: 0.9rem; opacity: 0.8; text-decoration: underline;" onclick="toggleAuthMode(true)">Mit Personalnummer anmelden</span>
                    <span id="switchToEmail" style="display: none; color: var(--color-accent-blue); cursor: pointer; font-size: 0.9rem; opacity: 0.8; text-decoration: underline;" onclick="toggleAuthMode(false)">Zur√ºck zur E-Mail-Anmeldung</span>
                </div>
                
                <span id="registerToggle" style="display: none;"></span>

            </form>

            <div style="position: absolute; bottom: 20px; opacity: 0.5; font-size: 0.8rem;">
                Powered by Supabase &amp; html5-qrcode
            </div>
        </div>

        <div id="appView" class="app-view-container">
            <header>
                <div style="display: flex; align-items: center;">
                    <span style="font-size: 1.5em; margin-right: 8px;">üì¶</span>
                    <h1 id="userDisplay"></h1>
                </div>
                <button class="header-icon-btn" onclick="showSettingsPopup()">‚öôÔ∏è</button>
                <button class="header-button" onclick="logout()">Abmelden</button>
            </header>

            <div id="tabContentContainer">
                <div id="scannerTab" class="tab-content active">
                    <div id="reader-container">
                        <div id="reader"></div>
                        <div class="scan-frame" id="scanFrame" style="display:none;"></div>
                        <div id="preScan">
                            <div style="font-size: 4em; margin-bottom: 20px;">üì¶</div>
                            <h2>Scanner bereit</h2>
                            <p style="opacity: 0.7; margin-bottom: 30px;">Kamera-Zugriff starten, um loszulegen.</p>
                            <button class="primary-button" style="max-width: 250px;" onclick="activateCamera()">SCAN STARTEN</button>
                        </div>
                    </div>

                    <div id="result-card" class="result-card">
                        <div class="card-handle"></div>
                        <div id="cardTitle"><span id="cardStatusIcon"></span> <span id="cardTitleText"></span></div>
                        <div id="cardContent"></div>
                        <div class="action-button-group">
                            <button class="action-button cancel" onclick="hideResultCard()">Fertig</button>
                            <button class="action-button register" id="registerButton" onclick="showPopup()">Registrieren</button>
                        </div>
                    </div>
                </div>

                <div id="listTab" class="tab-content">
                    <div class="search-container">
                        <input type="text" id="articleSearchInput" placeholder="Suche nach Name, Barcode oder Stellplatz..." oninput="debounce(loadArticleList, 300, this.value)">
                    </div>
                    <div class="list-content-container">
                        <ul id="articleList"></ul>
                    </div>
                </div>

                <div id="logTab" class="tab-content">
                    <div class="search-container">
                        <input type="text" id="logSearchInput" placeholder="Suche nach Aktion oder Beschreibung..." oninput="loadAdminLog(this.value)">
                    </div>
                    <div class="list-content-container">
                        <ul id="logList"></ul>
                    </div>
                </div>

                <div id="usersTab" class="tab-content">
                    <div class="search-container" style="display: flex; align-items: center; justify-content: space-between;">
                        <input type="text" id="userSearchInput" placeholder="Suche nach E-Mail, Rolle oder Anmerkungen..." oninput="loadUserList(this.value)" style="flex-grow: 1;">
                        <button id="addStaffButton" class="header-button" style="margin-left: 10px; display: none;" onclick="showStaffMemberCreatePopup()">Mitarbeiter anlegen</button>
                    </div>
                    <div class="list-content-container">
                        <ul id="userList"></ul>
                    </div>
                </div>
                
            </div>

            <footer>
                <div class="nav-item" id="navScanner" onclick="changeTab('scannerTab')">
                    <svg viewBox="0 0 24 24"><path d="M4 8V6C4 5.44772 4.44772 5 5 5H6C6.55228 5 7 5.44772 7 6V8M4 16V18C4 18.5523 4.44772 19 5 19H6C6.55228 19 7 18.5523 7 18V16M17 8V6C17 5.44772 17.4477 5 18 5H19C19.5523 5 20 5.44772 20 6V8M17 16V18C17 18.5523 17.4477 19 18 19H19C19.5523 19 20 18.5523 20 18V16M9 12H15"/></svg>
                    <span>Scanner</span>
                </div>
                <div class="nav-item" id="navList" onclick="changeTab('listTab')">
                    <svg viewBox="0 0 24 24"><path d="M4 7H20M4 12H20M4 17H20"/></svg>
                    <span>Artikel</span>
                </div>
                <div class="nav-item" id="navLog" onclick="changeTab('logTab')" style="display: none;">
                    <svg viewBox="0 0 24 24"><path d="M12 4L12 12L16 16"/></svg>
                    <span>Logbuch</span>
                </div>
                <div class="nav-item" id="navUsers" onclick="changeTab('usersTab')" style="display: none;">
                    <svg viewBox="0 0 24 24"><path d="M16 7C16 9.20914 14.2091 11 12 11C9.79086 11 8 9.20914 8 7C8 4.79086 9.79086 3 12 3C14.2091 3 16 4.79086 16 7ZM12 14C16.4183 14 20 17.5817 20 22H4C4 17.5817 7.58172 14 12 14Z"/></svg>
                    <span>Benutzer</span>
                </div>
            </footer>
        </div>

        <script>
            // Globale Variablen & Initialisierung (am Anfang der script-Tags)
            let html5QrCode = null;
            let currentUserId = null;
            let isRegisterMode = false;
            let currentAdminEmail = ""; // NEU: Speichert die Admin-E-Mail f√ºr PIN-Login

            // Audio-Feedback f√ºr Scanner
            const feedbackAudio = new Audio('data:audio/wav;base64,UklGRl9vT1JXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAAABkYXRhAAALSA==');
            let appSettings = {};
            
            // NEU: IndexDB Wrapper Klasse (von oben √ºbernommen)
            class IndexedDBHelper {
                constructor(dbName = 'inventoryDB', dbVersion = 3) {
                    this.dbName = dbName;
                    this.dbVersion = dbVersion;
                    this.db = null;
                }

                async open() {
                    return new Promise((resolve, reject) => {
                        if (this.db) {
                            resolve();
                            return;
                        }
                        const request = indexedDB.open(this.dbName, this.dbVersion);
                        request.onupgradeneeded = (event) => {
                            const db = event.target.result;
                            // Artikel-Speicher (Schl√ºssel: barcode)
                            if (!db.objectStoreNames.contains('artikel')) {
                                db.createObjectStore('artikel', { keyPath: 'barcode' });
                            }
                            // Benutzerrollen-Speicher (Schl√ºssel: id/uuid)
                            if (!db.objectStoreNames.contains('user_roles')) {
                                db.createObjectStore('user_roles', { keyPath: 'id' });
                            }
                            // Logbuch-Speicher (Schl√ºssel: created_at)
                            if (!db.objectStoreNames.contains('audit_log')) {
                                db.createObjectStore('audit_log', { keyPath: 'created_at' });
                            }
                            // Outbox f√ºr Offline-√Ñnderungen (Schl√ºssel: Inkrementeller Index)
                            if (!db.objectStoreNames.contains('outbox')) {
                                const outboxStore = db.createObjectStore('outbox', { keyPath: 'id', autoIncrement: true });
                                outboxStore.createIndex('timestamp', 'timestamp', { unique: false });
                            }
                            // NEU: Staff Members f√ºr PIN-Login (Schl√ºssel: personal_number, da dies mit client_id eindeutig sein sollte)
                            if (!db.objectStoreNames.contains('staff_members')) {
                                db.createObjectStore('staff_members', { keyPath: 'personal_number' });
                            }
                        };
                        request.onsuccess = (event) => {
                            this.db = event.target.result;
                            resolve();
                        };
                        request.onerror = (event) => {
                            console.error("IndexedDB Fehler:", event.target.error);
                            reject(event.target.error);
                        };
                    });
                }

                async upsertData(storeName, data, keyPath = null) {
                    await this.open();
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction(storeName, 'readwrite');
                        const store = transaction.objectStore(storeName);
                        let request;
                        if (keyPath) {
                            // Spezieller Fall f√ºr audit_log, da created_at als keyPath verwendet wird
                            request = store.put(data);
                        } else {
                            request = store.put(data);
                        }
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = (event) => reject(event.target.error);
                    });
                }

                async getData(storeName, key) {
                    await this.open();
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction(storeName, 'readonly');
                        const store = transaction.objectStore(storeName);
                        const request = store.get(key);
                        request.onsuccess = (event) => resolve(event.target.result);
                        request.onerror = (event) => reject(event.target.error);
                    });
                }

                async getAllData(storeName) {
                    await this.open();
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction(storeName, 'readonly');
                        const store = transaction.objectStore(storeName);
                        const request = store.getAll();
                        request.onsuccess = (event) => resolve(event.target.result);
                        request.onerror = (event) => reject(event.target.error);
                    });
                }

                async deleteData(storeName, key) {
                    await this.open();
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction(storeName, 'readwrite');
                        const store = transaction.objectStore(storeName);
                        const request = store.delete(key);
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = (event) => reject(event.target.error);
                    });
                }

                async clearData(storeName) {
                    await this.open();
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction(storeName, 'readwrite');
                        const store = transaction.objectStore(storeName);
                        const request = store.clear();
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = (event) => reject(event.target.error);
                    });
                }
                
                async bulkInsertData(storeName, data) {
                    await this.open();
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction(storeName, 'readwrite');
                        const store = transaction.objectStore(storeName);
                        data.forEach(item => {
                            store.put(item);
                        });
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = (event) => reject(event.target.error);
                    });
                }

                async addToOutbox(operation) {
                    await this.open();
                    return this.upsertData('outbox', operation);
                }

                async getAllOutboxOperations() {
                    return this.getAllData('outbox');
                }

                // Artikel Helfer
                async getArticleByBarcode(barcode) { return this.getData('artikel', barcode); }
                async getAllArticles() { return this.getAllData('artikel'); }
                async deleteArticle(barcode) { return this.deleteData('artikel', barcode); }
                async updateArticleScans(barcode, newScans) { const article = await this.getArticleByBarcode(barcode); if (article) { article.scans = newScans; await this.upsertData('artikel', article); } }
                async updateArticleStellplatz(barcode, newPlatz) { const article = await this.getArticleByBarcode(barcode); if (article) { article.stellplatz = newPlatz; await this.upsertData('artikel', article); } }
                // Log Helfer
                async getAllLogs() { return this.getAllData('audit_log'); }
                // User Helfer
                async getAllUserRoles() { return this.getAllData('user_roles'); }
                async getUserRole(id) { return this.getData('user_roles', id); }

                // NEU: Staff Helfer
                async getStaffMember(personal_number) { return this.getData('staff_members', personal_number); }
                async getAllStaffMembers() { return this.getAllData('staff_members'); } // Nicht im Original, aber notwendig f√ºr Admin-Liste
            }


            // --- UTILITY FUNKTIONEN ---
            function debounce(func, delay, ...args) {
                let timeoutId;
                return function() {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(this, args), delay);
                };
            }
            
            function showToast(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.classList.add('toast', type);

                let icon = '';
                if (type === 'success') icon = '‚úÖ';
                if (type === 'error') icon = '‚ùå';
                if (type === 'info') icon = '‚ÑπÔ∏è';
                if (type === 'warning') icon = '‚ö†Ô∏è';

                toast.innerHTML = `<span class="toast-icon">${icon}</span> ${message}`;
                container.prepend(toast); // Neueste oben

                // Anzeigen
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);

                // Ausblenden und Entfernen
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        container.removeChild(toast);
                    }, 300);
                }, duration);
            }

            // --- SETTINGS LOGIK ---
            function initSettings() {
                const storedSettings = localStorage.getItem('inventoryAppSettings');
                if (storedSettings) {
                    appSettings = JSON.parse(storedSettings);
                } else {
                    appSettings = {
                        sound: true,
                        vibrate: true,
                        volume: 50
                    };
                }

                if(document.getElementById('settingSound')) document.getElementById('settingSound').checked = appSettings.sound;
                if(document.getElementById('settingVibrate')) document.getElementById('settingVibrate').checked = appSettings.vibrate;
                if(document.getElementById('settingVolume')) document.getElementById('settingVolume').value = appSettings.volume;
                if(document.getElementById('volValue')) document.getElementById('volValue').innerText = `${appSettings.volume}%`;
                feedbackAudio.volume = appSettings.volume / 100;
            }

            function updateVolumeLabel() {
                document.getElementById('volValue').innerText = `${document.getElementById('settingVolume').value}%`;
            }

            function saveSettings() {
                appSettings.sound = document.getElementById('settingSound').checked;
                appSettings.vibrate = document.getElementById('settingVibrate').checked;
                appSettings.volume = parseInt(document.getElementById('settingVolume').value);
                feedbackAudio.volume = appSettings.volume / 100;
                localStorage.setItem('inventoryAppSettings', JSON.stringify(appSettings));
            }

            function showSettingsPopup() {
                document.getElementById('settingsPopupOverlay').style.display = 'flex';
                setTimeout(() => document.getElementById('settingsPopupOverlay').classList.add('show'), 10);
            }

            function hideSettingsPopup() {
                document.getElementById('settingsPopupOverlay').classList.remove('show');
                setTimeout(() => document.getElementById('settingsPopupOverlay').style.display = 'none', 300);
            }

            function triggerScanFeedback() {
                if (appSettings.sound) {
                    feedbackAudio.currentTime = 0;
                    feedbackAudio.play().catch(e => console.log("Audio blockiert", e));
                }
                if (appSettings.vibrate && navigator.vibrate) {
                    navigator.vibrate(200); // 200ms Vibration
                }
            }

            function testFeedback() {
                triggerScanFeedback();
                showToast("Feedback getestet.", 'success');
            }


            // --- AUTHENTIFIZIERUNG LOGIK ---
            
            function toggleAuthMode(isPinModeEnabled) {
                window.isPinMode = isPinModeEnabled;
                document.getElementById('emailPasswordLogin').style.display = isPinModeEnabled ? 'none' : 'block';
                document.getElementById('pinLoginFields').style.display = isPinModeEnabled ? 'block' : 'none';
                document.getElementById('switchToPin').style.display = isPinModeEnabled ? 'none' : 'inline';
                document.getElementById('switchToEmail').style.display = isPinModeEnabled ? 'inline' : 'none';
                document.getElementById('registerToggle').style.display = isPinModeEnabled ? 'none' : 'inline';
                document.getElementById("authError").innerText = ""; 
                
                // Setzt den Anmeldetext korrekt f√ºr den E-Mail-Modus
                if (!isPinModeEnabled) {
                    const submitButton = document.getElementById("authSubmitButton");
                    submitButton.innerText = isRegisterMode ? "Registrieren" : "Anmelden";
                }
            }

            function switchView(viewId) {
                document.querySelectorAll('.app-view-container').forEach(view => {
                    view.classList.remove('active');
                });
                document.getElementById(viewId).classList.add('active');
                // Wenn wir zur App wechseln, Tabs und Admin-Ansichten aktualisieren
                if (viewId === 'appView') {
                    changeTab(window.currentTabId);
                    updateAdminViews(window.currentUserRole);
                }
            }

            function updateAdminViews(role) {
                const isAdmin = role === 'admin';
                document.getElementById('navLog').style.display = isAdmin ? 'flex' : 'none';
                document.getElementById('navUsers').style.display = isAdmin ? 'flex' : 'none';
                
                // NEU: Mitarbeiter anlegen Button nur f√ºr Admins
                const addStaffButton = document.getElementById('addStaffButton');
                if (addStaffButton) {
                    addStaffButton.style.display = isAdmin ? 'inline-block' : 'none';
                }
            }

            function toggleAuthMode() {
                isRegisterMode = !isRegisterMode;
                const submitButton = document.getElementById("authSubmitButton");
                const toggle = document.getElementById("registerToggle");
                submitButton.innerText = isRegisterMode ? "Registrieren" : "Anmelden";
                toggle.innerText = isRegisterMode ? "Zum Login" : "Neu registrieren";
                document.getElementById("authError").innerText = "";
            }

            async function handlePinLogin(companyEmail, personalNumber, pin) {
                const submitButton = document.getElementById("pinSubmitButton");
                submitButton.disabled = true;
                submitButton.innerText = "Pr√ºfe...";
                document.getElementById("authError").innerText = "";
                
                let isOffline = !navigator.onLine;

                try {
                    const clientEmail = companyEmail.toLowerCase().trim();
                    const pn = personalNumber.trim();
                    let clientId = null;
                    let staffData = null;

                    // 1. Finde die Client-ID (Tenant-ID) √ºber die Admin/Firmen-E-Mail (Online-Pfad)
                    if (!isOffline) {
                        const { data: userData, error: userError } = await window.appSupabaseClient
                            .from('user_roles')
                            .select('client_id, is_blocked, id')
                            .eq('email', clientEmail)
                            .maybeSingle();

                        if (userError || !userData) {
                            throw new Error("Fehler: Firmen-E-Mail nicht gefunden.");
                        }

                        if (userData.is_blocked) {
                            throw new Error("Fehler: Firmen-Konto ist gesperrt.");
                        }
                        
                        clientId = userData.client_id;
                        window.currentAdminEmail = clientEmail; // Speichern f√ºr das Staff Creation Popup
                        
                        // 2. Suche den Mitarbeiter in der staff_members Tabelle (Online-Pfad)
                        const { data: onlineStaffData, error: staffError } = await window.appSupabaseClient
                            .from('staff_members')
                            .select('*')
                            .eq('client_id', clientId)
                            .eq('personal_number', pn)
                            .maybeSingle();

                        if (staffError) throw staffError;
                        if (!onlineStaffData) {
                            throw new Error(`Mitarbeiter mit Personalnummer ${pn} nicht gefunden.`);
                        }
                        staffData = onlineStaffData;
                    } else {
                        // Offline-Pfad
                        showToast("PIN-Login ist im Offline-Modus nur m√∂glich, wenn Admin-E-Mail und Client-ID lokal gespeichert sind.", 'warning', 7000);
                        throw new Error("Offline-Modus: PIN-Login nicht m√∂glich.");
                    }

                    // 3. PIN-Pr√ºfung (ACHTUNG: Hier ungesicherte PIN-Pr√ºfung f√ºr das Beispiel)
                    if (staffData.pin !== pin.trim()) {
                         throw new Error("Falsche PIN/Passwort.");
                    }
                    
                    if (staffData.is_blocked) {
                        throw new Error("Ihr Konto ist gesperrt. Bitte wenden Sie sich an den Administrator.");
                    }

                    // 4. Erfolgreicher Login
                    // Mitarbeiter verwenden ihre Personalnummer als eindeutigen Schl√ºssel in dieser Sitzung, 
                    // da sie keinen eigenen Supabase Auth-Account haben.
                    const employeeId = `${staffData.client_id}-${staffData.personal_number}`; 
                    await handleLoginSuccess(employeeId, staffData.name, staffData.role, clientId);
                    showToast(`Willkommen, ${staffData.name} (PN: ${pn})!`, 'success');

                } catch (error) {
                    let errorMessage = "Unbekannter Fehler bei der PIN-Anmeldung.";
                    if (error.message) { errorMessage = error.message.replace('Failed to fetch', 'Netzwerkfehler').replace('Database error querying row', 'Interner Fehler.'); }
                    
                    document.getElementById("authError").innerText = errorMessage;
                    showToast("Login fehlgeschlagen.", 'error', 5000);

                } finally {
                    submitButton.disabled = false;
                    submitButton.innerText = "Anmelden mit Personalnummer";
                }
            }


            async function authenticateUser(event) {
                event.preventDefault();

                if (window.isPinMode) {
                    const companyEmail = document.getElementById("authCompanyEmail").value;
                    const personalNumber = document.getElementById("authPersonalNumber").value;
                    const pin = document.getElementById("authPin").value;
                    await handlePinLogin(companyEmail, personalNumber, pin);
                    return;
                }
                
                // ... (Rest der authenticateUser Funktion f√ºr E-Mail/Passwort bleibt unver√§ndert) ...
                const email = document.getElementById("authEmail").value;
                const password = document.getElementById("authPassword").value;
                const submitButton = document.getElementById("authSubmitButton");
                
                submitButton.disabled = true;
                submitButton.innerText = (isRegisterMode ? "Registriere..." : "Melde an...");
                document.getElementById("authError").innerText = "";

                try {
                    if (isRegisterMode) {
                        const { data, error } = await window.appSupabaseClient.auth.signUp({ 
                            email: email, 
                            password: password 
                        });
                        
                        if (error) throw error;
                        
                        showToast("Registrierung erfolgreich. Bitte E-Mail best√§tigen.", 'info', 7000);
                        toggleAuthMode(false); // Zur√ºck zum Login
                    } else {
                        const { data, error } = await window.appSupabaseClient.auth.signInWithPassword({
                            email: email,
                            password: password,
                        });
                        if (error) throw error;
                        await handleLoginSuccess(data.user.id, data.user.email);
                    }
                } catch (error) {
                    let errorMessage = "Unbekannter Fehler bei der Authentifizierung.";
                    if (error.message) {
                        errorMessage = error.message;
                    } else if (error.status === 400 && errorMessage.includes('Email not confirmed')) {
                        errorMessage = "E-Mail noch nicht best√§tigt. Bitte √ºberpr√ºfen Sie Ihr Postfach.";
                    }
                    document.getElementById("authError").innerText = errorMessage;
                    showToast("Login fehlgeschlagen.", 'error', 5000);
                }
                submitButton.disabled = false;
                submitButton.innerText = (isRegisterMode ? "Registrieren" : "Anmelden");
            }


            async function handleLoginSuccess(identifier, displayIdentifier, role = null, clientId = null) {
                let userId = identifier;
                let userEmailOrName = displayIdentifier;
                
                currentUserId = userId; 
                
                let userRole = role || 'user'; 
                let isBlocked = false; 
                let client_id = clientId || null; 
                
                // Nur wenn keine Rolle/Client_ID √ºbergeben wurde (Standard Supabase Auth Login)
                if (!role || !clientId) {
                    let isOffline = !navigator.onLine;
                    try {
                        // 1. Online-Versuch, Benutzerrolle und Client-ID zu laden
                        const { data, error } = await window.appSupabaseClient
                            .from('user_roles')
                            .select('role, is_blocked, notes, client_id') // NEU: client_id abrufen
                            .eq('id', userId)
                            .single();

                        if (data) {
                            userRole = data.role || 'user';
                            isBlocked = data.is_blocked || false;
                            client_id = data.client_id; // NEU: Client-ID setzen
                            window.currentAdminEmail = userEmailOrName; // Die Admin E-Mail/Tenant Owner E-Mail
                            // Lokale Kopie aktualisieren (upsert)
                            await window.offlineDB.upsertData('user_roles', { id: userId, email: userEmailOrName, role: userRole, is_blocked: isBlocked, notes: data.notes, client_id: client_id }); 
                        }
                    } catch (e) {
                        // 2. Offline-Fallback
                        if (e.message.includes('Failed to fetch') || !navigator.onLine) {
                            isOffline = true;
                            showToast("Netzwerkfehler. Suche lokale Benutzerdaten...", 'info');
                            try {
                                const localUser = await window.offlineDB.getUserRole(userId);
                                if (localUser) {
                                    userRole = localUser.role;
                                    isBlocked = localUser.is_blocked;
                                    client_id = localUser.client_id;
                                    window.currentAdminEmail = localUser.email;
                                } else {
                                    throw new Error("Keine lokalen Daten f√ºr diesen Benutzer.");
                                }
                            } catch (e) {
                                console.error("Offline-Login-Fehler:", e);
                            }
                        } else {
                            console.error("Datenbankfehler user_roles:", e);
                        }
                    }
                }
                
                if (!client_id) {
                    // Sign-out only if it's a Supabase Auth user (not staff)
                    if (!String(userId).includes('-')) {
                        await window.appSupabaseClient.auth.signOut();
                    }
                    document.getElementById("authError").innerText = "Interner Fehler: Client-ID fehlt. Wenden Sie sich an den Admin.";
                    showToast("Login fehlgeschlagen: Konfigurationsfehler.", 'error', 7000);
                    return;
                }

                if (isBlocked) {
                    // Sign-out only if it's a Supabase Auth user (not staff)
                    if (!String(userId).includes('-')) {
                        await window.appSupabaseClient.auth.signOut();
                    }
                    document.getElementById("authError").innerText = "Ihr Konto ist gesperrt. Bitte wenden Sie sich an den Administrator.";
                    showToast("Login fehlgeschlagen: Konto gesperrt.", 'error', 7000);
                    return;
                }

                window.currentUserRole = userRole;
                window.currentClientId = client_id; // Globale Tenant-ID setzen
                document.getElementById("userDisplay").innerText = userEmailOrName; // NEU: Kann Name oder E-Mail sein
                switchView('appView');
                syncData(true);
            }

            async function logout() {
                const { error } = await window.appSupabaseClient.auth.signOut();
                if (error) {
                    showToast("Fehler beim Abmelden.", 'error');
                    console.error("Logout Fehler:", error);
                }
                switchView('loginView');
                window.currentUserRole = null;
                window.currentClientId = null; // Client-ID l√∂schen
                showToast("Erfolgreich abgemeldet.", 'info');
                window.lastCode = "";
                document.getElementById("userDisplay").innerText = "";
                document.getElementById("authEmail").value = "";
                document.getElementById("authPassword").value = "";
                document.getElementById("authError").innerText = "";
                document.getElementById("authCompanyEmail").value = ""; // NEU
                document.getElementById("authPersonalNumber").value = ""; // NEU
                document.getElementById("authPin").value = ""; // NEU
                toggleAuthMode(false); // Zur√ºck zum E-Mail-Login
            }

            // --- SCANNER FUNKTIONEN ---
            // ... (Hier kommen die bestehenden SCANNER FUNKTIONEN) ...
            
            // --- ARTIKEL, ADMIN EDIT, DELETE FUNKTIONEN ---
            // ... (Hier kommen die bestehenden ARTIKEL, ADMIN EDIT, DELETE FUNKTIONEN) ...

            // --- LISTEN FUNKTIONEN ---
            // ... (Hier kommen die bestehenden LISTEN FUNKTIONEN: loadArticleList, loadAdminLog, loadUserList) ...


            /* --- ADMIN MITARBEITER LOGIK (NEU) --- */
            
            function showStaffMemberCreatePopup() {
                if (window.currentUserRole !== 'admin') {
                    showToast("Nur Administratoren d√ºrfen Mitarbeiter anlegen.", 'error');
                    return;
                }
                
                // Felder zur√ºcksetzen
                document.getElementById('staffCreateName').value = '';
                document.getElementById('staffCreatePersonalNumber').value = '';
                document.getElementById('staffCreatePin').value = '';

                document.getElementById('staffMemberCreatePopupOverlay').style.display = 'flex';
                setTimeout(() => document.getElementById('staffMemberCreatePopupOverlay').classList.add('show'), 10);
            }

            function hideStaffMemberCreatePopup() {
                document.getElementById('staffMemberCreatePopupOverlay').classList.remove('show');
                setTimeout(() => document.getElementById('staffMemberCreatePopupOverlay').style.display = 'none', 300);
            }

            async function createStaffMember() {
                if (window.currentUserRole !== 'admin' || !window.currentClientId) {
                    showToast("Fehler: Keine Admin/Client-ID.", 'error');
                    return;
                }
                
                const name = document.getElementById('staffCreateName').value.trim();
                const personalNumber = document.getElementById('staffCreatePersonalNumber').value.trim();
                const pin = document.getElementById('staffCreatePin').value.trim();

                const submitButton = document.querySelector('#staffMemberCreatePopupOverlay button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerText = 'Erstelle...';

                if (!name || !personalNumber || pin.length !== 4) {
                    showToast("Bitte Name, eine Personalnummer (1-4 Ziffern) und eine 4-stellige PIN eingeben.", 'error', 7000);
                    submitButton.disabled = false;
                    submitButton.innerText = 'Mitarbeiter anlegen';
                    return;
                }
                
                const newStaffMember = {
                    client_id: window.currentClientId,
                    personal_number: personalNumber, 
                    name: name,
                    pin: pin, // ACHTUNG: UNGESICHERT F√úR DIESES BEISPIEL!
                    role: 'user',
                    is_blocked: false,
                    created_at: new Date().toISOString(),
                };
                
                let success = false;
                let isOffline = !navigator.onLine;
                
                // Generiere eine tempor√§re ID, falls die DB dies ben√∂tigt (wird bei Staff Login nicht verwendet)
                const tempId = `staff-${window.currentClientId}-${personalNumber}`; 

                try {
                    // Supabase INSERT in die staff_members Tabelle
                    const { error } = await window.appSupabaseClient
                        .from('staff_members')
                        .insert([{
                            ...newStaffMember,
                            id: tempId // Supabase erfordert eine ID
                        }]); 
                        
                    if (error) {
                        if (error.code === '23505' || error.message.includes('duplicate key value')) {
                            throw new Error(`Personalnummer ${personalNumber} existiert bereits f√ºr diesen Kunden.`);
                        }
                        if (error.message.includes('Failed to fetch')) {
                            throw new Error("Offline");
                        }
                        throw error;
                    }
                    success = true;
                    
                    // Lokalen Cache aktualisieren
                    await window.offlineDB.upsertData('staff_members', newStaffMember);

                } catch (e) {
                    if (e.message.includes("Offline") || !navigator.onLine) {
                        isOffline = true;
                        // Lokale Daten aktualisieren und Outbox-Eintrag erstellen
                        await window.offlineDB.upsertData('staff_members', newStaffMember);
                        await window.offlineDB.addToOutbox({ 
                            type: 'INSERT', 
                            table: 'staff_members', 
                            key: personalNumber, 
                            payload: newStaffMember, 
                            timestamp: new Date().toISOString() 
                        });
                        success = true;
                    } else if (e.message.includes("existiert bereits")) {
                         showToast(e.message, 'error');
                         return;
                    } else {
                        showToast(`FEHLER beim Anlegen des Mitarbeiters.`, "error");
                        console.error("Mitarbeitererstellungsfehler:", e);
                    }
                }

                if (success) {
                    const statusMessage = isOffline 
                        ? `Mitarbeiter ${name} lokal angelegt. Wird bei Verbindung synchronisiert.` 
                        : `Mitarbeiter ${name} (PN: ${personalNumber}) erfolgreich angelegt.`;
                        
                    showToast(statusMessage, isOffline ? "info" : "success", 7000);
                    logAdminAction('STAFF_MEMBER_CREATED', `Mitarbeiter ${name} (PN: ${personalNumber}) wurde angelegt.`);
                    hideStaffMemberCreatePopup();
                    loadUserList(document.getElementById('userSearchInput').value); // Liste aktualisieren
                }
                 submitButton.disabled = false;
                 submitButton.innerText = 'Mitarbeiter anlegen';
            }


            // --- OFFLINE/SYNC LOGIK ---
            
            function initOfflineSync() {
                window.offlineDB = new IndexedDBHelper();
                // Regelm√§√üigen Synchronisations-Check starten
                if (navigator.onLine) {
                    syncData(true); 
                }
                // Setze ein Intervall von 30 Sekunden
                setInterval(() => {
                    if (!window.isSyncing && navigator.onLine) {
                        syncData();
                    }
                }, 30000); 
                
                // F√ºge Event Listener f√ºr Online/Offline hinzu, um sofort zu synchronisieren
                window.addEventListener('online', () => {
                    showToast("Wieder online. Starte Synchronisation...", 'info', 3000);
                    syncData(true);
                });
                window.addEventListener('offline', () => {
                    showToast("Offline-Modus aktiv.", 'warning', 3000);
                });
            }

            async function syncData(initialSync = false) {
                if (window.isSyncing || !window.currentClientId || !window.appSupabaseClient) {
                    return;
                }
                
                const syncStatusElement = document.getElementById('syncStatus');
                if (syncStatusElement) {
                    syncStatusElement.innerText = 'Synchronisiere...';
                    syncStatusElement.style.color = 'var(--color-warning-yellow)';
                }

                window.isSyncing = true;
                console.log("Starte Synchronisation...");
                let successfulOps = 0;
                
                try {
                    const outboxOperations = await window.offlineDB.getAllOutboxOperations();
                    
                    if (outboxOperations.length > 0) {
                        showToast(`Offline-√Ñnderungen: ${outboxOperations.length} Aktionen synchronisieren...`, 'info', 5000);
                    }

                    for (const op of outboxOperations) {
                        const { type, table, payload, key } = op;
                        
                        if (!payload.client_id) {
                            payload.client_id = window.currentClientId;
                        }
                        
                        let error = null;
                        let dbAction = null;
                        const storeNameMap = {
                            'artikel': 'barcode',
                            'user_roles': 'id',
                            'audit_log': 'created_at',
                            'staff_members': 'personal_number' // NEU: staff_members
                        };
                        const keyColumn = storeNameMap[table] || 'barcode';


                        // 1. Online-Operation ausf√ºhren
                        try {
                            switch (type) {
                                case 'INSERT':
                                    dbAction = await window.appSupabaseClient
                                        .from(table)
                                        .insert([payload]);
                                    break;
                                case 'UPDATE':
                                    // Bei Updates nach Key und Client-ID filtern
                                    dbAction = await window.appSupabaseClient
                                        .from(table)
                                        .update(payload)
                                        .eq(keyColumn, key)
                                        .eq('client_id', window.currentClientId);
                                    break;
                                case 'DELETE':
                                    // Bei Deletes nach Key und Client-ID filtern
                                    dbAction = await window.appSupabaseClient
                                        .from(table)
                                        .delete()
                                        .eq(keyColumn, key)
                                        .eq('client_id', window.currentClientId);
                                    break;
                                default:
                                    console.error(`Unbekannter Outbox-Typ: ${type}`);
                                    error = { message: "Unbekannter Outbox-Typ" }; 
                            }
                            
                            if (dbAction && dbAction.error) {
                                error = dbAction.error;
                            }

                        } catch (networkError) {
                            console.warn("Netzwerkfehler w√§hrend Synchronisation. Breche ab.", networkError);
                            throw new Error("Netzwerkfehler");
                        }


                        if (error) {
                            if (error.code === '23505' || (error.message && error.message.includes('duplicate key value'))) {
                                if (type === 'INSERT') {
                                    showToast(`Artikel/Eintrag existiert bereits (Key: ${key}). Offline-Aktion √ºbersprungen.`, 'info', 7000);
                                    await window.offlineDB.deleteData('outbox', op.id); 
                                    continue;
                                }
                            } else if (error.code === '42501' || (error.message && error.message.includes('permission denied')) || (error.message && error.message.includes('violates row level security policy'))) {
                                showToast(`Berechtigungsfehler beim Synchronisieren von ${type} (${table}). Aktion √ºbersprungen.`, 'error', 7000);
                                await window.offlineDB.deleteData('outbox', op.id); 
                                continue;
                            } else if (error.code === '404' || (error.message && error.message.includes('Not Found'))) {
                                if (type === 'UPDATE' || type === 'DELETE') {
                                    showToast(`Ziel-Eintrag nicht auf dem Server gefunden. Lokale Outbox-Aktion (${type}) √ºbersprungen.`, 'info', 7000);
                                    await window.offlineDB.deleteData('outbox', op.id); 
                                    continue;
                                }
                            }
                            
                            console.error(`Outbox DB Fehler f√ºr ${type} ${table}:`, error);
                            showToast(`Fehler beim Synchronisieren von ${type} (${table}). Breche ab.`, 'error', 7000);
                            return; // Schleife abbrechen

                        }
                        
                        // 2. Erfolg: Operation aus der Outbox l√∂schen
                        await window.offlineDB.deleteData('outbox', op.id); 
                        successfulOps++;
                        console.log(`Outbox-Aktion erfolgreich synchronisiert und gel√∂scht: ${type} ${table}`);

                    }

                    // Lade alle Listen neu, um den neuesten Stand zu zeigen
                    if (initialSync || successfulOps > 0) {
                        if (successfulOps > 0) {
                            showToast(`${successfulOps} Offline-√Ñnderungen erfolgreich synchronisiert.`, 'success', 5000);
                        }
                        
                        console.log("Starte initialen/finalen Daten-Fetch vom Server...");
                        // Diese Funktionen holen die Daten vom Server und aktualisieren den lokalen Cache
                        // HINWEIS: Hier fehlen die Implementierungen f√ºr loadArticleList, loadAdminLog, loadUserList, 
                        // aber die Logik geht davon aus, dass sie existieren und Serverdaten holen.
                        // loadArticleList(document.getElementById('articleSearchInput').value || ''); 
                        // if (window.currentUserRole === 'admin') {
                        //     loadAdminLog(document.getElementById('logSearchInput').value || '');
                        //     loadUserList(document.getElementById('userSearchInput').value || '');
                        // }
                    }

                } catch (e) {
                    if (e.message.includes("Netzwerkfehler")) {
                        showToast("Netzwerkverbindung unterbrochen. Synchronisation pausiert.", 'error', 5000);
                    } else {
                        console.error("Fehler im Synchronisationsprozess:", e);
                    }
                } finally {
                    window.isSyncing = false;
                    if (syncStatusElement) {
                        syncStatusElement.innerText = successfulOps > 0 ? 'Erfolgreich synchronisiert' : (navigator.onLine ? 'Bereit' : 'Offline');
                        syncStatusElement.style.color = successfulOps > 0 ? 'var(--color-accent-green)' : (navigator.onLine ? 'white' : 'var(--color-warning-yellow)');
                    }
                }
            }
            
            // --- HIER M√úSSTEN DIE FEHLENDEN LOGIK-FUNKTIONEN EINGEF√úGT WERDEN (logAdminAction, loadArticleList, etc.) ---
            // Da ich den Rest des Codes nicht habe, f√ºge ich hier Platzhalter f√ºr die Kernfunktionen ein,
            // damit der Code kompiliert und die neue Login-Logik funktioniert.
            
            function logAdminAction(action, description) { console.log(`ADMIN LOG: ${action} - ${description}`); }
            function loadArticleList(query) { console.log(`Loading articles for query: ${query}`); }
            function loadAdminLog(query) { console.log(`Loading logs for query: ${query}`); }
            function loadUserList(query) { 
                console.log(`Loading users for query: ${query}`);
                // HINWEIS: Hier muss der Aufruf zur Supabase Tabelle staff_members (neben user_roles) eingebaut werden,
                // um die Mitarbeiter in der Liste anzuzeigen.
            }
            function changeTab(tabId) { 
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.getElementById('nav' + tabId.replace('Tab', '')).classList.add('active');
                window.currentTabId = tabId;
            }
            // Ende Platzhalter
            
            // --- Ende der hinzugef√ºgten Logik ---

            window.onload = function() {
                initSettings(); // Einstellungen laden
                initOfflineSync(); // Offline-Logik initialisieren
                // checkLogin() muss existieren, um den User zu initialisieren und
                // die handleLoginSuccess aufzurufen.
                async function checkLogin() {
                    document.getElementById("authForm").style.display = "none";
                    document.getElementById("loadingAuth").style.display = "block";
                    const { data: { session } } = await window.appSupabaseClient.auth.getSession();
                    if (session) {
                         // Nur f√ºr Admin-Konten, Mitarbeiter haben keine Supabase-Session
                        await handleLoginSuccess(session.user.id, session.user.email);
                    } else {
                        switchView('loginView');
                    }
                    document.getElementById("loadingAuth").style.display = "none";
                    document.getElementById("authForm").style.display = "block";
                }
                checkLogin();
                // Sicherstellen, dass der Standardmodus aktiv ist
                toggleAuthMode(false); 
            };
        </script>

    </body>
    </html>