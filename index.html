<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Stellplatz App</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const SUPABASE_URL = "https://sjhyvctidpnttqhenqoy.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHl2Y3RpZHBudHRxaGVucW95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MzU3NTksImV4cCI6MjA4MDAxMTc1OX0.oXUA012J99W8fNNJi8Zxqn-2BUjf1QJOrXGYlPotaS4";

window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>

<style>
body {
    margin: 0;
    background: linear-gradient(145deg, #09090b, #1e1e24);
    color: white;
    height: 100vh;
    font-family: Arial, sans-serif;
    overflow: hidden;
}

#loginView, #appView {
    height: 100%;
    display: none;
}

#loginView {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    padding: 50px 20px;
}

#pinIndicators {
    display: flex;
    gap: 15px;
}

.pin-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.4);
}

.pin-indicator.active {
    background: #4A90E2;
    border-color: #4A90E2;
}

.pin-indicator.error {
    background: red;
    border-color: red;
}

#keypad {
    width: 100%;
    max-width: 320px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
}

.keypad-button {
    height: 70px;
    border-radius: 50%;
    font-size: 1.5em;
    background: rgba(255,255,255,0.08);
    color: white;
    border: none;
}

#reader { height: 60%; background: black; }

#result {
    height: 40%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.1em;
    padding: 20px;
}

.green { color: #4CAF50; }
.red { color: red; }
.yellow { color: gold; }

#popup {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.8);
    justify-content: center;
    align-items: center;
}

#popupBox {
    background: #222;
    padding: 20px;
    border-radius: 15px;
    width: 90%;
    max-width: 350px;
}

input {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 10px;
    border: none;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginView">
    <h2>üîê Stellplatz Login</h2>

    <div id="pinIndicators">
        <div class="pin-indicator"></div>
        <div class="pin-indicator"></div>
        <div class="pin-indicator"></div>
        <div class="pin-indicator"></div>
        <div class="pin-indicator"></div>
        <div class="pin-indicator"></div>
    </div>

    <div id="keypad">
        <button class="keypad-button" onclick="handlePin('1')">1</button>
        <button class="keypad-button" onclick="handlePin('2')">2</button>
        <button class="keypad-button" onclick="handlePin('3')">3</button>

        <button class="keypad-button" onclick="handlePin('4')">4</button>
        <button class="keypad-button" onclick="handlePin('5')">5</button>
        <button class="keypad-button" onclick="handlePin('6')">6</button>

        <button class="keypad-button" onclick="handlePin('7')">7</button>
        <button class="keypad-button" onclick="handlePin('8')">8</button>
        <button class="keypad-button" onclick="handlePin('9')">9</button>

        <button class="keypad-button" onclick="clearPin()">‚Ü∫</button>
        <button class="keypad-button" onclick="handlePin('0')">0</button>
        <button class="keypad-button" onclick="backspace()">‚å´</button>
    </div>
</div>

<!-- APP -->
<div id="appView">

<div id="reader"></div>
<div id="result">Scanne einen Barcode...</div>

<div id="popup">
<div id="popupBox">
    <h3>Neuer Artikel</h3>
    <input id="name" placeholder="Name">
    <input id="platz" placeholder="Stellplatz">
    <label>
        <input type="checkbox" id="block"> Blocklager
    </label>
    <button onclick="save()">Speichern</button>
    <button onclick="hidePopup()">Abbrechen</button>
</div>
</div>

</div>

<script>
/* -------- PIN LOGIN -------- */

let enteredPin = "";
const CORRECT_PIN = "123456"; // << PIN HIER √ÑNDERN

function handlePin(num) {
    if (enteredPin.length >= 6) return;
    enteredPin += num;
    updateDots();
    if (enteredPin.length === 6) validate();
}

function updateDots() {
    const dots = document.querySelectorAll(".pin-indicator");
    dots.forEach((d,i)=>d.classList.toggle("active", i < enteredPin.length));
}

function clearPin() {
    enteredPin = "";
    updateDots();
}

function backspace() {
    enteredPin = enteredPin.slice(0,-1);
    updateDots();
}

function validate() {
    const dots = document.querySelectorAll(".pin-indicator");

    if (enteredPin === CORRECT_PIN) {
        document.getElementById("loginView").style.display="none";
        document.getElementById("appView").style.display="block";
        startScanner();
    } else {
        dots.forEach(d=>d.classList.add("error"));
        setTimeout(()=> {
            dots.forEach(d=>d.classList.remove("error"));
            clearPin();
        }, 1000);
    }
}

/* -------- SCANNER -------- */

let html5QrCode = null;
let lastCode = "";

function showResult(msg, cls) {
    const r=document.getElementById("result");
    r.className=cls;
    r.innerHTML=msg;
}

function startScanner() {
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250},
        code => lookup(code));
}

async function lookup(code) {

    await html5QrCode.stop();
    showResult("‚è≥ Pr√ºfe...", "yellow");

    const { data } = await supabaseClient
        .from("artikel")
        .select("*")
        .eq("barcode", code)
        .single();

    if (data) {
        await supabaseClient
            .from("artikel")
            .update({ scans: data.scans + 1 })
            .eq("barcode", code);

        showResult(`‚úÖ ${data.name}<br>üìç ${data.stellplatz}<br>üìä ${data.scans+1}`, "green");
        startScanner();

    } else {
        lastCode = code;
        showResult("‚ùå Unbekannt", "red");
        showPopup();
    }
}

/* -------- NEUER ARTIKEL -------- */

function showPopup(){
    document.getElementById("popup").style.display="flex";
}

function hidePopup(){
    document.getElementById("popup").style.display="none";
    startScanner();
}

async function save() {

    await supabaseClient.from("artikel").insert([{
        barcode: lastCode,
        name: name.value,
        stellplatz: platz.value,
        blocklager: block.checked,
        scans: 0
    }]);

    hidePopup();
    lookup(lastCode);
}

document.getElementById("loginView").style.display="flex";
</script>
</body>
</html>
