<!DOCTYPE html>
    <html lang="de">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Inventar Scanner Pro</title>

        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="https://unpkg.com/html5-qrcode"></script>

        <script>
            // ---------------------------------------------------------
            // KONFIGURATION
            // ---------------------------------------------------------
            var APP_SUPABASE_URL = "https://sjhyvctidpnttqhenqoy.supabase.co"; 
            var APP_SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHl2Y3RpZHBudHRxaGVucW95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MzU3NTksImV4cCI6MjA4MDAxMTc1OX0.oXUA012J99W8fNNJi8Zxqn-2BUjf1QJOrXGYlPotaS4"; 
            
            // Initialisierung
            (function() {
                if (window['supabase']) {
                    window.appSupabaseClient = window['supabase'].createClient(APP_SUPABASE_URL, APP_SUPABASE_KEY);
                } else {
                    window.appSupabaseClient = null;
                    console.error("Supabase-Client konnte nicht initialisiert werden.");
                }
                window.lastCode = ""; 
                window.currentTabId = "scannerTab"; 
                window.currentUserRole = null; 
                window.offlineDB = null; // NEU: IndexedDB-Instanz
                window.isSyncing = false; // NEU: Synchronisations-Status
            })();
        </script>

        <style>
/* ... (Der Style-Block bleibt unver√§ndert) ... */
            /* --- GLOBALE STYLES & FONT --- */
            :root {
                --color-bg-dark: #0a0b10;
                --color-bg-card: #1d222e;
                --color-accent-blue: #007aff;
                --color-accent-green: #34c759;
                --color-error-red: #ff3b30;
                --color-border: rgba(255, 255, 255, 0.08);
                --transition-duration: 0.3s;
                --color-warning-yellow: #ffcc00; 
            }

            * {
                box-sizing: border-box;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            }

            body,
            html {
                margin: 0;
                padding: 0;
                background: var(--color-bg-dark);
                color: white;
                height: 100dvh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            /* --- LAYOUT & TRANSITIONEN --- */

            .app-view-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                transition: opacity var(--transition-duration) ease-in-out, transform var(--transition-duration) ease-in-out;
                opacity: 0;
                pointer-events: none;
                display: flex;
                flex-direction: column;
            }

            .app-view-container.active {
                opacity: 1;
                pointer-events: all;
            }

            #loginView {
                transform: translateY(0);
            }

            #appView {
                transform: translateY(100vh);
            }

            #loginView.active {
                transform: translateY(0);
            }

            #appView.active {
                transform: translateY(0);
            }
            
            #tabContentContainer {
                flex-grow: 1;
                position: relative;
                overflow: hidden; 
            }
            
            .tab-content {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: none !important; 
                flex-direction: column;
                overflow-y: auto; 
                background: var(--color-bg-dark); 
            }
            
            .tab-content.active {
                display: flex !important; 
            }


            /* --- HEADER --- */
            header {
                height: 55px;
                background: rgba(30, 30, 40, 0.9);
                backdrop-filter: blur(8px);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 15px;
                border-bottom: 1px solid var(--color-border);
                z-index: 10;
                flex-shrink: 0; 
            }

            header h1 {
                font-size: 1.1rem;
                font-weight: 600;
                margin: 0;
            }

            .header-button {
                padding: 5px 10px;
                font-size: 0.75em;
                background: rgba(255, 255, 255, 0.1);
                border: none;
                border-radius: 8px;
                color: white;
                cursor: pointer;
                transition: background 0.2s;
            }

             /* Icon Button f√ºr Settings */
            .header-icon-btn {
                background: none; border: none;
                font-size: 1.5rem; cursor: pointer;
                padding: 0 10px; margin-right: 5px;
                transition: transform 0.2s;
            }
            .header-icon-btn:active { transform: scale(0.9); }


            /* --- LOGIN VIEW --- */
            #loginView {
                justify-content: space-around;
                align-items: center;
                padding: 40px 20px;
                text-align: center;
            }

            .login-header {
                text-align: center;
                padding-top: 50px;
            }

            .app-icon {
                font-size: 3.5em;
                color: var(--color-accent-blue);
                margin-bottom: 15px;
            }

            .login-header h2 {
                font-size: 1.6rem;
                font-weight: 700;
                margin: 0;
            }

            #authError {
                color: var(--color-error-red);
                margin-top: 10px;
                height: 1.2em;
                font-weight: 500;
            }
            
            #loadingAuth {
                text-align: center;
                font-size: 1.1rem;
                opacity: 0.7;
                display: none; 
                margin-top: 40px;
            }

            #authForm {
                width: 100%;
                max-width: 320px;
                margin-top: 50px;
                display: none; 
            }
            
            #authForm .input-group input {
                width: 100%;
                padding: 12px;
                border-radius: 8px;
                border: 1px solid var(--color-border);
                background: var(--color-bg-card);
                color: white;
                font-size: 1rem;
                margin-bottom: 15px;
            }
            
            #authForm .input-group label {
                display: block;
                font-size: 0.9rem;
                margin-bottom: 5px;
                opacity: 0.8;
                text-align: left;
            }
            
            #authForm button[type="submit"] {
                width: 100%;
                padding: 12px;
                font-size: 1rem;
                font-weight: 600;
                background: var(--color-accent-blue);
                color: white;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                transition: background 0.2s;
            }
            
            #authForm button[type="submit"]:active {
                background: #0066cc;
            }
            
            #registerToggle {
                margin-top: 20px;
                color: var(--color-accent-blue);
                cursor: pointer;
                font-size: 0.9rem;
                opacity: 0.8;
                text-decoration: underline;
            }
            
            #pinIndicators, #keypad {
                display: none; 
            }


            /* --- APP VIEW / SCANNER --- */
            #scannerTab {
                position: relative;
                overflow: hidden;
            }

            #reader-container {
                flex-grow: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                overflow: hidden;
            }

            #reader {
                width: 100%;
                height: 100%;
                background: black;
                object-fit: cover;
            }
            
            #reader video {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }


            .scan-frame {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 70%;
                max-width: 300px;
                aspect-ratio: 1 / 1;
                border: 3px solid var(--color-accent-green);
                border-radius: 12px;
                box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.7);
                pointer-events: none;
            }

            #preScan {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: var(--color-bg-dark);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                z-index: 5;
            }

            .primary-button {
                padding: 12px 25px;
                font-size: 1rem;
                font-weight: 600;
                background: var(--color-accent-blue);
                color: white;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                transition: background 0.2s;
            }

            .primary-button:active {
                background: #0066cc;
            }


            /* --- Result Card --- */
            #result-card {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                background: var(--color-bg-card);
                border-top-left-radius: 20px;
                border-top-right-radius: 20px;
                padding: 20px;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.4);
                transform: translateY(100%);
                transition: transform var(--transition-duration) ease-out;
                z-index: 10;
            }

            #result-card.active {
                transform: translateY(0);
            }

            .card-handle {
                width: 40px;
                height: 4px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 2px;
                margin: 0 auto 15px;
            }

            #cardTitle {
                font-size: 1.4rem;
                font-weight: 700;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
            }

            #cardStatusIcon {
                margin-right: 10px;
                font-size: 1.1em;
            }

            #cardContent p {
                margin: 5px 0;
                font-size: 0.9rem;
                opacity: 0.8;
            }

            .action-button-group {
                display: flex;
                gap: 10px;
                margin-top: 15px;
            }

            .action-button {
                flex: 1;
                padding: 12px;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
            }

            .action-button.register {
                background: var(--color-accent-green);
                color: var(--color-bg-card);
            }
            .action-button.register:active {
                background: #2cb74b;
            }
            .action-button.cancel {
                background: rgba(255, 255, 255, 0.1);
                color: white;
            }
            .action-button.cancel:active {
                background: rgba(255, 255, 255, 0.2);
            }
            .action-button.delete {
                background: var(--color-error-red);
                color: white;
            }
            .action-button.delete:active {
                background: #cc2a22;
            }


            /* --- POPUPS --- */
            #popupOverlay, #adminEditPopupOverlay, #deleteConfirmPopupOverlay, #userEditPopupOverlay, #settingsPopupOverlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(5px);
                z-index: 100;
                display: none;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.2s ease-in-out;
            }

            #popupOverlay.show, #adminEditPopupOverlay.show, #deleteConfirmPopupOverlay.show, #userEditPopupOverlay.show, #settingsPopupOverlay.show {
                opacity: 1;
                display: flex; 
            }

            .popup-card {
                background: var(--color-bg-card);
                padding: 25px;
                border-radius: 15px;
                width: 90%;
                max-width: 400px;
                transform: translateY(20px);
                transition: transform 0.3s ease-in-out;
            }

            #popupOverlay.show .popup-card, #adminEditPopupOverlay.show .popup-card, #deleteConfirmPopupOverlay.show .popup-card, #userEditPopupOverlay.show .popup-card, #settingsPopupOverlay.show .popup-card {
                transform: translateY(0);
            }

            .popup-card h3 {
                margin-top: 0;
                font-size: 1.3rem;
                border-bottom: 1px solid var(--color-border);
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

            .input-group {
                margin-bottom: 15px;
            }
            
            .input-group textarea {
                resize: vertical;
                min-height: 80px;
            }

            .input-group label {
                display: block;
                font-size: 0.9rem;
                margin-bottom: 5px;
                opacity: 0.8;
            }

            .input-group input[type="text"],
            .input-group input[type="email"],
            .input-group input[type="password"],
            .input-group select,
            .input-group textarea {
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid var(--color-border);
                background: var(--color-bg-dark);
                color: white;
                font-size: 1rem;
            }
            .input-group input:focus,
            .input-group select:focus,
            .input-group textarea:focus {
                outline: none;
                border-color: var(--color-accent-blue);
            }

            /* --- SETTINGS STYLES --- */
            .setting-row {
                display: flex; justify-content: space-between; align-items: center;
                margin-bottom: 20px; padding-bottom: 15px;
                border-bottom: 1px solid var(--color-border);
            }
            .setting-row:last-child { border-bottom: none; }

            .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
            .switch input { opacity: 0; width: 0; height: 0; }
            .slider {
                position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
                background-color: #3a3a44; transition: .4s; border-radius: 34px;
            }
            .slider:before {
                position: absolute; content: ""; height: 20px; width: 20px;
                left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;
            }
            input:checked + .slider { background-color: var(--color-accent-green); }
            input:checked + .slider:before { transform: translateX(22px); }

            /* Volume Slider */
            input[type=range] { width: 100%; margin-top: 10px; background: transparent; -webkit-appearance: none; }
            input[type=range]::-webkit-slider-thumb {
                -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
                background: var(--color-accent-blue); cursor: pointer; margin-top: -8px;
            }
            input[type=range]::-webkit-slider-runnable-track {
                width: 100%; height: 4px; cursor: pointer; background: #3a3a44; border-radius: 2px;
            }

            /* --- TOASTS --- */
            #toastContainer {
                position: fixed;
                top: 15px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 350px;
                z-index: 200;
                pointer-events: none;
            }

            .toast {
                background: var(--color-bg-card);
                color: white;
                padding: 10px 15px;
                border-radius: 10px;
                margin-bottom: 10px;
                opacity: 0;
                transform: translateY(20px);
                transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                font-size: 0.95rem;
                font-weight: 500;
            }

            .toast.show {
                opacity: 1;
                transform: translateY(0);
            }

            .toast-icon {
                margin-right: 10px;
                font-size: 1.2em;
            }

            .toast.success .toast-icon {
                color: var(--color-accent-green);
            }

            .toast.error .toast-icon {
                color: var(--color-error-red);
            }

            .toast.info .toast-icon {
                color: var(--color-accent-blue);
            }

            /* --- FOOTER / NAVIGATION --- */
            footer {
                display: flex;
                height: 70px;
                background: rgba(30, 30, 40, 0.9);
                backdrop-filter: blur(8px);
                border-top: 1px solid var(--color-border);
                flex-shrink: 0;
                z-index: 20;
            }

            .nav-item {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: rgba(255, 255, 255, 0.5);
                font-size: 0.8rem;
                cursor: pointer;
                transition: color 0.2s;
                user-select: none;
            }

            .nav-item.active {
                color: var(--color-accent-blue);
            }

            .nav-item svg {
                width: 24px;
                height: 24px;
                stroke: currentColor;
                fill: none;
                stroke-width: 2;
                margin-bottom: 2px;
            }
            
            /* --- ARTIKEL LIST VIEW STYLES / REUSABLE LIST STYLES --- */
            /* Padding in .list-content-container, da das Tab-Content nun auch den Search-Header enth√§lt */
            .list-content-container {
                overflow-y: auto; 
                padding: 15px 15px 80px 15px; 
            }
            
            /* NEU: Search Container Style */
            .search-container {
                padding: 15px; 
                flex-shrink: 0; 
                background: var(--color-bg-dark);
                border-bottom: 1px solid var(--color-border);
            }

            .search-container input {
                width: 100%;
                padding: 10px 15px;
                border-radius: 8px;
                border: 1px solid var(--color-border);
                background: var(--color-bg-card);
                color: white;
                font-size: 1rem;
            }


            /* Alte Paddings entfernt und durch list-content-container ersetzt */
            #listTab, #logTab, #usersTab { 
                padding: 0; /* Wichtig: Padding hier entfernen */
            }
            
            #articleList, #logList, #userList { 
                list-style: none;
                padding: 0;
                margin: 0;
            }
            
            #articleList li, #logList li, #userList li { 
                background: var(--color-bg-card);
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 10px;
                border-left: 5px solid var(--color-accent-blue); 
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: background 0.2s; 
            }
            
            #articleList li[data-role="admin-editable"]:active, #userList li[data-role="admin-editable"]:active {
                background: #2a303e; 
            }
            
            .user-role-admin { border-left-color: var(--color-warning-yellow) !important; }
            .user-is-blocked { border-left-color: var(--color-error-red) !important; }

            .item-details strong {
                display: block;
                font-size: 1.rem;
                font-weight: 600;
                margin-bottom: 2px;
            }
            
            .item-details span {
                font-size: 0.85rem;
                opacity: 0.7;
            }
            
            .item-count {
                text-align: center; 
                width: 50px; 
                height: 50px; 
                flex-shrink: 0;
                margin-left: 10px;
                display: flex; 
                flex-direction: column;
                justify-content: center;
                align-items: center;
                font-size: 0.8rem;
            }
            
            .item-count svg {
                width: 28px; 
                height: 28px;
                margin-bottom: 2px; 
            }

            .item-count .item-label {
                font-size: 0.6rem; 
                font-weight: 600;
                line-height: 1;
            }
            
            #logTab {
                display: flex; 
                flex-direction: column;
            }
            
            .user-edit-button {
                background: var(--color-accent-blue);
                color: white;
                padding: 8px 15px;
                border-radius: 8px;
                font-size: 0.8rem;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.2s;
            }

        </style>
    </head>
    <body>

        <div id="toastContainer"></div>
        
        <div id="popupOverlay">
            <form class="popup-card" onsubmit="event.preventDefault(); saveArticle();">
                <h3>Artikel Registrieren</h3>
                <div class="input-group">
                    <label for="popupBarcode">Barcode</label>
                    <input type="text" id="popupBarcode" readonly>
                </div>
                
                <div class="input-group">
                    <label for="popupBaseName">Basis-Name (z.B. T-Shirt, Wasserflasche)</label>
                    <input type="text" id="popupBaseName" required>
                </div>
                
                <div class="input-group">
                    <label for="popupSize">Gr√∂√üe / Volumen (Liter)</label>
                    <select id="popupSize">
                        <option value="">(Optional)</option>
                        <option value="0.33">0,33 Liter</option>
                        <option value="0.5">0,5 Liter</option>
                        <option value="0.7">0,7 Liter</option>
                        <option value="1.0">1,0 Liter</option>
                        <option value="1.5">1,5 Liter</option>
                        <option value="2.0">2,0 Liter</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="popupPlatz">Stellplatz (z.B. A-02-C)</label>
                    <input type="text" id="popupPlatz" required>
                </div>
                
                <div class="input-group">
                    <label for="popupBlocklager">Lagertyp</label>
                    <select id="popupBlocklager">
                        <option value="false">Regal / Fach</option>
                        <option value="true">Blocklager</option>
                    </select>
                </div>

                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hidePopup()">Abbrechen</button>
                    <button type="submit" class="action-button register">Speichern</button>
                </div>
            </form>
        </div>
        
        <div id="adminEditPopupOverlay">
            <form class="popup-card" onsubmit="event.preventDefault(); saveAdminEdit();">
                <h3>Artikel Bearbeiten (Admin)</h3>
                <div class="input-group">
                    <label for="adminEditName">Artikel Name</label>
                    <input type="text" id="adminEditName" readonly>
                </div>

                <div class="input-group">
                    <label for="adminEditBarcode">Barcode</label>
                    <input type="text" id="adminEditBarcode" readonly>
                </div>
                
                <div class="input-group">
                    <label for="adminEditPlatz">Neuer Stellplatz</label>
                    <input type="text" id="adminEditPlatz" required>
                </div>
                
                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hideAdminEditPopup()">Abbrechen</button>
                    <button type="submit" class="action-button register">Speichern</button>
                </div>

                <button type="button" class="action-button delete" style="width: 100%; margin-top: 15px;" onclick="deleteArticle()">
                    Artikel l√∂schen...
                </button>

                <p style="font-size: 0.75rem; opacity: 0.6; text-align: center; margin-top: 15px;">Sie sind als Administrator angemeldet und k√∂nnen den Stellplatz √§ndern.</p>
            </form>
        </div>

        <div id="deleteConfirmPopupOverlay">
            <div class="popup-card">
                <h3 id="deleteConfirmTitle">Artikel unwiderruflich l√∂schen</h3>
                <p id="deleteConfirmMessage" style="margin-bottom: 25px; text-align: center; font-weight: 500; font-size: 1.1rem; line-height: 1.4;"></p>

                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hideDeleteConfirmPopup()">Abbrechen</button>
                    <button type="button" class="action-button delete" onclick="confirmDeleteArticle()">Ja, unwiderruflich l√∂schen</button>
                </div>
            </div>
        </div>
        
        <div id="userEditPopupOverlay">
            <form class="popup-card" onsubmit="event.preventDefault(); saveUserEdit();">
                <h3>Benutzer bearbeiten (Admin)</h3>
                <div class="input-group">
                    <label for="userEditEmail">E-Mail</label>
                    <input type="text" id="userEditEmail" readonly>
                </div>
                <div class="input-group">
                    <label for="userEditRole">Rolle</label>
                    <select id="userEditRole" required>
                        <option value="user">Benutzer (Standard)</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="userEditBlocked">Sperrstatus</label>
                    <select id="userEditBlocked" required>
                        <option value="false">Nicht gesperrt</option>
                        <option value="true">Gesperrt</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="userEditNotes">Anmerkungen (nur f√ºr Admins sichtbar)</label>
                    <textarea id="userEditNotes" placeholder="Interne Anmerkungen..."></textarea>
                </div>
                
                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hideUserEditPopup()">Abbrechen</button>
                    <button type="submit" class="action-button register">√Ñnderungen speichern</button>
                </div>
            </form>
        </div>

        <div id="settingsPopupOverlay">
            <div class="popup-card">
                <h3>Einstellungen</h3>
                
                <div class="setting-row">
                    <label>Sound bei Scan</label>
                    <label class="switch">
                        <input type="checkbox" id="settingSound" onchange="saveSettings()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="setting-row" style="display:block;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <label>Lautst√§rke</label>
                        <span id="volValue">50%</span>
                    </div>
                    <input type="range" id="settingVolume" min="0" max="100" value="50" oninput="updateVolumeLabel()" onchange="saveSettings()">
                </div>

                <div class="setting-row">
                    <label>Vibration bei Scan</label>
                    <label class="switch">
                        <input type="checkbox" id="settingVibrate" onchange="saveSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <h4 style="margin-top: 30px; margin-bottom: 15px; font-weight: 600;">Datenmanagement (Admin)</h4>
                <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 15px;">Import/Export ist nur f√ºr Administratoren verf√ºgbar.</p>

                <div class="setting-row" style="border-bottom: none; flex-direction: column; align-items: stretch; padding-bottom: 0;">
                    <label style="margin-bottom: 10px; font-weight: 600;">Daten exportieren (Artikel)</label>
                    <div class="action-button-group" style="margin-top: 0;">
                        <button type="button" class="action-button register" style="flex: 1; background: #2e8b57;" onclick="exportData('json')">Export JSON</button>
                        <button type="button" class="action-button register" style="flex: 1; background: #2e8b57;" onclick="exportData('csv')">Export CSV</button>
                    </div>
                </div>

                <div class="setting-row" style="border-bottom: none; flex-direction: column; align-items: stretch; padding-bottom: 0; margin-top: 20px;">
                    <label for="importFile" style="margin-bottom: 10px; font-weight: 600;">Daten importieren (CSV/JSON)</label>
                    <input type="file" id="importFile" accept=".csv, application/json" style="padding: 8px; border: 1px solid var(--color-border); border-radius: 8px; background: var(--color-bg-dark); margin-bottom: 10px;" onchange="document.getElementById('importButton').disabled = !this.files.length;">
                    <button id="importButton" type="button" class="primary-button" style="background: var(--color-warning-yellow); color: var(--color-bg-card);" disabled onclick="prepareImport()">Daten importieren (Upsert)</button>
                    <p style="font-size: 0.75rem; opacity: 0.6; margin-top: 5px;">Importiert Artikel. Vorhandene Barcodes werden aktualisiert.</p>
                </div>


                <div class="action-button-group" style="margin-top: 25px; border-top: 1px solid var(--color-border); padding-top: 20px;">
                    <button class="action-button cancel" onclick="hideSettingsPopup()">Schlie√üen</button>
                    <button class="action-button register" onclick="testFeedback()">Testen</button>
                </div>
            </div>
        </div>


        <div id="loginView" class="app-view-container active">

            <div class="login-header">
                <div class="app-icon">üîê</div>
                <h2>Inventar Scanner Pro</h2>
                <div id="authError"></div>
            </div>

            <form id="authForm" onsubmit="event.preventDefault(); handleAuthSubmit();">
                <h3 id="authTitle" style="margin-bottom: 30px;">Anmelden</h3>
                
                <div class="input-group">
                    <label for="authEmail">E-Mail</label>
                    <input type="email" id="authEmail" required placeholder="name@firma.de">
                </div>
                
                <div class="input-group">
                    <label for="authPassword">Passwort</label>
                    <input type="password" id="authPassword" required placeholder="mind. 6 Zeichen">
                </div>

                <div id="pinIndicators" style="margin-bottom: 15px;">
                    </div>
                
                <button type="submit" id="authSubmitButton" style="margin-bottom: 15px;">Anmelden</button>
                
                <p id="registerToggle" onclick="toggleAuthMode()">Noch kein Konto? Registrieren</p>

            </form>
            
            <div id="keypad" class="keypad-container">
                </div>
            
            <div id="loadingAuth">
                <p>√úberpr√ºfe Login-Status...</p>
            </div>

            <p style="margin-top: auto; font-size: 0.8rem; opacity: 0.5;">
                <span id="pinModeToggle" onclick="toggleAuthMode('pin')" style="cursor: pointer; text-decoration: underline; display: none;">PIN-Login verwenden</span>
            </p>

        </div>


        <div id="appView" class="app-view-container">
            
            <header>
                <div style="display: flex; align-items: center;">
                    <h1 id="headerTitle">Scanner</h1>
                    <span id="syncStatus" style="font-size: 0.8rem; margin-left: 10px; opacity: 0.7;"></span>
                </div>
                
                <div>
                    <span id="userDisplay" style="margin-right: 15px; font-size: 0.9rem; opacity: 0.8;"></span>
                    <button class="header-icon-btn" onclick="showSettingsPopup()">‚öôÔ∏è</button>
                    <button class="header-button" onclick="logout()">Logout</button>
                </div>
            </header>

            <div id="tabContentContainer">
                
                <div id="scannerTab" class="tab-content active">
                    <div id="reader-container">
                        <div id="reader"></div>
                        <div class="scan-frame" id="scanFrame" style="display:none;"></div>
                        <div id="preScan">
                            <div style="font-size: 4em; margin-bottom: 20px;">üì¶</div>
                            <h2>Scanner bereit</h2>
                            <p style="opacity: 0.7; margin-bottom: 30px;">Kamera-Zugriff starten, um loszulegen.</p>
                            <button class="primary-button" style="max-width: 250px;" onclick="activateCamera()">SCAN STARTEN</button>
                        </div>
                    </div>
                    
                    <div id="result-card" class="result-card">
                        <div class="card-handle"></div>
                        <div id="cardTitle"><span id="cardStatusIcon"></span> <span id="cardTitleText"></span></div>
                        <div id="cardContent"></div>
                        <div class="action-button-group">
                            <button class="action-button cancel" onclick="hideResultCard()">Fertig</button>
                            <button class="action-button register" id="registerButton" onclick="showPopup()">Registrieren</button>
                        </div>
                    </div>
                </div>

                <div id="listTab" class="tab-content">
                    <div class="search-container">
                        <input type="text" id="articleSearchInput" placeholder="Suche nach Name, Barcode oder Stellplatz..." oninput="debounce(loadArticleList, 300, this.value)">
                    </div>
                    <div class="list-content-container">
                        <ul id="articleList"></ul>
                    </div>
                </div>

                <div id="logTab" class="tab-content">
                    <div class="search-container">
                        <input type="text" id="logSearchInput" placeholder="Suche nach Aktion oder Beschreibung..." oninput="loadAdminLog(this.value)">
                    </div>
                    <div class="list-content-container">
                        <ul id="logList"></ul>
                    </div>
                </div>
                
                <div id="usersTab" class="tab-content">
                    <div class="search-container">
                        <input type="text" id="userSearchInput" placeholder="Suche nach E-Mail, Rolle oder Anmerkungen..." oninput="loadUserList(this.value)">
                    </div>
                    <div class="list-content-container">
                        <ul id="userList"></ul>
                    </div>
                </div>

            </div>

            <footer>
                <div class="nav-item active" data-tab="scannerTab" onclick="changeTab('scannerTab')">
                    <svg viewBox="0 0 24 24"><path d="M4 17h16M4 7h16m-9 10h2m-2-6h2m-2-6h2"/></svg>
                    <span>Scanner</span>
                </div>
                <div class="nav-item" data-tab="listTab" onclick="changeTab('listTab')">
                    <svg viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m-5-4V8h-2v8h2zM3 10a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2v-8z"/></svg>
                    <span>Artikel</span>
                </div>
                <div class="nav-item admin-only" data-tab="logTab" onclick="changeTab('logTab')" style="display: none;">
                    <svg viewBox="0 0 24 24"><path d="M12 20h9M12 4h9M2 4h18M2 20h18M4 9h10M4 15h10"/></svg>
                    <span>Log</span>
                </div>
                <div class="nav-item admin-only" data-tab="usersTab" onclick="changeTab('usersTab')" style="display: none;">
                    <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                    <span>Benutzer</span>
                </div>
            </footer>

        </div>

        <script>
            // Globale Variablen & Konstanten
            var html5QrCode;
            var currentScannedBarcode = null;
            var currentUserId = null;
            const WAREHOUSE_ICON_SVG = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trello"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="7" y1="7" x2="7" y2="7"/><line x1="7" y1="17" x2="7" y2="17"/></svg>';
            const SHELF_ICON_SVG = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-box"><path d="M12.68 2.37a2 2 0 00-1.36 0L4.32 5.92a2 2 0 00-1.09 1.76v8.64a2 2 0 001.09 1.76l7 3.55a2 2 0 001.36 0l7-3.55a2 2 0 001.09-1.76V7.68a2 2 0 00-1.09-1.76L12.68 2.37z"/><path d="M12 22V5m0 0l7.32-3.66m-7.32 3.66l-7.32-3.66"/></svg>';
            const USER_ICON_SVG = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';

            // Simpler debounce-Ersatz, da die eigentliche Funktion im Snippet fehlte.
            let debounceTimer;
            function debounce(func, delay, ...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func(...args), delay);
            }

            /* --- EINSTELLUNGEN LOGIK --- */
            const feedbackAudio = new Audio('scan_sound.mp3'); // Annahme: Existierende Datei
            let appSettings = {
                sound: true,
                vibrate: true,
                volume: 50
            };

            function initSettings() {
                const storedSettings = localStorage.getItem('inventoryAppSettings');
                if (storedSettings) {
                    appSettings = JSON.parse(storedSettings);
                }
                document.getElementById('settingSound').checked = appSettings.sound;
                document.getElementById('settingVibrate').checked = appSettings.vibrate;
                document.getElementById('settingVolume').value = appSettings.volume;
                document.getElementById('volValue').innerText = `${appSettings.volume}%`;
                feedbackAudio.volume = appSettings.volume / 100;
            }

            function updateVolumeLabel() {
                document.getElementById('volValue').innerText = `${document.getElementById('settingVolume').value}%`;
            }

            function saveSettings() {
                appSettings.sound = document.getElementById('settingSound').checked;
                appSettings.vibrate = document.getElementById('settingVibrate').checked;
                appSettings.volume = parseInt(document.getElementById('settingVolume').value);
                feedbackAudio.volume = appSettings.volume / 100;
                localStorage.setItem('inventoryAppSettings', JSON.stringify(appSettings));
            }

            function showSettingsPopup() {
                document.getElementById('settingsPopupOverlay').style.display = 'flex';
                setTimeout(() => document.getElementById('settingsPopupOverlay').classList.add('show'), 10);
            }

            function hideSettingsPopup() {
                document.getElementById('settingsPopupOverlay').classList.remove('show');
                setTimeout(() => document.getElementById('settingsPopupOverlay').style.display = 'none', 300);
            }

            function testFeedback() {
                triggerScanFeedback();
                showToast("Test-Feedback ausgel√∂st.", "info");
            }
            
            function triggerScanFeedback() {
                if (appSettings.sound) {
                    feedbackAudio.currentTime = 0;
                    feedbackAudio.play().catch(e => console.log("Audio blockiert", e));
                }
                if (appSettings.vibrate && navigator.vibrate) {
                    // Vibration funktioniert auf Android meistens.
                    // Auf iOS (iPhone) wird dies vom Browser blockiert und geht nur bei User-Interaktion.
                    navigator.vibrate(200); 
                }
            }


            /* --- OFFLINE/SYNC LOGIK (IndexedDB Wrapper) --- */

            class OfflineDB {
                constructor() {
                    this.db = null;
                    this.dbName = 'InventarScannerDB';
                    this.dbVersion = 1;
                    this.objectStores = ['artikel', 'audit_log', 'users', 'outbox'];
                }

                open() {
                    return new Promise((resolve, reject) => {
                        if (this.db) {
                            return resolve();
                        }

                        const request = indexedDB.open(this.dbName, this.dbVersion);

                        request.onupgradeneeded = (event) => {
                            this.db = event.target.result;
                            this.objectStores.forEach(storeName => {
                                if (!this.db.objectStoreNames.contains(storeName)) {
                                    let options = { keyPath: 'barcode' };
                                    if (storeName === 'audit_log') {
                                        options = { keyPath: 'id', autoIncrement: true };
                                    } else if (storeName === 'users') {
                                        options = { keyPath: 'id' };
                                    } else if (storeName === 'outbox') {
                                        options = { keyPath: 'id', autoIncrement: true };
                                    }
                                    const store = this.db.createObjectStore(storeName, options);
                                    
                                    // Index f√ºr schnellere Suche
                                    if (storeName === 'artikel') {
                                        store.createIndex('name', 'name', { unique: false });
                                        store.createIndex('stellplatz', 'stellplatz', { unique: false });
                                    }
                                    if (storeName === 'users') {
                                        store.createIndex('email', 'email', { unique: true });
                                    }
                                }
                            });
                        };

                        request.onsuccess = (event) => {
                            this.db = event.target.result;
                            resolve();
                        };

                        request.onerror = (event) => {
                            console.error("IndexedDB Fehler:", event.target.error);
                            reject(event.target.error);
                        };
                    });
                }

                // CRUD Helfer
                async putData(storeName, data, keyPath = null) {
                    await this.open();
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction(storeName, 'readwrite');
                        const store = transaction.objectStore(storeName);
                        let request;
                        if (keyPath) {
                            // Wenn ein custom keyPath √ºbergeben wurde, z.B. created_at f√ºr Log
                            request = store.put(data, data[keyPath]);
                        } else {
                            request = store.put(data);
                        }
                        request.onsuccess = () => resolve();
                        request.onerror = (event) => reject(event.target.error);
                    });
                }

                async getData(storeName, key) {
                    await this.open();
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction(storeName, 'readonly');
                        const store = transaction.objectStore(storeName);
                        const request = store.get(key);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = (event) => reject(event.target.error);
                    });
                }

                async getAllData(storeName) {
                    await this.open();
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction(storeName, 'readonly');
                        const store = transaction.objectStore(storeName);
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = (event) => reject(event.target.error);
                    });
                }

                async deleteData(storeName, key) {
                    await this.open();
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction(storeName, 'readwrite');
                        const store = transaction.objectStore(storeName);
                        const request = store.delete(key);
                        request.onsuccess = () => resolve();
                        request.onerror = (event) => reject(event.target.error);
                    });
                }

                async clearData(storeName) {
                    await this.open();
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction(storeName, 'readwrite');
                        const store = transaction.objectStore(storeName);
                        const request = store.clear();
                        request.onsuccess = () => resolve();
                        request.onerror = (event) => reject(event.target.error);
                    });
                }

                async bulkInsertData(storeName, data) {
                    await this.open();
                    return new Promise((resolve, reject) => {
                        const transaction = this.db.transaction(storeName, 'readwrite');
                        const store = transaction.objectStore(storeName);
                        let count = 0;
                        data.forEach(item => {
                            store.put(item);
                            count++;
                        });
                        transaction.oncomplete = () => resolve(count);
                        transaction.onerror = (event) => reject(event.target.error);
                    });
                }

                // Spezifische Helfer f√ºr Offline-Artikel

                async upsertData(storeName, data) {
                    await this.open();
                    return this.putData(storeName, data);
                }

                async getArticleByBarcode(barcode) {
                    return this.getData('artikel', barcode);
                }

                async updateArticleScanCount(barcode) {
                    await this.open();
                    const article = await this.getData('artikel', barcode);
                    if (article) {
                        article.scans = (article.scans || 0) + 1;
                        await this.putData('artikel', article);
                        return article;
                    }
                    return null;
                }

                async updateArticleStellplatz(barcode, newStellplatz) {
                    await this.open();
                    const article = await this.getData('artikel', barcode);
                    if (article) {
                        article.stellplatz = newStellplatz;
                        await this.putData('artikel', article);
                        return article;
                    }
                    return null;
                }

                async deleteArticle(barcode) {
                    return this.deleteData('artikel', barcode);
                }

                async getAllArticles() {
                    return this.getAllData('artikel');
                }

                // Spezifische Helfer f√ºr Outbox
                async addToOutbox(operation) {
                    // Die Outbox verwendet autoIncrement, daher muss der KeyPath 'id' hier ignoriert werden.
                    return this.putData('outbox', operation);
                }

                async getOutboxOperations() {
                    return this.getAllData('outbox');
                }
                
                async getAllLogs() {
                    return this.getAllData('audit_log');
                }
                
                async getAllUsers() {
                    return this.getAllData('users');
                }
                
                // Aktualisiere Benutzerdaten lokal (Admin-Aktion)
                async upsertUser(user) {
                    return this.putData('users', user);
                }
                
                // Hole Benutzer nach ID
                async getUserById(id) {
                    return this.getData('users', id);
                }

            }


            function initOfflineSync() {
                if (!window['indexedDB']) {
                    console.warn("IndexedDB wird von diesem Browser nicht unterst√ºtzt. Offline-Modus nicht verf√ºgbar.");
                    return;
                }
                
                window.offlineDB = new OfflineDB();
                window.offlineDB.open()
                    .then(() => {
                        console.log("IndexedDB erfolgreich ge√∂ffnet.");
                        // Listener f√ºr Netzwerkverbindung hinzuf√ºgen
                        window.addEventListener('online', () => syncData(false));
                        syncData(true); // Initialer Sync beim Laden
                    })
                    .catch(e => console.error("IndexedDB konnte nicht ge√∂ffnet werden.", e));
            }

            // Funktion, die regelm√§√üig oder bei Wiederverbindung aufgerufen wird
            async function syncData(initialLoad = false) {
                if (!navigator.onLine || window.isSyncing || !window.offlineDB) return;

                window.isSyncing = true;
                document.getElementById('syncStatus').innerText = 'Synchronisiere...';
                console.log("Starte Offline-Synchronisation...");

                try {
                    const outboxOps = await window.offlineDB.getOutboxOperations();
                    const pendingCount = outboxOps.length;

                    if (pendingCount > 0) {
                        showToast(`Synchronisiere ${pendingCount} ausstehende Aktionen...`, 'info', 10000);
                        await processOutbox(outboxOps);
                    } else if (!initialLoad) {
                        showToast("Online. Keine ausstehenden Aktionen.", 'success', 3000);
                    }
                    
                    // Aktualisiere Artikel- und Log-Listen im Hintergrund (falls gerade angezeigt)
                    if (window.currentTabId === 'listTab') loadArticleList(document.getElementById('articleSearchInput').value);
                    if (window.currentTabId === 'logTab' && window.currentUserRole === 'admin') loadAdminLog(document.getElementById('logSearchInput').value);
                    if (window.currentTabId === 'usersTab' && window.currentUserRole === 'admin') loadUserList(document.getElementById('userSearchInput').value);


                } catch (e) {
                    console.error("Fehler bei der Synchronisation:", e);
                    if (e.message.includes("Netzwerkfehler")) {
                         document.getElementById('syncStatus').innerText = 'Offline/Fehler';
                         showToast("Synchronisation abgebrochen (Netzwerkfehler).", 'error', 5000);
                    }
                } finally {
                    window.isSyncing = false;
                    if (navigator.onLine) {
                        document.getElementById('syncStatus').innerText = 'Online';
                    } else {
                        document.getElementById('syncStatus').innerText = 'Offline';
                    }
                }
            }


            // Verarbeite Outbox-Eintr√§ge sequenziell
            async function processOutbox(outboxOps) {
                for (const op of outboxOps) {
                    try {
                        let response;
                        let error = null;

                        // 1. F√ºhre die Supabase-Operation aus
                        if (op.type === 'INSERT' && op.table === 'artikel') {
                            response = await window.appSupabaseClient
                                .from('artikel')
                                .insert([op.payload]);
                            error = response.error;
                            // Nach erfolgreichem Insert, den Artikel lokal aktualisieren, falls er noch im IndexedDB ist.
                            // Wichtig: Der Insert-Flow in saveArticle() behandelt bereits den lokalen Update/Insert. 
                            // Der hier synchronisierte Insert ist nur f√ºr Offline-Aktionen relevant.

                        } else if (op.type === 'UPDATE' && op.table === 'artikel') {
                            response = await window.appSupabaseClient
                                .from('artikel')
                                .update(op.payload)
                                .eq('barcode', op.key);
                            error = response.error;

                        } else if (op.type === 'DELETE' && op.table === 'artikel') {
                            response = await window.appSupabaseClient
                                .from('artikel')
                                .delete()
                                .eq('barcode', op.key);
                            error = response.error;
                        
                        } else if (op.type === 'INSERT' && op.table === 'audit_log') {
                            // Log-Eintr√§ge werden einfach als neue Eintr√§ge eingef√ºgt
                            response = await window.appSupabaseClient
                                .from('audit_log')
                                .insert([op.payload]);
                            error = response.error;
                            // Lokal nicht l√∂schen, da Audit-Logs keinen unique key haben (id ist lokal generiert)

                        } else if (op.type === 'UPDATE' && op.table === 'user_roles') {
                            // Admin-User-Update
                            response = await window.appSupabaseClient
                                .from('user_roles')
                                .update(op.payload)
                                .eq('id', op.key);
                            error = response.error;
                        }

                        if (error) {
                            if (error.code === 'PGRST116' || error.code === '23505') { // Item nicht gefunden oder Unique Constraint verletzt (Fehlerhafte lokale Daten)
                                // √úberspringe die Operation und l√∂sche sie aus der Outbox
                                console.warn(`Outbox-Fehler: Ung√ºltiger Eintrag (${op.type} ${op.table} f√ºr ${op.key}): ${error.message}. Wird gel√∂scht.`);
                                showToast(`Fehler beim Synchronisieren von ${op.type} (${op.table}). Aktion √ºbersprungen.`, 'error', 7000);
                            } else {
                                // Netzwerkfehler oder Timeout: Abbrechen und warten auf n√§chste Sync
                                throw new Error("Netzwerkfehler beim Push.");
                            }
                        }
                        
                        // 2. Erfolg: Operation aus der Outbox l√∂schen
                        await window.offlineDB.deleteData('outbox', op.id); 
                        console.log(`Outbox-Aktion erfolgreich synchronisiert und gel√∂scht: ${op.type} ${op.table}`);

                    } catch (e) {
                        if (e.message.includes("Netzwerkfehler")) {
                            // Breche ab, um beim n√§chsten Sync erneut zu versuchen
                            return;
                        }
                        // Bei anderen Fehlern wird mit der n√§chsten Operation fortgefahren, 
                        // aber die fehlerhafte Operation nicht gel√∂scht (sollte im try-Block behandelt werden).
                    }
                }
            }


            /* --- ALLGEMEINE UI/HELFER LOGIK --- */

            function switchView(viewId) {
                document.querySelectorAll('.app-view-container').forEach(view => {
                    view.classList.remove('active');
                });
                document.getElementById(viewId).classList.add('active');
                
                // Wenn wir zur App-Ansicht wechseln, den Scanner neu starten, falls aktiv
                if (viewId === 'appView' && window.currentTabId === 'scannerTab') {
                     // Camera Start wird nur bei User-Click ausgel√∂st.
                } else if (viewId === 'appView') {
                    // Falls nicht Scanner-Tab, die Listen laden
                    if (window.currentTabId === 'listTab') loadArticleList(document.getElementById('articleSearchInput').value);
                    if (window.currentTabId === 'logTab' && window.currentUserRole === 'admin') loadAdminLog(document.getElementById('logSearchInput').value);
                    if (window.currentTabId === 'usersTab' && window.currentUserRole === 'admin') loadUserList(document.getElementById('userSearchInput').value);

                } else if (viewId === 'loginView') {
                    // Wenn wir zum Login wechseln, den Scanner stoppen
                    stopScanner();
                }
            }
            
            function changeTab(tabId) {
                // Wenn wir den Scanner verlassen, diesen stoppen
                if (window.currentTabId === 'scannerTab' && tabId !== 'scannerTab') {
                    stopScanner();
                } else if (tabId === 'scannerTab') {
                    // Bei Wechsel auf Scanner-Tab, nur die Pre-Scan-Ansicht anzeigen.
                    // Der Start der Kamera erfolgt durch Klick auf "SCAN STARTEN".
                    document.getElementById("preScan").style.display = "flex";
                    document.getElementById("scanFrame").style.display = "none";
                }
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`.nav-item[data-tab="${tabId}"]`).classList.add('active');
                
                window.currentTabId = tabId;
                
                // Header-Titel anpassen
                const tabTitles = {
                    'scannerTab': 'Scanner',
                    'listTab': 'Inventar',
                    'logTab': 'Audit Log',
                    'usersTab': 'Benutzer'
                };
                document.getElementById('headerTitle').innerText = tabTitles[tabId] || 'Inventar Scanner Pro';

                // Bei Listen-Tabs die Daten laden
                if (tabId === 'listTab') {
                    loadArticleList(document.getElementById('articleSearchInput').value);
                } else if (tabId === 'logTab') {
                    loadAdminLog(document.getElementById('logSearchInput').value);
                } else if (tabId === 'usersTab') {
                    loadUserList(document.getElementById('userSearchInput').value);
                }
            }
            
            function showToast(message, type = 'info', duration = 3000) {
                const toastContainer = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.classList.add('toast', type);
                
                let icon = '';
                if (type === 'success') icon = '‚úÖ';
                else if (type === 'error') icon = '‚ùå';
                else if (type === 'info') icon = '‚ÑπÔ∏è';
                else if (type === 'warning') icon = '‚ö†Ô∏è';
                
                toast.innerHTML = `<span class="toast-icon">${icon}</span> ${message}`;
                toastContainer.appendChild(toast);

                // Animation starten
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);

                // Toast nach 'duration' entfernen
                setTimeout(() => {
                    toast.classList.remove('show');
                    // Warte, bis die Transition beendet ist, bevor das Element entfernt wird
                    toast.addEventListener('transitionend', () => {
                        toast.remove();
                    });
                }, duration);
            }
            
            /* --- AUTH/LOGIN LOGIK --- */
            
            var isRegisterMode = false;
            var isPinMode = false;
            var currentPin = "";
            const correctPin = "1234"; // Dummy-PIN f√ºr den Test

            // Erstellt das Tastenfeld dynamisch (vereinfacht)
            function createKeypad() {
                const keypad = document.getElementById('keypad');
                keypad.innerHTML = '';
                const keys = [
                    ['1', '2', '3'],
                    ['4', '5', '6'],
                    ['7', '8', '9'],
                    ['', '0', '‚å´']
                ];
                
                const container = document.createElement('div');
                container.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 320px; margin: 20px auto;';
                
                keys.forEach(row => {
                    row.forEach(key => {
                        const button = document.createElement('button');
                        button.innerText = key;
                        button.classList.add('keypad-button');
                        button.onclick = () => handlePinInput(key);
                        button.style.cssText = 'padding: 15px; font-size: 1.5rem; background: var(--color-bg-card); color: white; border: none; border-radius: 10px; cursor: pointer; transition: background 0.1s;';
                        if (key === '‚å´') {
                            button.style.backgroundColor = 'var(--color-error-red)';
                        } else if (key === '') {
                             button.disabled = true;
                             button.style.visibility = 'hidden';
                        }
                        container.appendChild(button);
                    });
                });
                keypad.appendChild(container);

                const pinSubmit = document.createElement('button');
                pinSubmit.id = 'pinSubmitButton';
                pinSubmit.innerText = 'Login mit PIN';
                pinSubmit.disabled = true;
                pinSubmit.style.cssText = 'width: 100%; padding: 12px; font-size: 1rem; font-weight: 600; background: var(--color-accent-blue); color: white; border: none; border-radius: 10px; cursor: pointer; transition: background 0.2s; max-width: 320px; margin: 10px auto; display: block;';
                pinSubmit.onclick = handlePinSubmit;
                keypad.appendChild(pinSubmit);
            }
            
            // Zeigt die PIN-Eingabepunkte an
            function updatePinIndicators() {
                const indicators = document.getElementById('pinIndicators');
                indicators.innerHTML = '';
                for (let i = 0; i < 4; i++) {
                    const dot = document.createElement('span');
                    dot.style.cssText = `display: inline-block; width: 12px; height: 12px; border-radius: 50%; border: 1px solid white; margin: 0 5px; background-color: ${i < currentPin.length ? 'white' : 'transparent'}; transition: background-color 0.1s;`;
                    indicators.appendChild(dot);
                }
                
                document.getElementById('pinSubmitButton').disabled = currentPin.length !== 4;
            }

            // Verarbeitet die PIN-Eingabe
            function handlePinInput(key) {
                if (key === '‚å´') {
                    currentPin = currentPin.slice(0, -1);
                } else if (key.match(/[0-9]/) && currentPin.length < 4) {
                    currentPin += key;
                }
                updatePinIndicators();
                document.getElementById("authError").innerText = ""; // Fehler l√∂schen
            }
            
            // Sendet die PIN zur √úberpr√ºfung (Dummy-Funktion)
            async function handlePinSubmit() {
                if (currentPin.length !== 4) return;
                
                document.getElementById("authError").innerText = "";
                const submitButton = document.getElementById('pinSubmitButton');
                submitButton.disabled = true;
                submitButton.innerText = "√úberpr√ºfen...";

                // Dummy-PIN-Check (ersetzen Sie dies durch Ihre tats√§chliche Auth-Logik)
                await new Promise(resolve => setTimeout(resolve, 1000)); 
                
                if (currentPin === correctPin) {
                    // Hier m√ºsste die eigentliche Benutzeranmeldung/Rollenabfrage erfolgen,
                    // da die PIN normalerweise einem Benutzer zugeordnet ist.
                    // F√ºr dieses Frontend verwenden wir einen Dummy-Login-Erfolg.
                    
                    // Annahme: PIN 1234 ist Admin-PIN
                    if (currentPin === "1234") {
                         // Ein Dummy-Admin-User wird erstellt, um den Login-Flow zu simulieren
                         const dummyUser = { id: 'pin_user_1234', email: 'admin@pin.de' };
                         await handleLoginSuccess(dummyUser.id, dummyUser.email);
                    } else {
                        // Ein Dummy-Standard-User
                         const dummyUser = { id: 'pin_user_5678', email: 'user@pin.de' };
                         await handleLoginSuccess(dummyUser.id, dummyUser.email);
                    }
                    
                } else {
                    document.getElementById("authError").innerText = "Falsche PIN.";
                    showToast("Login fehlgeschlagen.", 'error', 5000);
                    currentPin = "";
                    updatePinIndicators();
                    submitButton.disabled = false;
                    submitButton.innerText = "Login mit PIN";
                }
            }

            // Wechselt zwischen Login/Registrieren und PIN-Modus
            function toggleAuthMode(mode) {
                const authForm = document.getElementById('authForm');
                const keypad = document.getElementById('keypad');
                const pinIndicators = document.getElementById('pinIndicators');
                const authTitle = document.getElementById('authTitle');
                const registerToggle = document.getElementById('registerToggle');
                const pinModeToggle = document.getElementById('pinModeToggle');

                if (mode === 'pin') {
                    isPinMode = true;
                    isRegisterMode = false;
                    authForm.style.display = 'none';
                    keypad.style.display = 'block';
                    pinIndicators.style.display = 'flex';
                    authTitle.innerText = "PIN-Login";
                    registerToggle.style.display = 'none';
                    pinModeToggle.innerText = 'E-Mail-Login verwenden';
                    pinModeToggle.onclick = () => toggleAuthMode('email');
                    createKeypad();
                    updatePinIndicators();
                    document.getElementById("authError").innerText = "";
                } else {
                    isPinMode = false;
                    currentPin = "";
                    
                    if (mode === 'register') {
                        isRegisterMode = !isRegisterMode;
                    }

                    authForm.style.display = 'block';
                    keypad.style.display = 'none';
                    pinIndicators.style.display = 'none';

                    if (isRegisterMode) {
                        authTitle.innerText = "Registrieren";
                        registerToggle.innerText = "Bereits registriert? Anmelden";
                        document.getElementById('authSubmitButton').innerText = "Registrieren";
                    } else {
                        authTitle.innerText = "Anmelden";
                        registerToggle.innerText = "Noch kein Konto? Registrieren";
                        document.getElementById('authSubmitButton').innerText = "Anmelden";
                    }
                    
                    pinModeToggle.innerText = 'PIN-Login verwenden';
                    pinModeToggle.onclick = () => toggleAuthMode('pin');
                    pinModeToggle.style.display = 'block'; // Zeige PIN-Option im E-Mail-Modus
                    document.getElementById("authError").innerText = "";
                }
            }
            
            // Pr√ºft den Login-Status beim App-Start
            async function checkLogin() {
                document.getElementById('loadingAuth').style.display = 'block';
                document.getElementById('authForm').style.display = 'none';
                document.getElementById('pinModeToggle').style.display = 'none';

                try {
                    const { data: { user }, error } = await window.appSupabaseClient.auth.getUser();

                    if (user) {
                        await handleLoginSuccess(user.id, user.email);
                    } else {
                        throw error;
                    }
                } catch (error) {
                    // Nicht eingeloggt oder Fehler (z.B. Session abgelaufen)
                    console.log("Nicht eingeloggt, zeige Login-Formular.");
                    toggleAuthMode('email'); // Standardm√§√üig E-Mail/Passwort anzeigen
                } finally {
                    document.getElementById('loadingAuth').style.display = 'none';
                }
            }

            // Verarbeitet E-Mail/Passwort Login und Registrierung
            async function handleAuthSubmit() {
                const email = document.getElementById('authEmail').value;
                const password = document.getElementById('authPassword').value;
                const submitButton = document.getElementById('authSubmitButton');
                
                document.getElementById("authError").innerText = "";

                if (!email || !password) {
                    document.getElementById("authError").innerText = "Bitte E-Mail und Passwort eingeben.";
                    return;
                }
                
                submitButton.disabled = true;
                submitButton.innerText = "L√§dt...";

                try {
                    if (isRegisterMode) {
                        const { error } = await window.appSupabaseClient.auth.signUp({
                            email: email,
                            password: password,
                        });
                        
                        if (error) throw error;
                        
                        showToast("Registrierung erfolgreich. Bitte E-Mail best√§tigen.", 'info', 7000);
                        toggleAuthMode(); // Zur√ºck zum Login
                        
                    } else {
                        const { data, error } = await window.appSupabaseClient.auth.signInWithPassword({
                            email: email,
                            password: password,
                        });
                        
                        if (error) throw error;
                        
                        await handleLoginSuccess(data.user.id, data.user.email);
                    }
                } catch (error) {
                    let errorMessage = "Unbekannter Fehler bei der Authentifizierung.";
                    if (error.message) {
                        errorMessage = error.message;
                    } else if (error.status === 400 && error.message.includes('Email not confirmed')) {
                        errorMessage = "E-Mail noch nicht best√§tigt. Bitte √ºberpr√ºfen Sie Ihr Postfach.";
                    }
                    document.getElementById("authError").innerText = errorMessage;
                    showToast("Login fehlgeschlagen.", 'error', 5000);
                }
                
                submitButton.disabled = false;
                submitButton.innerText = (isRegisterMode ? "Registrieren" : "Anmelden");
            }

            async function handleLoginSuccess(userId, email) {
                currentUserId = userId;
                let userRole = 'user';
                let isBlocked = false;
                
                // Hole Benutzerrolle und Status aus der user_roles Tabelle
                const { data, error } = await window.appSupabaseClient
                    .from('user_roles')
                    .select('role, is_blocked, notes')
                    .eq('id', userId)
                    .single();

                if (data) {
                    userRole = data.role || 'user';
                    isBlocked = data.is_blocked || false;
                    // Lokal speichern/aktualisieren
                    await window.offlineDB.upsertUser({ id: userId, email: email, role: userRole, is_blocked: isBlocked, notes: data.notes || '' });
                } else {
                    // Wenn kein Eintrag gefunden (z.B. neuer User), lege ihn mit Standardrolle an
                    const { error: insertError } = await window.appSupabaseClient
                        .from('user_roles')
                        .insert([{ id: userId, email: email, role: 'user', is_blocked: false }]);
                        
                    if (!insertError) {
                        await window.offlineDB.upsertUser({ id: userId, email: email, role: 'user', is_blocked: false, notes: '' });
                    }
                    // userRole bleibt 'user' und isBlocked bleibt false
                }
                
                if (isBlocked) {
                    await window.appSupabaseClient.auth.signOut();
                    document.getElementById("authError").innerText = "Ihr Konto ist gesperrt. Bitte wenden Sie sich an den Administrator.";
                    showToast("Login fehlgeschlagen: Konto gesperrt.", 'error', 7000);
                    return;
                }
                
                window.currentUserRole = userRole;
                document.getElementById("userDisplay").innerText = `Angemeldet als: ${email} (${userRole})`;
                showToast("Erfolgreich angemeldet.", 'success', 3000);
                
                // Tabs basierend auf der Rolle anzeigen
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = (userRole === 'admin') ? 'flex' : 'none';
                });

                // Auf die App-Ansicht wechseln und den initialen Tab laden
                switchView('appView');
                changeTab(window.currentTabId);
            }
            
            async function logout() {
                const { error } = await window.appSupabaseClient.auth.signOut();
                if (error) {
                    showToast("Fehler beim Abmelden.", 'error');
                    console.error("Logout Fehler:", error);
                }
                switchView('loginView');
                window.currentUserRole = null;
                showToast("Erfolgreich abgemeldet.", 'info');
                lastCode = "";
                document.getElementById("userDisplay").innerText = "";
                document.getElementById("authEmail").value = "";
                document.getElementById("authPassword").value = "";
                document.getElementById("authError").innerText = "";
            }


            /* --- SCANNER LOGIK --- */

            async function activateCamera() {
                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode("reader");
                }

                document.getElementById("preScan").style.display = "none";
                document.getElementById("scanFrame").style.display = "block";
                hideResultCard();
                
                // Versuche, die hintere Kamera zu finden und zu verwenden
                const cameraIdOrConstraints = { facingMode: "environment" };
                
                html5QrCode.start(
                    cameraIdOrConstraints, 
                    {
                        fps: 10, // Frames per second
                        qrbox: { width: 250, height: 250 } // Scan-Fenster-Gr√∂√üe
                    }, 
                    onScanSuccess, 
                    onScanError
                )
                .catch(err => {
                    document.getElementById("preScan").style.display = "flex";
                    document.getElementById("scanFrame").style.display = "none";
                    showToast("Kamera Fehler: Zugriff verweigert oder Ger√§t nicht gefunden.", 'error', 4000);
                    console.error("Scanner Start Fehler:", err);
                });
            }

            async function stopScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    try {
                        await html5QrCode.stop();
                        document.getElementById("preScan").style.display = "flex";
                        document.getElementById("scanFrame").style.display = "none";
                        hideResultCard();
                    } catch (err) {
                        console.error("Scanner Stop Fehler:", err);
                    }
                }
            }

            function onScanError(errorMessage) {
                // Nur anzeigen, wenn kein Code erkannt wird.
                // console.log("Scan Fehler:", errorMessage);
            }

            async function onScanSuccess(decodedText, decodedResult) {
                if (decodedText === lastCode) {
                    return; // Code wurde bereits verarbeitet, um Doppelerkennung zu verhindern
                }
                
                lastCode = decodedText;
                triggerScanFeedback();
                currentScannedBarcode = decodedText;
                
                await html5QrCode.pause();
                document.getElementById("scanFrame").style.display = "none";
                
                await searchArticle(decodedText);
            }

            async function searchArticle(code) {
                let data = null;
                let error = null;
                let isOffline = false;
                
                try {
                    // 1. Online-Versuch
                    const response = await window.appSupabaseClient
                        .from('artikel')
                        .select('*')
                        .eq('barcode', code)
                        .single();

                    data = response.data;
                    error = response.error;
                    
                    if (data) {
                        // Bei Erfolg: Lokale Kopie aktualisieren (upsert)
                        await window.offlineDB.upsertData('artikel', data);
                    }
                    
                } catch (e) {
                    // 2. Offline-Fallback
                    isOffline = true;
                    showToast("Netzwerkfehler. Suche in lokalen Daten...", 'info');
                    
                    try {
                        data = await window.offlineDB.getArticleByBarcode(code);
                        error = null;
                        if (!data) error = { code: 'PGRST116', message: 'Not found in local DB' }; 
                    } catch (dbError) {
                        console.error("Lokaler DB Fehler:", dbError);
                        error = { code: 'DB_ERROR', message: 'Local DB access failed' };
                    }
                }

                if (data) {
                    const content = `
                        <p><strong>Name:</strong> ${data.name}</p>
                        <p><strong>Stellplatz:</strong> ${data.stellplatz}</p>
                        <p><strong>Lagertyp:</strong> ${data.blocklager ? 'Blocklager' : 'Regal / Fach'}</p>
                        <p><strong>Anzahl Scans:</strong> <span id="scanCountDisplay">${data.scans || 1}</span></p>
                    `;
                    showResultCard("Artikel gefunden!", content, '‚úÖ');
                    
                    // Button f√ºr Registrieren/Bearbeiten ausblenden/anzeigen
                    if (window.currentUserRole === 'admin') {
                         document.getElementById("registerButton").style.display = "block";
                         document.getElementById("registerButton").innerText = "Bearbeiten (Admin)";
                         document.getElementById("registerButton").onclick = () => showAdminEditPopup(data);
                    } else {
                         document.getElementById("registerButton").style.display = "none";
                    }

                    // Scanz√§hler erh√∂hen
                    let newScans = (data.scans || 0) + 1;
                    if (!isOffline) {
                        // Online: Update auf Supabase und lokal
                        const { error: updateError } = await window.appSupabaseClient
                            .from('artikel')
                            .update({ scans: newScans })
                            .eq('barcode', code);
                            
                        if (updateError) {
                            // Wenn Online-Update fehlschl√§gt, lokal und in Outbox speichern
                             await window.offlineDB.updateArticleScanCount(code);
                             await window.offlineDB.addToOutbox({
                                type: 'UPDATE',
                                table: 'artikel',
                                key: code,
                                payload: { scans: newScans },
                                timestamp: new Date().toISOString()
                            });
                             showToast("Scan-Z√§hler lokal erh√∂ht. Synchronisierung steht aus.", 'info');
                             newScans = (await window.offlineDB.getArticleByBarcode(code)).scans; // Aktualisiere Anzeige aus lokaler DB
                        } else {
                            // Erfolgreich online
                            await window.offlineDB.updateArticleScanCount(code);
                            showToast("Scan erfolgreich gespeichert.", 'success');
                        }
                    } else {
                         // Offline: Lokal erh√∂hen und Outbox-Eintrag erstellen
                        await window.offlineDB.updateArticleScanCount(code);
                        await window.offlineDB.addToOutbox({
                            type: 'UPDATE',
                            table: 'artikel',
                            key: code,
                            payload: { scans: newScans },
                            timestamp: new Date().toISOString()
                        });
                        showToast("Scan gespeichert. Wird synchronisiert, sobald online.", 'info');
                    }
                    
                    // Scanz√§hler in der Anzeige aktualisieren (aus dem neuesten Wert)
                    document.getElementById("scanCountDisplay").innerText = newScans;

                } else if (error && error.code === 'PGRST116') {
                    // Artikel nicht gefunden (404)
                    const content = `<p>Der Barcode <strong>${code}</strong> wurde noch nicht registriert.</p>`;
                    showResultCard("Unbekannter Artikel", content, '‚ùì');
                    
                    if (window.currentUserRole === 'admin') {
                        document.getElementById("registerButton").style.display = "block";
                        document.getElementById("registerButton").innerText = "Registrieren";
                        document.getElementById("registerButton").onclick = showPopup;
                    } else {
                        document.getElementById("registerButton").style.display = "none";
                    }

                    if (isOffline) {
                        showToast("Artikel nicht einmal lokal gefunden.", 'error');
                    }
                } else {
                    // Allgemeiner Fehler
                    console.error("Fehler bei der Artikelsuche:", error);
                    showResultCard("Fehler", `<p>Es ist ein Fehler aufgetreten: ${error ? error.message : 'Netzwerkfehler'}</p>`, '‚ùå');
                    document.getElementById("registerButton").style.display = "none";
                }
            }


            /* --- ARTIKEL SPEICHERN LOGIK (F√úR NEUE ARTIKEL) --- */

            function showPopup() {
                if (window.currentUserRole !== 'admin') {
                    showToast("Nur Administratoren d√ºrfen neue Artikel registrieren.", 'error');
                    return;
                }
                
                document.getElementById('popupBarcode').value = currentScannedBarcode;
                document.getElementById('popupOverlay').classList.add('show');
            }

            function hidePopup() {
                document.getElementById('popupOverlay').classList.remove('show');
                document.getElementById('popupBaseName').value = '';
                document.getElementById('popupSize').value = '';
                document.getElementById('popupPlatz').value = '';
                document.getElementById('popupBlocklager').value = 'false';
                
                // Wieder Scanner aufnehmen, falls er pausiert ist
                if (html5QrCode && html5QrCode.isScanning) {
                     html5QrCode.resume();
                }
            }

            async function saveArticle() {
                const barcode = document.getElementById('popupBarcode').value.trim();
                const baseName = document.getElementById('popupBaseName').value.trim();
                const sizeValue = document.getElementById('popupSize').value.trim();
                const platz = document.getElementById('popupPlatz').value.trim();
                const block = document.getElementById('popupBlocklager').value === 'true';

                let name = baseName;
                if (sizeValue) {
                    const sizeDisplay = sizeValue.replace('.', ',');
                    name += ` (${sizeDisplay} L)`;
                }

                const lagertyp = block ? 'Blocklager' : 'Regal/Fach';

                if (!baseName || !platz) {
                    showToast("Bitte Basis-Name und Stellplatz ausf√ºllen.", "error");
                    return;
                }

                const newArticle = {
                    barcode: barcode,
                    name: name,
                    stellplatz: platz,
                    blocklager: block,
                    scans: 1,
                    created_at: new Date().toISOString()
                };

                let success = false;
                let isOffline = !navigator.onLine;

                try {
                    const { error } = await window.appSupabaseClient
                        .from("artikel")
                        .insert([newArticle]);

                    if (error) {
                         if (error.message.includes('Failed to fetch')) {
                            throw new Error("Offline");
                        } else if (error.code === '23505') {
                            showToast(`FEHLER: Artikel mit Barcode ${barcode} existiert bereits.`, "error");
                            return;
                        }
                        showToast(`FEHLER beim Speichern des Artikels.`, "error");
                        console.error("Speicherfehler:", error);
                    } else {
                        success = true;
                    }
                } catch (e) {
                    if (e.message === "Offline" || !navigator.onLine) {
                        isOffline = true;
                        // Artikel lokal speichern und Outbox-Eintrag erstellen
                        await window.offlineDB.upsertData('artikel', newArticle);
                        await window.offlineDB.addToOutbox({
                            type: 'INSERT',
                            table: 'artikel',
                            key: barcode,
                            payload: newArticle,
                            timestamp: new Date().toISOString()
                        });
                        success = true;
                    } else {
                        console.error("Speicherfehler:", e);
                    }
                }

                if (success) {
                    const statusMessage = isOffline 
                        ? `Artikel lokal registriert. Wird synchronisiert, sobald online.` 
                        : `Artikel "${name}" erfolgreich registriert.`;
                    showToast(statusMessage, isOffline ? "info" : "success");
                    
                    logAdminAction('ARTICLE_CREATED', `Neuer Artikel "${name}" (Barcode: ${barcode}) an Platz ${platz} registriert.`);

                    hidePopup();
                    hideResultCard();
                    // Wenn der Scanner pausiert ist, starte ihn wieder, damit weitergescannt werden kann
                    if (html5QrCode && html5QrCode.isScanning) {
                         html5QrCode.resume();
                    }
                }
            }


            /* --- ARTIKEL BEARBEITEN LOGIK (ADMIN) --- */
            
            function showAdminEditPopup(article) {
                if (window.currentUserRole !== 'admin') {
                    showToast("Nur Administratoren d√ºrfen Artikel Bearbeiten.", 'error');
                    return;
                }
                
                window.articleToEdit = article;
                document.getElementById('adminEditName').value = article.name;
                document.getElementById('adminEditBarcode').value = article.barcode;
                document.getElementById('adminEditPlatz').value = article.stellplatz;
                
                document.getElementById('adminEditPopupOverlay').style.display = "flex";
                setTimeout(() => document.getElementById('adminEditPopupOverlay').classList.add('show'), 10);
            }

            function hideAdminEditPopup() {
                document.getElementById('adminEditPopupOverlay').classList.remove('show');
                setTimeout(() => {
                    document.getElementById('adminEditPopupOverlay').style.display = "none";
                    window.articleToEdit = null;
                }, 300);
            }

            async function saveAdminEdit() {
                if (window.currentUserRole !== 'admin' || !window.articleToEdit) return;

                const oldPlatz = window.articleToEdit.stellplatz;
                const newPlatz = document.getElementById('adminEditPlatz').value.trim();
                const barcode = window.articleToEdit.barcode;

                if (!newPlatz) {
                    showToast("Der Stellplatz darf nicht leer sein.", "error");
                    return;
                }
                
                if (newPlatz === oldPlatz) {
                    showToast("Stellplatz wurde nicht ge√§ndert.", "info");
                    hideAdminEditPopup();
                    return;
                }

                const updatePayload = {
                    stellplatz: newPlatz
                };

                let success = false;
                let isOffline = !navigator.onLine;

                try {
                    const { error } = await window.appSupabaseClient
                        .from("artikel")
                        .update(updatePayload)
                        .eq("barcode", barcode);

                    if (error) {
                        if (error.message.includes('Failed to fetch')) {
                            throw new Error("Offline");
                        }
                        showToast(`FEHLER beim Speichern des Stellplatzes.`, "error");
                        console.error("Speicherfehler:", error);
                    } else {
                        success = true;
                    }
                } catch (e) {
                    if (e.message === "Offline" || !navigator.onLine) {
                        isOffline = true;
                        // Lokale Daten aktualisieren und Outbox-Eintrag erstellen
                        await window.offlineDB.updateArticleStellplatz(barcode, newPlatz);
                        await window.offlineDB.addToOutbox({
                            type: 'UPDATE',
                            table: 'artikel',
                            key: barcode,
                            payload: updatePayload,
                            timestamp: new Date().toISOString()
                        });
                        success = true;
                    } else {
                        console.error("Speicherfehler:", e);
                    }
                }

                if (success) {
                    const statusMessage = isOffline 
                        ? `Stellplatz lokal aktualisiert. Wird synchronisiert, sobald online.` 
                        : `Stellplatz erfolgreich von ${oldPlatz} auf ${newPlatz} ge√§ndert.`;
                    showToast(statusMessage, isOffline ? "info" : "success");
                    
                    logAdminAction('STELLPLATZ_UPDATED', `Stellplatz von "${window.articleToEdit.name}" (Barcode: ${barcode}) von ${oldPlatz} auf ${newPlatz} ge√§ndert.`);
                    
                    // Lokales Objekt aktualisieren
                    window.articleToEdit.stellplatz = newPlatz;

                    // Listenansicht aktualisieren, falls aktiv
                    if (window.currentTabId === 'listTab') {
                        loadArticleList(document.getElementById('articleSearchInput').value);
                    }
                    
                    hideAdminEditPopup();
                }
            }


            // L√∂schen-Flow
            function deleteArticle() {
                if (!window.articleToEdit || window.currentUserRole !== 'admin') return;

                const articleName = window.articleToEdit.name;
                const barcode = window.articleToEdit.barcode;
                
                document.getElementById('deleteConfirmTitle').innerText = 'Artikel unwiderruflich l√∂schen';
                document.getElementById('deleteConfirmMessage').innerHTML = `Sind Sie sicher, dass Sie den Artikel<br><strong>"${articleName}"</strong> (Barcode: ${barcode})<br>unwiderruflich l√∂schen m√∂chten?`;

                hideAdminEditPopup(); // Schlie√üe das Bearbeitungs-Popup
                document.getElementById('deleteConfirmPopupOverlay').style.display = "flex";
                setTimeout(() => document.getElementById('deleteConfirmPopupOverlay').classList.add('show'), 10);
            }

            function hideDeleteConfirmPopup() {
                document.getElementById('deleteConfirmPopupOverlay').classList.remove('show');
                setTimeout(() => {
                    document.getElementById('deleteConfirmPopupOverlay').style.display = "none";
                    // articleToEdit wird erst nach erfolgreichem L√∂schen auf null gesetzt
                }, 300);
            }

            async function confirmDeleteArticle() {
                if (!window.articleToEdit || window.currentUserRole !== 'admin') return;
                
                const barcode = window.articleToEdit.barcode;
                const articleName = window.articleToEdit.name;

                let success = false;
                let isOffline = !navigator.onLine;

                try {
                    const { error } = await window.appSupabaseClient
                        .from("artikel")
                        .delete()
                        .eq("barcode", barcode);
                        
                    if (error) {
                        if (error.message.includes('Failed to fetch')) {
                            throw new Error("Offline");
                        }
                        showToast(`FEHLER beim L√∂schen des Artikels.`, "error");
                        console.error("L√∂schfehler:", error);
                    } else {
                        success = true;
                    }
                } catch (e) {
                    if (e.message === "Offline" || !navigator.onLine) {
                        isOffline = true;
                        // Lokale Daten l√∂schen und Outbox-Eintrag erstellen
                        await window.offlineDB.deleteArticle(barcode);
                        await window.offlineDB.addToOutbox({
                            type: 'DELETE',
                            table: 'artikel',
                            key: barcode,
                            payload: { barcode: barcode }, // Payload f√ºr die Synchronisation
                            timestamp: new Date().toISOString()
                        });
                        success = true;
                    } else {
                        console.error("L√∂schfehler:", e);
                    }
                }

                if (success) {
                    const statusMessage = isOffline 
                        ? `Artikel lokal gel√∂scht. L√∂schvorgang wird bei Verbindung synchronisiert.` 
                        : `Artikel "${articleName}" wurde erfolgreich gel√∂scht.`;
                    showToast(statusMessage, isOffline ? "info" : "success");
                    
                    logAdminAction('ARTICLE_DELETED', `Artikel "${articleName}" (Barcode: ${barcode}) unwiderruflich gel√∂scht.`);
                    
                    window.articleToEdit = null;
                    hideDeleteConfirmPopup();
                    
                    // Listenansicht aktualisieren
                    loadArticleList(document.getElementById('articleSearchInput').value);
                }
            }


            /* --- RESULT CARD LOGIK --- */

            function showResultCard(title, contentHTML, icon) {
                document.getElementById('cardTitleText').innerText = title;
                document.getElementById('cardStatusIcon').innerText = icon;
                document.getElementById('cardContent').innerHTML = contentHTML;
                document.getElementById('result-card').classList.add('active');
            }

            function hideResultCard() {
                document.getElementById('result-card').classList.remove('active');
                lastCode = "";
                document.getElementById("scanFrame").style.display = "block";
                
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.resume();
                }
            }


            /* --- ARTIKEL LISTE LOGIK --- */

            async function loadArticleList(searchTerm = '') {
                const articleListContainer = document.getElementById('articleList');
                articleListContainer.innerHTML = '<li style="border-left: 5px solid rgba(255, 255, 255, 0.1); background: none; text-align: center; color: rgba(255, 255, 255, 0.5); padding: 10px;">Lade Artikel...</li>';
                
                let data = [];
                let isOffline = false;

                try {
                    // 1. Online-Versuch
                    let query = window.appSupabaseClient
                        .from('artikel')
                        .select('*')
                        .order('name', { ascending: true });
                        
                    if (searchTerm) {
                        const search = `%${searchTerm.toLowerCase()}%`;
                        query = query.or(`name.ilike.${search},barcode.ilike.${search},stellplatz.ilike.${search}`);
                    }

                    const { data: articles, error } = await query;
                    
                    if (error) {
                         if (error.message.includes('Failed to fetch')) {
                            throw new Error("Offline");
                        }
                        throw error;
                    }
                    
                    data = articles;
                    
                    // Bei Erfolg: Lokalen Cache aktualisieren
                    await window.offlineDB.clearData('artikel');
                    if (data.length > 0) {
                         await window.offlineDB.bulkInsertData('artikel', data);
                    }

                } catch (error) {
                    isOffline = true;
                    showToast("Netzwerkfehler. Zeige lokale Artikel...", 'info');

                    // 2. Offline-Fallback (IndexedDB)
                    try {
                        const localData = await window.offlineDB.getAllArticles();
                        data = localData.filter(item => {
                            if (!searchTerm) return true;
                            const term = searchTerm.toLowerCase();
                            return item.name.toLowerCase().includes(term) ||
                                   item.barcode.toLowerCase().includes(term) ||
                                   item.stellplatz.toLowerCase().includes(term);
                        });
                        // Sortieren im Frontend (da IndexedDB keine komplexe Sortierung bietet)
                        data.sort((a, b) => a.name.localeCompare(b.name));
                        
                    } catch (e) {
                        console.error("Lokaler DB Fehler beim Laden der Artikel:", e);
                        data = [];
                    }
                }
                
                
                if (data.length === 0) {
                    articleListContainer.innerHTML = `<li style="border-left: 5px solid rgba(255, 255, 255, 0.1); background: none; text-align: center; color: rgba(255, 255, 255, 0.5); padding: 10px;">${searchTerm ? 'Keine Artikel entsprechen der Suche.' : 'Noch keine Artikel vorhanden.'}</li>`;
                    return;
                }

                articleListContainer.innerHTML = '';
                data.forEach(item => {
                    const listItem = document.createElement('li');
                    
                    if (window.currentUserRole === 'admin') {
                        listItem.onclick = () => showAdminEditPopup(item);
                        listItem.style.cursor = 'pointer';
                        listItem.setAttribute('data-role', 'admin-editable');
                    }
                    
                    const isBlocklager = item.blocklager;
                    const lagertypIconSvg = isBlocklager ? WAREHOUSE_ICON_SVG : SHELF_ICON_SVG;
                    const lagertypLabel = isBlocklager ? 'BLOCK' : 'REGAL';

                    const details = `
                        <div class="item-details">
                            <strong>${item.name}</strong>
                            <span>Stellplatz: ${item.stellplatz} | Barcode: ${item.barcode}</span>
                        </div>
                        <div class="item-count">
                            ${lagertypIconSvg}
                            <span class="item-label">${lagertypLabel}</span>
                        </div>
                    `;

                    listItem.innerHTML = details;
                    articleListContainer.appendChild(listItem);
                });
                
                if (isOffline) {
                    articleListContainer.innerHTML += '<li style="margin-top: 15px; text-align: center; color: var(--color-warning-yellow); border: none; background: transparent; padding: 5px;">Offline-Modus aktiv.</li>';
                }
            }
            
            
            /* --- ADMIN LOGGING FUNKTION --- */

            async function logAdminAction(actionType, description) {
                if (window.currentUserRole !== 'admin') {
                    console.warn("Versuch, eine Admin-Aktion ohne Admin-Rechte zu protokollieren.");
                    return;
                }
                
                const logEntry = {
                    action_type: actionType,
                    description: description,
                    user_id: currentUserId, // User-ID hinzuf√ºgen
                    user_email: document.getElementById("userDisplay").innerText.split('(')[0].replace('Angemeldet als: ', '').trim() || 'Unbekannt',
                    user_role: window.currentUserRole,
                    created_at: new Date().toISOString()
                };

                let isOffline = !navigator.onLine;

                try {
                    const { error } = await window.appSupabaseClient
                        .from('audit_log')
                        .insert([logEntry]);

                    if (error) {
                        if (error.message.includes('Failed to fetch')) {
                            // Supabase Netzwerkfehler
                            throw new Error("Offline");
                        }
                        throw error;
                    }
                    
                    // Online: Lokalen Cache aktualisieren
                    await window.offlineDB.upsertData('audit_log', logEntry);

                } catch (e) {
                    if (e.message === "Offline" || !navigator.onLine) {
                        isOffline = true;
                        // Log lokal speichern und Outbox-Eintrag erstellen
                         // Das Log-Element muss eine tempor√§re ID f√ºr die Outbox erhalten
                        const tempId = Date.now(); 
                        logEntry.id = tempId; 
                        await window.offlineDB.addToOutbox({
                            type: 'INSERT',
                            table: 'audit_log',
                            key: tempId,
                            payload: logEntry,
                            timestamp: new Date().toISOString()
                        });
                        showToast("Admin-Aktion lokal protokolliert. Synchronisierung steht aus.", 'info');
                    } else {
                        console.error("Log-Fehler:", e);
                    }
                }
            }


            /* --- ADMIN LOG ANZEIGE LOGIK --- */

            async function loadAdminLog(searchTerm = '') {
                if (window.currentUserRole !== 'admin') {
                    document.getElementById('logList').innerHTML = '<li style="border-left: 5px solid var(--color-error-red); background: none; text-align: center; color: var(--color-error-red); padding: 10px;">Keine Berechtigung, das Audit-Log einzusehen.</li>';
                    return;
                }
                
                const logListContainer = document.getElementById('logList');
                logListContainer.innerHTML = '<li style="border-left: 5px solid rgba(255, 255, 255, 0.1); background: none; text-align: center; color: rgba(255, 255, 255, 0.5); padding: 10px;">Lade Log-Eintr√§ge...</li>';

                let logData = [];
                let isOffline = false;

                try {
                    // 1. Online-Versuch
                    let query = window.appSupabaseClient
                        .from('audit_log')
                        .select('*');
                        
                    if (searchTerm) {
                        const search = `%${searchTerm.toLowerCase()}%`;
                        query = query.or(`action_type.ilike.${search},description.ilike.${search}`);
                    }

                    const { data: logs, error } = await query
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                         if (error.message.includes('Failed to fetch')) {
                            // Supabase Netzwerkfehler
                            throw new Error("Offline");
                        }
                        throw error;
                    }
                    
                    logData = logs;
                    
                    // Bei Erfolg: Lokalen Cache aktualisieren
                    if (logData.length > 0) {
                        await window.offlineDB.clearData('audit_log');
                        await window.offlineDB.bulkInsertData('audit_log', logData);
                    }


                } catch (error) {
                    isOffline = true;
                    showToast("Netzwerkfehler. Zeige lokale Log-Eintr√§ge...", 'info');
                    
                    // 2. Offline-Fallback (IndexedDB)
                    try {
                        const localData = await window.offlineDB.getAllLogs();
                        logData = localData.filter(item => {
                            if (!searchTerm) return true;
                            const term = searchTerm.toLowerCase();
                            return item.action_type.toLowerCase().includes(term) || item.description.toLowerCase().includes(term);
                        }).sort((a, b) => b.created_at.localeCompare(a.created_at)); // Sortieren im Frontend
                        
                    } catch (e) {
                        console.error("Lokaler DB Fehler beim Laden der Logs:", e);
                        logData = [];
                    }
                }


                if (logData.length === 0) {
                    logListContainer.innerHTML = `<li style="border-left: 5px solid rgba(255, 255, 255, 0.1); background: none; text-align: center; color: rgba(255, 255, 255, 0.5); padding: 10px;">${searchTerm ? 'Keine Log-Eintr√§ge entsprechen der Suche.' : 'Noch keine Log-Eintr√§ge vorhanden.'}</li>`;
                    return;
                }

                logListContainer.innerHTML = '';
                logData.forEach(log => {
                    const listItem = document.createElement('li');
                    
                    const time = new Date(log.created_at).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    const date = new Date(log.created_at).toLocaleDateString('de-DE');
                    const role = log.user_role === 'admin' ? 'ADMIN' : 'USER';
                    
                    let color = 'var(--color-accent-blue)';
                    if (log.action_type === 'ARTICLE_CREATED' || log.action_type === 'USER_UPDATED') color = 'var(--color-accent-green)';
                    else if (log.action_type === 'ARTICLE_DELETED') color = 'var(--color-error-red)';
                    else if (log.action_type === 'STELLPLATZ_UPDATED' || log.action_type === 'DATA_IMPORTED') color = 'var(--color-warning-yellow)';
                    
                    listItem.style.borderLeftColor = color;
                    
                    const details = `
                        <div class="item-details" style="flex-grow: 1;">
                            <strong>${log.description}</strong>
                            <span>Aktion: ${log.action_type} | ${date} ${time} | ${log.user_email} (${role})</span>
                        </div>
                    `;

                    listItem.innerHTML = details;
                    logListContainer.appendChild(listItem);
                });
                
                if (isOffline) {
                    logListContainer.innerHTML += '<li style="margin-top: 15px; text-align: center; color: var(--color-warning-yellow); border: none; background: transparent; padding: 5px;">Offline-Modus aktiv.</li>';
                }
            }


            /* --- BENUTZER VERWALTUNG LOGIK (ADMIN) --- */

            async function loadUserList(searchTerm = '') {
                 if (window.currentUserRole !== 'admin') {
                    document.getElementById('userList').innerHTML = '<li style="border-left: 5px solid var(--color-error-red); background: none; text-align: center; color: var(--color-error-red); padding: 10px;">Keine Berechtigung, die Benutzerliste einzusehen.</li>';
                    return;
                }

                const userListContainer = document.getElementById('userList');
                userListContainer.innerHTML = '<li style="border-left: 5px solid rgba(255, 255, 255, 0.1); background: none; text-align: center; color: rgba(255, 255, 255, 0.5); padding: 10px;">Lade Benutzer...</li>';
                
                let userData = [];
                let isOffline = false;

                try {
                    // 1. Online-Versuch
                    let query = window.appSupabaseClient
                        .from('user_roles')
                        .select('*')
                        .order('email', { ascending: true });
                        
                    if (searchTerm) {
                        const search = `%${searchTerm.toLowerCase()}%`;
                        query = query.or(`email.ilike.${search},role.ilike.${search},notes.ilike.${search}`);
                    }

                    const { data: users, error } = await query;
                    
                    if (error) {
                         if (error.message.includes('Failed to fetch')) {
                            throw new Error("Offline");
                        }
                        throw error;
                    }
                    
                    userData = users;
                    
                    // Bei Erfolg: Lokalen Cache aktualisieren
                    await window.offlineDB.clearData('users');
                    if (userData.length > 0) {
                         await window.offlineDB.bulkInsertData('users', userData);
                    }

                } catch (error) {
                    isOffline = true;
                    showToast("Netzwerkfehler. Zeige lokale Benutzer...", 'info');

                    // 2. Offline-Fallback (IndexedDB)
                    try {
                        const localData = await window.offlineDB.getAllUsers();
                        userData = localData.filter(item => {
                            if (!searchTerm) return true;
                            const term = searchTerm.toLowerCase();
                            return item.email.toLowerCase().includes(term) ||
                                   item.role.toLowerCase().includes(term) ||
                                   item.notes.toLowerCase().includes(term);
                        }).sort((a, b) => a.email.localeCompare(b.email));
                        
                    } catch (e) {
                        console.error("Lokaler DB Fehler beim Laden der Benutzer:", e);
                        userData = [];
                    }
                }
                
                
                if (userData.length === 0) {
                    userListContainer.innerHTML = `<li style="border-left: 5px solid rgba(255, 255, 255, 0.1); background: none; text-align: center; color: rgba(255, 255, 255, 0.5); padding: 10px;">${searchTerm ? 'Keine Benutzer entsprechen der Suche.' : 'Noch keine Benutzer vorhanden.'}</li>`;
                    return;
                }

                userListContainer.innerHTML = '';
                userData.forEach(user => {
                    const listItem = document.createElement('li');
                    
                    // Der aktuell eingeloggte Benutzer kann nicht √ºber die Liste bearbeitet werden
                    if (user.id !== currentUserId) {
                        listItem.onclick = () => showUserEditPopup(user);
                        listItem.style.cursor = 'pointer';
                        listItem.setAttribute('data-role', 'admin-editable');
                    }
                    
                    let roleClass = '';
                    if (user.role === 'admin') roleClass = 'user-role-admin';
                    if (user.is_blocked) roleClass += ' user-is-blocked';
                    listItem.classList.add(roleClass.trim());

                    const details = `
                        <div class="item-details" style="flex-grow: 1;">
                            <strong>${user.email}</strong>
                            <span>Rolle: ${user.role} | Status: ${user.is_blocked ? 'GESPERRT' : 'Aktiv'}</span>
                            <span style="font-size: 0.75rem; opacity: 0.6; margin-top: 5px;">${user.notes || 'Keine Anmerkungen'}</span>
                        </div>
                        <div class="item-count" style="width: 30px; height: 30px; margin-left: 5px; opacity: 0.8;">
                             ${USER_ICON_SVG}
                        </div>
                    `;

                    listItem.innerHTML = details;
                    userListContainer.appendChild(listItem);
                });
                
                if (isOffline) {
                    userListContainer.innerHTML += '<li style="margin-top: 15px; text-align: center; color: var(--color-warning-yellow); border: none; background: transparent; padding: 5px;">Offline-Modus aktiv.</li>';
                }
            }
            
            window.userToEdit = null;

            function showUserEditPopup(user) {
                if (window.currentUserRole !== 'admin') return;

                window.userToEdit = user;
                document.getElementById('userEditEmail').value = user.email;
                document.getElementById('userEditRole').value = user.role;
                document.getElementById('userEditBlocked').value = user.is_blocked ? 'true' : 'false';
                document.getElementById('userEditNotes').value = user.notes || '';
                
                document.getElementById('userEditPopupOverlay').style.display = "flex";
                setTimeout(() => document.getElementById('userEditPopupOverlay').classList.add('show'), 10);
            }

            function hideUserEditPopup() {
                document.getElementById('userEditPopupOverlay').classList.remove('show');
                setTimeout(() => {
                    document.getElementById('userEditPopupOverlay').style.display = "none";
                    window.userToEdit = null;
                }, 300);
            }

            async function saveUserEdit() {
                if (window.currentUserRole !== 'admin' || !window.userToEdit) return;

                const userId = window.userToEdit.id;
                const newRole = document.getElementById('userEditRole').value;
                const newBlockedStatus = document.getElementById('userEditBlocked').value === 'true';
                const newNotes = document.getElementById('userEditNotes').value.trim();

                const oldRole = window.userToEdit.role;
                const oldBlockedStatus = window.userToEdit.is_blocked;
                const oldNotes = window.userToEdit.notes;

                const updatePayload = {};
                if (newRole !== oldRole) updatePayload.role = newRole;
                if (newBlockedStatus !== oldBlockedStatus) updatePayload.is_blocked = newBlockedStatus;
                if (newNotes !== oldNotes) updatePayload.notes = newNotes;

                if (Object.keys(updatePayload).length === 0) {
                    showToast("Keine √Ñnderungen vorgenommen.", "info");
                    hideUserEditPopup();
                    return;
                }

                let success = false;
                let isOffline = !navigator.onLine;

                try {
                    const { error } = await window.appSupabaseClient
                        .from("user_roles")
                        .update(updatePayload)
                        .eq("id", userId);

                    if (error) {
                        if (error.message.includes('Failed to fetch')) {
                            throw new Error("Offline");
                        }
                        showToast(`FEHLER beim Speichern der Benutzerdaten.`, "error");
                        console.error("Speicherfehler:", error);
                    } else {
                        success = true;
                    }
                } catch (e) {
                    if (e.message === "Offline" || !navigator.onLine) {
                        isOffline = true;
                        // Lokale Daten aktualisieren und Outbox-Eintrag erstellen
                        const updatedUser = { ...window.userToEdit, ...updatePayload };
                        await window.offlineDB.upsertUser(updatedUser);
                        await window.offlineDB.addToOutbox({
                            type: 'UPDATE',
                            table: 'user_roles',
                            key: userId,
                            payload: updatePayload,
                            timestamp: new Date().toISOString()
                        });
                        success = true;
                    } else {
                        console.error("Speicherfehler:", e);
                    }
                }

                if (success) {
                    const statusMessage = isOffline 
                        ? `Benutzerdaten lokal aktualisiert. Wird synchronisiert, sobald online.` 
                        : `Benutzer ${window.userToEdit.email} erfolgreich aktualisiert.`;
                    showToast(statusMessage, isOffline ? "info" : "success");
                    
                    logAdminAction('USER_UPDATED', `Benutzer ${window.userToEdit.email} (ID: ${userId}) aktualisiert: ${JSON.stringify(updatePayload)}.`);
                    
                    hideUserEditPopup();
                    loadUserList(document.getElementById('userSearchInput').value); // Liste aktualisieren
                }
            }


            /* --- DATEN IMPORT/EXPORT LOGIK (Admin) --- */

            // Hilfsfunktion zum Konvertieren von JSON in CSV
            function convertToCSV(data) {
                if (data.length === 0) return '';
                
                // Wir verwenden eine statische Liste der Spalten, um die Reihenfolge beizubehalten
                const keys = ['barcode', 'name', 'stellplatz', 'blocklager', 'scans', 'created_at']; 
                const header = keys.join(';');
                
                const rows = data.map(row => 
                    keys.map(k => {
                        let value = row[k] === null || row[k] === undefined ? '' : String(row[k]);
                        
                        // Anf√ºhrungszeichen escapen und umrahmen, falls Semikolons oder Zeilenumbr√ºche enthalten sind
                        if (value.includes(';') || value.includes('\n') || value.includes('"')) {
                            value = `"${value.replace(/"/g, '""')}"`;
                        }
                        
                        return value;
                    }).join(';')
                );
                
                return [header, ...rows].join('\n');
            }

            function downloadFile(filename, content, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            async function exportData(format) {
                if (window.currentUserRole !== 'admin') {
                    showToast("Nur Administratoren d√ºrfen Daten exportieren.", 'error');
                    return;
                }

                showToast(`Starte Export als ${format.toUpperCase()}...`, 'info');

                try {
                    // Artikel abrufen (Wir nutzen die Online-Daten f√ºr den Export)
                    const { data: articles, error } = await window.appSupabaseClient
                        .from('artikel')
                        .select('barcode, name, stellplatz, blocklager, scans, created_at')
                        .order('name', { ascending: true });

                    if (error) throw error;
                    if (articles.length === 0) {
                        showToast("Keine Artikel zum Exportieren gefunden.", 'warning');
                        return;
                    }

                    let content;
                    let filename;
                    let mimeType;

                    if (format === 'json') {
                        content = JSON.stringify(articles, null, 2);
                        filename = 'inventar_export.json';
                        mimeType = 'application/json';
                    } else if (format === 'csv') {
                        content = convertToCSV(articles);
                        filename = 'inventar_export.csv';
                        mimeType = 'text/csv';
                    } else {
                        return;
                    }

                    downloadFile(filename, content, mimeType);
                    logAdminAction('DATA_EXPORTED', `Datenbank mit ${articles.length} Artikeln als ${format.toUpperCase()} exportiert.`);
                    showToast("Export erfolgreich!", 'success');

                } catch (error) {
                    console.error("Export Fehler:", error);
                    showToast("FEHLER beim Export. √úberpr√ºfen Sie die Netzwerkverbindung und RLS-Policies.", 'error', 7000);
                }
            }


            function prepareImport() {
                if (window.currentUserRole !== 'admin') {
                    showToast("Nur Administratoren d√ºrfen Daten importieren.", 'error');
                    return;
                }
                
                const fileInput = document.getElementById('importFile');
                const file = fileInput.files[0];

                if (!file) {
                    showToast("Bitte w√§hlen Sie eine Datei aus.", 'error');
                    return;
                }

                // Disable button during process
                document.getElementById('importButton').disabled = true;

                const reader = new FileReader();

                reader.onload = async (e) => {
                    try {
                        let parsedData;
                        const fileContent = e.target.result;
                        const filename = file.name.toLowerCase();

                        if (filename.endsWith('.json')) {
                            parsedData = JSON.parse(fileContent);
                        } else if (filename.endsWith('.csv')) {
                            parsedData = parseCSV(fileContent);
                        } else {
                            showToast("Nicht unterst√ºtztes Dateiformat.", 'error');
                            document.getElementById('importButton').disabled = false;
                            return;
                        }

                        if (!Array.isArray(parsedData) || parsedData.length === 0) {
                            showToast("Die Datei enth√§lt keine g√ºltigen Artikeldaten.", 'error');
                            document.getElementById('importButton').disabled = false;
                            return;
                        }

                        await importArticles(parsedData, file.name);

                    } catch (error) {
                        showToast("Fehler beim Verarbeiten der Datei. (Falsches Format?)", 'error', 7000);
                        console.error("Dateiverarbeitungsfehler:", error);
                    } finally {
                        document.getElementById('importButton').disabled = false;
                    }
                };

                reader.onerror = () => {
                    showToast("Fehler beim Lesen der Datei.", 'error');
                    document.getElementById('importButton').disabled = false;
                };

                reader.readAsText(file);
            }

            // Hilfsfunktion zum Parsen von CSV (einfaches Semikolon-Trennzeichen erwartet)
            function parseCSV(csvText) {
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) return [];

                // Header mit Semikolon als Trennzeichen
                const headers = lines[0].split(';').map(h => h.trim().toLowerCase());
                const result = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(';');
                    if (values.length !== headers.length) continue; // √úberspringe fehlerhafte Zeilen

                    const obj = {};
                    values.forEach((val, j) => {
                        let cleanVal = val.trim();
                        // Entferne Anf√ºhrungszeichen, falls vorhanden und ersetze doppelte Anf√ºhrungszeichen
                        if (cleanVal.startsWith('"') && cleanVal.endsWith('"')) {
                            cleanVal = cleanVal.substring(1, cleanVal.length - 1).replace(/""/g, '"');
                        }
                        
                        // Typ-Konvertierung f√ºr boolsche und numerische Felder
                        if (headers[j] === 'blocklager') {
                            obj[headers[j]] = cleanVal.toLowerCase() === 'true';
                        } else if (headers[j] === 'scans') {
                            obj[headers[j]] = parseInt(cleanVal) || 0;
                        } else {
                            obj[headers[j]] = cleanVal;
                        }
                    });
                    
                    // Nur importieren, wenn der Barcode vorhanden ist
                    if (obj.barcode) {
                         result.push(obj);
                    }
                }

                return result;
            }

            async function importArticles(articles, filename) {
                if (articles.length === 0) {
                    showToast("Keine Artikel zum Importieren gefunden.", 'info');
                    return;
                }

                // Daten f√ºr Supabase vorbereiten (nur notwendige Felder)
                const allowedFields = ['barcode', 'name', 'stellplatz', 'blocklager', 'scans'];
                const upsertData = articles.map(article => {
                    const item = {};
                    allowedFields.forEach(field => {
                        // Wir erlauben nur definierte Felder. created_at/id/user_id etc. muss entfernt werden.
                        if (article.hasOwnProperty(field)) {
                            item[field] = article[field];
                        }
                    });
                    
                    // Sicherstellen, dass Pflichtfelder vorhanden und Typen korrekt sind
                    if (typeof item.blocklager !== 'boolean') item.blocklager = item.blocklager === true || item.blocklager === 'true'; // JSON kann boolsche Werte haben
                    if (typeof item.scans !== 'number') item.scans = parseInt(item.scans) || 0;
                    
                    return item;
                }).filter(item => item.barcode && item.name && item.stellplatz); // Nur Artikel mit allen Pflichtfeldern importieren


                if (upsertData.length === 0) {
                    showToast("Keine Artikel mit g√ºltigem Barcode, Name und Stellplatz zum Importieren gefunden.", 'error', 7000);
                    return;
                }
                
                showToast(`Starte Import von ${upsertData.length} g√ºltigen Artikeln...`, 'info', 10000);

                // Supabase upsert (batch insert/update)
                // Wichtig: 'onConflict: 'barcode'' f√ºr UPSERT
                const { error } = await window.appSupabaseClient
                    .from('artikel')
                    .upsert(upsertData, { onConflict: 'barcode' }); 

                if (error) {
                    showToast("FEHLER beim Import. √úberpr√ºfen Sie die Daten und RLS-Policies.", 'error', 10000);
                    console.error("Import Fehler:", error);
                } else {
                    logAdminAction('DATA_IMPORTED', `${upsertData.length} Artikel erfolgreich aus Datei ${filename} importiert/aktualisiert.`);
                    showToast(`Import von ${upsertData.length} Artikeln erfolgreich!`, 'success', 5000);
                    loadArticleList(document.getElementById('articleSearchInput').value); // Liste aktualisieren
                }
            }


            window.onload = function() {
                initSettings(); // Einstellungen laden
                initOfflineSync(); // Offline-Logik initialisieren
                checkLogin();
            };
        </script>

    </body>
    </html>