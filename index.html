<!DOCTYPE html>
    <html lang="de">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Inventar Scanner Pro</title>

        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="https://unpkg.com/html5-qrcode"></script>

        <script>
            // ---------------------------------------------------------
            // KONFIGURATION: Supabase und Zugangs-Codes
            // ---------------------------------------------------------
            var APP_SUPABASE_URL = "https://sjhyvctidpnttqhenqoy.supabase.co";
            // BEST√ÑTIGT KORREKT: Dies ist der √∂ffentliche 'anon' Schl√ºssel.
            var APP_SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHl2Y3RpZHBudHRxaGVucW95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MzU3NTksImV4cCI6MjA4MDAxMTc1OX0.oXUA012J99W8fNNJi8Zxqn-2BUjf1QJOrXGYlPotaS4";
            
            // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            // !!! KRITISCHE SICHERHEITSWARNUNG: DIESER CODE IST UNSICHER             !!!
            // !!! BITTE DIESE LOGIK DURCH EINE SUPABASE AUTHENTIFIZIERUNG ERSETZEN!  !!!
            // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            var USER_ACCESS_CODE = "1234"; // 4-stellig
            var ADMIN_ACCESS_CODE = "4321"; // 4-stellig
            // ---------------------------------------------------------

            // Initialisierung
            (function() {
                if (window['supabase']) {
                    window.appSupabaseClient = window['supabase'].createClient(APP_SUPABASE_URL, APP_SUPABASE_KEY);
                } else {
                    window.appSupabaseClient = null;
                    console.error("Supabase-Client konnte nicht initialisiert werden.");
                }
                window.currentPin = ""; // Speichert den aktuell eingegebenen PIN-Code
                window.lastCode = ""; // F√ºr Debouncing des Scanners
                window.currentTabId = "scannerTab"; // Aktueller Tab
                window.currentUserRole = null; // Speichert die Rolle ('user', 'admin' oder null)
            })();
        </script>

        <style>
            /* --- GLOBALE STYLES & FONT --- */
            :root {
                --color-bg-dark: #0a0b10;
                --color-bg-card: #1d222e;
                --color-accent-blue: #007aff;
                --color-accent-green: #34c759;
                --color-error-red: #ff3b30;
                --color-border: rgba(255, 255, 255, 0.08);
                --transition-duration: 0.3s;
            }

            * {
                box-sizing: border-box;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            }

            body,
            html {
                margin: 0;
                padding: 0;
                background: var(--color-bg-dark);
                color: white;
                height: 100dvh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            /* --- LAYOUT & TRANSITIONEN --- */

            .app-view-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                transition: opacity var(--transition-duration) ease-in-out, transform var(--transition-duration) ease-in-out;
                opacity: 0;
                pointer-events: none;
                display: flex;
                flex-direction: column;
            }

            .app-view-container.active {
                opacity: 1;
                pointer-events: all;
            }

            /* Initial Zustand f√ºr Login, um den "Slide-In"-Effekt zu simulieren */
            #loginView {
                transform: translateY(0);
            }

            #appView {
                transform: translateY(100vh);
            }

            #loginView.active {
                transform: translateY(0);
            }

            #appView.active {
                transform: translateY(0);
            }
            
            /* Der Container f√ºr die Tabs */
            #tabContentContainer {
                flex-grow: 1;
                position: relative;
                overflow: hidden; /* Wichtig, um die Tabs im Container zu halten */
            }
            
            /* KORREKTUR: Vereinfachung der Sichtbarkeitsregeln - Wichtig f√ºr Log √úberlappung */
            .tab-content {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                /* WICHTIG: display: none mit !important, um √úberlappung zu verhindern */
                display: none !important; 
                flex-direction: column;
                overflow-y: auto; /* List- und Log-Tabs brauchen Scrolling */
                
                /* Expliziter Hintergrund, falls doch etwas durchscheint */
                background: var(--color-bg-dark); 
            }
            
            .tab-content.active {
                display: flex !important; /* Macht den aktiven Tab sichtbar */
            }


            /* --- HEADER --- */
            header {
                height: 55px;
                background: rgba(30, 30, 40, 0.9);
                backdrop-filter: blur(8px);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 15px;
                border-bottom: 1px solid var(--color-border);
                z-index: 10;
                flex-shrink: 0; /* Verhindert, dass der Header schrumpft */
            }

            header h1 {
                font-size: 1.1rem;
                font-weight: 600;
                margin: 0;
            }

            .header-button {
                padding: 5px 10px;
                font-size: 0.75em;
                background: rgba(255, 255, 255, 0.1);
                border: none;
                border-radius: 8px;
                color: white;
                cursor: pointer;
                transition: background 0.2s;
            }

            /* --- LOGIN VIEW --- */
            #loginView {
                justify-content: space-around;
                align-items: center;
                padding: 40px 20px;
            }

            .login-header {
                text-align: center;
                padding-top: 50px;
            }

            .app-icon {
                font-size: 3.5em;
                color: var(--color-accent-blue);
                margin-bottom: 15px;
            }

            .login-header h2 {
                font-size: 1.6rem;
                font-weight: 700;
                margin: 0;
            }

            #authError {
                color: var(--color-error-red);
                margin-top: 10px;
                height: 1.2em;
                font-weight: 500;
            }
            
            /* Ladezustand f√ºr Login */
            #loadingAuth {
                text-align: center;
                font-size: 1.1rem;
                opacity: 0.7;
                display: none; /* Wird dynamisch in JS angezeigt/versteckt */
                margin-top: 40px;
            }

            /* --- PIN INDICATORS --- */
            #pinIndicators {
                display: flex;
                gap: 15px;
                margin-bottom: 30px;
                height: 12px;
                /* Beschr√§nkt auf 4 Ziffern */
                width: 130px; 
                justify-content: center;
            }

            .pin-indicator {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                border: 2px solid rgba(255, 255, 255, 0.2);
                background: transparent;
                transition: background-color 0.2s, border-color 0.2s;
            }

            .pin-indicator.active {
                background: var(--color-accent-blue);
                border-color: var(--color-accent-blue);
                box-shadow: 0 0 10px rgba(0, 122, 255, 0.6);
            }

            /* --- KEYPAD --- */
            #keypad {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
                width: 100%;
                max-width: 320px;
                padding: 10px 0;
            }

            .keypad-button {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                background: var(--color-bg-card);
                color: white;
                font-size: 1.8rem;
                font-weight: 500;
                border: none;
                cursor: pointer;
                transition: background 0.1s, box-shadow 0.1s;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto;
            }

            .keypad-button:active {
                background: rgba(255, 255, 255, 0.15);
                box-shadow: 0 0 15px 5px rgba(0, 122, 255, 0.3); /* Leichter Akzent-Gl√ºheffekt */
            }

            .keypad-button.action {
                /* Tasten f√ºr Aktionen (L√∂schen/Backspace) sind weniger prominent */
                background: transparent;
                box-shadow: none;
                opacity: 0.7;
                font-size: 1rem;
                font-weight: 400;
            }

            .keypad-button.action:active {
                background: rgba(255, 255, 255, 0.1);
            }

            .keypad-button.backspace svg {
                width: 28px;
                height: 28px;
                stroke: white;
            }

            /* --- APP VIEW / SCANNER --- */
            #scannerTab {
                position: relative;
                overflow: hidden;
            }

            #reader-container {
                flex-grow: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                overflow: hidden;
            }

            #reader {
                width: 100%;
                height: 100%;
                background: black;
                /* Stellt sicher, dass das Video den Container ausf√ºllt */
                object-fit: cover;
            }
            
            #reader video {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }


            .scan-frame {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 70%;
                max-width: 300px;
                aspect-ratio: 1 / 1;
                border: 3px solid var(--color-accent-green);
                border-radius: 12px;
                box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.7);
                pointer-events: none;
            }

            /* Overlay vor dem Scannen */
            #preScan {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: var(--color-bg-dark);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                z-index: 5;
            }

            .primary-button {
                padding: 12px 25px;
                font-size: 1rem;
                font-weight: 600;
                background: var(--color-accent-blue);
                color: white;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                transition: background 0.2s;
            }

            .primary-button:active {
                background: #0066cc;
            }


            /* --- Result Card (Pull-Up) --- */
            #result-card {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                background: var(--color-bg-card);
                border-top-left-radius: 20px;
                border-top-right-radius: 20px;
                padding: 20px;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.4);
                transform: translateY(100%);
                transition: transform var(--transition-duration) ease-out;
                z-index: 10;
            }

            #result-card.active {
                transform: translateY(0);
            }

            .card-handle {
                width: 40px;
                height: 4px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 2px;
                margin: 0 auto 15px;
            }

            #cardTitle {
                font-size: 1.4rem;
                font-weight: 700;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
            }

            #cardStatusIcon {
                margin-right: 10px;
                font-size: 1.1em;
            }

            #cardContent p {
                margin: 5px 0;
                font-size: 0.9rem;
                opacity: 0.8;
            }

            .action-button-group {
                display: flex;
                gap: 10px;
                margin-top: 15px;
            }

            .action-button {
                flex: 1;
                padding: 12px;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
            }

            .action-button.register {
                background: var(--color-accent-green);
                color: var(--color-bg-card);
            }
            .action-button.register:active {
                background: #2cb74b;
            }
            .action-button.cancel {
                background: rgba(255, 255, 255, 0.1);
                color: white;
            }
            .action-button.cancel:active {
                background: rgba(255, 255, 255, 0.2);
            }
            /* Style f√ºr L√∂sch-Button */
            .action-button.delete {
                background: var(--color-error-red);
                color: white;
            }
            .action-button.delete:active {
                background: #cc2a22;
            }


            /* --- POPUP / REGISTRIEREN & ADMIN EDIT (REUSABLE STYLES) --- */
            #popupOverlay, #adminEditPopupOverlay, #deleteConfirmPopupOverlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(5px);
                z-index: 100;
                display: none;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.2s ease-in-out;
            }

            #popupOverlay.show, #adminEditPopupOverlay.show, #deleteConfirmPopupOverlay.show {
                opacity: 1;
                display: flex; /* Wichtig, um nach der Transition sichtbar zu sein */
            }

            .popup-card {
                background: var(--color-bg-card);
                padding: 25px;
                border-radius: 15px;
                width: 90%;
                max-width: 400px;
                transform: translateY(20px);
                transition: transform 0.3s ease-in-out;
            }

            #popupOverlay.show .popup-card, #adminEditPopupOverlay.show .popup-card, #deleteConfirmPopupOverlay.show .popup-card {
                transform: translateY(0);
            }

            .popup-card h3 {
                margin-top: 0;
                font-size: 1.3rem;
                border-bottom: 1px solid var(--color-border);
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

            .input-group {
                margin-bottom: 15px;
            }

            .input-group label {
                display: block;
                font-size: 0.9rem;
                margin-bottom: 5px;
                opacity: 0.8;
            }

            .input-group input[type="text"],
            .input-group select {
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid var(--color-border);
                background: var(--color-bg-dark);
                color: white;
                font-size: 1rem;
            }
            .input-group input[type="text"]:focus,
            .input-group select:focus {
                outline: none;
                border-color: var(--color-accent-blue);
            }

            /* --- TOASTS --- */
            #toastContainer {
                position: fixed;
                top: 15px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 350px;
                z-index: 200;
                pointer-events: none; /* Macht Toasts nicht klickbar */
            }

            .toast {
                background: var(--color-bg-card);
                color: white;
                padding: 10px 15px;
                border-radius: 10px;
                margin-bottom: 10px;
                opacity: 0;
                transform: translateY(20px);
                transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                font-size: 0.95rem;
                font-weight: 500;
            }

            .toast.show {
                opacity: 1;
                transform: translateY(0);
            }

            .toast-icon {
                margin-right: 10px;
                font-size: 1.2em;
            }

            .toast.success .toast-icon {
                color: var(--color-accent-green);
            }

            .toast.error .toast-icon {
                color: var(--color-error-red);
            }

            .toast.info .toast-icon {
                color: var(--color-accent-blue);
            }

            /* --- FOOTER / NAVIGATION --- */
            footer {
                display: flex;
                height: 70px;
                background: rgba(30, 30, 40, 0.9);
                backdrop-filter: blur(8px);
                border-top: 1px solid var(--color-border);
                flex-shrink: 0;
                z-index: 20;
            }

            .nav-item {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: rgba(255, 255, 255, 0.5);
                font-size: 0.8rem;
                cursor: pointer;
                transition: color 0.2s;
                user-select: none; /* Verhindert Auswahl beim Tippen */
            }

            .nav-item.active {
                color: var(--color-accent-blue);
            }

            .nav-item svg {
                width: 24px;
                height: 24px;
                stroke: currentColor;
                fill: none;
                stroke-width: 2;
                margin-bottom: 2px;
            }
            
            /* --- ARTIKEL LIST VIEW STYLES --- */
            #listTab {
                /* Padding muss hier gesetzt werden, da es der Scroll-Container ist */
                padding: 15px 15px 80px 15px;
            }
            
            #articleList {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            
            #articleList li {
                background: var(--color-bg-card);
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 10px;
                border-left: 5px solid var(--color-accent-blue);
                display: flex;
                justify-content: space-between;
                align-items: center;
                /* Visuelle Anzeige f√ºr Admin-Klickbarkeit */
                transition: background 0.2s; 
            }
            
            /* Admin-Elemente haben einen Hover-Effekt */
            #articleList li[data-role="admin-editable"]:active {
                background: #2a303e; 
            }
            
            .item-details strong {
                display: block;
                font-size: 1.rem;
                font-weight: 600;
                margin-bottom: 2px;
            }
            
            .item-details span {
                font-size: 0.85rem;
                opacity: 0.7;
            }
            
            /* Icon-Anzeige f√ºr Lagertyp */
            .item-count {
                text-align: center; 
                width: 40px; 
                height: 50px; 
                flex-shrink: 0;
                margin-left: 10px;
                display: flex; 
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            
            .item-count svg {
                width: 28px; 
                height: 28px;
                margin-bottom: 2px; 
            }

            .item-count .item-label {
                font-size: 0.6rem; 
                font-weight: 600;
                line-height: 1;
            }
            
            /* Admin Log Liste Styles */
            #logTab {
                padding: 15px 15px 80px 15px; 
                display: flex; 
                flex-direction: column;
            }

            #logList {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            
            #logList li {
                /* Grund-Styles f√ºr die Konsistenz mit Artikelliste */
                background: var(--color-bg-card);
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 10px;
            }

        </style>
    </head>
    <body>

        <div id="toastContainer"></div>
        
        <div id="popupOverlay">
            <form class="popup-card" onsubmit="event.preventDefault(); saveArticle();">
                <h3>Artikel Registrieren</h3>
                <div class="input-group">
                    <label for="popupBarcode">Barcode</label>
                    <input type="text" id="popupBarcode" readonly>
                </div>
                
                <div class="input-group">
                    <label for="popupBaseName">Basis-Name (z.B. T-Shirt, Wasserflasche)</label>
                    <input type="text" id="popupBaseName" required>
                </div>
                
                <div class="input-group">
                    <label for="popupSize">Gr√∂√üe / Volumen (Liter)</label>
                    <select id="popupSize">
                        <option value="">(Optional)</option>
                        <option value="0.33">0,33 Liter</option>
                        <option value="0.5">0,5 Liter</option>
                        <option value="0.7">0,7 Liter</option>
                        <option value="1.0">1,0 Liter</option>
                        <option value="1.5">1,5 Liter</option>
                        <option value="2.0">2,0 Liter</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="popupPlatz">Stellplatz (z.B. A-02-C)</label>
                    <input type="text" id="popupPlatz" required>
                </div>
                
                <div class="input-group">
                    <label for="popupBlocklager">Lagertyp</label>
                    <select id="popupBlocklager">
                        <option value="false">Regal / Fach</option>
                        <option value="true">Blocklager</option>
                    </select>
                </div>

                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hidePopup()">Abbrechen</button>
                    <button type="submit" class="action-button register">Speichern</button>
                </div>
            </form>
        </div>
        
        <div id="adminEditPopupOverlay">
            <form class="popup-card" onsubmit="event.preventDefault(); saveAdminEdit();">
                <h3>Artikel Bearbeiten (Admin)</h3>
                <div class="input-group">
                    <label for="adminEditName">Artikel Name</label>
                    <input type="text" id="adminEditName" readonly>
                </div>

                <div class="input-group">
                    <label for="adminEditBarcode">Barcode</label>
                    <input type="text" id="adminEditBarcode" readonly>
                </div>
                
                <div class="input-group">
                    <label for="adminEditPlatz">Neuer Stellplatz</label>
                    <input type="text" id="adminEditPlatz" required>
                </div>
                
                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hideAdminEditPopup()">Abbrechen</button>
                    <button type="submit" class="action-button register">Speichern</button>
                </div>

                <button type="button" class="action-button delete" style="width: 100%; margin-top: 15px;" onclick="deleteArticle()">
                    Artikel l√∂schen...
                </button>

                <p style="font-size: 0.75rem; opacity: 0.6; text-align: center; margin-top: 15px;">Sie sind als Administrator angemeldet und k√∂nnen den Stellplatz √§ndern.</p>
            </form>
        </div>

        <div id="deleteConfirmPopupOverlay">
            <div class="popup-card">
                <h3 id="deleteConfirmTitle">Artikel unwiderruflich l√∂schen</h3>
                <p id="deleteConfirmMessage" style="margin-bottom: 25px; text-align: center; font-weight: 500; font-size: 1.1rem; line-height: 1.4;"></p>

                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hideDeleteConfirmPopup()">Abbrechen</button>
                    <button type="button" class="action-button delete" onclick="confirmDeleteArticle()">Ja, unwiderruflich l√∂schen</button>
                </div>
            </div>
        </div>


        <div id="loginView" class="app-view-container active">

            <div class="login-header">
                <div class="app-icon">üîê</div>
                <h2>Inventar Scanner Pro</h2>
                <div id="authError"></div>
            </div>

            <div id="authContent" style="display: none; align-items: center; flex-direction: column;">
                <p style="opacity: 0.7;" id="pinInstruction">Geben Sie Ihren 4-stelligen PIN ein.</p> 
                
                <div id="pinIndicators">
                    <div class="pin-indicator"></div>
                    <div class="pin-indicator"></div>
                    <div class="pin-indicator"></div>
                    <div class="pin-indicator"></div>
                </div>

                <div id="keypad">
                    <button class="keypad-button" data-key="1" onclick="handlePinInput(1)">1</button>
                    <button class="keypad-button" data-key="2" onclick="handlePinInput(2)">2</button>
                    <button class="keypad-button" data-key="3" onclick="handlePinInput(3)">3</button>
                    <button class="keypad-button" data-key="4" onclick="handlePinInput(4)">4</button>
                    <button class="keypad-button" data-key="5" onclick="handlePinInput(5)">5</button>
                    <button class="keypad-button" data-key="6" onclick="handlePinInput(6)">6</button>
                    <button class="keypad-button" data-key="7" onclick="handlePinInput(7)">7</button>
                    <button class="keypad-button" data-key="8" onclick="handlePinInput(8)">8</button>
                    <button class="keypad-button" data-key="9" onclick="handlePinInput(9)">9</button>
                    <div class="keypad-button action"></div>
                    <button class="keypad-button" data-key="0" onclick="handlePinInput(0)">0</button>
                    <button class="keypad-button action backspace" onclick="handlePinInput('backspace')">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7 16L3 12M3 12L7 8M3 12H16.8C18.4565 12 20.0456 11.3151 21.2132 10.1475C22.3809 8.97994 23.0658 7.39082 23.0658 5.73449C23.0658 4.07817 22.3809 2.48905 21.2132 1.32148C20.0456 0.15392 18.4565 0 16.8 0H4" transform="translate(0 6)"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div id="loadingAuth">
                Initialisiere App...
            </div>
        </div>

        <div id="appView" class="app-view-container">

            <header>
                <h1>Inventar Scanner Pro</h1>
                <button class="header-button" onclick="logout()">Logout (<span id="userDisplay"></span>)</button>
            </header>

            <div id="tabContentContainer">
                <div id="scannerTab" class="tab-content active">
                    <div id="reader-container">
                        <div id="reader"></div>
                        <div class="scan-frame" id="scanFrame" style="display:none;"></div>

                        <div id="preScan">
                            <div style="font-size: 4em; margin-bottom: 20px;">üì¶</div>
                            <h2>Scanner bereit</h2>
                            <p style="opacity: 0.7; margin-bottom: 30px;">Kamera-Zugriff starten, um loszulegen.</p>
                            <button class="primary-button" style="max-width: 250px;" onclick="activateCamera()">SCAN STARTEN</button>
                        </div>
                    </div>

                    <div id="result-card" class="result-card">
                        <div class="card-handle"></div>
                        <div id="cardTitle"><span id="cardStatusIcon"></span> <span id="cardTitleText"></span></div>
                        <div id="cardContent"></div>
                        
                        <div class="action-button-group">
                            <button class="action-button cancel" onclick="hideResultCard()">Fertig</button>
                            <button class="action-button register" id="registerButton" onclick="showPopup()">Registrieren</button>
                        </div>
                    </div>
                </div>

                <div id="listTab" class="tab-content">
                    <ul id="articleList">
                        <li>Lade Artikel...</li>
                    </ul>
                </div>

                <div id="logTab" class="tab-content">
                    <ul id="logList">
                        <li>Lade Log-Protokoll...</li>
                    </ul>
                </div>
            </div>

            <footer>
                <div class="nav-item active" data-tab="scannerTab" onclick="changeTab('scannerTab')">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h.01M7 7h.01M11 11h.01M15 15h.01M21 3h-6l-3 3H3v18h18V3z"/></svg>
                    <span>Scannen</span>
                </div>
                <div class="nav-item" data-tab="listTab" onclick="changeTab('listTab')">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                    <span>Liste</span>
                </div>
                <div class="nav-item" data-tab="logTab" onclick="changeTab('logTab')">
                    <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 11H5M19 11v6m0-6V5m-4 16H9M12 4v16M21 11H3"/></svg>
                    <span>Log</span>
                </div>
            </footer>
        </div>

        <script>
            let html5QrCode = null;
            let lastCode = "";
            let currentScannedBarcode = "";
            let currentTabId = "scannerTab";
            let currentUserId = null;
            let currentUserRole = null;
            let isAuthReady = false;
            let articleToEdit = null;
            let articleToDelete = null;

            // SVG-Strings f√ºr die Lagertypen
            const SHELF_ICON_SVG = '<svg viewBox="0 0 24 24" stroke="white" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16v16H4V4zm4 0v16m8-16v16M4 10h16M4 16h16"/></svg>';
            const WAREHOUSE_ICON_SVG = '<svg viewBox="0 0 24 24" stroke="white" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l10 5l-10 5l-10-5zM2 12v6l10 5l10-5v-6M12 2v10"/></svg>';


            /* --- HILFSFUNKTIONEN --- */

            /**
             * Zeigt eine tempor√§re, nicht-blockierende Nachricht an.
             */
            function showToast(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;

                let icon = '‚ÑπÔ∏è';
                if (type === 'success') icon = '‚úÖ';
                if (type === 'error') icon = '‚ùå';

                toast.innerHTML = `<span class="toast-icon">${icon}</span>${message}`;
                container.appendChild(toast);

                // Trigger CSS transition
                setTimeout(() => toast.classList.add('show'), 10);

                // Hide and remove after duration
                setTimeout(() => {
                    toast.classList.remove('show');
                    // Remove from DOM after transition
                    setTimeout(() => {
                        if (toast.parentNode === container) {
                            container.removeChild(toast);
                        }
                    }, 300);
                }, duration);
            }

            /** Ansicht zwischen Login und App wechseln */
            function switchView(targetViewId) {
                const views = document.querySelectorAll('.app-view-container');
                views.forEach(view => {
                    view.classList.remove('active');
                    if (view.id === targetViewId) {
                        view.classList.add('active');
                    }
                });
            }


            /* --- LOGIN LOGIK --- */

            function updatePinIndicators() {
                // HINWEIS: W√§hlt nur die 4 vorhandenen Indikatoren
                const indicators = document.querySelectorAll('#pinIndicators .pin-indicator');
                indicators.forEach((indicator, index) => {
                    if (index < window.currentPin.length) {
                        indicator.classList.add('active');
                    } else {
                        indicator.classList.remove('active');
                    }
                });
            }

            // Automatischer 4-stelliger Login
            function handlePinInput(key) {
                document.getElementById("authError").innerText = "";
                const MAX_PIN_LENGTH = 4; // Max 4 Ziffern

                if (key === 'backspace') {
                    window.currentPin = window.currentPin.slice(0, -1);
                } else if (typeof key === 'number' && window.currentPin.length < MAX_PIN_LENGTH) {
                    window.currentPin += key.toString();
                }

                updatePinIndicators();

                // Automatischer Login-Versuch, sobald 4 Ziffern eingegeben wurden
                if (window.currentPin.length === MAX_PIN_LENGTH) {
                    handlePinEntry(window.currentPin);
                    // PIN zur√ºcksetzen, um den n√§chsten Versuch zu erm√∂glichen
                    window.currentPin = ""; 
                    setTimeout(updatePinIndicators, 300);
                }
            }

            function handlePinEntry(pin) {
                let role = null;
                let success = false;
                
                if (pin === USER_ACCESS_CODE) {
                    role = 'user';
                    success = true;
                } else if (pin === ADMIN_ACCESS_CODE) {
                    role = 'admin';
                    success = true;
                }

                if (success) {
                    document.getElementById("authError").innerText = "";
                    window.currentUserRole = role; // Rolle setzen
                    
                    // Anpassung der Anzeige
                    const roleDisplay = (role === 'admin' ? "ADMIN" : "USER");
                    document.getElementById("userDisplay").innerText = `${roleDisplay}`;
                    
                    switchView('appView');
                    changeTab('scannerTab');
                } else {
                    document.getElementById("authError").innerText = "Falscher Code. Bitte versuchen Sie es erneut.";
                    showToast("Falscher Code.", 'error');
                }
            }


            // Beim Start die Login- oder App-Ansicht festlegen
            async function checkLogin() {
                const authContent = document.getElementById("authContent");
                const loadingIndicator = document.getElementById("loadingAuth");

                if (isAuthReady) {
                    authContent.style.display = "flex";
                    loadingIndicator.style.display = "none";
                    return;
                }
                
                loadingIndicator.style.display = "block";
                authContent.style.display = "none";

                // Warten auf die Session-Pr√ºfung von Supabase (Simuliert)
                const { data } = await window.appSupabaseClient.auth.getSession();
                const currentSession = data.session;
                
                // Session-Check beendet
                isAuthReady = true;
                loadingIndicator.style.display = "none";

                // Zeige immer die Login-Ansicht anfangs
                switchView('loginView');
                authContent.style.display = "flex";
            }


            /* --- SCANNEN LOGIK --- */

            async function activateCamera() {
                if (html5QrCode) {
                    // Falls bereits initialisiert, einfach starten (oder neustarten)
                    await startScanner();
                    return;
                }
                
                html5QrCode = new Html5Qrcode("reader");
                await startScanner();
            }

            async function startScanner() {
                document.getElementById("preScan").style.display = "none";
                document.getElementById("scanFrame").style.display = "block";
                
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    // Bevorzuge die r√ºckw√§rtige Kamera auf mobilen Ger√§ten
                    facingMode: "environment" 
                };

                // F√§ngt Fehler ab, falls die Kamera nicht gestartet werden kann (z.B. keine Berechtigung)
                try {
                    // Verwende facingMode als Konfiguration, um die r√ºckw√§rtige Kamera zu erzwingen
                    await html5QrCode.start({ facingMode: { exact: "environment"} }, config, onScanSuccess, onScanError);
                } catch (err) {
                    console.error("Kamera konnte nicht gestartet werden.", err);
                    document.getElementById("preScan").style.display = "flex";
                    document.getElementById("scanFrame").style.display = "none";
                    document.getElementById("preScan").innerHTML = `
                        <div style="font-size: 4em; margin-bottom: 20px; color: var(--color-error-red);">‚ùå</div>
                        <h2>Fehler</h2>
                        <p style="opacity: 0.7; margin-bottom: 30px;">Kamera konnte nicht gestartet werden. Bitte Berechtigungen pr√ºfen oder eine andere Kamera ausw√§hlen.</p>
                        <button class="primary-button" style="max-width: 250px;" onclick="activateCamera()">NEU STARTEN</button>
                    `;
                    showToast("Kamerafehler. Berechtigungen pr√ºfen.", 'error');
                }
            }


            async function stopScanner() {
                document.getElementById("scanFrame").style.display = "none";
                if (html5QrCode && html5QrCode.isScanning) {
                    try {
                        await html5QrCode.stop();
                        console.log("Scanner gestoppt.");
                    } catch (err) {
                        // console.error("Fehler beim Stoppen des Scanners:", err); // Wird ignoriert
                    }
                }
                // setze preScan zur√ºck, falls der Tab gewechselt wird
                if (currentTabId === 'scannerTab') {
                    document.getElementById("preScan").style.display = "flex";
                }
            }

            function onScanSuccess(decodedText, decodedResult) {
                // Debouncing: Scanne nur, wenn der Code neu ist oder 5 Sekunden vergangen sind
                if (decodedText === lastCode && (Date.now() - lastCode.timestamp) < 5000) {
                    return;
                }
                
                lastCode = { code: decodedText, timestamp: Date.now() };
                currentScannedBarcode = decodedText;
                
                // Visuelles Feedback
                document.getElementById('scanFrame').style.borderColor = 'var(--color-accent-blue)';
                setTimeout(() => {
                    document.getElementById('scanFrame').style.borderColor = 'var(--color-accent-green)';
                }, 500);

                showToast(`Code gescannt: ${decodedText}`, 'success');
                lookupBarcode(decodedText);
            }

            function onScanError(errorMessage) {
                // Wenn die Karte sichtbar ist, nichts tun, um nicht zu unterbrechen
                if (document.getElementById('result-card').classList.contains('active')) {
                    return;
                }
                // console.log("Scan Error: ", errorMessage); // Zu viel Log-Output
            }


            async function lookupBarcode(barcode) {
                showResultCard({ name: "Suche...", placement_slot: "...", block_warehouse: false }, barcode, 'info');

                const { data, error } = await window.appSupabaseClient
                    .from('articles')
                    .select('*')
                    .eq('barcode', barcode)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 = No Rows Found
                    console.error('Fehler bei der Barcode-Suche:', error);
                    showToast("Fehler bei der Datenbanksuche.", 'error');
                    showResultCard({ name: "Fehler", placement_slot: "DB-Fehler", block_warehouse: false }, barcode, 'error');
                    return;
                }

                if (data) {
                    // Artikel gefunden
                    showResultCard(data, barcode, 'success');
                } else {
                    // Artikel nicht gefunden (PGRST116)
                    showResultCard(null, barcode, 'warning');
                }
            }


            function showResultCard(article, barcode, type = 'info') {
                const card = document.getElementById('result-card');
                const titleText = document.getElementById('cardTitleText');
                const content = document.getElementById('cardContent');
                const icon = document.getElementById('cardStatusIcon');
                const registerButton = document.getElementById('registerButton');

                registerButton.style.display = 'none'; // Standardm√§√üig ausblenden
                
                // Speichert den aktuellen Artikel f√ºr die Admin-Bearbeitung
                articleToEdit = article; 

                if (type === 'success' && article) {
                    titleText.textContent = article.name;
                    icon.innerHTML = '‚úÖ';
                    
                    const blockText = article.block_warehouse ? 'Blocklager' : 'Regal / Fach';
                    
                    content.innerHTML = `
                        <p><strong>Status:</strong> Verf√ºgbar</p>
                        <p><strong>Stellplatz:</strong> ${article.placement_slot}</p>
                        <p><strong>Lagertyp:</strong> ${blockText}</p>
                        <p><strong>Barcode:</strong> ${article.barcode}</p>
                    `;
                    
                    // Admin: Zeigt Bearbeiten/L√∂schen an. User: Zeigt nur "Fertig" an (ist Standard).
                    if (window.currentUserRole === 'admin') {
                         registerButton.textContent = 'Bearbeiten (Admin)';
                         registerButton.classList.add('register');
                         registerButton.classList.remove('delete');
                         registerButton.onclick = () => showAdminEditPopup(article);
                         registerButton.style.display = 'block';
                    }
                } else if (type === 'warning') {
                    titleText.textContent = "Artikel nicht gefunden";
                    icon.innerHTML = '‚ö†Ô∏è';
                    content.innerHTML = `
                        <p>Der Barcode <strong>${barcode}</strong> ist nicht registriert.</p>
                        <p style="margin-top: 10px;">M√∂chten Sie ihn jetzt registrieren?</p>
                    `;
                    registerButton.textContent = 'Registrieren';
                    registerButton.classList.add('register');
                    registerButton.classList.remove('delete');
                    registerButton.onclick = showPopup;
                    registerButton.style.display = 'block';
                } else {
                    // Info/Error State
                    titleText.textContent = article ? article.name : "System-Info";
                    icon.innerHTML = type === 'error' ? '‚ùå' : 'üîé';
                    content.innerHTML = `<p>${article ? article.placement_slot : 'Daten werden verarbeitet...'}</p>`;
                }
                
                card.classList.add('active');
            }

            function hideResultCard() {
                document.getElementById('result-card').classList.remove('active');
                articleToEdit = null;
            }


            /* --- POPUP LOGIK --- */
            
            // Registrierungs-Popup anzeigen
            function showPopup() {
                hideResultCard();
                document.getElementById('popupBarcode').value = currentScannedBarcode;
                document.getElementById('popupOverlay').classList.add('show');
            }

            function hidePopup() {
                document.getElementById('popupOverlay').classList.remove('show');
                // Formular zur√ºcksetzen, falls es geschlossen wird
                document.getElementById('popupBaseName').value = '';
                document.getElementById('popupSize').value = '';
                document.getElementById('popupPlatz').value = '';
                document.getElementById('popupBlocklager').value = 'false';
                currentScannedBarcode = ""; // Barcode zur√ºcksetzen
            }

            async function saveArticle() {
                const name = document.getElementById('popupBaseName').value.trim();
                const size = document.getElementById('popupSize').value.trim();
                const platz = document.getElementById('popupPlatz').value.trim().toUpperCase();
                const isBlocklager = document.getElementById('popupBlocklager').value === 'true';
                const barcode = document.getElementById('popupBarcode').value.trim();

                if (!name || !platz || !barcode) {
                    showToast("Bitte alle Pflichtfelder ausf√ºllen.", 'error');
                    return;
                }
                
                // Name mit Gr√∂√üe/Volumen erg√§nzen, falls vorhanden
                const finalName = size ? `${name} (${size}L)` : name;

                const newArticle = {
                    barcode: barcode,
                    name: finalName,
                    placement_slot: platz,
                    block_warehouse: isBlocklager,
                };
                
                // Eintrag in die Haupttabelle
                const { error: insertError } = await window.appSupabaseClient
                    .from('articles')
                    .insert([newArticle]);

                if (insertError) {
                    showToast("Fehler beim Speichern des Artikels.", 'error');
                    console.error("Insert Error:", insertError);
                    return;
                }
                
                // Eintrag in die Log-Tabelle
                const logEntry = {
                    action_type: 'ARTICLE_ADDED',
                    description: `Neuer Artikel: ${finalName} registriert am Platz ${platz}.`,
                    user_role: window.currentUserRole,
                    // Die Spalte hei√üt 'timestamp' in der DB!
                    timestamp: new Date().toISOString(), 
                };
                
                const { error: logError } = await window.appSupabaseClient
                    .from('audit_log')
                    .insert([logEntry]);
                    
                if (logError) {
                    console.error("Log-Eintrag Fehler:", logError);
                    // Dennoch als Erfolg melden, da Artikel gespeichert wurde
                }

                showToast(`Artikel "${finalName}" erfolgreich registriert!`, 'success', 5000);
                hidePopup();
            }


            // --- ADMIN BEARBEITUNG LOGIK ---
            
            // Aktuell bearbeiteter Artikel (globaler Zustand)
            // articleToEdit global definiert
            
            function showAdminEditPopup(article) {
                hideResultCard();
                
                // articleToEdit wurde bereits in showResultCard gesetzt, aber hier zur Sicherheit erneut
                articleToEdit = article; 
                
                document.getElementById('adminEditName').value = article.name;
                document.getElementById('adminEditBarcode').value = article.barcode;
                document.getElementById('adminEditPlatz').value = article.placement_slot;
                
                document.getElementById('adminEditPopupOverlay').classList.add('show');
            }

            function hideAdminEditPopup() {
                document.getElementById('adminEditPopupOverlay').classList.remove('show');
                articleToEdit = null;
            }

            function showDeleteConfirmPopup(article) {
                articleToDelete = article;
                document.getElementById('deleteConfirmMessage').innerHTML = `M√∂chten Sie den Artikel <strong>"${article.name}"</strong> mit dem Stellplatz <strong>${article.placement_slot}</strong> wirklich l√∂schen?`;
                document.getElementById('deleteConfirmPopupOverlay').classList.add('show');
            }

            function hideDeleteConfirmPopup() {
                document.getElementById('deleteConfirmPopupOverlay').classList.remove('show');
                articleToDelete = null;
            }

            async function deleteArticle() {
                if (!articleToEdit) return;
                
                hideAdminEditPopup(); // Schlie√üe Bearbeitungs-Popup
                showDeleteConfirmPopup(articleToEdit); // Zeige Best√§tigungs-Popup
            }

            async function confirmDeleteArticle() {
                if (!articleToDelete) return;

                const name = articleToDelete.name;
                const barcode = articleToDelete.barcode;
                const platz = articleToDelete.placement_slot;
                
                // Haupttabelle L√∂schen
                const { error: deleteError } = await window.appSupabaseClient
                    .from('articles')
                    .delete()
                    .eq('id', articleToDelete.id); // L√∂sche anhand der ID

                if (deleteError) {
                    showToast("Fehler beim L√∂schen des Artikels.", 'error');
                    console.error("Delete Error:", deleteError);
                    hideDeleteConfirmPopup();
                    return;
                }
                
                // Log-Eintrag
                const logEntry = {
                    action_type: 'ARTICLE_DELETED',
                    description: `Artikel: ${name} (Barcode: ${barcode}) von Platz ${platz} gel√∂scht.`,
                    user_role: window.currentUserRole,
                    timestamp: new Date().toISOString(),
                };
                
                await window.appSupabaseClient.from('audit_log').insert([logEntry]);
                
                showToast(`Artikel "${name}" erfolgreich gel√∂scht.`, 'success', 5000);
                
                hideDeleteConfirmPopup();
                articleToDelete = null;
                
                // Artikelliste neu laden, falls wir im Listen-Tab sind
                if (currentTabId === 'listTab') {
                    loadArticleList();
                }
            }


            async function saveAdminEdit() {
                if (!articleToEdit) return;
                
                const newPlatz = document.getElementById('adminEditPlatz').value.trim().toUpperCase();

                if (!newPlatz) {
                    showToast("Bitte den Stellplatz eingeben.", 'error');
                    return;
                }
                
                const oldPlatz = articleToEdit.placement_slot;

                // Update in der Haupttabelle
                const { error: updateError } = await window.appSupabaseClient
                    .from('articles')
                    .update({ placement_slot: newPlatz })
                    .eq('id', articleToEdit.id);

                if (updateError) {
                    showToast("Fehler beim Speichern der Admin-√Ñnderung.", 'error');
                    console.error("Update Error:", updateError);
                    return;
                }

                // Log-Eintrag
                const logEntry = {
                    action_type: 'ARTICLE_UPDATED',
                    description: `Stellplatz von Artikel "${articleToEdit.name}" von ${oldPlatz} zu ${newPlatz} ge√§ndert.`,
                    user_role: window.currentUserRole,
                    timestamp: new Date().toISOString(),
                };
                
                await window.appSupabaseClient.from('audit_log').insert([logEntry]);
                
                showToast(`Stellplatz von ${articleToEdit.name} erfolgreich auf ${newPlatz} ge√§ndert.`, 'success', 5000);
                
                hideAdminEditPopup();
                
                // Artikelliste neu laden, falls wir im Listen-Tab sind
                if (currentTabId === 'listTab') {
                    loadArticleList();
                }
            }


            // --- ARTIKELLISTE & LOG ---

            async function loadArticleList() {
                const listContainer = document.getElementById('articleList');
                listContainer.innerHTML = '<li style="border-left: 5px solid rgba(255, 255, 255, 0.2); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">Lade Artikelliste...</li>'; 

                // DATENBANK-ABFRAGE (Selectiert Artikel sortiert nach Stellplatz)
                // Beachte: User haben nur Lesezugriff durch RLS-Policies
                const { data, error } = await window.appSupabaseClient
                    .from("articles") 
                    .select("id, barcode, name, placement_slot, block_warehouse")
                    .order("placement_slot", { ascending: true })
                    .limit(100); 
                    
                if (error) {
                    showToast("Fehler beim Laden der Artikelliste.", 'error');
                    console.error("Fehler beim Laden der Liste:", error);
                    listContainer.innerHTML = '<li style="color: var(--color-error-red); border-left: 5px solid var(--color-error-red); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">FEHLER: Die Artikelliste konnte nicht geladen werden.</li>';
                    return;
                }

                listContainer.innerHTML = ''; // Liste leeren
                
                if (data.length === 0) {
                    listContainer.innerHTML = '<li style="border-left: 5px solid rgba(255, 255, 255, 0.2); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">Keine Artikel im Inventar.</li>';
                    return;
                }
                
                // Sortierung (wird bereits in der Query gemacht, aber zur Sicherheit)
                // data.sort((a, b) => a.placement_slot.localeCompare(b.placement_slot));

                data.forEach(article => {
                    const isBlock = article.block_warehouse;
                    const iconHtml = isBlock 
                        ? `<div class="item-count" style="color: var(--color-accent-blue);">${WAREHOUSE_ICON_SVG}<span class="item-label">BLOCK</span></div>`
                        : `<div class="item-count" style="color: var(--color-accent-green);">${SHELF_ICON_SVG}<span class="item-label">REGAL</span></div>`;

                    const listItem = document.createElement('li');
                    // Admin d√ºrfen auf Listenelemente klicken, um sie zu bearbeiten
                    if (window.currentUserRole === 'admin') {
                         listItem.setAttribute('data-role', 'admin-editable');
                         // Speichert die Artikeldaten direkt im Element f√ºr das Bearbeitungs-Popup
                         listItem.onclick = () => showAdminEditPopup(article); 
                    }
                    
                    const details = `
                        <div class="item-details">
                            <strong>${article.name}</strong>
                            <span>Platz: ${article.placement_slot} | Barcode: ${article.barcode}</span>
                        </div>
                        ${iconHtml}
                    `;
                    listItem.innerHTML = details;
                    listContainer.appendChild(listItem);
                });
            }

            // --- LOG FUNKTION (KORRIGIERT) ---
            async function loadAdminLog() {
                const logListContainer = document.getElementById('logList');
                
                // NUR Admins d√ºrfen Log sehen
                if (window.currentUserRole !== 'admin') {
                    logListContainer.innerHTML = '<li style="color: var(--color-error-red); border-left: 5px solid var(--color-error-red); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">Zugriff verweigert. Nur Administratoren d√ºrfen das Protokoll einsehen.</li>';
                    return;
                }
                
                logListContainer.innerHTML = '<li style="border-left: 5px solid rgba(255, 255, 255, 0.2); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">Lade Admin-Protokoll...</li>'; 

                // DATENBANK-ABFRAGE
                // Best√§tigt: Tabelle hei√üt audit_log, Spalte hei√üt timestamp
                const { data, error } = await window.appSupabaseClient
                    .from("audit_log") 
                    .select("*")
                    .order("timestamp", { ascending: false })
                    .limit(50); 
                    
                if (error) {
                    showToast("Fehler beim Laden des Admin-Protokolls.", 'error');
                    console.error("Fehler beim Laden des Logs:", error);
                    logListContainer.innerHTML = '<li style="color: var(--color-error-red); border-left: 5px solid var(--color-error-red); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">FEHLER: Das Protokoll konnte nicht geladen werden. Bitte die `audit_log` Tabelle und RLS-Richtlinien pr√ºfen.</li>';
                    return;
                }

                logListContainer.innerHTML = ''; // Liste leeren
                
                if (data.length === 0) {
                    logListContainer.innerHTML = '<li style="border-left: 5px solid rgba(255, 255, 255, 0.2); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">Keine Protokolleintr√§ge vorhanden.</li>';
                    return;
                }

                data.forEach(item => {
                    // KORREKTUR: Verwende item.timestamp direkt, um den 'Invalid Date' Fehler zu vermeiden.
                    const dateSource = item.timestamp; 
                    const timestamp = new Date(dateSource).toLocaleString('de-DE', { dateStyle: 'short', timeStyle: 'medium' });
                    
                    let color = 'var(--color-accent-blue)';
                    if (item.action_type.includes('ADDED')) color = 'var(--color-accent-green)';
                    if (item.action_type.includes('DELETED')) color = 'var(--color-error-red)';
                    
                    const listItem = document.createElement('li');
                    listItem.style.borderLeft = `5px solid ${color}`;
                    
                    const details = `
                        <div class="item-details">
                            <strong style="font-size: 0.95rem; font-weight: 600;">${item.action_type.replace(/_/g, ' ')}</strong>
                            <span style="display: block; font-size: 0.85rem; opacity: 0.9; margin-top: 5px; line-height: 1.3;">${item.description}</span>
                            <span style="display: block; font-size: 0.75rem; opacity: 0.6; margin-top: 5px;">${timestamp} (Rolle: ${item.user_role || 'N/A'})</span>
                        </div>
                    `;
                    listItem.innerHTML = details;
                    logListContainer.appendChild(listItem);
                });
            }


            // --- INITIALISIERUNG & TABS ---

            function changeTab(targetTabId) {
                // Navigations-Buttons aktualisieren
                document.querySelectorAll('footer .nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('data-tab') === targetTabId) {
                        item.classList.add('active');
                    }
                });
                
                // Tab-Inhalte aktualisieren
                document.querySelectorAll('#tabContentContainer .tab-content').forEach(item => {
                    item.classList.remove('active');
                    if (item.id === targetTabId) {
                        item.classList.add('active');
                    }
                });

                currentTabId = targetTabId;
                hideResultCard();

                if (targetTabId === 'scannerTab') {
                    activateCamera();
                } else {
                    stopScanner();
                    
                    if (targetTabId === 'listTab') {
                        loadArticleList();
                    } else if (targetTabId === 'logTab') { // NEU: Log Tab
                        loadAdminLog();
                    }
                }
            }
            
            async function logout() {
                stopScanner();
                
                // Zur Login-Ansicht zur√ºck
                switchView('loginView');
                window.currentPin = "";
                window.currentUserRole = null; 
                updatePinIndicators();
                showToast("Erfolgreich abgemeldet.", 'info');
                lastCode = "";
                
                document.getElementById("userDisplay").innerText = ""; 
            }


            // Start der Anwendung
            window.onload = function() {
                checkLogin();
                updatePinIndicators(); // Setze Indikatoren auf 0
            };
        </script>

    </body>
    </html>