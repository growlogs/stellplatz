<!DOCTYPE html>
    <html lang="de">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Inventar Scanner Pro</title>

        <!-- Bibliotheken -->
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="https://unpkg.com/html5-qrcode"></script>

        <!-- Supabase Konfiguration -->
        <script>
            // ---------------------------------------------------------
            // KONFIGURATION: Supabase und Master-Code
            // ---------------------------------------------------------
            var APP_SUPABASE_URL = "https://sjhyvctidpnttqhenqoy.supabase.co";
            var APP_SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHl2Y3RpZHBudHRxaGVucW95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MzU3NTksImV4cCI6MjA4MDAxMTc1OX0.oXUA012J99W8fNNJi8Zxqn-2BUjf1QJOrXGYlPotaS4";
            var MASTER_ACCESS_CODE = "123456"; // <<<<<<<<<<<<<<< WICHTIG: Setzen Sie hier Ihren Code fest
            // ---------------------------------------------------------

            // Initialisierung
            (function() {
                if (window['supabase']) {
                    window.appSupabaseClient = window['supabase'].createClient(APP_SUPABASE_URL, APP_SUPABASE_KEY);
                } else {
                    window.appSupabaseClient = null;
                    console.error("Supabase-Client konnte nicht initialisiert werden.");
                }
                window.currentPin = ""; // Speichert den aktuell eingegebenen PIN-Code
            })();
        </script>

        <style>
            /* --- GLOBALE STYLES & FONT --- */
            :root {
                --color-bg-dark: #0a0b10; /* Noch dunklerer Hintergrund */
                --color-bg-card: #1d222e;
                --color-accent-blue: #007aff;
                --color-accent-green: #34c759;
                --color-error-red: #ff3b30;
                --color-border: rgba(255, 255, 255, 0.08);
                --transition-duration: 0.3s;
            }

            * {
                box-sizing: border-box;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            }

            body,
            html {
                margin: 0;
                padding: 0;
                background: var(--color-bg-dark);
                color: white;
                height: 100dvh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            /* --- LAYOUT & TRANSITIONEN --- */

            .app-view-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                transition: opacity var(--transition-duration) ease-in-out, transform var(--transition-duration) ease-in-out;
                opacity: 0;
                pointer-events: none;
                display: flex;
                flex-direction: column;
            }

            .app-view-container.active {
                opacity: 1;
                pointer-events: all;
            }

            /* Initial Zustand f√ºr Login, um den "Slide-In"-Effekt zu simulieren */
            #loginView {
                transform: translateY(0);
            }

            #appView {
                transform: translateY(100vh);
            }

            #loginView.active {
                transform: translateY(0);
            }

            #appView.active {
                transform: translateY(0);
            }
            
            /* Der Container f√ºr die Tabs */
            #tabContentContainer {
                flex-grow: 1;
                position: relative;
                overflow: hidden; /* Wichtig, um die Tabs im Container zu halten */
            }
            
            .tab-content {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: none;
                flex-direction: column;
            }
            
            .tab-content.active {
                display: flex;
            }


            /* --- HEADER --- */
            header {
                height: 55px;
                background: rgba(30, 30, 40, 0.9);
                backdrop-filter: blur(8px);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 15px;
                border-bottom: 1px solid var(--color-border);
                z-index: 10;
                flex-shrink: 0; /* Verhindert, dass der Header schrumpft */
            }

            header h1 {
                font-size: 1.1rem;
                font-weight: 600;
                margin: 0;
            }

            .header-button {
                padding: 5px 10px;
                font-size: 0.75em;
                background: rgba(255, 255, 255, 0.1);
                border: none;
                border-radius: 8px;
                color: white;
                cursor: pointer;
                transition: background 0.2s;
            }

            /* --- LOGIN VIEW --- */
            #loginView {
                justify-content: space-around;
                align-items: center;
                padding: 40px 20px;
            }

            .login-header {
                text-align: center;
                padding-top: 50px;
            }

            .app-icon {
                font-size: 3.5em;
                color: var(--color-accent-blue);
                margin-bottom: 15px;
            }

            .login-header h2 {
                font-size: 1.6rem;
                font-weight: 700;
                margin: 0;
            }

            #authError {
                color: var(--color-error-red);
                margin-top: 10px;
                height: 1.2em;
                font-weight: 500;
            }
            
            /* Ladezustand f√ºr Login */
            #loadingAuth {
                text-align: center;
                font-size: 1.1rem;
                opacity: 0.7;
                display: none; /* Wird dynamisch in JS angezeigt/versteckt */
                margin-top: 40px;
            }

            /* --- PIN INDICATORS --- */
            #pinIndicators {
                display: flex;
                gap: 15px;
                margin-bottom: 30px;
                height: 12px;
            }

            .pin-indicator {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                border: 2px solid rgba(255, 255, 255, 0.2);
                background: transparent;
                transition: background-color 0.2s, border-color 0.2s;
            }

            .pin-indicator.active {
                /* F√ºllung mit Gradient, um es etwas heller zu machen */
                background: var(--color-accent-blue);
                border-color: var(--color-accent-blue);
            }

            .pin-indicator.error {
                background: var(--color-error-red);
                border-color: var(--color-error-red);
                animation: shake 0.3s;
            }

            @keyframes shake {
                0%, 100% {
                    transform: translateX(0);
                }
                20%, 60% {
                    transform: translateX(-5px);
                }
                40%, 80% {
                    transform: translateX(5px);
                }
            }

            /* --- NEUES KEYPAD STYLING (CHIC) --- */
            #keypad {
                width: 100%;
                max-width: 380px;
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 20px; /* Mehr Abstand */
                padding-bottom: 50px;
            }

            .keypad-button {
                height: 80px; /* Etwas gr√∂√üer */
                width: 80px;
                justify-self: center; /* Zentriert die Tasten im Grid-Feld */
                border: 1px solid rgba(255, 255, 255, 0.05); /* Sehr feine, helle Linie */
                background: linear-gradient(145deg, rgba(30, 30, 40, 0.6), rgba(20, 20, 30, 0.6)); /* Dunkler Glass-Verlauf */
                backdrop-filter: blur(5px); /* Leichte Unsch√§rfe */
                color: white;
                border-radius: 50%;
                font-size: 1.8rem; /* Gr√∂√üere Schrift */
                font-weight: 500;
                cursor: pointer;
                transition: all 0.1s ease-out;
                /* Neumorphismus-Schatten f√ºr Tiefe */
                box-shadow: 
                    -5px -5px 15px rgba(255, 255, 255, 0.05), /* Heller innerer Schatten (oben/links) */
                    5px 5px 15px rgba(0, 0, 0, 0.6), /* Dunkler √§u√üerer Schatten (unten/rechts) */
                    inset 0 0 0 1px rgba(255, 255, 255, 0.03); /* Leichte Innenkontur */
                
                /* FIX: Entfernt den Standard-Fokus/Klick-Ring des Browsers */
                outline: none; 
                /* FIX: Entfernt das standardm√§√üige graue/blaue Overlay auf iOS/Android beim Tippen */
                -webkit-tap-highlight-color: transparent; 
            }

            .keypad-button:active {
                /* Simuliert den Druck auf die Taste */
                background: var(--color-bg-dark); /* Taster wird dunkler */
                transform: scale(0.95);
                box-shadow: 
                    2px 2px 5px rgba(0, 0, 0, 0.8) inset, /* Tiefer innerer Schatten */
                    -2px -2px 5px rgba(255, 255, 255, 0.01) inset, /* Heller innerer Schatten */
                    0 0 5px rgba(0, 122, 255, 0.3); /* Leichter Akzent-Gl√ºheffekt */
            }

            .keypad-button.action {
                /* Tasten f√ºr Aktionen (L√∂schen/Backspace) sind weniger prominent */
                background: transparent;
                box-shadow: none;
                opacity: 0.7;
                font-size: 1rem;
                font-weight: 400;
            }
            
            .keypad-button.action:active {
                background: rgba(255, 255, 255, 0.1);
            }

            .keypad-button.backspace svg {
                width: 28px;
                height: 28px;
                stroke: white;
            }

            /* --- APP VIEW / SCANNER --- */
            #scannerTab {
                position: relative;
                flex-grow: 1;
                /* Alle Inhalte, die nicht zum Scanner geh√∂ren, sind absolut positioniert */
            }
            
            #reader-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: black;
                overflow: hidden;
                display: flex;
                align-items: center;
                justify-content: center;
                /* √úbergang, damit es sanfter erscheint */
                transition: all 0.5s ease;
            }
            
            /* FIX: Sorgt daf√ºr, dass das Video das Container-Element ausf√ºllt */
            #reader video {
                width: 100% !important;
                height: 100% !important;
                object-fit: cover; 
            }

            /* Visual frame for scanning */
            .scan-frame {
                position: absolute;
                width: 250px;
                height: 250px;
                border: 2px solid var(--color-accent-green);
                box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
                pointer-events: none;
                z-index: 2;
                animation: scan-pulse 1.5s infinite alternate;
            }

            @keyframes scan-pulse {
                from {
                    border-color: var(--color-accent-green);
                    box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
                }
                to {
                    border-color: #50C9C3;
                    box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.7);
                }
            }

            #preScan {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                background: rgba(15, 15, 15, 0.98);
                text-align: center;
                z-index: 5;
                padding: 20px;
            }

            /* --- RESULT / DETAIL CARD (Pull-Up) --- */
            #result-card {
                background: var(--color-bg-card);
                border-top-left-radius: 20px;
                border-top-right-radius: 20px;
                padding: 20px;
                position: absolute;
                bottom: 0;
                width: 100%;
                min-height: 120px; /* Start-H√∂he */
                max-height: 80%;
                box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.6);
                transition: transform 0.4s ease-out;
                transform: translateY(0); /* Standardzustand */
                z-index: 50;
            }

            #result-card.hidden {
                transform: translateY(100%);
            }

            #result-content {
                font-size: 1em;
                text-align: left;
                padding: 5px 0;
                opacity: 0.8;
                transition: opacity 0.3s;
            }

            .result-title {
                font-size: 1.2rem;
                font-weight: 700;
                margin-bottom: 5px;
                color: var(--color-accent-blue);
            }
            
            /* --- TOAST NOTIFICATIONS (Professional Feedback) --- */
            #toastContainer {
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 1000;
                display: flex;
                flex-direction: column;
                align-items: center;
                pointer-events: none;
            }

            .toast {
                background: rgba(30, 30, 40, 0.95);
                color: white;
                padding: 10px 20px;
                border-radius: 10px;
                margin-bottom: 10px;
                opacity: 0;
                transform: translateY(20px);
                transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                font-size: 0.95rem;
                font-weight: 500;
            }

            .toast.show {
                opacity: 1;
                transform: translateY(0);
            }

            .toast-icon {
                margin-right: 10px;
                font-size: 1.2em;
            }
            
            .toast.success .toast-icon { color: var(--color-accent-green); }
            .toast.error .toast-icon { color: var(--color-error-red); }
            .toast.info .toast-icon { color: var(--color-accent-blue); }

            /* --- POPUP (MODAL) STYLES --- */
            #popup {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 100;
                justify-content: center;
                align-items: center;
                opacity: 0;
                transition: opacity 0.3s;
            }
            
            #popup.visible {
                display: flex;
                opacity: 1;
            }

            #popupBox {
                background: var(--color-bg-card);
                padding: 25px;
                border-radius: 15px;
                width: 90%;
                max-width: 400px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
                transform: scale(0.9);
                transition: transform 0.3s ease-out;
            }
            
            #popup.visible #popupBox {
                transform: scale(1);
            }
            
            #popupBox h3 {
                margin-top: 0;
                border-bottom: 1px solid var(--color-border);
                padding-bottom: 10px;
                font-weight: 600;
                color: var(--color-accent-blue);
            }

            /* --- INPUT & BUTTON STYLES (GENERAL) --- */
            input[type="text"], input[type="search"], select { /* SELECT HINZUGEF√úGT */
                width: 100%;
                padding: 12px;
                margin: 8px 0 15px 0;
                background: #2a303f;
                border: 1px solid #3e4453;
                color: white;
                border-radius: 8px;
                font-size: 16px;
                transition: border-color 0.3s;
            }

            input:focus, select:focus {
                border-color: var(--color-accent-blue);
                outline: none;
            }
            
            /* Spezielles Styling f√ºr das Select-Element */
            select {
                /* Entfernt Standard-Pfeile */
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                /* F√ºgt benutzerdefiniertes Pfeil-Icon hinzu (SVG in base64) */
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='white'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z' clip-rule='evenodd'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 15px center;
                background-size: 1.2em;
            }


            button {
                padding: 12px 20px;
                border: none;
                border-radius: 10px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                color: white;
                transition: all 0.2s ease;
                user-select: none;
            }
            
            .primary-button {
                width: 100%;
                margin-top: 15px;
                background: linear-gradient(135deg, var(--color-accent-blue) 0%, #00aaff 100%);
                box-shadow: 0 4px 15px rgba(0, 122, 255, 0.4);
            }
            
            .primary-button:active {
                box-shadow: 0 2px 5px rgba(0, 122, 255, 0.6);
                transform: scale(0.98);
            }

            .secondary-button {
                width: 100%;
                margin-top: 10px;
                background: var(--color-bg-dark);
                border: 1px solid var(--color-border);
                box-shadow: none;
            }
            
            /* --- BOTTOM NAVIGATION & TABS --- */
            #navBar {
                display: flex;
                height: 60px;
                background: rgba(30, 30, 40, 0.9);
                backdrop-filter: blur(8px);
                border-top: 1px solid var(--color-border);
                flex-shrink: 0;
                z-index: 20;
            }

            .nav-item {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: rgba(255, 255, 255, 0.5);
                font-size: 0.8rem;
                cursor: pointer;
                transition: color 0.2s;
            }

            .nav-item.active {
                color: var(--color-accent-blue);
            }

            .nav-item svg {
                width: 24px;
                height: 24px;
                stroke: currentColor;
                fill: none;
                stroke-width: 2;
                margin-bottom: 2px;
            }
            
            /* --- ARTIKEL LIST VIEW STYLES --- */
            #listTab {
                overflow-y: auto;
                padding: 15px 15px 20px 15px;
                height: 100%;
            }

            #articleSearch {
                margin-top: 0;
                margin-bottom: 20px;
                background: #2a303f;
                border-color: #3e4453;
                box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
            }

            .article-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                background: var(--color-bg-card);
                border-radius: 12px;
                margin-bottom: 10px;
                transition: transform 0.2s, box-shadow 0.2s;
                border-left: 5px solid var(--color-bg-card);
            }
            
            .article-item.block {
                 border-left-color: #50C9C3; /* Leichterer Akzent f√ºr Blocklager */
            }
            
            .article-item-details strong {
                font-size: 1.1rem;
                font-weight: 600;
                display: block;
                margin-bottom: 4px;
                color: white;
            }

            .article-item-details span {
                font-size: 0.85rem;
                opacity: 0.7;
                display: block;
            }

            .article-item-scans {
                text-align: right;
            }
            
            .article-item-scans .count {
                font-size: 1.2rem;
                font-weight: 700;
                color: var(--color-accent-green);
                display: block;
            }
            
            .article-item-scans .label {
                font-size: 0.75rem;
                opacity: 0.6;
            }
        </style>
    </head>

    <body>

        <!-- TOAST/NOTIFICATION CONTAINER -->
        <div id="toastContainer"></div>

        <!-- LOGIN SCREEN (PIN EINGABE) -->
        <div id="loginView" class="app-view-container active">
            <div class="login-header">
                <div class="app-icon">üîê</div>
                <h2>Inventar Zugang</h2>
                <div id="authError"></div>
            </div>

            <div id="loadingAuth">
                Authentifiziere Session...
            </div>

            <!-- PIN Indikatoren & Keypad (Wird erst nach Session-Check angezeigt) -->
            <div id="authContent" style="display: none; align-items: center; flex-direction: column;">
                <!-- PIN Indikatoren -->
                <div id="pinIndicators">
                    <div class="pin-indicator" data-index="0"></div>
                    <div class="pin-indicator" data-index="1"></div>
                    <div class="pin-indicator" data-index="2"></div>
                    <div class="pin-indicator" data-index="3"></div>
                    <div class="pin-indicator" data-index="4"></div>
                    <div class="pin-indicator" data-index="5"></div>
                </div>

                <!-- Keypad -->
                <div id="keypad" oncontextmenu="return false;">
                    <button class="keypad-button" onclick="handlePinInput('1')">1</button>
                    <button class="keypad-button" onclick="handlePinInput('2')">2</button>
                    <button class="keypad-button" onclick="handlePinInput('3')">3</button>

                    <button class="keypad-button" onclick="handlePinInput('4')">4</button>
                    <button class="keypad-button" onclick="handlePinInput('5')">5</button>
                    <button class="keypad-button" onclick="handlePinInput('6')">6</button>

                    <button class="keypad-button" onclick="handlePinInput('7')">7</button>
                    <button class="keypad-button" onclick="handlePinInput('8')">8</button>
                    <button class="keypad-button" onclick="handlePinInput('9')">9</button>

                    <!-- Aktionen -->
                    <button class="keypad-button action" onclick="handlePinInput('clear')">L√ñSCHEN</button>
                    <button class="keypad-button" onclick="handlePinInput('0')">0</button>
                    <button class="keypad-button action backspace" onclick="handlePinInput('backspace')">
                        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 5H9L3 12L9 19H21V5Z" stroke-width="2" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- APP SCREEN (SCANNER & LISTE) -->
        <div id="appView" class="app-view-container">
            <header>
                <h1>Lager Scanner Pro</h1>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 0.8em; opacity: 0.7;" id="userDisplay">ANONYM</span>
                    <button class="header-button" onclick="logout()">Logout</button>
                </div>
            </header>

            <!-- TAB CONTAINER (Inhalt) -->
            <div id="tabContentContainer">
                
                <!-- Tab 1: Scanner -->
                <div id="scannerTab" class="tab-content active">
                    
                    <!-- Scanner Bereich -->
                    <div id="reader-container">
                        <div id="reader"></div>
                        <div class="scan-frame" id="scanFrame" style="display:none;"></div>

                        <!-- Start Button Overlay -->
                        <div id="preScan">
                            <div style="font-size: 4em; margin-bottom: 20px;">üì¶</div>
                            <h2>Scanner bereit</h2>
                            <p style="opacity: 0.7; margin-bottom: 30px;">Kamera-Zugriff starten, um loszulegen.</p>
                            <button class="primary-button" style="max-width: 250px;" onclick="activateCamera()">SCAN STARTEN</button>
                        </div>
                    </div>

                    <!-- Ergebnis Karte (Pull-Up) -->
                    <div id="result-card" class="hidden">
                        <div id="result-content">
                            <!-- Dynamischer Inhalt hier -->
                        </div>
                    </div>

                    <!-- Popup f√ºr neue Artikel -->
                    <div id="popup">
                        <div id="popupBox">
                            <h3>Artikel anlegen (Barcode: <span id="popupBarcode"></span>)</h3>
                            
                            <!-- NEU: Basis-Name -->
                            <label for="baseName">Basis-Name:</label>
                            <input id="baseName" placeholder="z.B. Fanta" autocomplete="off" type="text">
                            
                            <!-- NEU: Gr√∂√üe/Volumen Dropdown -->
                            <label for="volume">Gr√∂√üe/Volumen:</label>
                            <select id="volume">
                                <option value="1.0L">1.0L</option>
                                <option value="0.5L">0.5L</option>
                                <option value="0.33L">0.33L</option>
                                <option value="2.0L">2.0L</option>
                                <option value="0.2L">0.2L</option>
                            </select>
                            
                            <!-- NEU: Material Dropdown -->
                            <label for="material">Material:</label>
                            <select id="material">
                                <option value="PET">PET</option>
                                <option value="Glas">Glas</option>
                                <option value="Dose">Dose</option>
                                <option value="Karton">Karton</option>
                            </select>
                            
                            <!-- Stellplatz (Platzhalter f√ºr das alte Name-Feld war "name") -->
                            <label for="platz">Stellplatz:</label>
                            <input id="platz" placeholder="z.B. A-01" autocomplete="off" type="text">
                            
                            <label style="display: flex; align-items: center; margin: 15px 0 20px 0; font-size: 0.9em; opacity: 0.8;">
                                <input type="checkbox" id="block" style="width: auto; margin-right: 10px; accent-color: var(--color-accent-blue);"> Blocklager
                            </label>
                            <button class="primary-button" onclick="save()">Speichern</button>
                            <button class="secondary-button" onclick="hidePopup()">Abbrechen</button>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Artikelliste (NEU) -->
                <div id="listTab" class="tab-content">
                    <input type="search" id="articleSearch" placeholder="Artikel, Barcode oder Stellplatz suchen..." oninput="handleSearchInput()">
                    <div id="articleList">
                        <p style="text-align: center; opacity: 0.5; margin-top: 40px;">Lade Artikel...</p>
                    </div>
                </div>

            </div>
            
            <!-- Bottom Navigation Bar (NEU) -->
            <nav id="navBar">
                <div class="nav-item active" data-tab="scannerTab" onclick="switchTab('scannerTab')">
                    <svg viewBox="0 0 24 24"><path d="M4 8V6C4 5.44772 4.44772 5 5 5H8" /><path d="M4 16V18C4 18.5523 4.44772 19 5 19H8" /><path d="M16 5H19C19.5523 5 20 5.44772 20 6V8" /><path d="M16 19H19C19.5523 19 20 18.5523 20 18V16" /><line x1="8" y1="12" x2="16" y2="12" /></svg>
                    <span>Scanner</span>
                </div>
                <div class="nav-item" data-tab="listTab" onclick="switchTab('listTab')">
                    <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
                    <span>Artikel</span>
                </div>
            </nav>
        </div>

        <script>
            var lastCode = "";
            var html5QrCode = null;
            var currentUserId = null;
            var currentTabId = 'scannerTab'; // Start-Tab
            var searchTimeout; // F√ºr Debouncing der Suche
            var isAuthReady = false; // Steuert, ob die PIN-Eingabe erlaubt ist

            // --- HILFSFUNKTIONEN ---

            /**
             * Zeigt eine tempor√§re, nicht-blockierende Nachricht an.
             * @param {string} message - Die anzuzeigende Nachricht.
             * @param {string} type - 'success', 'error', oder 'info'.
             * @param {number} duration - Anzeigedauer in ms.
             */
            function showToast(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                let icon = '‚ÑπÔ∏è';
                if (type === 'success') icon = '‚úÖ';
                if (type === 'error') icon = '‚ùå';

                toast.innerHTML = `<span class="toast-icon">${icon}</span>${message}`;
                container.appendChild(toast);

                // Trigger CSS transition
                setTimeout(() => toast.classList.add('show'), 10);

                // Hide and remove after duration
                setTimeout(() => {
                    toast.classList.remove('show');
                    // Allow transition to finish before removal
                    toast.addEventListener('transitionend', () => toast.remove());
                }, duration);
            }

            // --- PIN-FELD LOGIK ---

            function updatePinIndicators(isError = false) {
                const indicators = document.querySelectorAll('.pin-indicator');
                indicators.forEach((indicator, index) => {
                    indicator.classList.remove('active', 'error');
                    if (isError) {
                        indicator.classList.add('error');
                    } else if (index < window.currentPin.length) {
                        indicator.classList.add('active');
                    }
                });
            }

            async function handlePinInput(value) {
                // Sperre die Eingabe, bis der initiale Auth-Check abgeschlossen ist
                if (!isAuthReady) {
                    showToast("Bitte warten Sie, bis die Session gepr√ºft wurde.", 'info', 1500);
                    return;
                }

                document.getElementById("authError").innerText = ""; // Fehler zur√ºcksetzen

                if (value === 'backspace') {
                    window.currentPin = window.currentPin.slice(0, -1);
                } else if (value === 'clear') {
                    window.currentPin = "";
                } else if (value.match(/[0-9]/) && window.currentPin.length < MASTER_ACCESS_CODE.length) {
                    window.currentPin += value;
                }

                updatePinIndicators();

                if (window.currentPin.length === MASTER_ACCESS_CODE.length) {
                    await loginWithCode(window.currentPin);
                }
            }

            // --- UI STATUS FUNKTIONEN ---
            
            /**
             * Zeigt die Ergebnis-Karte an und bef√ºllt sie mit Inhalt.
             */
            function showResultCard(title, content) {
                const card = document.getElementById("result-card");
                const resultContent = document.getElementById("result-content");
                
                resultContent.innerHTML = `<div class="result-title">${title}</div>${content}`;
                card.classList.remove("hidden");
            }
            
            /**
             * Versteckt die Ergebnis-Karte.
             */
            function hideResultCard() {
                document.getElementById("result-card").classList.add("hidden");
            }


            // --- KAMERA UND SCANNER LOGIK ---
            function activateCamera() {
                document.getElementById("preScan").style.display = "none";
                document.getElementById("scanFrame").style.display = "block";
                startScanner();
            }

            function startScanner() {
                // Nur starten, wenn Scanner-Tab aktiv ist
                if (currentTabId !== 'scannerTab') return; 
                
                // Verhindert mehrfaches Starten
                if (html5QrCode && html5QrCode.isScanning) return;
                
                hideResultCard(); // Verstecke die Karte beim Scann-Start

                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0
                };
                const readerElementId = "reader";
                const videoConstraints = { facingMode: "environment" };

                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode(readerElementId);
                }
                
                html5QrCode.start(videoConstraints, config, onScanSuccess)
                    .catch(err => {
                        // Wichtig: Zeige das Overlay wieder, falls der Start fehlschl√§gt
                        document.getElementById("preScan").style.display = "flex";
                        document.getElementById("scanFrame").style.display = "none";
                        showToast("Kamera Fehler: Zugriff verweigert oder Ger√§t nicht gefunden.", 'error', 4000);
                        console.error("Scanner Start Fehler:", err);
                    });
            }
            
            async function stopScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    try {
                         await html5QrCode.stop();
                         // Wichtig: Visuals zur√ºcksetzen, falls die Kamera gestoppt wird
                         document.getElementById("preScan").style.display = "flex";
                         document.getElementById("scanFrame").style.display = "none";
                    } catch (err) {
                        console.warn("Kamera Stoppen fehlgeschlagen:", err);
                    }
                }
            }


            async function onScanSuccess(code) {
                if (code === lastCode) return;
                lastCode = code; 

                if (html5QrCode) html5QrCode.pause();
                showToast("üîç Scanne Barcode...", 'info', 1500);

                if (!window.appSupabaseClient) {
                    showToast("Datenbank nicht verbunden.", "error");
                    // Scanner nach kurzem Warten wieder starten
                    setTimeout(() => { lastCode = ""; if (html5QrCode) html5QrCode.resume(); }, 2000);
                    return;
                }

                // --- Datenbank-Abfrage mit Retry ---
                const MAX_RETRIES = 3;
                let data = null;
                let error = null;

                for (let i = 0; i < MAX_RETRIES; i++) {
                    const result = await window.appSupabaseClient
                        .from("artikel")
                        .select("*")
                        .eq("barcode", code)
                        .single();

                    data = result.data;
                    error = result.error;

                    if (data || !error || error.code !== '500') break; // Erfolg oder nicht-serverbedingter Fehler
                    const delay = Math.pow(2, i) * 100;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }

                if (data) {
                    // Artikel gefunden
                    const newScans = data.scans + 1;
                    
                    // Update Scan-Z√§hler
                    const { error: updateError } = await window.appSupabaseClient
                        .from("artikel")
                        .update({ scans: newScans })
                        .eq("barcode", code);

                    if (updateError) {
                        console.error("Update Fehler:", updateError);
                    }

                    showResultCard(
                        data.name,
                        `<p><strong>Stellplatz:</strong> ${data.stellplatz}</p>
                        <p><strong>Typ:</strong> ${data.blocklager ? 'Blocklager' : 'Regal'}</p>
                        <p><strong>Scans:</strong> ${newScans}</p>`
                    );
                    showToast(`Artikel "${data.name}" gefunden!`, "success", 2500);

                    // Scanner nach Pause wieder starten
                    setTimeout(() => {
                        lastCode = "";
                        if (html5QrCode) html5QrCode.resume();
                    }, 3000);
                    
                } else {
                    // Artikel nicht gefunden -> Popup anzeigen
                    document.getElementById("popupBarcode").innerText = code;
                    document.getElementById("popup").classList.add('visible');
                    document.getElementById("baseName").focus(); // Fokus auf das erste Feld
                }
            }

            // --- POPUP LOGIK ---
            function hidePopup() {
                document.getElementById("popup").classList.remove('visible');
                
                // Felder zur√ºcksetzen
                document.getElementById("baseName").value = "";
                document.getElementById("volume").value = "1.0L";
                document.getElementById("material").value = "PET";
                document.getElementById("platz").value = "";
                document.getElementById("block").checked = false;

                // Scanner wieder starten
                lastCode = "";
                if (html5QrCode) html5QrCode.resume();
            }

            async function save() {
                const barcode = document.getElementById("popupBarcode").innerText;
                const baseName = document.getElementById("baseName").value.trim();
                const volume = document.getElementById("volume").value;
                const material = document.getElementById("material").value;
                const platz = document.getElementById("platz").value.trim();
                const block = document.getElementById("block").checked;
                
                // Generiere den vollst√§ndigen Namen f√ºr die Datenbank
                const name = `${baseName} ${volume} (${material})`;

                if (!baseName || !platz) {
                    showToast("Bitte Basis-Name und Stellplatz ausf√ºllen.", "error");
                    return;
                }

                const result = await window.appSupabaseClient.from("artikel").insert([{
                    barcode: barcode,
                    name: name, // Verwende den generierten Namen
                    stellplatz: platz,
                    blocklager: block,
                    scans: 1
                }]);

                if (result.error) {
                    showToast(`FEHLER beim Speichern.`, "error");
                } else {
                    hidePopup();
                    showToast(`Artikel "${name}" erfolgreich gespeichert.`, "success");
                    showResultCard(
                        name,
                        `<p><strong>Stellplatz:</strong> ${platz}</p>
                        <p><strong>Typ:</strong> ${block ? 'Blocklager' : 'Regal'}</p>
                        <p><strong>Scans:</strong> 1</p>`
                    );
                    // Artikel-Liste im Hintergrund neu laden, falls aktiv
                    if (currentTabId === 'listTab') loadArticleList(document.getElementById('articleSearch').value);
                }
            }

            // --- ARTIKELLISTE LOGIK (NEU) ---
            
            /**
             * Rendert die Artikel-Liste ins DOM.
             * @param {Array} articles - Array von Artikel-Objekten.
             */
            function renderArticleList(articles) {
                const listContainer = document.getElementById('articleList');
                listContainer.innerHTML = '';
                
                if (articles.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center; opacity: 0.5; margin-top: 40px;">Keine Artikel gefunden.</p>';
                    return;
                }
                
                articles.forEach(article => {
                    const item = document.createElement('div');
                    item.className = `article-item ${article.blocklager ? 'block' : ''}`;
                    
                    // ACHTUNG: Der Artikel ben√∂tigt keine 'id' f√ºr die Anzeige
                    item.innerHTML = `
                        <div class="article-item-details">
                            <strong>${article.name}</strong>
                            <span>Stellplatz: ${article.stellplatz} | Barcode: ${article.barcode}</span>
                        </div>
                        <div class="article-item-scans">
                            <span class="count">${article.scans}</span>
                            <span class="label">Scans</span>
                        </div>
                    `;
                    listContainer.appendChild(item);
                });
            }
            
            /**
             * L√§dt die Artikelliste von Supabase.
             * @param {string} searchTerm - Optionaler Suchbegriff.
             */
            async function loadArticleList(searchTerm = '') {
                if (!window.appSupabaseClient) return;

                let query = window.appSupabaseClient
                    // ENTFERNT: 'id' aus der SELECT-Liste, da die Spalte im Schema des Benutzers nicht existiert.
                    .from("artikel")
                    .select("name, stellplatz, barcode, blocklager, scans"); 

                if (searchTerm.length > 0) {
                    // Suche in Name, Barcode und Stellplatz (case-insensitive)
                    const search = `%${searchTerm.toLowerCase()}%`;
                    query = query.or(`name.ilike.${search},barcode.ilike.${search},stellplatz.ilike.${search}`);
                }
                
                // Sortierung nach Name, damit die Liste konsistent ist
                query = query.order('name', { ascending: true });

                const { data, error } = await query;

                if (error) {
                    console.error("Fehler beim Laden der Artikel:", error);
                    renderArticleList([]);
                    showToast("Fehler beim Laden der Artikelliste.", "error");
                    return;
                }
                
                renderArticleList(data || []);
            }
            
            /**
             * Debounced Funktion f√ºr die Suche.
             */
            function handleSearchInput() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const searchTerm = document.getElementById('articleSearch').value.trim();
                    loadArticleList(searchTerm);
                }, 300); // 300ms Verz√∂gerung f√ºr fl√ºssige Eingabe
            }

            // --- AUTHENTIFIZIERUNG & NAVIGATION ---

            /**
             * Wechselt die aktiven Tabs und die Navigationselemente.
             */
            function switchTab(targetTabId) {
                if (targetTabId === currentTabId) return; // Bereits aktiv
                
                // Tabs verwalten
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.getElementById(targetTabId).classList.add('active');

                // Navigation verwalten
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('data-tab') === targetTabId) {
                        item.classList.add('active');
                    }
                });

                currentTabId = targetTabId;
                
                // Logik basierend auf dem neuen Tab
                if (targetTabId === 'scannerTab') {
                    // Wenn der Scanner-Tab aktiv wird, starte die Kamera
                    activateCamera(); // Ruft activateCamera auf, um Overlay zu verstecken und startScanner zu rufen
                } else {
                    // Wenn ein anderer Tab aktiv wird, stoppe die Kamera
                    stopScanner();
                    hideResultCard();
                    if (targetTabId === 'listTab') {
                        // Lade die Liste nur, wenn der Tab zum ersten Mal ge√∂ffnet wird oder der Suchbegriff leer ist
                        loadArticleList(document.getElementById('articleSearch').value.trim());
                    }
                }
            }


            /**
             * Wechselt die Haupt-Ansicht mit sanfter Animation.
             */
            function switchView(targetViewId) {
                const loginView = document.getElementById('loginView');
                const appView = document.getElementById('appView');

                if (targetViewId === 'appView') {
                    loginView.classList.remove('active');
                    appView.classList.add('active');
                    // Sicherstellen, dass der Scanner-Tab aktiv ist und die Kamera initialisiert
                    switchTab('scannerTab'); 
                } else {
                    appView.classList.remove('active');
                    loginView.classList.add('active');
                }
            }
            
            /**
             * Meldet den Benutzer ab und l√§dt die Seite neu.
             */
            async function logout() {
                if (!window.appSupabaseClient) {
                    window.location.reload();
                    return;
                }

                // Kamera stoppen
                await stopScanner();

                await window.appSupabaseClient.auth.signOut();
                window.location.reload(); // Erzwingt den sauberen Start in der Login-Ansicht
            }

            async function loginWithCode(enteredCode) {
                if (!window.appSupabaseClient) {
                    document.getElementById("authError").innerText = "Datenbank nicht bereit.";
                    updatePinIndicators(true);
                    window.currentPin = "";
                    return;
                }
                
                // Setze isAuthReady tempor√§r auf false, um Doppel-Logins w√§hrend der √úberpr√ºfung zu vermeiden
                isAuthReady = false; 
                document.getElementById("authContent").style.display = "none";
                document.getElementById("loadingAuth").style.display = "block";


                if (enteredCode === MASTER_ACCESS_CODE) {
                    try {
                        // Da der Benutzer bereits eine Session haben k√∂nnte (durch das Neuladen),
                        // ist signInAnonymously() riskant. Wir m√ºssen den Erfolg abwarten und
                        // das Error-Handling verbessern.
                        const { data, error } = await window.appSupabaseClient.auth.signInAnonymously();

                        if (error || !data.user) {
                            document.getElementById("authError").innerText = "Anmeldefehler. Pr√ºfen Sie die Konfiguration.";
                            updatePinIndicators(true);
                        } else {
                            showToast("Login erfolgreich!", "success");
                            switchView('appView');
                            currentUserId = data.user.id;
                            document.getElementById("userDisplay").innerText = "ANONYM (ID: " + currentUserId.substring(0, 4) + ")";
                            // WICHTIG: PIN wird nur bei Erfolg oder nach Fehlerausgabe zur√ºckgesetzt
                        }
                    } catch (e) {
                        console.error("Kritischer Anmeldefehler:", e);
                        document.getElementById("authError").innerText = "Kritischer Fehler.";
                        updatePinIndicators(true);
                    }
                } else {
                    document.getElementById("authError").innerText = "Falscher Code.";
                    updatePinIndicators(true);
                }
                
                // Cleanup nach dem Login-Versuch (Erfolg oder Misserfolg)
                setTimeout(() => {
                    window.currentPin = "";
                    updatePinIndicators();
                    // Zeige AuthContent wieder, falls nicht zur App gewechselt wurde
                    if (document.getElementById('appView').classList.contains('active')) {
                        document.getElementById("loadingAuth").style.display = "none";
                    } else {
                        document.getElementById("authContent").style.display = "flex";
                        document.getElementById("loadingAuth").style.display = "none";
                        isAuthReady = true; // Freigeben f√ºr neuen Versuch
                    }
                }, 500);

            }

            /**
             * √úberpr√ºft den Anmeldestatus beim Laden und navigiert.
             */
            async function checkLogin() {
                const loadingIndicator = document.getElementById("loadingAuth");
                const authContent = document.getElementById("authContent");

                if (!window.appSupabaseClient) {
                    document.getElementById("authError").innerText = "‚ö†Ô∏è Supabase nicht verbunden.";
                    loadingIndicator.style.display = "none";
                    authContent.style.display = "flex";
                    isAuthReady = true;
                    return;
                }
                
                loadingIndicator.style.display = "block";
                authContent.style.display = "none";

                // Warten auf die Session-Pr√ºfung von Supabase
                const { data } = await window.appSupabaseClient.auth.getSession();
                const currentSession = data.session;
                
                // Session-Check beendet
                isAuthReady = true;
                loadingIndicator.style.display = "none";


                if (currentSession) {
                    currentUserId = currentSession.user.id;
                    switchView('appView');
                    document.getElementById("userDisplay").innerText = "ANONYM (ID: " + currentUserId.substring(0, 4) + ")";
                    hideResultCard();
                    loadArticleList();
                } else {
                    switchView('loginView');
                    currentUserId = null;
                    authContent.style.display = "flex"; // Zeige Keypad, da keine Session gefunden wurde
                }
            }

            // Start der Anwendung
            window.onload = function() {
                // Keine onAuthStateChange-Listener mehr, da checkLogin jetzt die Hauptlogik steuert
                checkLogin();
                updatePinIndicators(); // Setze Indikatoren auf 0
            };
        </script>

    </body>
    </html>