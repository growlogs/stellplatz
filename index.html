<!DOCTYPE html>
    <html lang="de">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Inventar Scanner Pro</title>

        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="https://unpkg.com/html5-qrcode"></script>

        <script>
            // ---------------------------------------------------------
            // KONFIGURATION
            // ---------------------------------------------------------
            var APP_SUPABASE_URL = "https://sjhyvctidpnttqhenqoy.supabase.co"; 
            var APP_SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHl2Y3RpZHBudHRxaGVucW95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MzU3NTksImV4cCI6MjA4MDAxMTc1OX0.oXUA012J99W8fNNJi8Zxqn-2BUjf1QJOrXGYlPotaS4"; 
            
            // Initialisierung
            (function() {
                if (window['supabase']) {
                    window.appSupabaseClient = window['supabase'].createClient(APP_SUPABASE_URL, APP_SUPABASE_KEY);
                } else {
                    window.appSupabaseClient = null;
                    console.error("Supabase-Client konnte nicht initialisiert werden.");
                }
                window.lastCode = ""; 
                window.currentTabId = "scannerTab"; 
                window.currentUserRole = null; 
            })();
        </script>

        <style>
            /* --- GLOBALE STYLES & FONT --- */
            :root {
                --color-bg-dark: #0a0b10;
                --color-bg-card: #1d222e;
                --color-accent-blue: #007aff;
                --color-accent-green: #34c759;
                --color-error-red: #ff3b30;
                --color-border: rgba(255, 255, 255, 0.08);
                --transition-duration: 0.3s;
                --color-warning-yellow: #ffcc00; 
            }

            * {
                box-sizing: border-box;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            }

            body,
            html {
                margin: 0;
                padding: 0;
                background: var(--color-bg-dark);
                color: white;
                height: 100dvh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            /* --- LAYOUT & TRANSITIONEN --- */

            .app-view-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                transition: opacity var(--transition-duration) ease-in-out, transform var(--transition-duration) ease-in-out;
                opacity: 0;
                pointer-events: none;
                display: flex;
                flex-direction: column;
            }

            .app-view-container.active {
                opacity: 1;
                pointer-events: all;
            }

            #loginView {
                transform: translateY(0);
            }

            #appView {
                transform: translateY(100vh);
            }

            #loginView.active {
                transform: translateY(0);
            }

            #appView.active {
                transform: translateY(0);
            }
            
            #tabContentContainer {
                flex-grow: 1;
                position: relative;
                overflow: hidden; 
            }
            
            .tab-content {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: none !important; 
                flex-direction: column;
                overflow-y: auto; 
                background: var(--color-bg-dark); 
            }
            
            .tab-content.active {
                display: flex !important; 
            }


            /* --- HEADER --- */
            header {
                height: 55px;
                background: rgba(30, 30, 40, 0.9);
                backdrop-filter: blur(8px);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 15px;
                border-bottom: 1px solid var(--color-border);
                z-index: 10;
                flex-shrink: 0; 
            }

            header h1 {
                font-size: 1.1rem;
                font-weight: 600;
                margin: 0;
            }

            .header-button {
                padding: 5px 10px;
                font-size: 0.75em;
                background: rgba(255, 255, 255, 0.1);
                border: none;
                border-radius: 8px;
                color: white;
                cursor: pointer;
                transition: background 0.2s;
            }

             /* NEU: Icon Button f√ºr Settings */
            .header-icon-btn {
                background: none; border: none;
                font-size: 1.5rem; cursor: pointer;
                padding: 0 10px; margin-right: 5px;
                transition: transform 0.2s;
            }
            .header-icon-btn:active { transform: scale(0.9); }


            /* --- LOGIN VIEW --- */
            #loginView {
                justify-content: space-around;
                align-items: center;
                padding: 40px 20px;
                text-align: center;
            }

            .login-header {
                text-align: center;
                padding-top: 50px;
            }

            .app-icon {
                font-size: 3.5em;
                color: var(--color-accent-blue);
                margin-bottom: 15px;
            }

            .login-header h2 {
                font-size: 1.6rem;
                font-weight: 700;
                margin: 0;
            }

            #authError {
                color: var(--color-error-red);
                margin-top: 10px;
                height: 1.2em;
                font-weight: 500;
            }
            
            #loadingAuth {
                text-align: center;
                font-size: 1.1rem;
                opacity: 0.7;
                display: none; 
                margin-top: 40px;
            }

            #authForm {
                width: 100%;
                max-width: 320px;
                margin-top: 50px;
                display: none; 
            }
            
            #authForm .input-group input {
                width: 100%;
                padding: 12px;
                border-radius: 8px;
                border: 1px solid var(--color-border);
                background: var(--color-bg-card);
                color: white;
                font-size: 1rem;
                margin-bottom: 15px;
            }
            
            #authForm .input-group label {
                display: block;
                font-size: 0.9rem;
                margin-bottom: 5px;
                opacity: 0.8;
                text-align: left;
            }
            
            #authForm button[type="submit"] {
                width: 100%;
                padding: 12px;
                font-size: 1rem;
                font-weight: 600;
                background: var(--color-accent-blue);
                color: white;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                transition: background 0.2s;
            }
            
            #authForm button[type="submit"]:active {
                background: #0066cc;
            }
            
            #registerToggle {
                margin-top: 20px;
                color: var(--color-accent-blue);
                cursor: pointer;
                font-size: 0.9rem;
                opacity: 0.8;
                text-decoration: underline;
            }
            
            #pinIndicators, #keypad {
                display: none; 
            }


            /* --- APP VIEW / SCANNER --- */
            #scannerTab {
                position: relative;
                overflow: hidden;
            }

            #reader-container {
                flex-grow: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                overflow: hidden;
            }

            #reader {
                width: 100%;
                height: 100%;
                background: black;
                object-fit: cover;
            }
            
            #reader video {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }


            .scan-frame {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 70%;
                max-width: 300px;
                aspect-ratio: 1 / 1;
                border: 3px solid var(--color-accent-green);
                border-radius: 12px;
                box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.7);
                pointer-events: none;
            }

            #preScan {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: var(--color-bg-dark);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                z-index: 5;
            }

            .primary-button {
                padding: 12px 25px;
                font-size: 1rem;
                font-weight: 600;
                background: var(--color-accent-blue);
                color: white;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                transition: background 0.2s;
            }

            .primary-button:active {
                background: #0066cc;
            }


            /* --- Result Card --- */
            #result-card {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                background: var(--color-bg-card);
                border-top-left-radius: 20px;
                border-top-right-radius: 20px;
                padding: 20px;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.4);
                transform: translateY(100%);
                transition: transform var(--transition-duration) ease-out;
                z-index: 10;
            }

            #result-card.active {
                transform: translateY(0);
            }

            .card-handle {
                width: 40px;
                height: 4px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 2px;
                margin: 0 auto 15px;
            }

            #cardTitle {
                font-size: 1.4rem;
                font-weight: 700;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
            }

            #cardStatusIcon {
                margin-right: 10px;
                font-size: 1.1em;
            }

            #cardContent p {
                margin: 5px 0;
                font-size: 0.9rem;
                opacity: 0.8;
            }

            .action-button-group {
                display: flex;
                gap: 10px;
                margin-top: 15px;
            }

            .action-button {
                flex: 1;
                padding: 12px;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
            }

            .action-button.register {
                background: var(--color-accent-green);
                color: var(--color-bg-card);
            }
            .action-button.register:active {
                background: #2cb74b;
            }
            .action-button.cancel {
                background: rgba(255, 255, 255, 0.1);
                color: white;
            }
            .action-button.cancel:active {
                background: rgba(255, 255, 255, 0.2);
            }
            .action-button.delete {
                background: var(--color-error-red);
                color: white;
            }
            .action-button.delete:active {
                background: #cc2a22;
            }


            /* --- POPUPS --- */
            #popupOverlay, #adminEditPopupOverlay, #deleteConfirmPopupOverlay, #userEditPopupOverlay, #settingsPopupOverlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(5px);
                z-index: 100;
                display: none;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.2s ease-in-out;
            }

            #popupOverlay.show, #adminEditPopupOverlay.show, #deleteConfirmPopupOverlay.show, #userEditPopupOverlay.show, #settingsPopupOverlay.show {
                opacity: 1;
                display: flex; 
            }

            .popup-card {
                background: var(--color-bg-card);
                padding: 25px;
                border-radius: 15px;
                width: 90%;
                max-width: 400px;
                transform: translateY(20px);
                transition: transform 0.3s ease-in-out;
            }

            #popupOverlay.show .popup-card, #adminEditPopupOverlay.show .popup-card, #deleteConfirmPopupOverlay.show .popup-card, #userEditPopupOverlay.show .popup-card, #settingsPopupOverlay.show .popup-card {
                transform: translateY(0);
            }

            .popup-card h3 {
                margin-top: 0;
                font-size: 1.3rem;
                border-bottom: 1px solid var(--color-border);
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

            .input-group {
                margin-bottom: 15px;
            }
            
            .input-group textarea {
                resize: vertical;
                min-height: 80px;
            }

            .input-group label {
                display: block;
                font-size: 0.9rem;
                margin-bottom: 5px;
                opacity: 0.8;
            }

            .input-group input[type="text"],
            .input-group input[type="email"],
            .input-group input[type="password"],
            .input-group select,
            .input-group textarea {
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid var(--color-border);
                background: var(--color-bg-dark);
                color: white;
                font-size: 1rem;
            }
            .input-group input:focus,
            .input-group select:focus,
            .input-group textarea:focus {
                outline: none;
                border-color: var(--color-accent-blue);
            }

            /* --- NEU: SETTINGS STYLES --- */
            .setting-row {
                display: flex; justify-content: space-between; align-items: center;
                margin-bottom: 20px; padding-bottom: 15px;
                border-bottom: 1px solid var(--color-border);
            }
            .setting-row:last-child { border-bottom: none; }

            .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
            .switch input { opacity: 0; width: 0; height: 0; }
            .slider {
                position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
                background-color: #3a3a44; transition: .4s; border-radius: 34px;
            }
            .slider:before {
                position: absolute; content: ""; height: 20px; width: 20px;
                left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;
            }
            input:checked + .slider { background-color: var(--color-accent-green); }
            input:checked + .slider:before { transform: translateX(22px); }

            /* Volume Slider */
            input[type=range] { width: 100%; margin-top: 10px; background: transparent; -webkit-appearance: none; }
            input[type=range]::-webkit-slider-thumb {
                -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
                background: var(--color-accent-blue); cursor: pointer; margin-top: -8px;
            }
            input[type=range]::-webkit-slider-runnable-track {
                width: 100%; height: 4px; cursor: pointer; background: #3a3a44; border-radius: 2px;
            }

            /* --- TOASTS --- */
            #toastContainer {
                position: fixed;
                top: 15px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 350px;
                z-index: 200;
                pointer-events: none;
            }

            .toast {
                background: var(--color-bg-card);
                color: white;
                padding: 10px 15px;
                border-radius: 10px;
                margin-bottom: 10px;
                opacity: 0;
                transform: translateY(20px);
                transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                font-size: 0.95rem;
                font-weight: 500;
            }

            .toast.show {
                opacity: 1;
                transform: translateY(0);
            }

            .toast-icon {
                margin-right: 10px;
                font-size: 1.2em;
            }

            .toast.success .toast-icon {
                color: var(--color-accent-green);
            }

            .toast.error .toast-icon {
                color: var(--color-error-red);
            }

            .toast.info .toast-icon {
                color: var(--color-accent-blue);
            }

            /* --- FOOTER / NAVIGATION --- */
            footer {
                display: flex;
                height: 70px;
                background: rgba(30, 30, 40, 0.9);
                backdrop-filter: blur(8px);
                border-top: 1px solid var(--color-border);
                flex-shrink: 0;
                z-index: 20;
            }

            .nav-item {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: rgba(255, 255, 255, 0.5);
                font-size: 0.8rem;
                cursor: pointer;
                transition: color 0.2s;
                user-select: none;
            }

            .nav-item.active {
                color: var(--color-accent-blue);
            }

            .nav-item svg {
                width: 24px;
                height: 24px;
                stroke: currentColor;
                fill: none;
                stroke-width: 2;
                margin-bottom: 2px;
            }
            
            /* --- ARTIKEL LIST VIEW STYLES / REUSABLE LIST STYLES --- */
            #listTab, #logTab, #usersTab { 
                padding: 15px 15px 80px 15px;
            }
            
            #articleList, #logList, #userList { 
                list-style: none;
                padding: 0;
                margin: 0;
            }
            
            #articleList li, #logList li, #userList li { 
                background: var(--color-bg-card);
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 10px;
                border-left: 5px solid var(--color-accent-blue); 
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: background 0.2s; 
            }
            
            #articleList li[data-role="admin-editable"]:active, #userList li[data-role="admin-editable"]:active {
                background: #2a303e; 
            }
            
            .user-role-admin { border-left-color: var(--color-warning-yellow) !important; }
            .user-is-blocked { border-left-color: var(--color-error-red) !important; }

            .item-details strong {
                display: block;
                font-size: 1.rem;
                font-weight: 600;
                margin-bottom: 2px;
            }
            
            .item-details span {
                font-size: 0.85rem;
                opacity: 0.7;
            }
            
            .item-count {
                text-align: center; 
                width: 50px; 
                height: 50px; 
                flex-shrink: 0;
                margin-left: 10px;
                display: flex; 
                flex-direction: column;
                justify-content: center;
                align-items: center;
                font-size: 0.8rem;
            }
            
            .item-count svg {
                width: 28px; 
                height: 28px;
                margin-bottom: 2px; 
            }

            .item-count .item-label {
                font-size: 0.6rem; 
                font-weight: 600;
                line-height: 1;
            }
            
            #logTab {
                display: flex; 
                flex-direction: column;
            }
            
            .user-edit-button {
                background: var(--color-accent-blue);
                color: white;
                padding: 8px 15px;
                border-radius: 8px;
                font-size: 0.8rem;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.2s;
            }

        </style>
    </head>
    <body>

        <div id="toastContainer"></div>
        
        <div id="popupOverlay">
            <form class="popup-card" onsubmit="event.preventDefault(); saveArticle();">
                <h3>Artikel Registrieren</h3>
                <div class="input-group">
                    <label for="popupBarcode">Barcode</label>
                    <input type="text" id="popupBarcode" readonly>
                </div>
                
                <div class="input-group">
                    <label for="popupBaseName">Basis-Name (z.B. T-Shirt, Wasserflasche)</label>
                    <input type="text" id="popupBaseName" required>
                </div>
                
                <div class="input-group">
                    <label for="popupSize">Gr√∂√üe / Volumen (Liter)</label>
                    <select id="popupSize">
                        <option value="">(Optional)</option>
                        <option value="0.33">0,33 Liter</option>
                        <option value="0.5">0,5 Liter</option>
                        <option value="0.7">0,7 Liter</option>
                        <option value="1.0">1,0 Liter</option>
                        <option value="1.5">1,5 Liter</option>
                        <option value="2.0">2,0 Liter</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="popupPlatz">Stellplatz (z.B. A-02-C)</label>
                    <input type="text" id="popupPlatz" required>
                </div>
                
                <div class="input-group">
                    <label for="popupBlocklager">Lagertyp</label>
                    <select id="popupBlocklager">
                        <option value="false">Regal / Fach</option>
                        <option value="true">Blocklager</option>
                    </select>
                </div>

                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hidePopup()">Abbrechen</button>
                    <button type="submit" class="action-button register">Speichern</button>
                </div>
            </form>
        </div>
        
        <div id="adminEditPopupOverlay">
            <form class="popup-card" onsubmit="event.preventDefault(); saveAdminEdit();">
                <h3>Artikel Bearbeiten (Admin)</h3>
                <div class="input-group">
                    <label for="adminEditName">Artikel Name</label>
                    <input type="text" id="adminEditName" readonly>
                </div>

                <div class="input-group">
                    <label for="adminEditBarcode">Barcode</label>
                    <input type="text" id="adminEditBarcode" readonly>
                </div>
                
                <div class="input-group">
                    <label for="adminEditPlatz">Neuer Stellplatz</label>
                    <input type="text" id="adminEditPlatz" required>
                </div>
                
                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hideAdminEditPopup()">Abbrechen</button>
                    <button type="submit" class="action-button register">Speichern</button>
                </div>

                <button type="button" class="action-button delete" style="width: 100%; margin-top: 15px;" onclick="deleteArticle()">
                    Artikel l√∂schen...
                </button>

                <p style="font-size: 0.75rem; opacity: 0.6; text-align: center; margin-top: 15px;">Sie sind als Administrator angemeldet und k√∂nnen den Stellplatz √§ndern.</p>
            </form>
        </div>

        <div id="deleteConfirmPopupOverlay">
            <div class="popup-card">
                <h3 id="deleteConfirmTitle">Artikel unwiderruflich l√∂schen</h3>
                <p id="deleteConfirmMessage" style="margin-bottom: 25px; text-align: center; font-weight: 500; font-size: 1.1rem; line-height: 1.4;"></p>

                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hideDeleteConfirmPopup()">Abbrechen</button>
                    <button type="button" class="action-button delete" onclick="confirmDeleteArticle()">Ja, unwiderruflich l√∂schen</button>
                </div>
            </div>
        </div>
        
        <div id="userEditPopupOverlay">
            <form class="popup-card" onsubmit="event.preventDefault(); saveUserEdit();">
                <h3>Benutzer bearbeiten (Admin)</h3>
                <div class="input-group">
                    <label for="userEditEmail">E-Mail</label>
                    <input type="text" id="userEditEmail" readonly>
                </div>
                <div class="input-group">
                    <label for="userEditRole">Rolle</label>
                    <select id="userEditRole" required>
                        <option value="user">Benutzer (Standard)</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="userEditBlocked">Sperrstatus</label>
                    <select id="userEditBlocked" required>
                        <option value="false">Nicht gesperrt</option>
                        <option value="true">Gesperrt</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="userEditNotes">Anmerkungen (nur f√ºr Admins sichtbar)</label>
                    <textarea id="userEditNotes" placeholder="Interne Anmerkungen..."></textarea>
                </div>
                
                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hideUserEditPopup()">Abbrechen</button>
                    <button type="submit" class="action-button register">√Ñnderungen speichern</button>
                </div>
            </form>
        </div>

        <div id="settingsPopupOverlay">
            <div class="popup-card">
                <h3>Einstellungen</h3>
                
                <div class="setting-row">
                    <label>Sound bei Scan</label>
                    <label class="switch">
                        <input type="checkbox" id="settingSound" onchange="saveSettings()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="setting-row" style="display:block;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <label>Lautst√§rke</label>
                        <span id="volValue">50%</span>
                    </div>
                    <input type="range" id="settingVolume" min="0" max="100" value="50" oninput="updateVolumeLabel()" onchange="saveSettings()">
                </div>

                <div class="setting-row">
                    <label>Vibration bei Scan</label>
                    <label class="switch">
                        <input type="checkbox" id="settingVibrate" onchange="saveSettings()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="action-button-group">
                    <button class="action-button cancel" onclick="hideSettingsPopup()">Schlie√üen</button>
                    <button class="action-button register" onclick="testFeedback()">Testen</button>
                </div>
            </div>
        </div>


        <div id="loginView" class="app-view-container active">

            <div class="login-header">
                <div class="app-icon">üîê</div>
                <h2>Inventar Scanner Pro</h2>
                <div id="authError"></div>
            </div>

            <form id="authForm" onsubmit="event.preventDefault(); handleAuthSubmit();">
                <h3 id="authTitle" style="margin-bottom: 30px;">Anmelden</h3>
                
                <div class="input-group">
                    <label for="authEmail">E-Mail</label>
                    <input type="email" id="authEmail" required placeholder="name@firma.de">
                </div>
                
                <div class="input-group">
                    <label for="authPassword">Passwort</label>
                    <input type="password" id="authPassword" required placeholder="Mindestens 6 Zeichen">
                </div>
                
                <button type="submit" id="authSubmitButton">Anmelden</button>
                
                <div id="registerToggle" onclick="toggleAuthMode()">Noch keinen Account? Registrieren</div>
            </form>
            <div id="pinIndicators"></div>
            <div id="keypad"></div>
            <div id="loadingAuth">
                Initialisiere App...
            </div>
            
        </div>


        <div id="appView" class="app-view-container">

            <header>
                <h1>Inventar Scanner Pro</h1>
                <div style="display: flex; align-items: center;">
                    <button class="header-icon-btn" onclick="showSettingsPopup()">‚öôÔ∏è</button>
                    <button class="header-button" onclick="logout()">Logout (<span id="userDisplay"></span>)</button>
                </div>
            </header>

            <div id="tabContentContainer">

                <div id="scannerTab" class="tab-content active">
                    <div id="reader-container">
                        <div id="reader"></div>
                        <div class="scan-frame" id="scanFrame" style="display:none;"></div>

                        <div id="preScan">
                            <div style="font-size: 4em; margin-bottom: 20px;">üì¶</div>
                            <h2>Scanner bereit</h2>
                            <p style="opacity: 0.7; margin-bottom: 30px;">Kamera-Zugriff starten, um loszulegen.</p>
                            <button class="primary-button" style="max-width: 250px;" onclick="activateCamera()">SCAN STARTEN</button>
                        </div>
                    </div>

                    <div id="result-card" class="result-card">
                        <div class="card-handle"></div>
                        <div id="cardTitle"><span id="cardStatusIcon"></span> <span id="cardTitleText"></span></div>
                        <div id="cardContent"></div>
                        <div class="action-button-group">
                            <button class="action-button cancel" onclick="hideResultCard()">Fertig</button>
                            <button class="action-button register" id="registerButton" onclick="showPopup()">Registrieren</button>
                        </div>
                    </div>
                </div>

                <div id="listTab" class="tab-content">
                    <ul id="articleList">
                        <li>Lade Artikel...</li>
                    </ul>
                </div>
                
                <div id="logTab" class="tab-content">
                    <ul id="logList">
                        <li>Lade Log-Protokoll...</li>
                    </ul>
                </div>

                <div id="usersTab" class="tab-content">
                    <ul id="userList">
                        <li>Lade Benutzer...</li>
                    </ul>
                </div>

            </div>

            <footer>
                <div class="nav-item active" data-tab="scannerTab" onclick="changeTab('scannerTab')">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h.01M7 7h.01M11 11h.01M15 15h.01M21 3h-6l-3 3H3v18h18V3z"/></svg>
                    <span>Scannen</span>
                </div>
                <div class="nav-item" data-tab="listTab" onclick="changeTab('listTab')">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                    <span>Liste</span>
                </div>
                <div class="nav-item" data-tab="logTab" onclick="changeTab('logTab')">
                    <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 11H5M19 11v6m0-6V5m-4 16H9M12 4v16M21 11H3"/></svg>
                    <span>Log</span>
                </div>
                <div class="nav-item" data-tab="usersTab" onclick="changeTab('usersTab')">
                    <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87m-4-1.63a4 4 0 0 1 0-7.74"/></svg>
                    <span>Personal</span>
                </div>
            </footer>
        </div>


        <script>
            let html5QrCode = null;
            let lastCode = "";
            let currentScannedBarcode = "";
            let currentTabId = "scannerTab";
            let currentUserId = null;
            let currentUserRole = null; 
            let isAuthReady = false;
            let articleToEdit = null; 
            let articleToDelete = null; 
            let userToEdit = null; 
            let isRegisterMode = false; 
            
            const SHELF_ICON_SVG = '<svg viewBox="0 0 24 24" stroke="white" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16v16H4V4zm4 0v16m8-16v16M4 10h16M4 16h16"/></svg>';
            const WAREHOUSE_ICON_SVG = '<svg viewBox="0 0 24 24" stroke="white" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l10 5l-10 5l-10-5zM2 12v6l10 5l10-5v-6M12 2v10"/></svg>';

            const USER_ICON_SVG = '<svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
            const ADMIN_ICON_SVG = '<svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20"/><path d="M17 4l-5 5l-5-5M17 20l-5-5l-5 5"/></svg>';
            const BLOCKED_ICON_SVG = '<svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>';

            /* --- FEEDBACK & EINSTELLUNGEN LOGIK (NEU) --- */
            
            let feedbackAudio = new Audio();
            let appSettings = { sound: true, volume: 50, vibrate: true };

            function initSettings() {
                const stored = localStorage.getItem('inventoryAppSettings');
                if (stored) { appSettings = JSON.parse(stored); }
                
                document.getElementById('settingSound').checked = appSettings.sound;
                document.getElementById('settingVibrate').checked = appSettings.vibrate;
                document.getElementById('settingVolume').value = appSettings.volume;
                updateVolumeLabel();
                
                // Sound-Quelle (Online-URL f√ºr Zuverl√§ssigkeit)
                feedbackAudio.src = "https://actions.google.com/sounds/v1/alarms/beep_short.ogg"; 
            }

            function updateVolumeLabel() {
                const val = document.getElementById('settingVolume').value;
                document.getElementById('volValue').innerText = val + "%";
                appSettings.volume = parseInt(val);
                feedbackAudio.volume = appSettings.volume / 100;
            }

            function saveSettings() {
                appSettings.sound = document.getElementById('settingSound').checked;
                appSettings.vibrate = document.getElementById('settingVibrate').checked;
                appSettings.volume = parseInt(document.getElementById('settingVolume').value);
                feedbackAudio.volume = appSettings.volume / 100;
                localStorage.setItem('inventoryAppSettings', JSON.stringify(appSettings));
            }

            function showSettingsPopup() {
                document.getElementById('settingsPopupOverlay').style.display = 'flex';
                setTimeout(() => document.getElementById('settingsPopupOverlay').classList.add('show'), 10);
            }

            function hideSettingsPopup() {
                document.getElementById('settingsPopupOverlay').classList.remove('show');
                setTimeout(() => document.getElementById('settingsPopupOverlay').style.display = 'none', 300);
            }

            function triggerScanFeedback() {
                if (appSettings.sound) {
                    feedbackAudio.currentTime = 0;
                    feedbackAudio.play().catch(e => console.log("Audio blockiert", e));
                }
                if (appSettings.vibrate && navigator.vibrate) {
                    // Vibration funktioniert auf Android meistens.
                    // Auf iOS (iPhone) wird dies vom Browser blockiert und funktioniert dort nicht.
                    navigator.vibrate(200);
                }
            }

            function testFeedback() { triggerScanFeedback(); }


            /* --- HILFSFUNKTIONEN --- */

            function showToast(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                let icon = '‚ÑπÔ∏è';
                if (type === 'success') icon = '‚úÖ';
                if (type === 'error') icon = '‚ùå';
                toast.innerHTML = `<span class="toast-icon">${icon}</span>${message}`;

                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode === container) {
                            container.removeChild(toast);
                        }
                    }, 300);
                }, duration);
            }
            
            function switchView(targetViewId) {
                const views = document.querySelectorAll('.app-view-container');
                views.forEach(view => {
                    view.classList.remove('active');
                    if (view.id === targetViewId) {
                        view.classList.add('active');
                    }
                });
            }

            /* --- NEUE AUTH LOGIK (ersetzt PIN) --- */

            function toggleAuthMode() {
                isRegisterMode = !isRegisterMode;
                const title = document.getElementById('authTitle');
                const submitButton = document.getElementById('authSubmitButton');
                const toggleLink = document.getElementById('registerToggle');

                if (isRegisterMode) {
                    title.innerText = "Registrieren";
                    submitButton.innerText = "Registrieren";
                    toggleLink.innerText = "Bereits registriert? Anmelden";
                } else {
                    title.innerText = "Anmelden";
                    submitButton.innerText = "Anmelden";
                    toggleLink.innerText = "Noch keinen Account? Registrieren";
                }
                document.getElementById("authError").innerText = ""; 
            }
            
            async function handleAuthSubmit() {
                const email = document.getElementById('authEmail').value;
                const password = document.getElementById('authPassword').value;
                const submitButton = document.getElementById('authSubmitButton');
                document.getElementById("authError").innerText = "";
                
                if (!email || !password) {
                    document.getElementById("authError").innerText = "Bitte E-Mail und Passwort eingeben.";
                    return;
                }
                
                submitButton.disabled = true;
                submitButton.innerText = (isRegisterMode ? "Registriere..." : "Melde an...");

                let error;
                if (isRegisterMode) {
                    const { error: signUpError } = await window.appSupabaseClient.auth.signUp({
                        email: email,
                        password: password,
                    });
                    error = signUpError;
                    
                    if (!error) {
                        document.getElementById("authError").innerText = "";
                        showToast("Registrierung erfolgreich! Bitte E-Mail best√§tigen.", 'success', 5000);
                        isRegisterMode = false; 
                        toggleAuthMode();
                    }
                    
                } else {
                    const { data, error: signInError } = await window.appSupabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password,
                    });
                    error = signInError;
                    
                    if (!error && data.session) {
                        await handleLoginSuccess(data.session.user.id, data.session.user.email);
                        submitButton.disabled = false;
                        submitButton.innerText = "Anmelden";
                        return; 
                    }
                }
                
                if (error) {
                    document.getElementById("authError").innerText = error.message;
                    showToast(`Auth Fehler: ${error.message}`, 'error', 5000);
                }
                
                submitButton.disabled = false;
                submitButton.innerText = (isRegisterMode ? "Registrieren" : "Anmelden");
            }
            
            async function handleLoginSuccess(userId, email) {
                currentUserId = userId;
                let userRole = 'user'; 
                let isBlocked = false;
                
                const { data, error } = await window.appSupabaseClient
                    .from('user_roles') 
                    .select('role, is_blocked')
                    .eq('id', userId)
                    .single();

                if (data) {
                    userRole = data.role || 'user'; 
                    isBlocked = data.is_blocked || false;
                }
                
                if (isBlocked) {
                    await window.appSupabaseClient.auth.signOut();
                    document.getElementById("authError").innerText = "Ihr Konto ist gesperrt. Bitte wenden Sie sich an den Administrator.";
                    showToast("Login fehlgeschlagen: Konto gesperrt.", 'error', 7000);
                    return;
                }

                if (error && error.code !== 'PGRST116') {
                    console.error("Fehler beim Laden der Benutzerrolle (RLS-Policy pr√ºfen):", error);
                    showToast("Login erfolgreich, aber Rollenpr√ºfung fehlgeschlagen. Nur als USER angemeldet.", 'info');
                }
                
                window.currentUserRole = userRole; 
                
                const roleDisplay = (userRole === 'admin' ? "ADMIN" : "USER");
                document.getElementById("userDisplay").innerText = `${email.split('@')[0]} (${roleDisplay})`;
                
                switchView('appView');
                changeTab('scannerTab');
                showToast(`Willkommen als ${roleDisplay}!`, 'success');
            }


            async function checkLogin() {
                const authForm = document.getElementById("authForm");
                const loadingIndicator = document.getElementById("loadingAuth");
                
                loadingIndicator.style.display = "block";
                authForm.style.display = "none";

                const { data } = await window.appSupabaseClient.auth.getSession();
                const currentSession = data.session;
                
                isAuthReady = true;
                loadingIndicator.style.display = "none";

                if (currentSession) {
                    await handleLoginSuccess(currentSession.user.id, currentSession.user.email);
                } else {
                    switchView('loginView');
                    authForm.style.display = "block";
                    toggleAuthMode(); 
                }
            }
            
            /* --- SCANNEN LOGIK --- */
            
            async function activateCamera() {
                if (html5QrCode) {
                    await startScanner();
                    return;
                }
                html5QrCode = new Html5Qrcode("reader");
                await startScanner();
            }
            
            async function startScanner() {
                 document.getElementById("preScan").style.display = "none";
                 document.getElementById("scanFrame").style.display = "block";

                const config = { 
                    fps: 10, 
                    qrbox: { width: 250, height: 250 },
                };
                
                const cameraIdOrConstraints = { facingMode: "environment" }; 
                
                html5QrCode.start(cameraIdOrConstraints, config, onScanSuccess, onScanError)
                .catch(err => {
                    document.getElementById("preScan").style.display = "flex";
                    document.getElementById("scanFrame").style.display = "none";
                    showToast("Kamera Fehler: Zugriff verweigert oder Ger√§t nicht gefunden.", 'error', 4000);
                    console.error("Scanner Start Fehler:", err);
                });
            }

            async function stopScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    try {
                        await html5QrCode.stop();
                        document.getElementById("preScan").style.display = "flex";
                        document.getElementById("scanFrame").style.display = "none";
                    } catch (err) {
                        console.warn("Kamera Stoppen fehlgeschlagen:", err);
                    }
                }
            }
            
            function onScanError(errorMessage) {}

            async function onScanSuccess(code) {
                if (code === lastCode) return;
                lastCode = code;

                if (html5QrCode) html5QrCode.pause(true); 

                // --- NEU: Feedback beim Scannen ---
                triggerScanFeedback();
                // ----------------------------------

                currentScannedBarcode = code;
                showToast(`Barcode gescannt: ${code}`, 'info', 2000);

                const { data, error } = await window.appSupabaseClient
                    .from("artikel")
                    .select("*")
                    .eq("barcode", code)
                    .single();

                if (error && error.code !== 'PGRST116') { 
                    showToast("Fehler bei der Datenbankabfrage.", 'error');
                    console.error(error);
                    showResultCard("Fehler", "Datenbankfehler beim Suchen.", '‚ùå');
                    html5QrCode.resume();
                    lastCode = ""; 
                    return;
                }

                if (data) {
                    const lagertyp = data.blocklager ? 'Blocklager' : 'Regal/Fach'; 
                    
                    const content = `
                        <p><strong>Stellplatz:</strong> ${data.stellplatz}</p>
                        <p><strong>Typ:</strong> ${lagertyp}</p>
                        <p><strong>Erster Scan:</strong> ${new Date(data.created_at).toLocaleDateString()}</p>
                        <p><strong>Barcode:</strong> ${data.barcode}</p>
                    `;
                    showResultCard(data.name, content, '‚úÖ');
                    document.getElementById("registerButton").style.display = "none"; 
                    
                    const { error: updateError } = await window.appSupabaseClient
                        .from("artikel")
                        .update({ scans: (data.scans || 0) + 1 }) 
                        .eq("barcode", code);
                        
                    if(updateError) console.error("Update Fehler:", updateError);
                    
                } else {
                    const content = `<p>Der Barcode <strong>${code}</strong> wurde noch nicht registriert.</p>`;
                    showResultCard("Unbekannter Artikel", content, '‚ùì');
                    if (window.currentUserRole === 'admin') {
                        document.getElementById("registerButton").style.display = "block";
                    } else {
                        document.getElementById("registerButton").style.display = "none";
                    }
                }
            }
            
            
            /* --- ARTIKEL SPEICHERN LOGIK (F√úR NEUE ARTIKEL) --- */
            
            function showPopup() {
                if (window.currentUserRole !== 'admin') {
                    showToast("Nur Administratoren d√ºrfen neue Artikel registrieren.", 'error');
                    return;
                }
                
                document.getElementById('popupBarcode').value = currentScannedBarcode;
                document.getElementById('popupOverlay').classList.add('show');
            }
            
            function hidePopup() {
                document.getElementById('popupOverlay').classList.remove('show');
                document.getElementById('popupBaseName').value = '';
                document.getElementById('popupSize').value = ''; 
                document.getElementById('popupPlatz').value = '';
                document.getElementById('popupBlocklager').value = 'false';
            }

            async function saveArticle() {
                const barcode = document.getElementById('popupBarcode').value.trim();
                const baseName = document.getElementById('popupBaseName').value.trim();
                const sizeValue = document.getElementById('popupSize').value.trim(); 
                const platz = document.getElementById('popupPlatz').value.trim();
                const block = document.getElementById('popupBlocklager').value === 'true';

                let name = baseName;
                if (sizeValue) {
                    const sizeDisplay = sizeValue.replace('.', ','); 
                    name += ` (${sizeDisplay} L)`; 
                }

                const lagertyp = block ? 'Blocklager' : 'Regal/Fach'; 

                if (!baseName || !platz) {
                    showToast("Bitte Basis-Name und Stellplatz ausf√ºllen.", "error");
                    return;
                }

                const { data, error } = await window.appSupabaseClient
                    .from("artikel")
                    .insert([{ 
                        barcode: barcode, 
                        name: name, 
                        stellplatz: platz, 
                        blocklager: block, 
                        scans: 1 
                    }]);

                if (error) {
                    showToast(`FEHLER beim Speichern.`, "error");
                    console.error("Speicherfehler:", error);
                } else {
                    logAdminAction('ARTICLE_ADDED', `Neuer Artikel "${name}" registriert (Barcode: ${barcode}). Stellplatz: ${platz}.`);
                    hidePopup();
                    showToast(`Artikel "${name}" erfolgreich gespeichert.`, "success");
                    showResultCard(
                        name, 
                        `<p><strong>Stellplatz:</strong> ${platz}</p> <p><strong>Typ:</strong> ${lagertyp}</p>`,
                        '‚úÖ'
                    );
                    
                    if (currentTabId === 'listTab') loadArticleList();
                }
            }


            /* --- ADMIN EDIT LOGIK --- */
            
            function showAdminEditPopup(article) {
                if (window.currentUserRole !== 'admin') {
                    showToast("Keine Berechtigung zum Bearbeiten.", 'error');
                    return;
                }
                
                window.articleToEdit = article;
                
                document.getElementById('adminEditName').value = article.name;
                document.getElementById('adminEditBarcode').value = article.barcode;
                document.getElementById('adminEditPlatz').value = article.stellplatz; 
                
                document.getElementById('adminEditPopupOverlay').style.display = "flex";
                setTimeout(() => document.getElementById('adminEditPopupOverlay').classList.add('show'), 10);
            }

            function hideAdminEditPopup() {
                document.getElementById('adminEditPopupOverlay').classList.remove('show');
                
                setTimeout(() => {
                    document.getElementById('adminEditPopupOverlay').style.display = "none";
                    if (!window.articleToDelete) { 
                        window.articleToEdit = null;
                    }
                }, 300);
            }

            async function saveAdminEdit() {
                if (!window.articleToEdit) return;

                const newPlatz = document.getElementById('adminEditPlatz').value.trim();
                const oldPlatz = window.articleToEdit.stellplatz;

                if (!newPlatz) {
                    showToast("Der Stellplatz darf nicht leer sein.", "error");
                    return;
                }
                
                if (newPlatz === oldPlatz) {
                    showToast("Stellplatz wurde nicht ge√§ndert.", "info");
                    hideAdminEditPopup();
                    return;
                }

                const { error } = await window.appSupabaseClient
                    .from("artikel")
                    .update({ 
                        stellplatz: newPlatz 
                    })
                    .eq("barcode", window.articleToEdit.barcode);

                if (error) {
                    showToast(`FEHLER beim Speichern des Stellplatzes.`, "error");
                    console.error("Speicherfehler:", error);
                } else {
                    logAdminAction('STELLPLATZ_UPDATED', `Stellplatz von Artikel "${window.articleToEdit.name}" (Barcode: ${window.articleToEdit.barcode}) von ${oldPlatz} auf ${newPlatz} ge√§ndert.`);
                    hideAdminEditPopup();
                    showToast(`Stellplatz f√ºr ${window.articleToEdit.name} erfolgreich aktualisiert.`, "success");
                    loadArticleList(); 
                }
            }
            
            function deleteArticle() {
                if (window.currentUserRole !== 'admin' || !window.articleToEdit) {
                    showToast("Keine Berechtigung oder Artikel nicht ausgew√§hlt.", 'error');
                    return;
                }
                showDeleteConfirmPopup(window.articleToEdit);
            }

            function showDeleteConfirmPopup(article) {
                window.articleToDelete = article; 
                
                document.getElementById('deleteConfirmMessage').innerHTML = `Sind Sie **SICHER**, dass Sie den Artikel<br><strong>"${article.name}"</strong><br>(Barcode: ${article.barcode}) unwiderruflich l√∂schen m√∂chten?`;
                
                document.getElementById('deleteConfirmPopupOverlay').style.display = "flex";
                setTimeout(() => document.getElementById('deleteConfirmPopupOverlay').classList.add('show'), 10);
            }

            function hideDeleteConfirmPopup() {
                document.getElementById('deleteConfirmPopupOverlay').classList.remove('show');
                
                setTimeout(() => {
                    document.getElementById('deleteConfirmPopupOverlay').style.display = "none";
                    if (window.articleToEdit) {
                        document.getElementById('adminEditPopupOverlay').style.display = "flex";
                        document.getElementById('adminEditPopupOverlay').classList.add('show');
                    }
                    window.articleToDelete = null; 
                }, 300);
            }

            async function confirmDeleteArticle() {
                if (window.currentUserRole !== 'admin' || !window.articleToDelete) {
                    hideDeleteConfirmPopup();
                    return;
                }
                
                const articleName = window.articleToDelete.name;
                const barcode = window.articleToDelete.barcode;
                
                const { error } = await window.appSupabaseClient
                    .from("artikel")
                    .delete()
                    .eq("barcode", barcode);

                if (error) {
                    showToast(`FEHLER beim L√∂schen des Artikels.`, "error");
                    console.error("L√∂schfehler:", error);
                    hideDeleteConfirmPopup(); 
                } else {
                    showToast(`Artikel "${articleName}" wurde erfolgreich gel√∂scht.`, "success");
                    logAdminAction('ARTICLE_DELETED', `Artikel "${articleName}" (Barcode: ${barcode}) unwiderruflich gel√∂scht.`);
                    window.articleToEdit = null;
                    hideDeleteConfirmPopup(); 
                    loadArticleList(); 
                }
            }


            /* --- RESULT CARD LOGIK --- */
            
            function showResultCard(title, contentHTML, icon) {
                document.getElementById('cardTitleText').innerText = title;
                document.getElementById('cardContent').innerHTML = contentHTML;
                document.getElementById('cardStatusIcon').innerText = icon;
                document.getElementById('result-card').classList.add('active');
            }
            
            function hideResultCard() {
                document.getElementById('result-card').classList.remove('active');
                lastCode = ""; 
                
                if (html5QrCode && currentTabId === 'scannerTab') {
                    html5QrCode.resume();
                }
            }
            
            
            /* --- ARTIKEL LISTE LOGIK --- */
            
            async function loadArticleList() {
                const articleListContainer = document.getElementById('articleList');
                articleListContainer.innerHTML = '<li style="border-left: 5px solid rgba(255, 255, 255, 0.2); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">Lade Artikel...</li>'; 

                const { data, error } = await window.appSupabaseClient
                    .from("artikel")
                    .select("*")
                    .order("name", { ascending: true }); 
                    
                if (error) {
                    showToast("Fehler beim Laden der Artikelliste.", 'error');
                    console.error("Fehler beim Laden der Artikel (Pr√ºfen Sie RLS-Policies!):", error);
                    articleListContainer.innerHTML = '<li style="color: var(--color-error-red); border-left: 5px solid var(--color-error-red); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">FEHLER: Die Liste konnte nicht von der Datenbank geladen werden. BITTE RLS-POLICIES PR√úFEN!</li>';
                    return;
                }

                articleListContainer.innerHTML = ''; 
                
                if (data.length === 0) {
                    articleListContainer.innerHTML = '<li style="border-left: 5px solid rgba(255, 255, 255, 0.2); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">Noch keine Artikel vorhanden. Scannen Sie einen Barcode, um zu starten.</li>';
                    return;
                }

                data.forEach(item => {
                    const listItem = document.createElement('li');
                    
                    if (window.currentUserRole === 'admin') {
                        listItem.onclick = () => showAdminEditPopup(item);
                        listItem.style.cursor = 'pointer'; 
                        listItem.setAttribute('data-role', 'admin-editable'); 
                    }
                    
                    const isBlocklager = item.blocklager;
                    const lagertypIconSvg = isBlocklager ? WAREHOUSE_ICON_SVG : SHELF_ICON_SVG;
                    const lagertypLabel = isBlocklager ? 'BLOCK' : 'REGAL'; 

                    const details = `
                        <div class="item-details">
                            <strong>${item.name}</strong>
                            <span>Stellplatz: ${item.stellplatz} | Barcode: ${item.barcode}</span>
                        </div>
                        <div class="item-count">
                            ${lagertypIconSvg}
                            <span class="item-label">${lagertypLabel}</span>
                        </div>
                    `;
                    listItem.innerHTML = details;
                    articleListContainer.appendChild(listItem);
                });
            }
            
            /* --- ADMIN LOGGING FUNKTION --- */

            async function logAdminAction(actionType, description) {
                if (window.currentUserRole !== 'admin') {
                    console.warn("Versuch, eine Admin-Aktion ohne Admin-Rechte zu protokollieren.");
                    return;
                }
                
                const { error } = await window.appSupabaseClient
                    .from('audit_log')
                    .insert({
                        action_type: actionType,
                        description: description,
                        user_role: window.currentUserRole
                    });

                if (error) {
                    console.error("FEHLER beim Protokollieren der Admin-Aktion:", error);
                    showToast("FEHLER: Konnte Aktion nicht im Log speichern.", 'error');
                }
            }

            /* --- ADMIN LOG LISTE LOGIK --- */

            async function loadAdminLog() {
                const logListContainer = document.getElementById('logList');
                
                if (window.currentUserRole !== 'admin') {
                    logListContainer.innerHTML = '<li style="color: var(--color-error-red); border-left: 5px solid var(--color-error-red); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">Zugriff verweigert. Nur Administratoren d√ºrfen das Protokoll einsehen.</li>';
                    return;
                }
                
                logListContainer.innerHTML = '<li style="border-left: 5px solid rgba(255, 255, 255, 0.2); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">Lade Admin-Protokoll...</li>'; 

                const { data, error } = await window.appSupabaseClient
                    .from("audit_log") 
                    .select("*")
                    .order("created_at", { ascending: false }) 
                    .limit(50); 
                    
                if (error) {
                    showToast("Fehler beim Laden des Admin-Protokolls.", 'error');
                    console.error("Fehler beim Laden des Logs:", error);
                    logListContainer.innerHTML = '<li style="color: var(--color-error-red); border-left: 5px solid var(--color-error-red); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">FEHLER: Das Protokoll konnte nicht geladen werden. Bitte die `audit_log` Tabelle und Spaltennamen pr√ºfen.</li>';
                    return;
                }

                logListContainer.innerHTML = ''; 
                
                if (data.length === 0) {
                    logListContainer.innerHTML = '<li style="border-left: 5px solid rgba(255, 255, 255, 0.2); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">Keine Protokolleintr√§ge vorhanden.</li>';
                    return;
                }

                data.forEach(item => {
                    const dateSource = item.created_at; 
                    const timestamp = new Date(dateSource).toLocaleString('de-DE', { dateStyle: 'short', timeStyle: 'medium' });
                    
                    let color = 'var(--color-accent-blue)';
                    if (item.action_type.includes('ADDED')) color = 'var(--color-accent-green)';
                    if (item.action_type.includes('DELETED')) color = 'var(--color-error-red)';
                    
                    const listItem = document.createElement('li');
                    listItem.style.borderLeft = `5px solid ${color}`;
                    
                    const details = `
                        <div class="item-details">
                            <strong style="font-size: 0.95rem; font-weight: 600;">${item.action_type.replace(/_/g, ' ')}</strong>
                            <span style="display: block; font-size: 0.85rem; opacity: 0.9; margin-top: 5px; line-height: 1.3;">${item.description}</span>
                            <span style="display: block; font-size: 0.75rem; opacity: 0.6; margin-top: 5px;">${timestamp} (Rolle: ${item.user_role || 'N/A'})</span>
                        </div>
                    `;
                    listItem.innerHTML = details;
                    logListContainer.appendChild(listItem);
                });
            }
            
            /* --- PERSONAL / BENUTZERVERWALTUNG LOGIK --- */
            
            async function loadUserList() {
                const userListContainer = document.getElementById('userList');
                userListContainer.innerHTML = ''; 
                
                if (window.currentUserRole !== 'admin') {
                    userListContainer.innerHTML = '<li style="color: var(--color-error-red); border-left: 5px solid var(--color-error-red); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">Zugriff verweigert. Nur Administratoren d√ºrfen Benutzer verwalten.</li>';
                    return;
                }
                
                userListContainer.innerHTML = '<li style="border-left: 5px solid rgba(255, 255, 255, 0.2); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">Lade Benutzerliste... (RLS-Policy f√ºr auth.users/user_roles notwendig)</li>';

                const { data: users, error } = await window.appSupabaseClient
                    .from('user_roles')
                    .select('*')
                    .order('email', { ascending: true });

                if (error) {
                    showToast("Fehler beim Laden der Benutzerliste.", 'error');
                    console.error("Fehler beim Laden der Benutzer (RLS-Policy pr√ºfen):", error);
                    userListContainer.innerHTML = `<li style="color: var(--color-error-red); border-left: 5px solid var(--color-error-red); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">FEHLER: Benutzerliste konnte nicht geladen werden. Fehler: ${error.message}</li>`;
                    return;
                }
                
                if (users.length === 0) {
                    userListContainer.innerHTML = '<li style="border-left: 5px solid rgba(255, 255, 255, 0.2); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">Keine Benutzer gefunden.</li>';
                    return;
                }
                
                userListContainer.innerHTML = '';
                
                users.forEach(user => {
                    const listItem = document.createElement('li');
                    
                    listItem.onclick = () => showUserEditPopup(user);
                    listItem.style.cursor = 'pointer'; 
                    listItem.setAttribute('data-role', 'admin-editable'); 
                    
                    const userRole = user.role || 'user';
                    const isBlocked = user.is_blocked || false;
                    
                    let roleIcon = USER_ICON_SVG;
                    let roleLabel = 'USER';
                    let listClass = '';

                    if (userRole === 'admin') {
                        roleIcon = ADMIN_ICON_SVG;
                        roleLabel = 'ADMIN';
                        listClass = 'user-role-admin';
                    }
                    if (isBlocked) {
                        roleIcon = BLOCKED_ICON_SVG;
                        roleLabel = 'GESPERRT';
                        listClass = 'user-is-blocked';
                    }
                    
                    if (user.id === currentUserId) {
                        roleLabel += ' (DU)';
                    }

                    listItem.className = listClass;
                    
                    const details = `
                        <div class="item-details" style="flex-grow: 1;">
                            <strong>${user.email}</strong>
                            <span>Von: ${userRole.toUpperCase()} | ${isBlocked ? 'Gesperrt' : 'Aktiv'}</span>
                            ${user.notes ? `<span style="font-style: italic; opacity: 0.6; margin-top: 5px;">Anm.: ${user.notes}</span>` : ''}
                        </div>
                        <div class="item-count" style="width: 70px;">
                             <button class="user-edit-button">Bearbeiten</button>
                        </div>
                    `;
                    listItem.innerHTML = details;
                    userListContainer.appendChild(listItem);
                });
            }
            
            function showUserEditPopup(user) {
                if (window.currentUserRole !== 'admin') return;
                
                window.userToEdit = user;
                
                document.getElementById('userEditEmail').value = user.email;
                document.getElementById('userEditRole').value = user.role || 'user';
                document.getElementById('userEditBlocked').value = user.is_blocked ? 'true' : 'false';
                document.getElementById('userEditNotes').value = user.notes || '';
                
                document.getElementById('userEditPopupOverlay').style.display = "flex";
                setTimeout(() => document.getElementById('userEditPopupOverlay').classList.add('show'), 10);
            }

            function hideUserEditPopup() {
                document.getElementById('userEditPopupOverlay').classList.remove('show');
                setTimeout(() => {
                    document.getElementById('userEditPopupOverlay').style.display = "none";
                    window.userToEdit = null;
                }, 300);
            }
            
            async function saveUserEdit() {
                if (!window.userToEdit || window.currentUserRole !== 'admin') {
                    showToast("Keine Berechtigung oder Benutzer nicht ausgew√§hlt.", 'error');
                    return;
                }
                
                const newRole = document.getElementById('userEditRole').value;
                const newBlockedStatus = document.getElementById('userEditBlocked').value === 'true';
                const newNotes = document.getElementById('userEditNotes').value.trim();
                
                const oldRole = window.userToEdit.role || 'user';
                const oldBlockedStatus = window.userToEdit.is_blocked || false;
                
                let changes = [];
                let description = `Benutzer ${window.userToEdit.email} bearbeitet: `;

                if (newRole !== oldRole) {
                    changes.push(`Rolle von ${oldRole.toUpperCase()} auf ${newRole.toUpperCase()}`);
                }
                if (newBlockedStatus !== oldBlockedStatus) {
                    changes.push(`Status: ${newBlockedStatus ? 'Gesperrt' : 'Entsperrt'}`);
                }
                
                if (changes.length === 0) {
                    if (newNotes === (window.userToEdit.notes || '')) {
                        showToast("Keine √Ñnderungen vorgenommen.", "info");
                        hideUserEditPopup();
                        return;
                    }
                }

                const { error } = await window.appSupabaseClient
                    .from("user_roles")
                    .update({ 
                        role: newRole, 
                        is_blocked: newBlockedStatus,
                        notes: newNotes
                    })
                    .eq("id", window.userToEdit.id);

                if (error) {
                    showToast(`FEHLER beim Speichern des Benutzers: ${error.message}`, "error");
                    console.error("Benutzer-Speicherfehler:", error);
                } else {
                    description += changes.join(', ');
                    logAdminAction('USER_UPDATED', description);
                    
                    hideUserEditPopup();
                    showToast(`Benutzer ${window.userToEdit.email} erfolgreich aktualisiert.`, "success");
                    loadUserList(); 
                }
            }


            /* --- NAVIGATION LOGIK --- */
            
            function changeTab(targetTabId) {
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                document.getElementById(targetTabId).classList.add('active');

                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('data-tab') === targetTabId) {
                        item.classList.add('active');
                    }
                });

                currentTabId = targetTabId;
                hideResultCard();

                if (targetTabId === 'scannerTab') {
                    activateCamera();
                } else {
                    stopScanner();
                    
                    if (targetTabId === 'listTab') {
                        loadArticleList();
                    } else if (targetTabId === 'logTab') { 
                        loadAdminLog();
                    } else if (targetTabId === 'usersTab') { 
                        loadUserList();
                    }
                }
            }
            
            async function logout() {
                stopScanner();
                
                const { error } = await window.appSupabaseClient.auth.signOut();
                
                if (error) {
                    showToast("Fehler beim Abmelden.", 'error');
                    console.error("Logout Fehler:", error);
                }
                
                switchView('loginView');
                window.currentUserRole = null; 
                showToast("Erfolgreich abgemeldet.", 'info');
                lastCode = "";
                
                document.getElementById("userDisplay").innerText = ""; 
                document.getElementById("authEmail").value = "";
                document.getElementById("authPassword").value = "";
                document.getElementById("authError").innerText = "";
            }


            window.onload = function() {
                initSettings(); // NEU: Einstellungen laden
                checkLogin();
            };
        </script>

    </body>
    </html>