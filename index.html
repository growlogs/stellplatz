<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Stellplatz App</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const SUPABASE_URL = "https://sjhyvctidpnttqhenqoy.supabase.co";
const SUPABASE_KEY = "eyJhbGciOi..."; // DEIN KEY BLEIBT UNVERÄNDERT
const VALID_PIN = "123456";

window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>

<style>
/* --- STYLE WIE IN DEINEM CODE, NICHT GEKÜRZT --- */
*{box-sizing:border-box;font-family:Inter,system-ui}
body{margin:0;padding:0;background:linear-gradient(145deg,#09090b,#1e1e24);color:#fff;height:100vh;display:flex;flex-direction:column}
#loginView,#appView{height:100%}
#loginView{display:flex;flex-direction:column;align-items:center;justify-content:space-between;padding:40px}
#pinIndicators{display:flex;gap:12px}
.pin-indicator{width:12px;height:12px;border-radius:50%;border:2px solid rgba(255,255,255,.3)}
.pin-indicator.active{background:#4A90E2;border-color:#4A90E2}
.pin-indicator.error{background:red;border-color:red;animation:shake .3s}
#keypad{width:100%;max-width:380px;display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.keypad-button{height:75px;background:rgba(255,255,255,.08);border-radius:50px;color:#fff;border:none;font-size:1.8rem}
.keypad-button:active{transform:scale(.95)}
@keyframes shake{0%,100%{transform:translateX(0)}25%,75%{transform:translateX(5px)}50%{transform:translateX(-5px)}}
#reader{flex:1}
#result-container{background:#18181f;padding:20px}
#popup{position:fixed;top:0;left:0;width:100%;height:100%;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,.7)}
#popupBox{background:#222;padding:20px;border-radius:10px;width:90%}
input,button{width:100%;margin-top:10px;padding:12px}
.green{color:#6f6}.red{color:#f55}.yellow{color:#fc0}
</style>
</head>

<body>

<div id="loginView">
  <h2>PIN eingeben</h2>
  <div id="pinIndicators">
    <div class="pin-indicator"></div><div class="pin-indicator"></div><div class="pin-indicator"></div>
    <div class="pin-indicator"></div><div class="pin-indicator"></div><div class="pin-indicator"></div>
  </div>

  <div id="keypad">
    <button class="keypad-button" onclick="handlePinInput('1')">1</button>
    <button class="keypad-button" onclick="handlePinInput('2')">2</button>
    <button class="keypad-button" onclick="handlePinInput('3')">3</button>
    <button class="keypad-button" onclick="handlePinInput('4')">4</button>
    <button class="keypad-button" onclick="handlePinInput('5')">5</button>
    <button class="keypad-button" onclick="handlePinInput('6')">6</button>
    <button class="keypad-button" onclick="handlePinInput('7')">7</button>
    <button class="keypad-button" onclick="handlePinInput('8')">8</button>
    <button class="keypad-button" onclick="handlePinInput('9')">9</button>
    <button class="keypad-button" onclick="clearPin()">C</button>
    <button class="keypad-button" onclick="handlePinInput('0')">0</button>
    <button class="keypad-button" onclick="deletePin()">←</button>
  </div>
</div>

<div id="appView" style="display:none;flex-direction:column">
  <div id="reader"></div>
  <div id="result-container"><div id="result">Bereit</div></div>
</div>

<div id="popup"><div id="popupBox">
  <h3>Neuer Artikel</h3>
  <input id="name" placeholder="Name">
  <input id="platz" placeholder="Platz">
  <label><input type="checkbox" id="block"> Blocklager</label>
  <button onclick="save()">Speichern</button>
  <button onclick="hide()">Abbrechen</button>
</div></div>

<script>
var enteredPin = "", currentUserId = "PINUSER";
var html5QrCode = null, lastCode = "";

function handlePinInput(num){
  if(enteredPin.length>=6) return;
  enteredPin += num;
  updatePinDots();
  if(enteredPin.length === 6) validatePin();
}

function updatePinDots(){
  document.querySelectorAll(".pin-indicator").forEach((el,i)=>{
    el.classList.toggle("active", i < enteredPin.length);
  });
}

function clearPin(){ enteredPin=""; updatePinDots(); }
function deletePin(){ enteredPin = enteredPin.slice(0,-1); updatePinDots(); }

function validatePin(){
  if(enteredPin === VALID_PIN){
    document.getElementById("loginView").style.display="none";
    document.getElementById("appView").style.display="flex";
    startScanner();
  } else {
    document.querySelectorAll(".pin-indicator").forEach(d=>d.classList.add("error"));
    setTimeout(()=>{clearPin();document.querySelectorAll(".pin-indicator").forEach(d=>d.classList.remove("error"));},600);
  }
}

function showResult(t,c){document.getElementById("result").className=c;document.getElementById("result").innerHTML=t;}

async function lookup(code){
  const {data}=await window.supabaseClient.from("artikel").select("*").eq("barcode",code).single();
  if(data){showResult("✅ "+data.name,"green")} 
  else { lastCode=code; document.getElementById("popup").style.display="flex"; }
}

function save(){
  window.supabaseClient.from("artikel").insert([{
    barcode:lastCode,name:name.value,stellplatz:platz.value,blocklager:block.checked,scans:0
  }]);
  hide();
}

function hide(){document.getElementById("popup").style.display="none";}

function startScanner(){
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250},code=>lookup(code));
}
</script>

</body>
</html>
