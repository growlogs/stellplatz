    <!DOCTYPE html>
        <html lang="de">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
            <title>Inventar Scanner Pro</title>

            <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
            <script src="https://unpkg.com/html5-qrcode"></script>

            <script>
                // ---------------------------------------------------------
                // KONFIGURATION
                // ---------------------------------------------------------
                var APP_SUPABASE_URL = "https://sjhyvctidpnttqhenqoy.supabase.co"; 
                var APP_SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHl2Y3RpZHBudHRxaGVucW95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MzU3NTksImV4cCI6MjA4MDAxMTc1OX0.oXUA012J99W8fNNJi8Zxqn-2BUjf1QJOrXGYlPotaS4"; 
                
                // Initialisierung
                (function() {
                    if (window['supabase']) {
                        window.appSupabaseClient = window['supabase'].createClient(APP_SUPABASE_URL, APP_SUPABASE_KEY);
                    } else {
                        window.appSupabaseClient = null;
                        console.error("Supabase-Client konnte nicht initialisiert werden.");
                    }
                    window.lastCode = ""; 
                    window.currentTabId = "scannerTab"; 
                    window.currentUserRole = null; 
                    window.currentClientId = null; // NEU: Tenant-ID
                    window.offlineDB = null; // NEU: IndexedDB-Instanz
                    window.isSyncing = false; // NEU: Synchronisations-Status
                })();
            </script>

            <style>
    /* ... (Der Style-Block bleibt unver√§ndert) ... */
                /* --- GLOBALE STYLES & FONT --- */
                :root {
                    --color-bg-dark: #0a0b10;
                    --color-bg-card: #1d222e;
                    --color-accent-blue: #007aff;
                    --color-accent-green: #34c759;
                    --color-error-red: #ff3b30;
                    --color-border: rgba(255, 255, 255, 0.08);
                    --transition-duration: 0.3s;
                    --color-warning-yellow: #ffcc00; 
                }

                * {
                    box-sizing: border-box;
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                }

                body,
                html {
                    margin: 0;
                    padding: 0;
                    background: var(--color-bg-dark);
                    color: white;
                    height: 100dvh;
                    display: flex;
                    flex-direction: column;
                    overflow: hidden;
                }

                /* --- LAYOUT & TRANSITIONEN --- */

                .app-view-container {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    transition: opacity var(--transition-duration) ease-in-out, transform var(--transition-duration) ease-in-out;
                    opacity: 0;
                    pointer-events: none;
                    display: flex;
                    flex-direction: column;
                }

                .app-view-container.active {
                    opacity: 1;
                    pointer-events: all;
                }

                #loginView {
                    transform: translateY(0);
                }

                #appView {
                    transform: translateY(100vh);
                }

                #loginView.active {
                    transform: translateY(0);
                }

                #appView.active {
                    transform: translateY(0);
                }
                
                #tabContentContainer {
                    flex-grow: 1;
                    position: relative;
                    overflow: hidden; 
                }
                
                .tab-content {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    display: none !important; 
                    flex-direction: column;
                    overflow-y: auto; 
                    background: var(--color-bg-dark); 
                }
                
                .tab-content.active {
                    display: flex !important; 
                }


                /* --- HEADER --- */
                header {
                    height: 55px;
                    background: rgba(30, 30, 40, 0.9);
                    backdrop-filter: blur(8px);
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 0 15px;
                    border-bottom: 1px solid var(--color-border);
                    z-index: 10;
                    flex-shrink: 0; 
                }

                header h1 {
                    font-size: 1.1rem;
                    font-weight: 600;
                    margin: 0;
                }

                .header-button {
                    padding: 5px 10px;
                    font-size: 0.75em;
                    background: rgba(255, 255, 255, 0.1);
                    border: none;
                    border-radius: 8px;
                    color: white;
                    cursor: pointer;
                    transition: background 0.2s;
                }

                /* Icon Button f√ºr Settings */
                .header-icon-btn {
                    background: none; border: none;
                    font-size: 1.5rem; cursor: pointer;
                    padding: 0 10px; margin-right: 5px;
                    transition: transform 0.2s;
                }
                .header-icon-btn:active { transform: scale(0.9); }


                /* --- LOGIN VIEW --- */
                #loginView {
                    justify-content: space-around;
                    align-items: center;
                    padding: 40px 20px;
                    text-align: center;
                }

                .login-header {
                    text-align: center;
                    padding-top: 50px;
                }

                .app-icon {
                    font-size: 3.5em;
                    color: var(--color-accent-blue);
                    margin-bottom: 15px;
                }

                .login-header h2 {
                    font-size: 1.6rem;
                    font-weight: 700;
                    margin: 0;
                }

                #authError {
                    color: var(--color-error-red);
                    margin-top: 10px;
                    height: 1.2em;
                    font-weight: 500;
                }
                
                #loadingAuth {
                    text-align: center;
                    font-size: 1.1rem;
                    opacity: 0.7;
                    display: none; 
                    margin-top: 40px;
                }

                #authForm {
                    width: 100%;
                    max-width: 320px;
                    margin-top: 50px;
                    display: none; 
                }
                
                #authForm .input-group input {
                    width: 100%;
                    padding: 12px;
                    border-radius: 8px;
                    border: 1px solid var(--color-border);
                    background: var(--color-bg-card);
                    color: white;
                    font-size: 1rem;
                    margin-bottom: 15px;
                }
                
                #authForm .input-group label {
                    display: block;
                    font-size: 0.9rem;
                    margin-bottom: 5px;
                    opacity: 0.8;
                    text-align: left;
                }
                
                #authForm button[type="submit"] {
                    width: 100%;
                    padding: 12px;
                    font-size: 1rem;
                    font-weight: 600;
                    background: var(--color-accent-blue);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: background 0.2s;
                }
                
                #authForm button[type="submit"]:active {
                    background: #0066cc;
                }
                
                #registerToggle {
                    margin-top: 20px;
                    color: var(--color-accent-blue);
                    cursor: pointer;
                    font-size: 0.9rem;
                    opacity: 0.8;
                    text-decoration: underline;
                }
                
                #pinIndicators, #keypad {
                    display: none; 
                }


                /* --- APP VIEW / SCANNER --- */
                #scannerTab {
                    position: relative;
                    overflow: hidden;
                }

                #reader-container {
                    flex-grow: 1;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    position: relative;
                    overflow: hidden;
                }

                #reader {
                    width: 100%;
                    height: 100%;
                    background: black;
                    object-fit: cover;
                }
                
                #reader video {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                }


                .scan-frame {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 70%;
                    max-width: 300px;
                    aspect-ratio: 1 / 1;
                    border: 3px solid var(--color-accent-green);
                    border-radius: 12px;
                    box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.7);
                    pointer-events: none;
                }

                #preScan {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: var(--color-bg-dark);
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                    z-index: 5;
                }

                .primary-button {
                    padding: 12px 25px;
                    font-size: 1rem;
                    font-weight: 600;
                    background: var(--color-accent-blue);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: background 0.2s;
                }

                .primary-button:active {
                    background: #0066cc;
                }


                /* --- Result Card --- */
                #result-card {
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    width: 100%;
                    background: var(--color-bg-card);
                    border-top-left-radius: 20px;
                    border-top-right-radius: 20px;
                    padding: 20px;
                    box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.4);
                    transform: translateY(100%);
                    transition: transform var(--transition-duration) ease-out;
                    z-index: 10;
                }

                #result-card.active {
                    transform: translateY(0);
                }

                .card-handle {
                    width: 40px;
                    height: 4px;
                    background: rgba(255, 255, 255, 0.2);
                    border-radius: 2px;
                    margin: 0 auto 15px;
                }

                #cardTitle {
                    font-size: 1.4rem;
                    font-weight: 700;
                    margin-bottom: 10px;
                    display: flex;
                    align-items: center;
                }

                #cardStatusIcon {
                    margin-right: 10px;
                    font-size: 1.1em;
                }

                #cardContent p {
                    margin: 5px 0;
                    font-size: 0.9rem;
                    opacity: 0.8;
                }

                .action-button-group {
                    display: flex;
                    gap: 10px;
                    margin-top: 15px;
                }

                .action-button {
                    flex: 1;
                    padding: 12px;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                }

                .action-button.register {
                    background: var(--color-accent-green);
                    color: var(--color-bg-card);
                }
                .action-button.register:active {
                    background: #2cb74b;
                }
                .action-button.cancel {
                    background: rgba(255, 255, 255, 0.1);
                    color: white;
                }
                .action-button.cancel:active {
                    background: rgba(255, 255, 255, 0.2);
                }
                .action-button.delete {
                    background: var(--color-error-red);
                    color: white;
                }
                .action-button.delete:active {
                    background: #cc2a22;
                }


                /* --- POPUPS --- */
                #popupOverlay, #adminEditPopupOverlay, #deleteConfirmPopupOverlay, #userEditPopupOverlay, #settingsPopupOverlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    backdrop-filter: blur(5px);
                    z-index: 100;
                    display: none;
                    align-items: center;
                    justify-content: center;
                    opacity: 0;
                    transition: opacity 0.2s ease-in-out;
                }

                #popupOverlay.show, #adminEditPopupOverlay.show, #deleteConfirmPopupOverlay.show, #userEditPopupOverlay.show, #settingsPopupOverlay.show {
                    opacity: 1;
                    display: flex; 
                }

                .popup-card {
                    background: var(--color-bg-card);
                    padding: 25px;
                    border-radius: 15px;
                    width: 90%;
                    max-width: 400px;
                    transform: translateY(20px);
                    transition: transform 0.3s ease-in-out;
                }

                #popupOverlay.show .popup-card, #adminEditPopupOverlay.show .popup-card, #deleteConfirmPopupOverlay.show .popup-card, #userEditPopupOverlay.show .popup-card, #settingsPopupOverlay.show .popup-card {
                    transform: translateY(0);
                }

                .popup-card h3 {
                    margin-top: 0;
                    font-size: 1.3rem;
                    border-bottom: 1px solid var(--color-border);
                    padding-bottom: 10px;
                    margin-bottom: 20px;
                }

                .input-group {
                    margin-bottom: 15px;
                }
                
                .input-group textarea {
                    resize: vertical;
                    min-height: 80px;
                }

                .input-group label {
                    display: block;
                    font-size: 0.9rem;
                    margin-bottom: 5px;
                    opacity: 0.8;
                }

                .input-group input[type="text"],
                .input-group input[type="email"],
                .input-group input[type="password"],
                .input-group select,
                .input-group textarea {
                    width: 100%;
                    padding: 10px;
                    border-radius: 8px;
                    border: 1px solid var(--color-border);
                    background: var(--color-bg-dark);
                    color: white;
                    font-size: 1rem;
                }
                .input-group input:focus,
                .input-group select:focus,
                .input-group textarea:focus {
                    outline: none;
                    border-color: var(--color-accent-blue);
                }

                /* --- SETTINGS STYLES --- */
                .setting-row {
                    display: flex; justify-content: space-between; align-items: center;
                    margin-bottom: 20px; padding-bottom: 15px;
                    border-bottom: 1px solid var(--color-border);
                }
                .setting-row:last-child { border-bottom: none; }

                .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
                .switch input { opacity: 0; width: 0; height: 0; }
                .slider {
                    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
                    background-color: #3a3a44; transition: .4s; border-radius: 34px;
                }
                .slider:before {
                    position: absolute; content: ""; height: 20px; width: 20px;
                    left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;
                }
                input:checked + .slider { background-color: var(--color-accent-green); }
                input:checked + .slider:before { transform: translateX(22px); }

                /* Volume Slider */
                input[type=range] { width: 100%; margin-top: 10px; background: transparent; -webkit-appearance: none; }
                input[type=range]::-webkit-slider-thumb {
                    -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
                    background: var(--color-accent-blue); cursor: pointer; margin-top: -8px;
                }
                input[type=range]::-webkit-slider-runnable-track {
                    width: 100%; height: 4px; cursor: pointer; background: #3a3a44; border-radius: 2px;
                }

                /* --- TOASTS --- */
                #toastContainer {
                    position: fixed;
                    top: 15px;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 90%;
                    max-width: 350px;
                    z-index: 200;
                    pointer-events: none;
                }

                .toast {
                    background: var(--color-bg-card);
                    color: white;
                    padding: 10px 15px;
                    border-radius: 10px;
                    margin-bottom: 10px;
                    opacity: 0;
                    transform: translateY(20px);
                    transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
                    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    font-size: 0.95rem;
                    font-weight: 500;
                }

                .toast.show {
                    opacity: 1;
                    transform: translateY(0);
                }

                .toast-icon {
                    margin-right: 10px;
                    font-size: 1.2em;
                }

                .toast.success .toast-icon {
                    color: var(--color-accent-green);
                }

                .toast.error .toast-icon {
                    color: var(--color-error-red);
                }

                .toast.info .toast-icon {
                    color: var(--color-accent-blue);
                }

                /* --- FOOTER / NAVIGATION --- */
                footer {
                    display: flex;
                    height: 70px;
                    background: rgba(30, 30, 40, 0.9);
                    backdrop-filter: blur(8px);
                    border-top: 1px solid var(--color-border);
                    flex-shrink: 0;
                    z-index: 20;
                }

                .nav-item {
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    color: rgba(255, 255, 255, 0.5);
                    font-size: 0.8rem;
                    cursor: pointer;
                    transition: color 0.2s;
                    user-select: none;
                }

                .nav-item.active {
                    color: var(--color-accent-blue);
                }

                .nav-item svg {
                    width: 24px;
                    height: 24px;
                    stroke: currentColor;
                    fill: none;
                    stroke-width: 2;
                    margin-bottom: 2px;
                }
                
                /* --- ARTIKEL LIST VIEW STYLES / REUSABLE LIST STYLES --- */
                /* Padding in .list-content-container, da das Tab-Content nun auch den Search-Header enth√§lt */
                .list-content-container {
                    overflow-y: auto; 
                    padding: 15px 15px 80px 15px; 
                }
                
                /* NEU: Search Container Style */
                .search-container {
                    padding: 15px; 
                    flex-shrink: 0; 
                    background: var(--color-bg-dark);
                    border-bottom: 1px solid var(--color-border);
                }

                .search-container input {
                    width: 100%;
                    padding: 10px 15px;
                    border-radius: 8px;
                    border: 1px solid var(--color-border);
                    background: var(--color-bg-card);
                    color: white;
                    font-size: 1rem;
                }


                /* Alte Paddings entfernt und durch list-content-container ersetzt */
                #listTab, #logTab, #usersTab { 
                    padding: 0; /* Wichtig: Padding hier entfernen */
                }
                
                #articleList, #logList, #userList { 
                    list-style: none;
                    padding: 0;
                    margin: 0;
                }
                
                #articleList li, #logList li, #userList li { 
                    background: var(--color-bg-card);
                    padding: 15px;
                    border-radius: 10px;
                    margin-bottom: 10px;
                    border-left: 5px solid var(--color-accent-blue); 
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    transition: background 0.2s; 
                }
                
                #articleList li[data-role="admin-editable"]:active, #userList li[data-role="admin-editable"]:active {
                    background: #2a303e; 
                }
                
                .user-role-admin { border-left-color: var(--color-warning-yellow) !important; }
                .user-is-blocked { border-left-color: var(--color-error-red) !important; }

                .item-details strong {
                    display: block;
                    font-size: 1.rem;
                    font-weight: 600;
                    margin-bottom: 2px;
                }
                
                .item-details span {
                    font-size: 0.85rem;
                    opacity: 0.7;
                }
                
                .item-count {
                    text-align: center; 
                    width: 50px; 
                    height: 50px; 
                    flex-shrink: 0;
                    margin-left: 10px;
                    display: flex; 
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    font-size: 0.8rem;
                }
                
                .item-count svg {
                    width: 28px; 
                    height: 28px;
                    margin-bottom: 2px; 
                }

                .item-count .item-label {
                    font-size: 0.6rem; 
                    font-weight: 600;
                    line-height: 1;
                }
                
                #logTab {
                    display: flex; 
                    flex-direction: column;
                }
                
                .user-edit-button {
                    background: var(--color-accent-blue);
                    color: white;
                    padding: 8px 15px;
                    border-radius: 8px;
                    font-size: 0.8rem;
                    font-weight: 600;
                    cursor: pointer;
                    transition: background 0.2s;
                }

            </style>
        </head>
        <body>

            <div id="toastContainer"></div>
            
            <div id="popupOverlay">
                <form class="popup-card" onsubmit="event.preventDefault(); saveArticle();">
                    <h3>Artikel Registrieren</h3>
                    <div class="input-group">
                        <label for="popupBarcode">Barcode</label>
                        <input type="text" id="popupBarcode" readonly>
                    </div>
                    
                    <div class="input-group">
                        <label for="popupBaseName">Basis-Name (z.B. T-Shirt, Wasserflasche)</label>
                        <input type="text" id="popupBaseName" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="popupSize">Gr√∂√üe / Volumen (Liter)</label>
                        <select id="popupSize">
                            <option value="">(Optional)</option>
                            <option value="0.33">0,33 Liter</option>
                            <option value="0.5">0,5 Liter</option>
                            <option value="0.7">0,7 Liter</option>
                            <option value="1.0">1,0 Liter</option>
                            <option value="1.5">1,5 Liter</option>
                            <option value="2.0">2,0 Liter</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="popupPlatz">Stellplatz (z.B. A-02-C)</label>
                        <input type="text" id="popupPlatz" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="popupBlocklager">Lagertyp</label>
                        <select id="popupBlocklager">
                            <option value="false">Regal / Fach</option>
                            <option value="true">Blocklager</option>
                        </select>
                    </div>

                    <div class="action-button-group">
                        <button type="button" class="action-button cancel" onclick="hidePopup()">Abbrechen</button>
                        <button type="submit" class="action-button register">Speichern</button>
                    </div>
                </form>
            </div>
            
            <div id="adminEditPopupOverlay">
                <form class="popup-card" onsubmit="event.preventDefault(); saveAdminEdit();">
                    <h3>Artikel Bearbeiten (Admin)</h3>
                    <div class="input-group">
                        <label for="adminEditName">Artikel Name</label>
                        <input type="text" id="adminEditName" readonly>
                    </div>

                    <div class="input-group">
                        <label for="adminEditBarcode">Barcode</label>
                        <input type="text" id="adminEditBarcode" readonly>
                    </div>
                    
                    <div class="input-group">
                        <label for="adminEditPlatz">Neuer Stellplatz</label>
                        <input type="text" id="adminEditPlatz" required>
                    </div>
                    
                    <div class="action-button-group">
                        <button type="button" class="action-button cancel" onclick="hideAdminEditPopup()">Abbrechen</button>
                        <button type="submit" class="action-button register">Speichern</button>
                    </div>

                    <button type="button" class="action-button delete" style="width: 100%; margin-top: 15px;" onclick="deleteArticle()">
                        Artikel l√∂schen...
                    </button>

                    <p style="font-size: 0.75rem; opacity: 0.6; text-align: center; margin-top: 15px;">Sie sind als Administrator angemeldet und k√∂nnen den Stellplatz √§ndern.</p>
                </form>
            </div>

            <div id="deleteConfirmPopupOverlay">
                <div class="popup-card">
                    <h3 id="deleteConfirmTitle">Artikel unwiderruflich l√∂schen</h3>
                    <p id="deleteConfirmMessage" style="margin-bottom: 25px; text-align: center; font-weight: 500; font-size: 1.1rem; line-height: 1.4;"></p>

                    <div class="action-button-group">
                        <button type="button" class="action-button cancel" onclick="hideDeleteConfirmPopup()">Abbrechen</button>
                        <button type="button" class="action-button delete" onclick="confirmDeleteArticle()">Ja, unwiderruflich l√∂schen</button>
                    </div>
                </div>
            </div>
            
            <div id="userEditPopupOverlay">
                <form class="popup-card" onsubmit="event.preventDefault(); saveUserEdit();">
                    <h3>Benutzer bearbeiten (Admin)</h3>
                    <div class="input-group">
                        <label for="userEditEmail">E-Mail</label>
                        <input type="text" id="userEditEmail" readonly>
                    </div>
                    <div class="input-group">
                        <label for="userEditRole">Rolle</label>
                        <select id="userEditRole" required>
                            <option value="user">Benutzer (Standard)</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="userEditBlocked">Sperrstatus</label>
                        <select id="userEditBlocked" required>
                            <option value="false">Nicht gesperrt</option>
                            <option value="true">Gesperrt</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="userEditNotes">Anmerkungen (nur f√ºr Admins sichtbar)</label>
                        <textarea id="userEditNotes" placeholder="Interne Anmerkungen..."></textarea>
                    </div>
                    
                    <div class="action-button-group">
                        <button type="button" class="action-button cancel" onclick="hideUserEditPopup()">Abbrechen</button>
                        <button type="submit" class="action-button register">√Ñnderungen speichern</button>
                    </div>
                </form>
            </div>

            <div id="settingsPopupOverlay">
                <div class="popup-card">
                    <h3>Einstellungen</h3>
                    
                    <div class="setting-row">
                        <label>Sound bei Scan</label>
                        <label class="switch">
                            <input type="checkbox" id="settingSound" onchange="saveSettings()">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-row" style="display:block;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <label>Lautst√§rke</label>
                            <span id="volValue">50%</span>
                        </div>
                        <input type="range" id="settingVolume" min="0" max="100" value="50" oninput="updateVolumeLabel()" onchange="saveSettings()">
                    </div>

                    <div class="setting-row">
                        <label>Vibration bei Scan</label>
                        <label class="switch">
                            <input type="checkbox" id="settingVibrate" onchange="saveSettings()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <h4 style="margin-top: 30px; margin-bottom: 15px; font-weight: 600;">Datenmanagement (Admin)</h4>
                    <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 15px;">Import/Export ist nur f√ºr Administratoren verf√ºgbar.</p>

                    <div class="setting-row" style="border-bottom: none; flex-direction: column; align-items: stretch; padding-bottom: 0;">
                        <label style="margin-bottom: 10px; font-weight: 600;">Daten exportieren (Artikel)</label>
                        <div class="action-button-group" style="margin-top: 0;">
                            <button type="button" class="action-button register" style="flex: 1; background: #2e8b57;" onclick="exportData('json')">Export JSON</button>
                            <button type="button" class="action-button register" style="flex: 1; background: #2e8b57;" onclick="exportData('csv')">Export CSV</button>
                        </div>
                    </div>

                    <div class="setting-row" style="border-bottom: none; flex-direction: column; align-items: stretch; padding-bottom: 0; margin-top: 20px;">
                        <label for="importFile" style="margin-bottom: 10px; font-weight: 600;">Daten importieren (CSV/JSON)</label>
                        <input type="file" id="importFile" accept=".csv, application/json" style="padding: 8px; border: 1px solid var(--color-border); border-radius: 8px; background: var(--color-bg-dark); margin-bottom: 10px;" onchange="document.getElementById('importButton').disabled = !this.files.length;">
                        <button id="importButton" type="button" class="primary-button" style="background: var(--color-warning-yellow); color: var(--color-bg-card);" disabled onclick="prepareImport()">Daten importieren (Upsert)</button>
                        <p style="font-size: 0.75rem; opacity: 0.6; margin-top: 5px;">Importiert Artikel. Vorhandene Barcodes werden aktualisiert.</p>
                    </div>


                    <div class="action-button-group" style="margin-top: 25px; border-top: 1px solid var(--color-border); padding-top: 20px;">
                        <button class="action-button cancel" onclick="hideSettingsPopup()">Schlie√üen</button>
                        <button class="action-button register" onclick="testFeedback()">Testen</button>
                    </div>
                </div>
            </div>


            <div id="loginView" class="app-view-container active">

                <div class="login-header">
                    <div class="app-icon">üîê</div>
                    <h2>Inventar Scanner Pro</h2>
                    <div id="authError"></div>
                </div>

                <form id="authForm" onsubmit="event.preventDefault(); handleAuthSubmit();">
                    <h3 id="authTitle" style="margin-bottom: 30px;">Anmelden</h3>
                    
                    <div class="input-group">
                        <label for="authEmail">E-Mail</label>
                        <input type="email" id="authEmail" required placeholder="name@firma.de">
                    </div>
                    
                    <div class="input-group">
                        <label for="authPassword">Passwort</label>
                        <input type="password" id="authPassword" required placeholder="Mindestens 6 Zeichen">
                    </div>
                    
                    <button type="submit" id="authSubmitButton">Anmelden</button>
                    
                    <div id="registerToggle" onclick="toggleAuthMode()">Noch kein Konto? Jetzt registrieren.</div>
                </form>
                
                <div id="loadingAuth" style="display: none;">Authentifiziere...</div>
                
                <div style="opacity: 0.5; font-size: 0.8rem; padding-top: 50px;">
                    <p>Version 1.2</p>
                    <p>Eingeloggt als: <span id="userDisplay">Nicht angemeldet</span></p>
                </div>
            </div>

            <div id="appView" class="app-view-container">

                <header>
                    <button class="header-button" onclick="logout()">Abmelden</button>
                    <h1>Inventar Scanner</h1>
                    <button class="header-icon-btn" onclick="showSettingsPopup()">‚öôÔ∏è</button>
                </header>

                <div id="tabContentContainer">

                    <div id="scannerTab" class="tab-content active">
                        <div id="reader-container">
                            <div id="reader"></div>
                            <div class="scan-frame" id="scanFrame" style="display:none;"></div>
                            <div id="preScan">
                                <div style="font-size: 4em; margin-bottom: 20px;">üì¶</div>
                                <h2>Scanner bereit</h2>
                                <p style="opacity: 0.7; margin-bottom: 30px;">Kamera-Zugriff starten, um loszulegen.</p>
                                <button class="primary-button" style="max-width: 250px;" onclick="activateCamera()">SCAN STARTEN</button>
                            </div>
                        </div>
                        
                        <div id="result-card" class="result-card">
                            <div class="card-handle"></div>
                            <div id="cardTitle"><span id="cardStatusIcon"></span> <span id="cardTitleText"></span></div>
                            <div id="cardContent"></div>
                            <div class="action-button-group">
                                <button class="action-button cancel" onclick="hideResultCard()">Fertig</button>
                                <button class="action-button register" id="registerButton" onclick="showPopup()">Registrieren</button>
                            </div>
                        </div>
                    </div>

                    <div id="listTab" class="tab-content">
                        <div class="search-container">
                            <input type="text" id="articleSearchInput" placeholder="Suche nach Name, Barcode oder Stellplatz..." oninput="debounce(loadArticleList, 300, this.value)">
                        </div>
                        <div class="list-content-container">
                            <ul id="articleList"></ul>
                        </div>
                    </div>

                    <div id="logTab" class="tab-content">
                        <div class="search-container">
                            <input type="text" id="logSearchInput" placeholder="Suche nach Aktion oder Beschreibung..." oninput="loadAdminLog(this.value)">
                        </div>
                        <div class="list-content-container">
                            <ul id="logList"></ul>
                        </div>
                    </div>

                    <div id="usersTab" class="tab-content">
                        <div class="search-container">
                            <input type="text" id="userSearchInput" placeholder="Suche nach E-Mail, Rolle oder Anmerkungen..." oninput="loadUserList(this.value)">
                        </div>
                        <div class="list-content-container">
                            <ul id="userList"></ul>
                        </div>
                    </div>

                </div>

                <footer>
                    <div class="nav-item active" data-tab="scannerTab" onclick="changeTab('scannerTab')">
                        <svg viewBox="0 0 24 24"><path d="M4 4h4v4H4zm6 0h4v4h-4zm6 0h4v4h-4zM4 10h4v4H4zm6 0h4v4h-4zm6 0h4v4h-4zM4 16h4v4H4zm6 1h4v3h-4zm6 0h4v3h-4z"/></svg>
                        <span>Scan</span>
                    </div>
                    <div class="nav-item" data-tab="listTab" onclick="changeTab('listTab')">
                        <svg viewBox="0 0 24 24"><path d="M3 5h18M3 10h18M3 15h18M3 20h18"/></svg>
                        <span>Artikel</span>
                    </div>
                    <div class="nav-item" data-tab="logTab" onclick="changeTab('logTab')" id="navLog">
                        <svg viewBox="0 0 24 24"><path d="M4 12V3h16v18H4v-9M12 9h4M12 15h4M8 12h.01M8 18h.01"/></svg>
                        <span>Log</span>
                    </div>
                    <div class="nav-item" data-tab="usersTab" onclick="changeTab('usersTab')" id="navUsers">
                        <svg viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/></svg>
                        <span>Nutzer</span>
                    </div>
                </footer>

            </div>
            
            <script>
                // --- CONSTANTS ---
                const SHELF_ICON_SVG = '<svg viewBox="0 0 24 24"><path d="M3 7v10h18V7H3zm2 2h14v6H5V9zm12 8h2v3h-2zm-2 0h-8v3h8zM5 17H3v3h2z"/></svg>';
                const WAREHOUSE_ICON_SVG = '<svg viewBox="0 0 24 24"><path d="M2 22h20M4 22V10l8-8 8 8v12H4zm8-18L6 10v10h12V10l-6-6zm0 4v10M16 10v10M8 10v10"/></svg>';

                // --- GLOBAL STATE ---
                let currentScannedBarcode = null;
                let html5QrCode = null;
                let isRegisterMode = false;
                let currentUserId = null;
                window.articleToEdit = null;
                window.userToEdit = null;

                // Simpler debounce-Ersatz, da die eigentliche Funktion im Snippet fehlte.
                let debounceTimer;
                function debounce(func, delay, ...args) {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => func(...args), delay);
                }

                /* --- EINSTELLUNGEN LOGIK --- */
                const feedbackAudio = new Audio('scan_sound.mp3'); // Annahme: Existierende Datei
                let appSettings = {
                    sound: true,
                    vibrate: true,
                    volume: 50
                };

                function initSettings() {
                    const storedSettings = localStorage.getItem('inventoryAppSettings');
                    if (storedSettings) {
                        appSettings = JSON.parse(storedSettings);
                    }
                    document.getElementById('settingSound').checked = appSettings.sound;
                    document.getElementById('settingVibrate').checked = appSettings.vibrate;
                    document.getElementById('settingVolume').value = appSettings.volume;
                    document.getElementById('volValue').innerText = `${appSettings.volume}%`;
                    feedbackAudio.volume = appSettings.volume / 100;
                }

                function updateVolumeLabel() {
                    document.getElementById('volValue').innerText = `${document.getElementById('settingVolume').value}%`;
                }

                function saveSettings() {
                    appSettings.sound = document.getElementById('settingSound').checked;
                    appSettings.vibrate = document.getElementById('settingVibrate').checked;
                    appSettings.volume = parseInt(document.getElementById('settingVolume').value);
                    feedbackAudio.volume = appSettings.volume / 100;
                    localStorage.setItem('inventoryAppSettings', JSON.stringify(appSettings));
                }

                function showSettingsPopup() {
                    document.getElementById('settingsPopupOverlay').style.display = 'flex';
                    setTimeout(() => document.getElementById('settingsPopupOverlay').classList.add('show'), 10);
                }

                function hideSettingsPopup() {
                    document.getElementById('settingsPopupOverlay').classList.remove('show');
                    setTimeout(() => document.getElementById('settingsPopupOverlay').style.display = 'none', 300);
                }

                function triggerScanFeedback() {
                    if (appSettings.sound) {
                        feedbackAudio.currentTime = 0;
                        feedbackAudio.play().catch(e => console.log("Audio blockiert", e));
                    }
                    if (appSettings.vibrate && navigator.vibrate) {
                        navigator.vibrate(200); // 200ms Vibration
                    }
                }

                function testFeedback() {
                    triggerScanFeedback();
                    showToast("Feedback getestet.", 'success');
                }


                /* --- AUTHENTIFIZIERUNG LOGIK --- */

                function switchView(viewId) {
                    document.querySelectorAll('.app-view-container').forEach(view => {
                        view.classList.remove('active');
                    });
                    document.getElementById(viewId).classList.add('active');
                    // Wenn wir zur App wechseln, Tabs und Admin-Ansichten aktualisieren
                    if (viewId === 'appView') {
                        changeTab(window.currentTabId);
                        updateAdminViews(window.currentUserRole);
                    }
                }

                function updateAdminViews(role) {
                    const isAdmin = role === 'admin';
                    document.getElementById('navLog').style.display = isAdmin ? 'flex' : 'none';
                    document.getElementById('navUsers').style.display = isAdmin ? 'flex' : 'none';
                    // Admin-Datenmanagement in den Settings
                    document.querySelectorAll('.setting-row h4, .setting-row p, .setting-row label[for="importFile"], .setting-row .action-button-group, #importFile, #importButton').forEach(el => {
                        if (el.tagName !== 'H4' && el.tagName !== 'P' && el.tagName !== 'INPUT') { // Handle visibility for non-admin-only elements
                            el.closest('.setting-row').style.display = isAdmin ? 'flex' : 'none';
                        }
                        if (el.tagName === 'H4' || el.tagName === 'P') {
                            el.style.display = isAdmin ? 'block' : 'none';
                        }
                        if (el.tagName === 'INPUT' && el.id === 'importFile') {
                            el.closest('.setting-row').style.display = isAdmin ? 'flex' : 'none';
                        }
                    });
                }


                async function checkLogin() {
                    const { data: { session } } = await window.appSupabaseClient.auth.getSession();
                    document.getElementById("loadingAuth").style.display = "none";
                    document.getElementById("authForm").style.display = "block";
                    
                    if (session) {
                        // Bereits eingeloggt
                        await handleLoginSuccess(session.user.id, session.user.email);
                    } else {
                        // Nicht eingeloggt
                        switchView('loginView');
                    }
                }

                function toggleAuthMode() {
                    isRegisterMode = !isRegisterMode;
                    document.getElementById('authTitle').innerText = isRegisterMode ? "Registrieren" : "Anmelden";
                    document.getElementById('authSubmitButton').innerText = isRegisterMode ? "Registrieren" : "Anmelden";
                    document.getElementById('registerToggle').innerText = isRegisterMode ? "Zur√ºck zur Anmeldung" : "Noch kein Konto? Jetzt registrieren.";
                    document.getElementById("authError").innerText = "";
                }

                async function handleAuthSubmit() {
                    const email = document.getElementById('authEmail').value.trim();
                    const password = document.getElementById('authPassword').value.trim();
                    const submitButton = document.getElementById('authSubmitButton');

                    if (!email || password.length < 6) {
                        document.getElementById("authError").innerText = "Bitte E-Mail und Passwort eingeben.";
                        return;
                    }
                    
                    submitButton.disabled = true;
                    submitButton.innerText = "L√§dt...";

                    try {
                        if (isRegisterMode) {
                            const { error } = await window.appSupabaseClient.auth.signUp({
                                email: email,
                                password: password,
                            });
                            if (error) throw error;
                            showToast("Registrierung erfolgreich. Bitte E-Mail best√§tigen.", 'info', 7000);
                            toggleAuthMode(); // Zur√ºck zum Login
                        } else {
                            const { data, error } = await window.appSupabaseClient.auth.signInWithPassword({
                                email: email,
                                password: password,
                            });
                            if (error) throw error;
                            await handleLoginSuccess(data.user.id, data.user.email);
                        }
                    } catch (error) {
                        let errorMessage = "Unbekannter Fehler bei der Authentifizierung.";
                        if (error.message) {
                            errorMessage = error.message;
                        } else if (error.status === 400 && errorMessage.includes('Email not confirmed')) {
                            errorMessage = "E-Mail noch nicht best√§tigt. Bitte √ºberpr√ºfen Sie Ihr Postfach.";
                        }
                        document.getElementById("authError").innerText = errorMessage;
                        showToast("Login fehlgeschlagen.", 'error', 5000);
                    }

                    submitButton.disabled = false;
                    submitButton.innerText = (isRegisterMode ? "Registrieren" : "Anmelden");
                }

                async function handleLoginSuccess(userId, email) {
                    currentUserId = userId;
                    let userRole = 'user';
                    let isBlocked = false;
                    let clientId = null; // NEU: Variable f√ºr die Client-ID
                    let isOffline = !navigator.onLine;

                    try {
                        // 1. Online-Versuch, Benutzerrolle und Client-ID zu laden
                        const { data, error } = await window.appSupabaseClient
                            .from('user_roles')
                            .select('role, is_blocked, notes, client_id') // NEU: client_id abrufen
                            .eq('id', userId)
                            .single();
                        
                        if (data) {
                            userRole = data.role || 'user';
                            isBlocked = data.is_blocked || false;
                            clientId = data.client_id; // NEU: Client-ID setzen
                            
                            // Lokale Kopie aktualisieren (upsert)
                            await window.offlineDB.upsertData('user_roles', { 
                                id: userId, email: email, role: userRole, 
                                is_blocked: isBlocked, notes: data.notes || '', 
                                client_id: clientId // NEU: client_id speichern
                            });
                        } else if (error && (error.message.includes('Failed to fetch') || error.code === '500')) { 
                            throw new Error("Offline"); 
                        } else if (error && error.code !== 'PGRST116') { // PGRST116 = keine Zeile gefunden
                            console.error("Fehler beim Laden der Benutzerrolle:", error);
                        }

                    } catch (e) {
                        if (e.message === "Offline" || !navigator.onLine) {
                            isOffline = true;
                            showToast("Netzwerkfehler. Lade lokale Benutzerrolle...", 'info');
                            try {
                                // OFFLINE FALLBACK: Rolle lokal laden
                                const localUser = await window.offlineDB.getData('user_roles', userId);
                                if (localUser) {
                                    userRole = localUser.role || 'user';
                                    isBlocked = localUser.is_blocked || false;
                                    clientId = localUser.client_id; // NEU: Client-ID aus lokalem Cache
                                } else {
                                    showToast("Lokale Rolle nicht gefunden. Standardrolle 'Benutzer'.", 'info');
                                }
                            } catch (e) {
                                console.error("IndexedDB Fehler beim Laden der Rolle:", e);
                            }
                        } else {
                            console.error("Unerwarteter Fehler beim Laden der Benutzerrolle:", e);
                        }
                    }
                    
                    // WICHTIG: Pr√ºfung, ob eine Client-ID gefunden wurde
                    if (!clientId) {
                        await window.appSupabaseClient.auth.signOut();
                        document.getElementById("authError").innerText = "Konto nicht f√ºr Mandantenbetrieb konfiguriert oder keine Client-ID gefunden.";
                        showToast("Login fehlgeschlagen: Keine Client-ID zugeordnet.", 'error', 7000);
                        return;
                    }
                    
                    if (isBlocked) {
                        await window.appSupabaseClient.auth.signOut();
                        document.getElementById("authError").innerText = "Ihr Konto ist gesperrt. Bitte wenden Sie sich an den Administrator.";
                        showToast("Login fehlgeschlagen: Konto gesperrt.", 'error', 7000);
                        return;
                    }
                    
                    window.currentUserRole = userRole;
                    window.currentClientId = clientId; // Globale Tenant-ID setzen
                    
                    document.getElementById("userDisplay").innerText = email;
                    switchView('appView');
                    syncData(true);
                }

                async function logout() {
                    const { error } = await window.appSupabaseClient.auth.signOut();
                    if (error) {
                        showToast("Fehler beim Abmelden.", 'error');
                        console.error("Logout Fehler:", error);
                    }
                    switchView('loginView');
                    window.currentUserRole = null;
                    window.currentClientId = null; // Client-ID l√∂schen
                    showToast("Erfolgreich abgemeldet.", 'info');
                    lastCode = "";
                    document.getElementById("userDisplay").innerText = "";
                    document.getElementById("authEmail").value = "";
                    document.getElementById("authPassword").value = "";
                    document.getElementById("authError").innerText = "";
                }


                /* --- SCANNER LOGIK --- */

                async function activateCamera() {
                    if (html5QrCode && html5QrCode.isScanning) return;

                    document.getElementById("preScan").style.display = "none";
                    document.getElementById("scanFrame").style.display = "block";
                    
                    if (!html5QrCode) {
                        html5QrCode = new Html5Qrcode("reader");
                    }
                    
                    const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
                    
                    const cameraIdOrConstraints = { facingMode: "environment" };

                    html5QrCode.start(cameraIdOrConstraints, config, onScanSuccess, onScanError)
                        .catch(err => {
                            document.getElementById("preScan").style.display = "flex";
                            document.getElementById("scanFrame").style.display = "none";
                            showToast("Kamera Fehler: Zugriff verweigert oder Ger√§t nicht gefunden.", 'error', 4000);
                            console.error("Scanner Start Fehler:", err);
                        });
                }

                async function stopScanner() {
                    if (html5QrCode && html5QrCode.isScanning) {
                        try {
                            await html5QrCode.stop();
                            document.getElementById("preScan").style.display = "flex";
                            document.getElementById("scanFrame").style.display = "none";
                            hideResultCard();
                        } catch (err) {
                            console.error("Scanner Stop Fehler:", err);
                        }
                    }
                }

                function onScanError(errorMessage) {
                    // Nur anzeigen, wenn kein Code erkannt wird.
                    // console.log("Scan Fehler:", errorMessage); 
                }

                async function onScanSuccess(decodedText, decodedResult) {
                    if (decodedText === lastCode) {
                        return; // Code wurde bereits verarbeitet, um Doppelerkennung zu verhindern
                    }
                    lastCode = decodedText;
                    triggerScanFeedback();
                    currentScannedBarcode = decodedText;
                    await html5QrCode.pause();
                    document.getElementById("scanFrame").style.display = "none";
                    await searchArticle(decodedText);
                }

                async function searchArticle(code) {
                    let data = null;
                    let error = null;
                    let isOffline = false;
                    
                    try {
                        // 1. Online-Versuch
                        const response = await window.appSupabaseClient
                            .from('artikel')
                            .select('*')
                            .eq('barcode', code)
                            .eq('client_id', window.currentClientId) // <-- NEUE FILTERUNG HINZUGEF√úGT
                            .single();
                        
                        data = response.data;
                        error = response.error;
                        
                        if (data) {
                            // Bei Erfolg: Lokale Kopie aktualisieren (upsert)
                            await window.offlineDB.upsertData('artikel', data);
                        }
                    } catch (e) {
                        // 2. Offline-Fallback
                        isOffline = true;
                        showToast("Netzwerkfehler. Suche in lokalen Daten...", 'info');
                        try {
                            data = await window.offlineDB.getArticleByBarcode(code);
                            error = null;
                            if (!data) error = { code: 'PGRST116' }; // Simuliere "not found" Fehler
                        } catch (e) {
                            console.error("IndexedDB Fehler:", e);
                        }
                    }
                    
                    if (data) {
                        // Artikel gefunden
                        let newScans = (data.scans || 0) + 1;
                        const content = `
                            <p><strong>Name:</strong> ${data.name}</p>
                            <p><strong>Barcode:</strong> ${data.barcode}</p>
                            <p><strong>Stellplatz:</strong> <span style="font-weight: 600; color: var(--color-accent-blue);">${data.stellplatz}</span></p>
                            <p><strong>Lagertyp:</strong> ${data.blocklager ? 'Blocklager' : 'Regal/Fach'}</p>
                            <p><strong>Gesamte Scans:</strong> ${newScans}</p>
                        `;
                        showResultCard("Artikel gefunden!", content, '‚úÖ');
                        
                        // Admin-Button anzeigen, wenn Admin
                        document.getElementById("registerButton").style.display = 'none';
                        if (window.currentUserRole === 'admin') {
                            // Der Admin-Bearbeiten-Button wird nicht direkt hier angezeigt, 
                            // aber das Result-Card dient auch als Info-Overlay
                            document.getElementById('result-card').innerHTML += 
                            `<div class="action-button-group"><button class="action-button register" onclick="showAdminEditPopup(${JSON.stringify(data).replace(/"/g, '&quot;')})">Bearbeiten</button></div>`;
                        }


                        // Z√§hlung aktualisieren
                        const updatePayload = { scans: newScans };
                        
                        try {
                            // 1. Online-Update
                            const { error } = await window.appSupabaseClient
                                .from('artikel')
                                .update(updatePayload)
                                .eq('barcode', code)
                                .eq('client_id', window.currentClientId); // <-- NEUE FILTERUNG HINZUGEF√úGT

                            if (error) {
                                if (error.message.includes('Failed to fetch')) {
                                    throw new Error("Offline");
                                }
                                console.error("Fehler beim Z√§hler-Update:", error);
                                showToast(`FEHLER beim Aktualisieren des Z√§hlers.`, "error");
                            } else if (!isOffline) {
                                showToast(`Scan erfolgreich! Neues Z√§hlwerk: ${newScans}`, 'success');
                                // Lokale DB direkt aktualisieren (falls online erfolgreich)
                                await window.offlineDB.updateArticleScans(code, newScans);
                            }

                        } catch (e) {
                            // 2. Offline-Update oder Netzwerkfehler beim Online-Versuch
                            isOffline = true;
                            // Lokale Daten aktualisieren und Outbox-Eintrag erstellen
                            await window.offlineDB.updateArticleScans(code, newScans);
                            await window.offlineDB.addToOutbox({ 
                                type: 'UPDATE', 
                                table: 'artikel', 
                                key: code, 
                                payload: { ...updatePayload, client_id: window.currentClientId }, // <-- client_id in Payload
                                timestamp: new Date().toISOString() 
                            });
                            showToast("Scan gespeichert. Wird synchronisiert, sobald online.", 'info');
                        }
                    } else {
                        const content = `<p>Der Barcode <strong>${code}</strong> wurde noch nicht registriert.</p>`;
                        showResultCard("Unbekannter Artikel", content, '‚ùì');
                        if (window.currentUserRole === 'admin') {
                            document.getElementById("registerButton").style.display = "block";
                        } else {
                            document.getElementById("registerButton").style.display = "none";
                        }
                        if (isOffline) {
                            showToast("Artikel nicht einmal lokal gefunden.", 'error');
                        }
                    }
                }

                /* --- ARTIKEL SPEICHERN LOGIK (F√úR NEUE ARTIKEL) --- */
                function showPopup() {
                    if (window.currentUserRole !== 'admin') {
                        showToast("Nur Administratoren d√ºrfen neue Artikel registrieren.", 'error');
                        return;
                    }
                    document.getElementById('popupBarcode').value = currentScannedBarcode;
                    document.getElementById('popupOverlay').classList.add('show');
                }

                function hidePopup() {
                    document.getElementById('popupOverlay').classList.remove('show');
                    document.getElementById('popupBaseName').value = '';
                    document.getElementById('popupSize').value = '';
                    document.getElementById('popupPlatz').value = '';
                    document.getElementById('popupBlocklager').value = 'false';
                }

                async function saveArticle() {
                    const barcode = document.getElementById('popupBarcode').value.trim();
                    const baseName = document.getElementById('popupBaseName').value.trim();
                    const sizeValue = document.getElementById('popupSize').value.trim();
                    const platz = document.getElementById('popupPlatz').value.trim();
                    const block = document.getElementById('popupBlocklager').value === 'true';
                    
                    let name = baseName;
                    if (sizeValue) {
                        const sizeDisplay = sizeValue.replace('.', ',');
                        name += ` (${sizeDisplay} L)`;
                    }
                    const lagertyp = block ? 'Blocklager' : 'Regal/Fach';

                    if (!baseName || !platz) {
                        showToast("Bitte Basis-Name und Stellplatz ausf√ºllen.", "error");
                        return;
                    }

                    const newArticle = { 
                        barcode: barcode, 
                        name: name, 
                        stellplatz: platz, 
                        blocklager: block, 
                        scans: 1, 
                        created_at: new Date().toISOString(),
                        client_id: window.currentClientId // <-- NEUE CLIENT-ID HINZUGEF√úGT
                    };

                    let success = false;
                    let isOffline = !navigator.onLine;

                    try {
                        const { error } = await window.appSupabaseClient
                            .from('artikel')
                            .insert([newArticle]);
                        
                        if (error) {
                            if (error.message.includes('Failed to fetch')) {
                                throw new Error("Offline");
                            }
                            showToast(`FEHLER beim Speichern des Artikels.`, "error");
                            console.error("Speicherfehler:", error);
                        } else {
                            success = true;
                        }

                    } catch (e) {
                        if (e.message === "Offline" || !navigator.onLine) {
                            isOffline = true;
                            // Lokale Daten aktualisieren und Outbox-Eintrag erstellen
                            await window.offlineDB.upsertData('artikel', newArticle);
                            await window.offlineDB.addToOutbox({ 
                                type: 'INSERT', 
                                table: 'artikel', 
                                key: barcode, 
                                payload: newArticle, // Enth√§lt bereits client_id
                                timestamp: new Date().toISOString() 
                            });
                            success = true;
                        } else {
                            console.error("Speicherfehler:", e);
                        }
                    }

                    if (success) {
                        const statusMessage = isOffline ? `Artikel lokal registriert. Wird bei Verbindung synchronisiert.` : `Artikel "${name}" wurde erfolgreich registriert.`;
                        showToast(statusMessage, isOffline ? "info" : "success");
                        logAdminAction('ARTICLE_REGISTERED', `Neuer Artikel "${name}" (Barcode: ${barcode}) registriert. Stellplatz: ${platz}`);
                        hidePopup();
                        hideResultCard();
                        loadArticleList(document.getElementById('articleSearchInput').value); // Liste aktualisieren
                    }
                }


                /* --- ADMIN EDIT LOGIK --- */
                function showAdminEditPopup(article) {
                    if (window.currentUserRole !== 'admin') {
                        showToast("Nur Administratoren d√ºrfen Artikel bearbeiten.", 'error');
                        return;
                    }
                    window.articleToEdit = article;
                    document.getElementById('adminEditName').value = article.name;
                    document.getElementById('adminEditBarcode').value = article.barcode;
                    document.getElementById('adminEditPlatz').value = article.stellplatz;
                    document.getElementById('adminEditPopupOverlay').style.display = "flex";
                    setTimeout(() => document.getElementById('adminEditPopupOverlay').classList.add('show'), 10);
                }

                function hideAdminEditPopup() {
                    document.getElementById('adminEditPopupOverlay').classList.remove('show');
                    setTimeout(() => {
                        document.getElementById('adminEditPopupOverlay').style.display = "none";
                        window.articleToEdit = null;
                    }, 300);
                }

                async function saveAdminEdit() {
                    if (window.currentUserRole !== 'admin' || !window.articleToEdit) return;

                    const oldPlatz = window.articleToEdit.stellplatz;
                    const newPlatz = document.getElementById('adminEditPlatz').value.trim();
                    const barcode = window.articleToEdit.barcode;

                    if (!newPlatz) {
                        showToast("Der Stellplatz darf nicht leer sein.", "error");
                        return;
                    }

                    if (newPlatz === oldPlatz) {
                        showToast("Stellplatz wurde nicht ge√§ndert.", "info");
                        hideAdminEditPopup();
                        return;
                    }

                    const updatePayload = { stellplatz: newPlatz };
                    let success = false;
                    let isOffline = !navigator.onLine;

                    try {
                        const { error } = await window.appSupabaseClient
                            .from("artikel")
                            .update(updatePayload)
                            .eq("barcode", barcode)
                            .eq('client_id', window.currentClientId); // <-- NEUE FILTERUNG HINZUGEF√úGT

                        if (error) {
                            if (error.message.includes('Failed to fetch')) {
                                throw new Error("Offline");
                            }
                            showToast(`FEHLER beim Speichern des Stellplatzes.`, "error");
                            console.error("Speicherfehler:", error);
                        } else {
                            success = true;
                        }

                    } catch (e) {
                        if (e.message === "Offline" || !navigator.onLine) {
                            isOffline = true;
                            // Lokale Daten aktualisieren und Outbox-Eintrag erstellen
                            await window.offlineDB.updateArticleStellplatz(barcode, newPlatz);
                            await window.offlineDB.addToOutbox({ 
                                type: 'UPDATE', 
                                table: 'artikel', 
                                key: barcode, 
                                payload: { ...updatePayload, client_id: window.currentClientId }, // <-- client_id in Payload
                                timestamp: new Date().toISOString() 
                            });
                            success = true;
                        } else {
                            console.error("Speicherfehler:", e);
                        }
                    }

                    if (success) {
                        const statusMessage = isOffline ? `Stellplatz lokal ge√§ndert. √Ñnderung wird bei Verbindung synchronisiert.` : `Stellplatz von "${window.articleToEdit.name}" erfolgreich auf ${newPlatz} ge√§ndert.`;
                        showToast(statusMessage, isOffline ? "info" : "success");
                        logAdminAction('ARTICLE_MOVED', `Stellplatz f√ºr "${window.articleToEdit.name}" (Barcode: ${barcode}) von ${oldPlatz} auf ${newPlatz} ge√§ndert.`);
                        window.articleToEdit = null;
                        hideAdminEditPopup();
                        loadArticleList(document.getElementById('articleSearchInput').value); // Liste aktualisieren
                    }
                }

                function deleteArticle() {
                    if (window.currentUserRole !== 'admin' || !window.articleToEdit) return;
                    
                    document.getElementById('adminEditPopupOverlay').classList.remove('show'); // Admin-Edit-Popup ausblenden
                    
                    document.getElementById('deleteConfirmMessage').innerHTML = `Sind Sie sicher, dass Sie den Artikel <strong>"${window.articleToEdit.name}"</strong> mit dem Barcode <strong>${window.articleToEdit.barcode}</strong> unwiderruflich l√∂schen m√∂chten?`;
                    document.getElementById('deleteConfirmPopupOverlay').style.display = "flex";
                    setTimeout(() => document.getElementById('deleteConfirmPopupOverlay').classList.add('show'), 10);
                }

                function hideDeleteConfirmPopup() {
                    document.getElementById('deleteConfirmPopupOverlay').classList.remove('show');
                    setTimeout(() => document.getElementById('deleteConfirmPopupOverlay').style.display = "none", 300);
                }

                async function confirmDeleteArticle() {
                    if (window.currentUserRole !== 'admin' || !window.articleToEdit) return;
                    
                    const barcode = window.articleToEdit.barcode;
                    const articleName = window.articleToEdit.name;
                    
                    let success = false;
                    let isOffline = !navigator.onLine;

                    try {
                        const { error } = await window.appSupabaseClient
                            .from("artikel")
                            .delete()
                            .eq("barcode", barcode)
                            .eq('client_id', window.currentClientId); // <-- NEUE FILTERUNG HINZUGEF√úGT

                        if (error) {
                            if (error.message.includes('Failed to fetch')) {
                                throw new Error("Offline");
                            }
                            showToast(`FEHLER beim L√∂schen des Artikels.`, "error");
                            console.error("L√∂schfehler:", error);
                        } else {
                            success = true;
                        }

                    } catch (e) {
                        if (e.message === "Offline" || !navigator.onLine) {
                            isOffline = true;
                            // Lokale Daten l√∂schen und Outbox-Eintrag erstellen
                            await window.offlineDB.deleteArticle(barcode);
                            await window.offlineDB.addToOutbox({ 
                                type: 'DELETE', 
                                table: 'artikel', 
                                key: barcode, 
                                payload: { barcode: barcode, client_id: window.currentClientId }, // <-- client_id in Payload
                                timestamp: new Date().toISOString() 
                            });
                            success = true;
                        } else {
                            console.error("L√∂schfehler:", e);
                        }
                    }

                    if (success) {
                        const statusMessage = isOffline ? `Artikel lokal gel√∂scht. L√∂schvorgang wird bei Verbindung synchronisiert.` : `Artikel "${articleName}" wurde erfolgreich gel√∂scht.`;
                        showToast(statusMessage, isOffline ? "info" : "success");
                        logAdminAction('ARTICLE_DELETED', `Artikel "${articleName}" (Barcode: ${barcode}) unwiderruflich gel√∂scht.`);
                        window.articleToEdit = null;
                        hideDeleteConfirmPopup();
                        loadArticleList(document.getElementById('articleSearchInput').value);
                    }
                }


                /* --- RESULT CARD LOGIK --- */

                function showResultCard(title, contentHTML, icon) {
                    document.getElementById('cardTitleText').innerText = title;
                    document.getElementById('cardStatusIcon').innerText = icon;
                    document.getElementById('cardContent').innerHTML = contentHTML;
                    document.getElementById('result-card').classList.add('active');
                }

                function hideResultCard() {
                    document.getElementById('result-card').classList.remove('active');
                    lastCode = "";
                    document.getElementById("scanFrame").style.display = "block";
                    if (html5QrCode && html5QrCode.isScanning) {
                        html5QrCode.resume();
                    }
                }


                /* --- ARTIKEL LISTE LOGIK --- */

                async function loadArticleList(searchTerm = '') {
                    const articleListContainer = document.getElementById('articleList');
                    let data = [];
                    let isOffline = false;
                    
                    // Spinner anzeigen
                    articleListContainer.innerHTML = '<li style="text-align: center; border: none; background: transparent; padding: 20px;">Lade Artikel...</li>';


                    try {
                        // 1. Online-Versuch
                        let query = window.appSupabaseClient
                            .from('artikel')
                            .select('*')
                            .eq('client_id', window.currentClientId); // <-- NEUE FILTERUNG HINZUGEF√úGT

                        if (searchTerm) {
                            const search = `%${searchTerm.toLowerCase()}%`;
                            query = query.or(`name.ilike.${search},barcode.ilike.${search},stellplatz.ilike.${search}`);
                        }
                        
                        const { data: articles, error } = await query.order('name', { ascending: true });

                        if (error) {
                            if (error.message.includes('Failed to fetch')) { 
                                throw new Error("Offline");
                            }
                            throw error;
                        }

                        data = articles;
                        
                        // Bei Erfolg: Lokalen Cache aktualisieren
                        if (data.length > 0) {
                            // L√∂schen Sie nur Artikel mit der aktuellen client_id, falls m√∂glich, 
                            // aber da IndexedDB keine RLS-Filterung kennt, leeren wir und f√ºgen alle
                            // von Supabase gefilterten Daten hinzu.
                            await window.offlineDB.clearData('artikel'); 
                            await window.offlineDB.bulkInsertData('artikel', data);
                        } else {
                            await window.offlineDB.clearData('artikel'); 
                        }

                    } catch (error) {
                        isOffline = true;
                        showToast("Netzwerkfehler. Zeige lokale Artikel...", 'info');
                        // 2. Offline-Fallback (IndexedDB)
                        try {
                            const localData = await window.offlineDB.getAllArticles();
                            data = localData.filter(item => {
                                // Zus√§tzliche Filterung nach client_id im Offline-Modus (Sicherheitsma√ünahme)
                                if (item.client_id !== window.currentClientId) return false; 
                                
                                if (!searchTerm) return true;
                                const term = searchTerm.toLowerCase();
                                return item.name.toLowerCase().includes(term) || item.barcode.toLowerCase().includes(term) || item.stellplatz.toLowerCase().includes(term);
                            }).sort((a, b) => a.name.localeCompare(b.name));
                        } catch (e) {
                            showToast("Fehler beim Laden der lokalen Artikel.", 'error');
                            console.error("IndexedDB Fehler:", e);
                        }
                    }

                    if (data.length === 0) {
                        articleListContainer.innerHTML = `<li style="border-left: 5px solid rgba(255, 255, 255, 0.2); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">${searchTerm ? 'Keine Artikel gefunden, die der Suche entsprechen.' : 'Noch keine Artikel vorhanden.'}</li>`;
                        return;
                    }

                    articleListContainer.innerHTML = '';
                    data.forEach(item => {
                        const listItem = document.createElement('li');
                        if (window.currentUserRole === 'admin') {
                            listItem.onclick = () => showAdminEditPopup(item);
                            listItem.style.cursor = 'pointer';
                            listItem.setAttribute('data-role', 'admin-editable');
                        }
                        const isBlocklager = item.blocklager;
                        const lagertypIconSvg = isBlocklager ? WAREHOUSE_ICON_SVG : SHELF_ICON_SVG;
                        const lagertypLabel = isBlocklager ? 'BLOCK' : 'REGAL';
                        
                        const details = `
                            <div class="item-details">
                                <strong>${item.name}</strong>
                                <span>Stellplatz: ${item.stellplatz} | Barcode: ${item.barcode}</span>
                            </div>
                            <div class="item-count">
                                ${lagertypIconSvg}
                                <span class="item-label">${lagertypLabel}</span>
                            </div>
                        `;
                        listItem.innerHTML = details;
                        articleListContainer.appendChild(listItem);
                    });

                    if (isOffline) {
                        articleListContainer.innerHTML += '<li style="margin-top: 15px; text-align: center; color: var(--color-warning-yellow); border: none; background: transparent; padding: 5px;">Offline-Modus aktiv.</li>';
                    }
                }


                /* --- ADMIN LOGGING FUNKTION --- */

                async function logAdminAction(actionType, description) {
                    if (window.currentUserRole !== 'admin') {
                        console.warn("Versuch, eine Admin-Aktion ohne Admin-Rechte zu protokollieren.");
                        return;
                    }
                    
                    const logEntry = {
                        action_type: actionType,
                        description: description,
                        user_role: window.currentUserRole,
                        created_at: new Date().toISOString(),
                        client_id: window.currentClientId // <-- NEUE CLIENT-ID HINZUGEF√úGT
                    };

                    let isOffline = !navigator.onLine;

                    try {
                        const { error } = await window.appSupabaseClient
                            .from('audit_log')
                            .insert([logEntry]);

                        if (error) {
                            if (error.message.includes('Failed to fetch')) { 
                                // Supabase Netzwerkfehler
                                throw new Error("Offline");
                            }
                            throw error;
                        }
                        // Online: Lokalen Cache aktualisieren
                        await window.offlineDB.upsertData('audit_log', logEntry, 'created_at');

                    } catch (e) {
                        if (e.message === "Offline" || !navigator.onLine) {
                            isOffline = true;
                            // Outbox-Eintrag erstellen
                            await window.offlineDB.addToOutbox({
                                type: 'INSERT',
                                table: 'audit_log',
                                key: logEntry.created_at, // Zeitstempel als Schl√ºssel
                                payload: logEntry, // Enth√§lt bereits client_id
                                timestamp: new Date().toISOString()
                            });
                        } else {
                            console.error("Log-Fehler:", e);
                        }
                    }
                }

                async function loadAdminLog(searchTerm = '') {
                    if (window.currentUserRole !== 'admin') {
                        document.getElementById('logList').innerHTML = '<li style="text-align: center; color: var(--color-error-red); border: none; background: transparent; padding: 20px;">Keine Berechtigung.</li>';
                        return;
                    }

                    const logListContainer = document.getElementById('logList');
                    let logData = [];
                    let isOffline = false;

                    // Spinner anzeigen
                    logListContainer.innerHTML = '<li style="text-align: center; border: none; background: transparent; padding: 20px;">Lade Logbuch...</li>';

                    try {
                        // 1. Online-Versuch
                        let query = window.appSupabaseClient
                            .from('audit_log')
                            .select('*')
                            .eq('client_id', window.currentClientId); // <-- NEUE FILTERUNG HINZUGEF√úGT

                        if (searchTerm) {
                            const search = `%${searchTerm.toLowerCase()}%`;
                            query = query.or(`action_type.ilike.${search},description.ilike.${search}`);
                        }

                        const { data: logs, error } = await query
                            .order('created_at', { ascending: false });

                        if (error) {
                            if (error.message.includes('Failed to fetch')) { 
                                // Supabase Netzwerkfehler
                                throw new Error("Offline");
                            }
                            throw error;
                        }

                        logData = logs;
                        
                        // Bei Erfolg: Lokalen Cache aktualisieren
                        if (logData.length > 0) {
                            await window.offlineDB.clearData('audit_log');
                            await window.offlineDB.bulkInsertData('audit_log', logData);
                        } else {
                            await window.offlineDB.clearData('audit_log');
                        }

                    } catch (error) {
                        isOffline = true;
                        showToast("Netzwerkfehler. Zeige lokale Log-Eintr√§ge...", 'info');
                        // 2. Offline-Fallback (IndexedDB)
                        try {
                            const localData = await window.offlineDB.getAllLogs();
                            logData = localData.filter(item => {
                                // Zus√§tzliche Filterung nach client_id im Offline-Modus (Sicherheitsma√ünahme)
                                if (item.client_id !== window.currentClientId) return false; 
                                
                                if (!searchTerm) return true;
                                const term = searchTerm.toLowerCase();
                                return item.action_type.toLowerCase().includes(term) || item.description.toLowerCase().includes(term);
                            }).sort((a, b) => b.created_at.localeCompare(a.created_at));
                        } catch (e) {
                            showToast("Fehler beim Laden der lokalen Log-Eintr√§ge.", 'error');
                            console.error("IndexedDB Fehler:", e);
                        }
                    }

                    logListContainer.innerHTML = '';

                    if (logData.length === 0) {
                        logListContainer.innerHTML = `<li style="border-left: 5px solid rgba(255, 255, 255, 0.2); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">${searchTerm ? 'Keine Logbuch-Eintr√§ge gefunden, die der Suche entsprechen.' : 'Keine Logbuch-Eintr√§ge vorhanden.'}</li>`;
                        return;
                    }

                    logData.forEach(item => {
                        const dateSource = item.created_at;
                        const timestamp = new Date(dateSource).toLocaleString('de-DE', { dateStyle: 'short', timeStyle: 'medium' });
                        
                        let color = 'var(--color-accent-blue)';
                        if (item.action_type.includes('DELETE')) {
                            color = 'var(--color-error-red)';
                        } else if (item.action_type.includes('REGISTERED') || item.action_type.includes('IMPORTED')) {
                            color = 'var(--color-accent-green)';
                        } else if (item.action_type.includes('USER') || item.action_type.includes('ADMIN')) {
                            color = 'var(--color-warning-yellow)';
                        }


                        const listItem = document.createElement('li');
                        listItem.style.borderLeftColor = color;
                        
                        const details = `
                            <div class="item-details" style="flex-grow: 1;">
                                <strong>[${item.action_type}]</strong>
                                <span>${item.description}</span>
                            </div>
                            <div style="font-size: 0.75rem; opacity: 0.8; text-align: right; margin-left: 10px; flex-shrink: 0;">
                                ${timestamp}
                            </div>
                        `;
                        listItem.innerHTML = details;
                        logListContainer.appendChild(listItem);
                    });

                    if (isOffline) {
                        logListContainer.innerHTML += '<li style="margin-top: 15px; text-align: center; color: var(--color-warning-yellow); border: none; background: transparent; padding: 5px;">Offline-Modus aktiv.</li>';
                    }
                }


                /* --- BENUTZERLISTE LOGIK (ADMIN) --- */

                async function loadUserList(searchTerm = '') {
                    if (window.currentUserRole !== 'admin') {
                        document.getElementById('userList').innerHTML = '<li style="text-align: center; color: var(--color-error-red); border: none; background: transparent; padding: 20px;">Keine Berechtigung.</li>';
                        return;
                    }

                    const userListContainer = document.getElementById('userList');
                    let users = [];
                    let isOffline = false;

                    // Spinner anzeigen
                    userListContainer.innerHTML = '<li style="text-align: center; border: none; background: transparent; padding: 20px;">Lade Benutzerliste...</li>';

                    try {
                        // 1. Online-Versuch
                        let query = window.appSupabaseClient
                            .from('user_roles')
                            .select('*')
                            .eq('client_id', window.currentClientId); // <-- NEUE FILTERUNG HINZUGEF√úGT

                        if (searchTerm) {
                            const search = `%${searchTerm.toLowerCase()}%`;
                            query = query.or(`email.ilike.${search},role.ilike.${search},notes.ilike.${search}`);
                        }

                        const { data: userData, error } = await query
                            .order('email', { ascending: true });

                        if (error) {
                            if (error.message.includes('Failed to fetch')) { 
                                // Supabase Netzwerkfehler
                                throw new Error("Offline");
                            }
                            throw error;
                        }

                        users = userData;
                        
                        // Bei Erfolg: Lokalen Cache aktualisieren
                        if (users.length > 0) {
                            await window.offlineDB.clearData('user_roles');
                            await window.offlineDB.bulkInsertData('user_roles', users);
                        } else {
                            await window.offlineDB.clearData('user_roles');
                        }

                    } catch (error) {
                        isOffline = true;
                        showToast("Netzwerkfehler. Zeige lokale Benutzerdaten...", 'info');
                        // 2. Offline-Fallback (IndexedDB)
                        try {
                            const localData = await window.offlineDB.getAllUsers();
                            users = localData.filter(item => {
                                // Zus√§tzliche Filterung nach client_id im Offline-Modus (Sicherheitsma√ünahme)
                                if (item.client_id !== window.currentClientId) return false; 
                                
                                if (!searchTerm) return true;
                                const term = searchTerm.toLowerCase();
                                return item.email.toLowerCase().includes(term) || (item.notes || '').toLowerCase().includes(term) || (item.role || '').toLowerCase().includes(term);
                            }).sort((a, b) => a.email.localeCompare(b.email));
                        } catch (e) {
                            showToast("Fehler beim Laden der lokalen Benutzerliste.", 'error');
                            console.error("IndexedDB Fehler:", e);
                        }
                    }

                    userListContainer.innerHTML = '';

                    if (users.length === 0) {
                        userListContainer.innerHTML = `<li style="border-left: 5px solid rgba(255, 255, 255, 0.2); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">${searchTerm ? 'Keine Benutzer gefunden, die der Suche entsprechen.' : 'Keine Benutzerkonten vorhanden.'}</li>`;
                        return;
                    }

                    users.forEach(user => {
                        const listItem = document.createElement('li');
                        listItem.onclick = () => showUserEditPopup(user);
                        listItem.style.cursor = 'pointer';
                        listItem.setAttribute('data-role', 'admin-editable');
                        
                        if (user.role === 'admin') {
                            listItem.classList.add('user-role-admin');
                        }
                        if (user.is_blocked) {
                            listItem.classList.add('user-is-blocked');
                        }

                        const status = user.is_blocked ? 'Gesperrt' : 'Aktiv';
                        
                        const details = `
                            <div class="item-details">
                                <strong>${user.email}</strong>
                                <span>Rolle: ${user.role} | Status: ${status}</span>
                            </div>
                            <button class="user-edit-button">Edit</button>
                        `;
                        listItem.innerHTML = details;
                        userListContainer.appendChild(listItem);
                    });

                    if (isOffline) {
                        userListContainer.innerHTML += '<li style="margin-top: 15px; text-align: center; color: var(--color-warning-yellow); border: none; background: transparent; padding: 5px;">Offline-Modus aktiv.</li>';
                    }
                }

                function showUserEditPopup(user) {
                    if (window.currentUserRole !== 'admin') {
                        showToast("Nur Administratoren d√ºrfen Benutzer bearbeiten.", 'error');
                        return;
                    }
                    window.userToEdit = user;
                    document.getElementById('userEditEmail').value = user.email;
                    document.getElementById('userEditRole').value = user.role || 'user';
                    document.getElementById('userEditBlocked').value = user.is_blocked ? 'true' : 'false';
                    document.getElementById('userEditNotes').value = user.notes || '';
                    
                    document.getElementById('userEditPopupOverlay').style.display = "flex";
                    setTimeout(() => document.getElementById('userEditPopupOverlay').classList.add('show'), 10);
                }

                function hideUserEditPopup() {
                    document.getElementById('userEditPopupOverlay').classList.remove('show');
                    setTimeout(() => {
                        document.getElementById('userEditPopupOverlay').style.display = "none";
                        window.userToEdit = null;
                    }, 300);
                }

                async function saveUserEdit() {
                    if (window.currentUserRole !== 'admin' || !window.userToEdit) return;

                    const email = window.userToEdit.email;
                    const newRole = document.getElementById('userEditRole').value;
                    const newBlockedStatus = document.getElementById('userEditBlocked').value === 'true';
                    const newNotes = document.getElementById('userEditNotes').value.trim();
                    const userId = window.userToEdit.id;

                    const oldRole = window.userToEdit.role || 'user';
                    const oldBlockedStatus = window.userToEdit.is_blocked;
                    const oldNotes = window.userToEdit.notes || '';

                    if (newRole === oldRole && newBlockedStatus === oldBlockedStatus && newNotes === oldNotes) {
                        showToast("Es wurden keine √Ñnderungen vorgenommen.", "info");
                        hideUserEditPopup();
                        return;
                    }

                    const updatePayload = {
                        role: newRole,
                        is_blocked: newBlockedStatus,
                        notes: newNotes,
                    };
                    
                    let success = false;
                    let isOffline = !navigator.onLine;

                    try {
                        const { error } = await window.appSupabaseClient
                            .from("user_roles")
                            .update(updatePayload)
                            .eq("id", userId)
                            .eq('client_id', window.currentClientId); // <-- NEUE FILTERUNG HINZUGEF√úGT

                        if (error) {
                            if (error.message.includes('Failed to fetch')) {
                                // Supabase Netzwerkfehler
                                throw new Error("Offline");
                            }
                            showToast(`FEHLER beim Speichern der Benutzerdaten.`, "error");
                            console.error("Speicherfehler Benutzer:", error);
                        } else {
                            success = true;
                        }

                    } catch (e) {
                        if (e.message === "Offline" || !navigator.onLine) {
                            isOffline = true;
                            // Lokale Daten aktualisieren und Outbox-Eintrag erstellen
                            await window.offlineDB.upsertData('user_roles', {...window.userToEdit, ...updatePayload});
                            await window.offlineDB.addToOutbox({ 
                                type: 'UPDATE', 
                                table: 'user_roles', 
                                key: userId, 
                                payload: { ...updatePayload, client_id: window.currentClientId }, // <-- client_id in Payload
                                timestamp: new Date().toISOString() 
                            });
                            success = true;
                        } else {
                            console.error("Speicherfehler Benutzer:", e);
                        }
                    }

                    if (success) {
                        let logMessage = `Benutzer ${email} aktualisiert.`;
                        if (newRole !== oldRole) logMessage += ` Rolle: ${oldRole} -> ${newRole}.`;
                        if (newBlockedStatus !== oldBlockedStatus) logMessage += ` Status: ${oldBlockedStatus ? 'Gesperrt' : 'Aktiv'} -> ${newBlockedStatus ? 'Gesperrt' : 'Aktiv'}.`;
                        
                        showToast("Benutzerdaten erfolgreich gespeichert.", isOffline ? "info" : "success");
                        logAdminAction('USER_EDITED', logMessage.trim());
                        window.userToEdit = null;
                        hideUserEditPopup();
                        loadUserList(document.getElementById('userSearchInput').value); // Liste aktualisieren
                    }
                }


                /* --- DATEN IMPORT/EXPORT LOGIK (Admin) --- */

                // Hilfsfunktion zum Konvertieren von JSON in CSV
                function convertToCSV(data) {
                    if (data.length === 0) return '';

                    // Wir verwenden eine statische Liste der Spalten, um die Reihenfolge beizubehalten
                    // F√ºgen Sie client_id hinzu (obwohl Sie es vielleicht nicht exportieren wollen, 
                    // aber es ist wichtig f√ºr die Struktur)
                    const keys = ['barcode', 'name', 'stellplatz', 'blocklager', 'scans', 'created_at', 'client_id'];
                    const header = keys.join(';');
                    
                    const rows = data.map(row => keys.map(k => {
                        let value = row[k] === null || row[k] === undefined ? '' : String(row[k]);
                        // Anf√ºhrungszeichen escapen und umrahmen, falls Semikolons oder Zeilenumbr√ºche enthalten sind
                        if (value.includes(';') || value.includes('\n') || value.includes('"')) {
                            value = `"${value.replace(/"/g, '""')}"`;
                        }
                        return value;
                    }).join(';'));
                    
                    return [header, ...rows].join('\n');
                }

                function downloadFile(filename, content, mimeType) {
                    const blob = new Blob([content], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }

                async function exportData(format) {
                    if (window.currentUserRole !== 'admin') {
                        showToast("Nur Administratoren d√ºrfen Daten exportieren.", 'error');
                        return;
                    }
                    
                    showToast("Starte Datenexport...", 'info');

                    try {
                        // Exportiert nur Daten des aktuellen Mandanten (RLS greift hier auch!)
                        const { data: articles, error } = await window.appSupabaseClient
                            .from('artikel')
                            .select('*')
                            .eq('client_id', window.currentClientId); 

                        if (error) throw error;

                        if (articles.length === 0) {
                            showToast("Keine Artikel zum Exportieren gefunden.", 'info');
                            return;
                        }

                        const now = new Date().toISOString().slice(0, 10);
                        let content;
                        let filename;
                        let mimeType;

                        if (format === 'json') {
                            content = JSON.stringify(articles, null, 2);
                            filename = `inventar_export_${now}.json`;
                            mimeType = 'application/json';
                        } else if (format === 'csv') {
                            content = convertToCSV(articles);
                            filename = `inventar_export_${now}.csv`;
                            mimeType = 'text/csv';
                        }

                        downloadFile(filename, content, mimeType);
                        logAdminAction('DATA_EXPORTED', `Daten im Format ${format.toUpperCase()} exportiert (${articles.length} Artikel).`);
                        showToast("Export erfolgreich!", 'success');

                    } catch (error) {
                        showToast("FEHLER beim Export der Daten.", 'error', 7000);
                        console.error("Export Fehler:", error);
                    }
                }

                // Hilfsfunktion zum Parsen von CSV (einfaches Semikolon-Trennzeichen erwartet)
                function parseCSV(csvText) {
                    const lines = csvText.trim().split('\n');
                    if (lines.length < 2) return [];

                    // Header mit Semikolon als Trennzeichen
                    const headers = lines[0].split(';').map(h => h.trim().toLowerCase().replace(/[^a-z0-9_]/g, ''));
                    const result = [];

                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(';');
                        if (values.length !== headers.length) continue; // Zeilen mit inkorrekter Spaltenzahl √ºberspringen

                        const obj = {};
                        values.forEach((v, index) => {
                            let header = headers[index];
                            let value = v.trim();
                            // Entferne umgebende Anf√ºhrungszeichen und unescape
                            if (value.startsWith('"') && value.endsWith('"')) {
                                value = value.substring(1, value.length - 1).replace(/""/g, '"');
                            }
                            obj[header] = value;
                        });
                        
                        // Konvertiere boolsche/numerische Felder (blocklager, scans)
                        if (obj.blocklager) {
                            obj.blocklager = obj.blocklager.toLowerCase() === 'true' || obj.blocklager === '1';
                        }
                        if (obj.scans) {
                            obj.scans = parseInt(obj.scans) || 0;
                        }

                        result.push(obj);
                    }
                    return result;
                }

                function prepareImport() {
                    if (window.currentUserRole !== 'admin') {
                        showToast("Nur Administratoren d√ºrfen Daten importieren.", 'error');
                        return;
                    }

                    const fileInput = document.getElementById('importFile');
                    const file = fileInput.files[0];

                    if (!file) {
                        showToast("Bitte w√§hlen Sie eine Datei aus.", 'error');
                        return;
                    }

                    // Disable button during process
                    document.getElementById('importButton').disabled = true;

                    const reader = new FileReader();

                    reader.onload = async (e) => {
                        try {
                            let parsedData;
                            const fileContent = e.target.result;
                            const filename = file.name.toLowerCase();

                            if (filename.endsWith('.json')) {
                                parsedData = JSON.parse(fileContent);
                            } else if (filename.endsWith('.csv')) {
                                parsedData = parseCSV(fileContent);
                            } else {
                                showToast("Nicht unterst√ºtztes Dateiformat.", 'error');
                                document.getElementById('importButton').disabled = false;
                                return;
                            }

                            if (!Array.isArray(parsedData) || parsedData.length === 0) {
                                showToast("Die Datei enth√§lt keine g√ºltigen Artikeldaten.", 'error');
                                document.getElementById('importButton').disabled = false;
                                return;
                            }
                            
                            await importArticles(parsedData, file.name);

                        } catch (error) {
                            showToast("Fehler beim Verarbeiten der Datei. (Falsches Format?)", 'error', 7000);
                            console.error("Dateiverarbeitungsfehler:", error);
                        } finally {
                            document.getElementById('importButton').disabled = false;
                        }
                    };

                    reader.onerror = () => {
                        showToast("Fehler beim Lesen der Datei.", 'error');
                        document.getElementById('importButton').disabled = false;
                    };

                    reader.readAsText(file);
                }

                async function importArticles(articles, filename) {
                    if (!articles || articles.length === 0) {
                        showToast("Keine Daten zum Importieren gefunden.", 'info');
                        return;
                    }

                    // Daten f√ºr Supabase vorbereiten (nur notwendige Felder)
                    const allowedFields = ['barcode', 'name', 'stellplatz', 'blocklager', 'scans'];
                    
                    const upsertData = articles.map(article => {
                        const item = {};
                        allowedFields.forEach(field => {
                            // Wir erlauben nur definierte Felder.
                            if (article.hasOwnProperty(field)) {
                                item[field] = article[field];
                            }
                        });

                        // Sicherstellen, dass Pflichtfelder vorhanden und Typen korrekt sind
                        if (typeof item.blocklager !== 'boolean') item.blocklager = item.blocklager === true || item.blocklager === 'true'; // JSON kann boolsche Werte haben
                        if (typeof item.scans !== 'number') item.scans = parseInt(item.scans) || 0;
                        
                        item.client_id = window.currentClientId; // NEU: client_id hinzuf√ºgen
                        
                        return item;
                    }).filter(item => item.barcode && item.name && item.stellplatz); 

                    // Nur Artikel mit allen Pflichtfeldern importieren
                    if (upsertData.length === 0) {
                        showToast("Keine Artikel mit g√ºltigem Barcode, Name und Stellplatz zum Importieren gefunden.", 'error', 7000);
                        return;
                    }

                    showToast(`Starte Import von ${upsertData.length} g√ºltigen Artikeln...`, 'info', 10000);

                    // Supabase upsert (batch insert/update)
                    // Wichtig: 'onConflict: 'barcode'' f√ºr UPSERT
                    const { error } = await window.appSupabaseClient
                        .from('artikel')
                        .upsert(upsertData, { 
                            onConflict: 'barcode' 
                        });

                    if (error) {
                        showToast("FEHLER beim Import. √úberpr√ºfen Sie die Daten und RLS-Policies.", 'error', 10000);
                        console.error("Import Fehler:", error);
                    } else {
                        logAdminAction('DATA_IMPORTED', `${upsertData.length} Artikel erfolgreich aus Datei ${filename} importiert/aktualisiert.`);
                        showToast(`Import von ${upsertData.length} Artikeln erfolgreich abgeschlossen!`, 'success');
                        loadArticleList(document.getElementById('articleSearchInput').value); // Liste aktualisieren
                    }
                }


                /* --- TOAST & NAVIGATION LOGIK --- */

                function showToast(message, type = 'info', duration = 3000) {
                    const toastContainer = document.getElementById('toastContainer');
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    
                    let icon = '‚ÑπÔ∏è';
                    if (type === 'success') icon = '‚úÖ';
                    if (type === 'error') icon = '‚ùå';

                    toast.innerHTML = `<span class="toast-icon">${icon}</span> ${message}`;
                    
                    // F√ºge Toast hinzu
                    toastContainer.prepend(toast);
                    
                    // Zeige Toast an
                    setTimeout(() => {
                        toast.classList.add('show');
                    }, 10);

                    // Verstecke und entferne Toast nach Dauer
                    setTimeout(() => {
                        toast.classList.remove('show');
                        setTimeout(() => {
                            toastContainer.removeChild(toast);
                        }, 300); // Warte, bis die Transition abgeschlossen ist
                    }, duration);
                }

                function changeTab(tabId) {
                    // Scanner stoppen, wenn wir den Tab wechseln
                    if (tabId !== 'scannerTab' && window.currentTabId === 'scannerTab') {
                        stopScanner();
                    }
                    
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');

                    document.querySelectorAll('.nav-item').forEach(nav => {
                        nav.classList.remove('active');
                        if (nav.getAttribute('data-tab') === tabId) {
                            nav.classList.add('active');
                        }
                    });

                    window.currentTabId = tabId;
                    
                    // Daten f√ºr Listen-Tabs laden
                    if (tabId === 'listTab') {
                        loadArticleList(document.getElementById('articleSearchInput').value);
                    } else if (tabId === 'logTab') {
                        loadAdminLog(document.getElementById('logSearchInput').value);
                    } else if (tabId === 'usersTab') {
                        loadUserList(document.getElementById('userSearchInput').value);
                    }
                }

                /* --- OFFLINE/INDEXEDDB LOGIK --- */

                // IndexedDB Wrapper Klasse (Nur die Methoden, die ben√∂tigt werden)
                class OfflineDB {
                    constructor() {
                        this.db = null;
                        this.dbName = 'InventoryDB';
                        this.dbVersion = 1;
                    }

                    open() {
                        return new Promise((resolve, reject) => {
                            if (this.db) {
                                resolve();
                                return;
                            }

                            const request = indexedDB.open(this.dbName, this.dbVersion);

                            request.onupgradeneeded = (event) => {
                                const db = event.target.result;
                                
                                // Artikel-Speicher (Schl√ºssel: barcode)
                                if (!db.objectStoreNames.contains('artikel')) {
                                    db.createObjectStore('artikel', { keyPath: 'barcode' });
                                }

                                // Benutzerrollen-Speicher (Schl√ºssel: id/uuid)
                                if (!db.objectStoreNames.contains('user_roles')) {
                                    db.createObjectStore('user_roles', { keyPath: 'id' });
                                }

                                // Logbuch-Speicher (Schl√ºssel: created_at)
                                if (!db.objectStoreNames.contains('audit_log')) {
                                    db.createObjectStore('audit_log', { keyPath: 'created_at' });
                                }

                                // Outbox f√ºr Offline-√Ñnderungen (Schl√ºssel: Inkrementeller Index)
                                if (!db.objectStoreNames.contains('outbox')) {
                                    const outboxStore = db.createObjectStore('outbox', { keyPath: 'id', autoIncrement: true });
                                    outboxStore.createIndex('timestamp', 'timestamp', { unique: false });
                                }
                            };

                            request.onsuccess = (event) => {
                                this.db = event.target.result;
                                resolve();
                            };

                            request.onerror = (event) => {
                                console.error("IndexedDB Fehler:", event.target.error);
                                reject(event.target.error);
                            };
                        });
                    }

                    // Generische CRUD Helfer
                    async upsertData(storeName, data, keyPath = null) {
                        await this.open();
                        return new Promise((resolve, reject) => {
                            const transaction = this.db.transaction(storeName, 'readwrite');
                            const store = transaction.objectStore(storeName);
                            let request;
                            if (keyPath) {
                                request = store.put(data, data[keyPath]);
                            } else {
                                request = store.put(data);
                            }
                            request.onsuccess = () => resolve();
                            request.onerror = (event) => reject(event.target.error);
                        });
                    }

                    async getData(storeName, key) {
                        await this.open();
                        return new Promise((resolve, reject) => {
                            const transaction = this.db.transaction(storeName, 'readonly');
                            const store = transaction.objectStore(storeName);
                            const request = store.get(key);
                            request.onsuccess = () => resolve(request.result);
                            request.onerror = (event) => reject(event.target.error);
                        });
                    }

                    async getAllData(storeName) {
                        await this.open();
                        return new Promise((resolve, reject) => {
                            const transaction = this.db.transaction(storeName, 'readonly');
                            const store = transaction.objectStore(storeName);
                            const request = store.getAll();
                            request.onsuccess = () => resolve(request.result);
                            request.onerror = (event) => reject(event.target.error);
                        });
                    }

                    async deleteData(storeName, key) {
                        await this.open();
                        return new Promise((resolve, reject) => {
                            const transaction = this.db.transaction(storeName, 'readwrite');
                            const store = transaction.objectStore(storeName);
                            const request = store.delete(key);
                            request.onsuccess = () => resolve();
                            request.onerror = (event) => reject(event.target.error);
                        });
                    }

                    async clearData(storeName) {
                        await this.open();
                        return new Promise((resolve, reject) => {
                            const transaction = this.db.transaction(storeName, 'readwrite');
                            const store = transaction.objectStore(storeName);
                            const request = store.clear();
                            request.onsuccess = () => resolve();
                            request.onerror = (event) => reject(event.target.error);
                        });
                    }
                    
                    async bulkInsertData(storeName, dataArray) {
                        await this.open();
                        return new Promise((resolve, reject) => {
                            const transaction = this.db.transaction(storeName, 'readwrite');
                            const store = transaction.objectStore(storeName);
                            
                            // F√ºge alle Daten hinzu
                            dataArray.forEach(data => {
                                // Verwende put() f√ºr upsert-Verhalten
                                if (storeName === 'audit_log') {
                                    store.put(data, data.created_at); // Log hat created_at als keyPath
                                } else {
                                    store.put(data);
                                }
                            });

                            transaction.oncomplete = () => resolve();
                            transaction.onerror = (event) => reject(event.target.error);
                        });
                    }


                    // Artikel Helfer
                    async getArticleByBarcode(barcode) {
                        return this.getData('artikel', barcode);
                    }

                    async getAllArticles() {
                        return this.getAllData('artikel');
                    }

                    async deleteArticle(barcode) {
                        return this.deleteData('artikel', barcode);
                    }

                    async updateArticleScans(barcode, newScans) {
                        const article = await this.getArticleByBarcode(barcode);
                        if (article) {
                            article.scans = newScans;
                            await this.upsertData('artikel', article);
                        }
                    }

                    async updateArticleStellplatz(barcode, newPlatz) {
                        const article = await this.getArticleByBarcode(barcode);
                        if (article) {
                            article.stellplatz = newPlatz;
                            await this.upsertData('artikel', article);
                        }
                    }

                    // Log Helfer
                    async getAllLogs() {
                        // Logs sind chronologisch sortiert, daher nur getAll
                        return this.getAllData('audit_log');
                    }
                    
                    // User Helfer
                    async getAllUsers() {
                        return this.getAllData('user_roles');
                    }


                    // Outbox Helfer
                    async addToOutbox(operation) {
                        return this.upsertData('outbox', operation);
                    }

                    async getOutboxOperations() {
                        await this.open();
                        return new Promise((resolve, reject) => {
                            const transaction = this.db.transaction('outbox', 'readonly');
                            const store = transaction.objectStore('outbox');
                            const index = store.index('timestamp'); // Index nach Zeitstempel
                            const request = index.getAll(); 
                            
                            request.onsuccess = () => resolve(request.result);
                            request.onerror = (event) => reject(event.target.error);
                        });
                    }
                }


                function initOfflineSync() {
                    if (!window.indexedDB) {
                        showToast("Ihr Browser unterst√ºtzt keinen Offline-Modus.", 'error', 10000);
                        return;
                    }

                    window.offlineDB = new OfflineDB();
                    window.offlineDB.open()
                        .then(() => {
                            console.log("IndexedDB erfolgreich ge√∂ffnet.");
                            // Listener f√ºr Netzwerkverbindung hinzuf√ºgen
                            window.addEventListener('online', () => syncData(false));
                        })
                        .catch(e => console.error("IndexedDB konnte nicht ge√∂ffnet werden.", e));
                }


                // Funktion, die regelm√§√üig oder bei Wiederverbindung aufgerufen wird
                async function syncData(initialLoad = false) {
                    if (!navigator.onLine || window.isSyncing || !window.offlineDB || !window.currentClientId) return;
                    
                    window.isSyncing = true;
                    console.log("Starte Offline-Synchronisation...");

                    try {
                        const outboxOps = await window.offlineDB.getOutboxOperations();
                        const pendingCount = outboxOps.length;

                        if (pendingCount > 0) {
                            showToast(`Synchronisiere ${pendingCount} ausstehende Aktionen...`, 'info', 10000);
                            await processOutbox(outboxOps);
                        } else if (!initialLoad) {
                            showToast("Synchronisation abgeschlossen. Keine ausstehenden Aktionen.", 'success');
                        }
                        
                        // Nach dem Push die Datenbank mit den aktuellen Online-Daten neu laden
                        if (pendingCount > 0 || initialLoad) {
                            if (window.currentTabId === 'listTab') {
                                await loadArticleList(document.getElementById('articleSearchInput').value);
                            } else if (window.currentTabId === 'logTab') {
                                await loadAdminLog(document.getElementById('logSearchInput').value);
                            } else if (window.currentTabId === 'usersTab') {
                                await loadUserList(document.getElementById('userSearchInput').value);
                            }
                        }

                    } catch (e) {
                        console.error("Fehler bei der Hauptsynchronisation:", e);
                        showToast("Synchronisationsfehler. Versuche es sp√§ter erneut.", 'error');
                    } finally {
                        window.isSyncing = false;
                        console.log("Offline-Synchronisation beendet.");
                    }
                }

                // F√ºhrt alle Outbox-Operationen sequenziell aus
                async function processOutbox(operations) {
                    for (const op of operations) {
                        try {
                            const { type, table, key, payload } = op;
                            
                            if (payload.client_id !== window.currentClientId) {
                                // Sollte bei der Erstellung des Payloads nicht passieren, aber zur Sicherheit:
                                console.warn(`√úberspringe Outbox-Aktion f√ºr falschen Mandanten (${payload.client_id} != ${window.currentClientId}).`);
                                await window.offlineDB.deleteData('outbox', op.id);
                                continue;
                            }

                            let error;

                            // 1. Supabase Operation durchf√ºhren
                            switch (type) {
                                case 'INSERT':
                                    ({ error } = await window.appSupabaseClient.from(table).insert([payload]));
                                    break;
                                case 'UPDATE':
                                    ({ error } = await window.appSupabaseClient.from(table).update(payload).eq(table === 'user_roles' ? 'id' : 'barcode', key).eq('client_id', window.currentClientId));
                                    break;
                                case 'DELETE':
                                    ({ error } = await window.appSupabaseClient.from(table).delete().eq('barcode', key).eq('client_id', window.currentClientId));
                                    break;
                                default:
                                    console.warn(`Unbekannter Outbox-Typ: ${type}`);
                                    await window.offlineDB.deleteData('outbox', op.id);
                                    continue;
                            }

                            if (error) {
                                if (error.message.includes('Failed to fetch') || error.code === '500') {
                                    // Netzwerkfehler: Breche ab und versuche es beim n√§chsten Sync erneut
                                    throw new Error("Netzwerkfehler beim Push.");
                                } else if (error.code === '23505') {
                                    // 23505 = Unique-Constraint-Fehler (z.B. Barcode existiert bereits beim INSERT). 
                                    // Dies kann passieren, wenn ein Artikel offline erstellt wurde, 
                                    // aber in der Zwischenzeit online erstellt wurde. -> √úberspringen und l√∂schen
                                    showToast(`Fehler: Eintrag (${table}, ${key}) existiert bereits online. Aktion √ºbersprungen.`, 'error', 7000);
                                } else if (error.code === '42501') {
                                    // 42501 = RLS-Fehler. Dies kann passieren, wenn der Benutzer in der Zwischenzeit
                                    // seine Rolle verloren hat. Da die RLS-Policies die client_id verwenden, ist dies 
                                    // unwahrscheinlich, aber es w√§re ein schwerwiegender Fehler.
                                    showToast(`Fehler: RLS-Policy-Verletzung f√ºr ${table}. Aktion √ºbersprungen.`, 'error', 7000);
                                } else {
                                    // Anderer DB-Fehler: Loggen und l√∂schen, da ein erneuter Versuch wahrscheinlich scheitert.
                                    console.error(`Outbox DB Fehler f√ºr ${type} ${table}:`, error);
                                    showToast(`Fehler beim Synchronisieren von ${type} (${table}). Aktion √ºbersprungen.`, 'error', 7000);
                                }
                            }
                            
                            // 2. Erfolg: Operation aus der Outbox l√∂schen
                            await window.offlineDB.deleteData('outbox', op.id); 
                            console.log(`Outbox-Aktion erfolgreich synchronisiert und gel√∂scht: ${type} ${table}`);

                        } catch (e) {
                            if (e.message.includes("Netzwerkfehler")) {
                                // Breche ab, um beim n√§chsten Sync erneut zu versuchen
                                return;
                            }
                            // Bei anderen Fehlern wird mit der n√§chsten Operation fortgefahren, 
                            // aber die fehlerhafte Operation nicht gel√∂scht (sollte im try-Block behandelt werden).
                        }
                    }
                }


                window.onload = function() {
                    initSettings(); // Einstellungen laden
                    initOfflineSync(); // Offline-Logik initialisieren
                    checkLogin();
                };
            </script>

        </body>
        </html>