<!DOCTYPE html>
    <html lang="de">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Inventar Scanner Pro</title>

        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="https://unpkg.com/html5-qrcode"></script>

        <script>
            // ---------------------------------------------------------
            // KRITISCHE SICHERHEITSKORREKTUR: KONFIGURATION
            // ---------------------------------------------------------
            // ANLEITUNG:
            // 1. Ersetzen Sie die Platzhalter durch Ihre tats√§chlichen Werte (z.B. aus der Supabase-Projekteinstellung > API).
            // 2. Im Produktionsbetrieb sollten Sie diese Werte als Umgebungsvariablen (ENV_VAR) Ihres Hosters setzen
            //    und sie hier dynamisch einf√ºgen (z.B. durch ein Build-Tool).
            
            // ACHTUNG: Der Anon Key ist NICHT geheim, er erlaubt nur Lesezugriff oder
            // das Aufrufen der auth-Funktionen. RLS-Policies sind der wahre Schutz.
            var APP_SUPABASE_URL = "https://sjhyvctidpnttqhenqoy.supabase.co"; // Kann so bleiben
            var APP_SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHl2Y3RpZHBudHRxaGVucW95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MzU3NTksImV4cCI6MjA4MDAxMTc1OX0.oXUA012J99W8fNNJi8Zxqn-2BUjf1QJOrXGYlPotaS4"; // ERSETZEN SIE DIESEN PLATZHALTER!
            
            // !!! KRITISCH: Die hardgecodeten PINS sind entfernt und durch Supabase Auth ersetzt. !!!
            // Role-Bestimmung erfolgt nun √ºber eine separate Datenbank-Tabelle
            // oder √ºber Custom Claims in Supabase Auth (beste Praxis).
            // Hier wird vereinfacht angenommen, dass die Rolle nach dem Login bekannt ist (RLS).
            // ---------------------------------------------------------

            // Initialisierung
            (function() {
                if (window['supabase']) {
                    window.appSupabaseClient = window['supabase'].createClient(APP_SUPABASE_URL, APP_SUPABASE_KEY);
                } else {
                    window.appSupabaseClient = null;
                    console.error("Supabase-Client konnte nicht initialisiert werden.");
                }
                // PIN-Logik entfernt
                window.lastCode = ""; // F√ºr Debouncing des Scanners
                window.currentTabId = "scannerTab"; // Aktueller Tab
                window.currentUserRole = null; // Speichert die Rolle ('user', 'admin' oder null)
            })();
        </script>

        <style>
            /* --- GLOBALE STYLES & FONT --- */
            :root {
                --color-bg-dark: #0a0b10;
                --color-bg-card: #1d222e;
                --color-accent-blue: #007aff;
                --color-accent-green: #34c759;
                --color-error-red: #ff3b30;
                --color-border: rgba(255, 255, 255, 0.08);
                --transition-duration: 0.3s;
                --color-warning-yellow: #ffcc00; /* NEU f√ºr gesperrt */
            }

            * {
                box-sizing: border-box;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            }

            body,
            html {
                margin: 0;
                padding: 0;
                background: var(--color-bg-dark);
                color: white;
                height: 100dvh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            /* --- LAYOUT & TRANSITIONEN --- */

            .app-view-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                transition: opacity var(--transition-duration) ease-in-out, transform var(--transition-duration) ease-in-out;
                opacity: 0;
                pointer-events: none;
                display: flex;
                flex-direction: column;
            }

            .app-view-container.active {
                opacity: 1;
                pointer-events: all;
            }

            /* Initial Zustand f√ºr Login, um den "Slide-In"-Effekt zu simulieren */
            #loginView {
                transform: translateY(0);
            }

            #appView {
                transform: translateY(100vh);
            }

            #loginView.active {
                transform: translateY(0);
            }

            #appView.active {
                transform: translateY(0);
            }
            
            /* Der Container f√ºr die Tabs */
            #tabContentContainer {
                flex-grow: 1;
                position: relative;
                overflow: hidden; /* Wichtig, um die Tabs im Container zu halten */
            }
            
            /* KORREKTUR: Vereinfachung der Sichtbarkeitsregeln - Wichtig f√ºr Log √úberlappung */
            .tab-content {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                /* WICHTIG: display: none mit !important, um √úberlappung zu verhindern */
                display: none !important; 
                flex-direction: column;
                overflow-y: auto; /* List- und Log-Tabs brauchen Scrolling */
                
                /* Expliziter Hintergrund, falls doch etwas durchscheint */
                background: var(--color-bg-dark); 
            }
            
            .tab-content.active {
                display: flex !important; /* Macht den aktiven Tab sichtbar */
            }


            /* --- HEADER --- */
            header {
                height: 55px;
                background: rgba(30, 30, 40, 0.9);
                backdrop-filter: blur(8px);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 15px;
                border-bottom: 1px solid var(--color-border);
                z-index: 10;
                flex-shrink: 0; /* Verhindert, dass der Header schrumpft */
            }

            header h1 {
                font-size: 1.1rem;
                font-weight: 600;
                margin: 0;
            }

            .header-button {
                padding: 5px 10px;
                font-size: 0.75em;
                background: rgba(255, 255, 255, 0.1);
                border: none;
                border-radius: 8px;
                color: white;
                cursor: pointer;
                transition: background 0.2s;
            }

            /* --- LOGIN VIEW (NEU: Email/Passwort) --- */
            #loginView {
                justify-content: space-around;
                align-items: center;
                padding: 40px 20px;
                text-align: center;
            }

            .login-header {
                text-align: center;
                padding-top: 50px;
            }

            .app-icon {
                font-size: 3.5em;
                color: var(--color-accent-blue);
                margin-bottom: 15px;
            }

            .login-header h2 {
                font-size: 1.6rem;
                font-weight: 700;
                margin: 0;
            }

            #authError {
                color: var(--color-error-red);
                margin-top: 10px;
                height: 1.2em;
                font-weight: 500;
            }
            
            /* Ladezustand f√ºr Login */
            #loadingAuth {
                text-align: center;
                font-size: 1.1rem;
                opacity: 0.7;
                display: none; 
                margin-top: 40px;
            }

            /* --- NEUE LOGIN FORM STYLES --- */
            #authForm {
                width: 100%;
                max-width: 320px;
                margin-top: 50px;
                display: none; /* In JS gezeigt */
            }
            
            #authForm .input-group input {
                width: 100%;
                padding: 12px;
                border-radius: 8px;
                border: 1px solid var(--color-border);
                background: var(--color-bg-card);
                color: white;
                font-size: 1rem;
                margin-bottom: 15px;
            }
            
            #authForm .input-group label {
                display: block;
                font-size: 0.9rem;
                margin-bottom: 5px;
                opacity: 0.8;
                text-align: left;
            }
            
            #authForm button[type="submit"] {
                width: 100%;
                padding: 12px;
                font-size: 1rem;
                font-weight: 600;
                background: var(--color-accent-blue);
                color: white;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                transition: background 0.2s;
            }
            
            #authForm button[type="submit"]:active {
                background: #0066cc;
            }
            
            #registerToggle {
                margin-top: 20px;
                color: var(--color-accent-blue);
                cursor: pointer;
                font-size: 0.9rem;
                opacity: 0.8;
                text-decoration: underline;
            }
            
            /* --- PIN INDICATORS (ENTFERNT) --- */
            #pinIndicators {
                display: none; /* Versteckt die alte PIN-Logik */
            }


            /* --- KEYPAD (ENTFERNT) --- */
            #keypad {
                display: none; /* Versteckt die alte PIN-Logik */
            }


            /* --- APP VIEW / SCANNER --- */
            #scannerTab {
                position: relative;
                overflow: hidden;
            }
            
            /* NEU: Umbuchungs-Modus Button Style */
            #relocationToggle {
                width: 100%;
            }

            #reader-container {
                flex-grow: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                overflow: hidden;
            }

            #reader {
                width: 100%;
                height: 100%;
                background: black;
                /* Stellt sicher, dass das Video den Container ausf√ºllt */
                object-fit: cover;
            }
            
            #reader video {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }


            .scan-frame {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 70%;
                max-width: 300px;
                aspect-ratio: 1 / 1;
                border: 3px solid var(--color-accent-green);
                border-radius: 12px;
                box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.7);
                pointer-events: none;
            }

            /* Overlay vor dem Scannen */
            #preScan {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: var(--color-bg-dark);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                z-index: 5;
            }

            .primary-button {
                padding: 12px 25px;
                font-size: 1rem;
                font-weight: 600;
                background: var(--color-accent-blue);
                color: white;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                transition: background 0.2s;
            }

            .primary-button:active {
                background: #0066cc;
            }


            /* --- Result Card (Pull-Up) --- */
            #result-card {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                background: var(--color-bg-card);
                border-top-left-radius: 20px;
                border-top-right-radius: 20px;
                padding: 20px;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.4);
                transform: translateY(100%);
                transition: transform var(--transition-duration) ease-out;
                z-index: 10;
            }

            #result-card.active {
                transform: translateY(0);
            }

            .card-handle {
                width: 40px;
                height: 4px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 2px;
                margin: 0 auto 15px;
            }

            #cardTitle {
                font-size: 1.4rem;
                font-weight: 700;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
            }

            #cardStatusIcon {
                margin-right: 10px;
                font-size: 1.1em;
            }

            #cardContent p {
                margin: 5px 0;
                font-size: 0.9rem;
                opacity: 0.8;
            }

            .action-button-group {
                display: flex;
                gap: 10px;
                margin-top: 15px;
            }

            .action-button {
                flex: 1;
                padding: 12px;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
            }

            .action-button.register {
                background: var(--color-accent-green);
                color: var(--color-bg-card);
            }
            .action-button.register:active {
                background: #2cb74b;
            }
            .action-button.cancel {
                background: rgba(255, 255, 255, 0.1);
                color: white;
            }
            .action-button.cancel:active {
                background: rgba(255, 255, 255, 0.2);
            }
            /* Style f√ºr L√∂sch-Button */
            .action-button.delete {
                background: var(--color-error-red);
                color: white;
            }
            .action-button.delete:active {
                background: #cc2a22;
            }


            /* --- POPUP / REGISTRIEREN & ADMIN EDIT (REUSABLE STYLES) --- */
            /* User Edit Popup, Inventory Popup, Delete Popup etc. hinzugef√ºgt */
            #popupOverlay, #adminEditPopupOverlay, #deleteConfirmPopupOverlay, #userEditPopupOverlay, #inventoryQuantityPopupOverlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(5px);
                z-index: 100;
                display: none;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.2s ease-in-out;
            }

            #popupOverlay.show, #adminEditPopupOverlay.show, #deleteConfirmPopupOverlay.show, #userEditPopupOverlay.show, #inventoryQuantityPopupOverlay.show {
                opacity: 1;
                display: flex; /* Wichtig, um nach der Transition sichtbar zu sein */
            }

            .popup-card {
                background: var(--color-bg-card);
                padding: 25px;
                border-radius: 15px;
                width: 90%;
                max-width: 400px;
                transform: translateY(20px);
                transition: transform 0.3s ease-in-out;
            }

            #popupOverlay.show .popup-card, #adminEditPopupOverlay.show .popup-card, #deleteConfirmPopupOverlay.show .popup-card, #userEditPopupOverlay.show .popup-card, #inventoryQuantityPopupOverlay.show .popup-card {
                transform: translateY(0);
            }

            .popup-card h3 {
                margin-top: 0;
                font-size: 1.3rem;
                border-bottom: 1px solid var(--color-border);
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

            .input-group {
                margin-bottom: 15px;
            }
            
            .input-group textarea {
                resize: vertical;
                min-height: 80px;
            }


            .input-group label {
                display: block;
                font-size: 0.9rem;
                margin-bottom: 5px;
                opacity: 0.8;
            }

            .input-group input[type="text"],
            .input-group input[type="number"], /* NEU: Number-Feld-Style */
            .input-group input[type="email"], /* NEU: Email-Feld-Style */
            .input-group input[type="password"], /* NEU: Passwort-Feld-Style */
            .input-group select,
            .input-group textarea {
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid var(--color-border);
                background: var(--color-bg-dark);
                color: white;
                font-size: 1rem;
            }
            .input-group input[type="text"]:focus,
            .input-group input[type="number"]:focus, /* NEU: Fokus-Style */
            .input-group input[type="email"]:focus, /* NEU: Fokus-Style */
            .input-group input[type="password"]:focus, /* NEU: Fokus-Style */
            .input-group select:focus,
            .input-group textarea:focus {
                outline: none;
                border-color: var(--color-accent-blue);
            }

            /* --- TOASTS --- */
            #toastContainer {
                position: fixed;
                top: 15px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 350px;
                z-index: 200;
                pointer-events: none; /* Macht Toasts nicht klickbar */
            }

            .toast {
                background: var(--color-bg-card);
                color: white;
                padding: 10px 15px;
                border-radius: 10px;
                margin-bottom: 10px;
                opacity: 0;
                transform: translateY(20px);
                transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                font-size: 0.95rem;
                font-weight: 500;
            }

            .toast.show {
                opacity: 1;
                transform: translateY(0);
            }

            .toast-icon {
                margin-right: 10px;
                font-size: 1.2em;
            }

            .toast.success .toast-icon {
                color: var(--color-accent-green);
            }

            .toast.error .toast-icon {
                color: var(--color-error-red);
            }

            .toast.info .toast-icon {
                color: var(--color-accent-blue);
            }

            /* --- FOOTER / NAVIGATION --- */
            footer {
                display: flex;
                height: 70px;
                background: rgba(30, 30, 40, 0.9);
                backdrop-filter: blur(8px);
                border-top: 1px solid var(--color-border);
                flex-shrink: 0;
                z-index: 20;
            }

            .nav-item {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                color: rgba(255, 255, 255, 0.5);
                font-size: 0.8rem;
                cursor: pointer;
                transition: color 0.2s;
                user-select: none; /* Verhindert Auswahl beim Tippen */
            }

            .nav-item.active {
                color: var(--color-accent-blue);
            }

            .nav-item svg {
                width: 24px;
                height: 24px;
                stroke: currentColor;
                fill: none;
                stroke-width: 2;
                margin-bottom: 2px;
            }
            
            /* --- ARTIKEL LIST VIEW STYLES / REUSABLE LIST STYLES --- */
            #listTab, #logTab, #usersTab { /* UsersTab hinzugef√ºgt */
                /* Padding muss hier gesetzt werden, da es der Scroll-Container ist */
                padding: 15px 15px 80px 15px;
            }
            
            #articleList, #logList, #userList { /* UserList hinzugef√ºgt */
                list-style: none;
                padding: 0;
                margin: 0;
            }
            
            #articleList li, #logList li, #userList li { /* UserList hinzugef√ºgt */
                background: var(--color-bg-card);
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 10px;
                /* Standard-Border f√ºr Artikel-Liste */
                border-left: 5px solid var(--color-accent-blue); 
                display: flex;
                justify-content: space-between;
                align-items: center;
                /* Visuelle Anzeige f√ºr Admin-Klickbarkeit */
                transition: background 0.2s; 
            }
            
            /* Admin-Elemente haben einen Hover-Effekt */
            #articleList li[data-role="admin-editable"]:active, #userList li[data-role="admin-editable"]:active {
                background: #2a303e; 
            }
            
            /* User-Liste spezifische Farben */
            .user-role-admin { border-left-color: var(--color-warning-yellow) !important; }
            .user-is-blocked { border-left-color: var(--color-error-red) !important; }

            .item-details strong {
                display: block;
                font-size: 1.rem;
                font-weight: 600;
                margin-bottom: 2px;
            }
            
            .item-details span {
                font-size: 0.85rem;
                opacity: 0.7;
            }
            
            /* Icon-Anzeige f√ºr Lagertyp / User-Status */
            .item-count {
                text-align: center; 
                width: 50px; /* Leicht vergr√∂√üert f√ºr den Status */
                height: 50px; 
                flex-shrink: 0;
                margin-left: 10px;
                display: flex; 
                flex-direction: column;
                justify-content: center;
                align-items: center;
                font-size: 0.8rem;
            }
            
            .item-count svg {
                width: 28px; 
                height: 28px;
                margin-bottom: 2px; 
            }

            .item-count .item-label {
                font-size: 0.6rem; 
                font-weight: 600;
                line-height: 1;
            }
            
            /* Admin Log Liste Styles */
            #logTab {
                /* padding wird √ºber den oberen Block gesetzt */
                display: flex; 
                flex-direction: column;
            }
            
            /* Styling f√ºr den Edit-Button in der User-Liste */
            .user-edit-button {
                background: var(--color-accent-blue);
                color: white;
                padding: 8px 15px;
                border-radius: 8px;
                font-size: 0.8rem;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.2s;
            }

        </style>
    </head>
    <body>

        <div id="toastContainer"></div>
        
        <div id="popupOverlay">
            <form class="popup-card" onsubmit="event.preventDefault(); saveArticle();">
                <h3>Artikel Registrieren</h3>
                <div class="input-group">
                    <label for="popupBarcode">Barcode</label>
                    <input type="text" id="popupBarcode" readonly>
                </div>
                
                <div class="input-group">
                    <label for="popupBaseName">Basis-Name (z.B. T-Shirt, Wasserflasche)</label>
                    <input type="text" id="popupBaseName" required>
                </div>
                
                <div class="input-group">
                    <label for="popupSize">Gr√∂√üe / Volumen (Liter)</label>
                    <select id="popupSize">
                        <option value="">(Optional)</option>
                        <option value="0.33">0,33 Liter</option>
                        <option value="0.5">0,5 Liter</option>
                        <option value="0.7">0,7 Liter</option>
                        <option value="1.0">1,0 Liter</option>
                        <option value="1.5">1,5 Liter</option>
                        <option value="2.0">2,0 Liter</option>
                    </select>
                </div>
                
                <div class="input-group" id="popupQuantityGroup">
                    <label for="popupQuantity">Startbestand (Menge)</label>
                    <input type="number" id="popupQuantity" value="1" min="1" required>
                </div>

                <div class="input-group">
                    <label for="popupPlatz">Stellplatz (z.B. A-02-C)</label>
                    <input type="text" id="popupPlatz" required>
                </div>
                
                <div class="input-group">
                    <label for="popupBlocklager">Lagertyp</label>
                    <select id="popupBlocklager">
                        <option value="false">Regal / Fach</option>
                        <option value="true">Blocklager</option>
                    </select>
                </div>

                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hidePopup()">Abbrechen</button>
                    <button type="submit" class="action-button register">Speichern</button>
                </div>
            </form>
        </div>
        
        <div id="adminEditPopupOverlay">
            <form class="popup-card" onsubmit="event.preventDefault(); saveAdminEdit();">
                <h3>Artikel Bearbeiten (Admin)</h3>
                <div class="input-group">
                    <label for="adminEditName">Artikel Name</label>
                    <input type="text" id="adminEditName" readonly>
                </div>

                <div class="input-group">
                    <label for="adminEditBarcode">Barcode</label>
                    <input type="text" id="adminEditBarcode" readonly>
                </div>
                
                <div class="input-group">
                    <label for="adminEditQuantity">Neuer Bestand</label>
                    <input type="number" id="adminEditQuantity" min="0" required>
                </div>
                
                <div class="input-group">
                    <label for="adminEditPlatz">Neuer Stellplatz</label>
                    <input type="text" id="adminEditPlatz" required>
                </div>
                
                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hideAdminEditPopup()">Abbrechen</button>
                    <button type="submit" class="action-button register">Speichern</button>
                </div>

                <button type="button" class="action-button delete" style="width: 100%; margin-top: 15px;" onclick="deleteArticle()">
                    Artikel l√∂schen...
                </button>

                <p style="font-size: 0.75rem; opacity: 0.6; text-align: center; margin-top: 15px;">Sie sind als Administrator angemeldet und k√∂nnen Bestand und Stellplatz √§ndern.</p>
            </form>
        </div>

        <div id="deleteConfirmPopupOverlay">
            <div class="popup-card">
                <h3 id="deleteConfirmTitle">Artikel unwiderruflich l√∂schen</h3>
                <p id="deleteConfirmMessage" style="margin-bottom: 25px; text-align: center; font-weight: 500; font-size: 1.1rem; line-height: 1.4;"></p>

                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hideDeleteConfirmPopup()">Abbrechen</button>
                    <button type="button" class="action-button delete" onclick="confirmDeleteArticle()">Ja, unwiderruflich l√∂schen</button>
                </div>
            </div>
        </div>
        
        <div id="inventoryQuantityPopupOverlay">
            <form class="popup-card" onsubmit="event.preventDefault(); processInventoryTransaction();">
                <h3 id="inventoryQuantityTitle">Artikel Ein-/Ausbuchen</h3>
                <p id="inventoryQuantityArticleName" style="font-weight: 600; margin-bottom: 20px;"></p>
                
                <div class="input-group">
                    <label for="inventoryQuantityInput">Menge</label>
                    <input type="number" id="inventoryQuantityInput" value="1" min="1" required>
                </div>
                
                <div class="input-group">
                    <label for="inventoryQuantityPlatz">Stellplatz (Kann ge√§ndert werden)</label>
                    <input type="text" id="inventoryQuantityPlatz">
                </div>

                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hideInventoryQuantityPopup()">Abbrechen</button>
                    <button type="submit" class="action-button register" id="inventoryQuantitySubmitButton">Best√§tigen</button>
                </div>
            </form>
        </div>
        
        <div id="userEditPopupOverlay">
            <form class="popup-card" onsubmit="event.preventDefault(); saveUserEdit();">
                <h3>Benutzer bearbeiten (Admin)</h3>
                <div class="input-group">
                    <label for="userEditEmail">E-Mail</label>
                    <input type="text" id="userEditEmail" readonly>
                </div>
                <div class="input-group">
                    <label for="userEditRole">Rolle</label>
                    <select id="userEditRole" required>
                        <option value="user">Benutzer (Standard)</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="userEditBlocked">Sperrstatus</label>
                    <select id="userEditBlocked" required>
                        <option value="false">Nicht gesperrt</option>
                        <option value="true">Gesperrt</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="userEditNotes">Anmerkungen (nur f√ºr Admins sichtbar)</label>
                    <textarea id="userEditNotes" placeholder="Interne Anmerkungen..."></textarea>
                </div>
                
                <div class="action-button-group">
                    <button type="button" class="action-button cancel" onclick="hideUserEditPopup()">Abbrechen</button>
                    <button type="submit" class="action-button register">√Ñnderungen speichern</button>
                </div>
            </form>
        </div>


        <div id="loginView" class="app-view-container active">

            <div class="login-header">
                <div class="app-icon">üîê</div>
                <h2>Inventar Scanner Pro</h2>
                <div id="authError"></div>
            </div>

            <form id="authForm" onsubmit="event.preventDefault(); handleAuthSubmit();">
                <h3 id="authTitle" style="margin-bottom: 30px;">Anmelden</h3>
                
                <div class="input-group">
                    <label for="authEmail">E-Mail</label>
                    <input type="email" id="authEmail" required placeholder="name@firma.de">
                </div>
                
                <div class="input-group">
                    <label for="authPassword">Passwort</label>
                    <input type="password" id="authPassword" required placeholder="Mindestens 6 Zeichen">
                </div>
                
                <button type="submit" id="authSubmitButton">Anmelden</button>
                
                <div id="registerToggle" onclick="toggleAuthMode()">Noch keinen Account? Registrieren</div>
            </form>
            <div id="pinIndicators">
                <div class="pin-indicator"></div>
                <div class="pin-indicator"></div>
                <div class="pin-indicator"></div>
                <div class="pin-indicator"></div>
            </div>
            
            <div id="keypad">
                </div>
            <div id="loadingAuth">
                Initialisiere App...
            </div>
            
        </div>


        <div id="appView" class="app-view-container">

            <header>
                <h1>Inventar Scanner Pro</h1>
                <button class="header-button" onclick="logout()">Logout (<span id="userDisplay"></span>)</button>
            </header>

            <div id="tabContentContainer">

                <div id="scannerTab" class="tab-content active">
                    
                    <div style="padding: 15px; text-align: center; z-index: 50; flex-shrink: 0;">
                        <button id="relocationToggle" class="primary-button" onclick="toggleRelocationMode()">
                            üîÑ Modus: Normal
                        </button>
                        <p id="relocationStatus" style="color: var(--color-warning-yellow); margin-top: 10px; display: none; font-weight: 600;">
                            ZU VERSCHIEBENDER ARTIKEL: <span id="relocationArticleNameDisplay"></span>
                        </p>
                    </div>
                    
                    <div id="reader-container">
                        <div id="reader"></div>
                        <div class="scan-frame" id="scanFrame" style="display:none;"></div>

                        <div id="preScan">
                            <div style="font-size: 4em; margin-bottom: 20px;">üì¶</div>
                            <h2>Scanner bereit</h2>
                            <p style="opacity: 0.7; margin-bottom: 30px;">Kamera-Zugriff starten, um loszulegen.</p>
                            <button class="primary-button" style="max-width: 250px;" onclick="activateCamera()">SCAN STARTEN</button>
                        </div>
                    </div>

                    <div id="result-card" class="result-card">
                        <div class="card-handle"></div>
                        <div id="cardTitle"><span id="cardStatusIcon"></span> <span id="cardTitleText"></span></div>
                        <div id="cardContent"></div>
                        <div class="action-button-group" id="inventoryButtonGroup">
                            <button class="action-button register" id="depositButton" onclick="showInventoryQuantityPopup('deposit')">‚¨ÜÔ∏è Einlagern</button>
                            <button class="action-button delete" id="withdrawButton" onclick="showInventoryQuantityPopup('withdraw')">‚¨áÔ∏è Auslagern</button>
                            <button class="action-button cancel" id="finishedButton" onclick="hideResultCard()">Fertig</button>
                            <button class="action-button register" id="registerButton" onclick="showPopup()">Registrieren</button>
                        </div>
                        <div class="action-button-group" id="adminButtonGroup" style="margin-top: 10px; display: none;">
                            <button class="action-button" style="background: var(--color-warning-yellow);" onclick="showAdminEditPopup()">‚öôÔ∏è Admin Edit</button>
                        </div>
                    </div>
                </div>

                <div id="listTab" class="tab-content">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-shrink: 0;">
                        <input type="text" id="articleSearchInput" placeholder="Suche nach Name, Barcode oder Platz..." style="flex-grow: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--color-border); background: var(--color-bg-dark); color: white;">
                        <button class="primary-button" onclick="loadArticleList()" style="width: 50px; padding: 10px;">üîé</button>
                        <button class="primary-button" onclick="exportArticleListCSV()" style="background: var(--color-accent-green); width: auto; padding: 10px 15px;">CSV Export</button>
                    </div>
                    <ul id="articleList" style="flex-grow: 1; overflow-y: auto;"> 
                        <li>Lade Artikel...</li>
                    </ul>
                </div>

                <div id="logTab" class="tab-content">
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 15px; flex-shrink: 0;">
                        <button class="primary-button" onclick="exportLogCSV()" style="background: var(--color-accent-green); width: auto; padding: 10px 15px;">CSV Export</button>
                    </div>
                    <ul id="logList" style="flex-grow: 1; overflow-y: auto;">
                        <li>Lade Log-Protokoll...</li>
                    </ul>
                </div>
                
                <div id="usersTab" class="tab-content"> 
                    <ul id="userList">
                        <li>Lade Benutzer...</li>
                    </ul>
                </div>
                
            </div> 

            <footer>
                <div class="nav-item active" data-tab="scannerTab" onclick="changeTab('scannerTab')">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h.01M7 7h.01M11 11h.01M15 15h.01M21 3h-6l-3 3H3v18h18V3z"/></svg>
                    <span>Scannen</span>
                </div>
                <div class="nav-item" data-tab="listTab" onclick="changeTab('listTab')">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                    <span>Liste</span>
                </div>
                <div class="nav-item" data-tab="logTab" onclick="changeTab('logTab')">
                    <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 11H5M19 11v6m0-6V5m-4 16H9M12 4v16M21 11H3"/></svg>
                    <span>Log</span>
                </div>
                <div class="nav-item" data-tab="usersTab" onclick="changeTab('usersTab')">
                    <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87m-4-1.63a4 4 0 0 1 0-7.74"/></svg>
                    <span>Personal</span>
                </div>
            </footer>
        </div>
        <script>
            let html5QrCode = null;
            let lastCode = "";
            let currentScannedBarcode = "";
            let currentTabId = "scannerTab";
            let currentUserId = null;
            let currentUserRole = null;
            let isAuthReady = false;
            let articleToEdit = null;
            let articleToDelete = null;
            let userToEdit = null; 
            
            // NEU: Globale Variablen f√ºr Inventar & Umbuchung
            let activeTransactionType = null; // 'deposit', 'withdraw' (Feature 1)
            let isRelocationMode = false; // (Feature 3)
            let relocationArticleId = null; // (Feature 3)
            let relocationArticleName = null; // (Feature 3)
            let articleCache = []; // (Feature 2 - Caching groundwork for CSV Export)
            let logCache = []; // (Feature 2 - Caching groundwork for CSV Export)


            // Role-Bestimmung erfolgt nun √ºber eine separate Datenbank-Tabelle
            // oder √ºber Custom Claims in Supabase Auth (beste Praxis).
            // Hier wird vereinfacht angenommen, dass die Rolle nach dem Login bekannt ist (RLS).
            // ---------------------------------------------------------
            
            // SVG-Strings f√ºr die Lagertypen
            const SHELF_ICON_SVG = '<svg viewBox="0 0 24 24" stroke="white" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16v16H4V4zm4 0v16m8-16v16M4 10h16M4 16h16"/></svg>';
            const WAREHOUSE_ICON_SVG = '<svg viewBox="0 0 24 24" stroke="white" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l10 5l-10 5l-10-5zM2 12v6l10 5l10-5v-6M12 2v10"/></svg>';
            
            // SVG-Strings f√ºr Benutzer-Status
            const USER_ICON_SVG = '<svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
            const ADMIN_ICON_SVG = '<svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20"/><path d="M17 4l-5 5l-5-5M17 20l-5-5l-5 5"/></svg>';
            const BLOCKED_ICON_SVG = '<svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>';

            /* --- HILFSFUNKTIONEN --- */
            
            /** Zeigt eine tempor√§re, nicht-blockierende Nachricht an. */
            function showToast(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                let icon = '‚ÑπÔ∏è';
                if (type === 'success') icon = '‚úÖ';
                if (type === 'error') icon = '‚ùå';
                if (type === 'warning') icon = '‚ö†Ô∏è';
                toast.innerHTML = `<span class="toast-icon">${icon}</span>${message}`;
                container.appendChild(toast);
                // Trigger CSS transition
                setTimeout(() => toast.classList.add('show'), 10);
                // Hide and remove after duration
                setTimeout(() => {
                    toast.classList.remove('show');
                    // Remove from DOM after transition
                    setTimeout(() => {
                        if (toast.parentNode === container) {
                            container.removeChild(toast);
                        }
                    }, 300);
                }, duration);
            }
            
            /** Ansicht zwischen Login und App wechseln */
            function switchView(targetViewId) {
                const views = document.querySelectorAll('.app-view-container');
                views.forEach(view => {
                    view.classList.remove('active');
                    if (view.id === targetViewId) {
                        view.classList.add('active');
                    }
                });
            }
            
            /** Exportiert eine Liste von Objekten als CSV-Datei (Feature 4) */
            function exportToCSV(filename, data) {
                if (data.length === 0) {
                    showToast("Keine Daten zum Exportieren gefunden.", 'info');
                    return;
                }
                
                const headers = Object.keys(data[0]);
                const csvRows = [];
                
                // 1. Header Row
                csvRows.push(headers.join(';'));
                
                // 2. Data Rows
                for (const row of data) {
                    const values = headers.map(header => {
                        const value = row[header];
                        // Formatierung (Kommas in Strings entfernen, falls sie CSV-Struktur st√∂ren)
                        let stringValue = (value === null || value === undefined) ? '' : String(value);
                        // Semikolons durch Kommas ersetzen, damit sie nicht die Spaltentrennung st√∂ren
                        stringValue = stringValue.replace(/;/g, ',');
                        // Zelle in Anf√ºhrungszeichen einschlie√üen, falls sie ein Zeilenumbruch oder Anf√ºhrungszeichen enth√§lt
                        return `"${stringValue.replace(/"/g, '""')}"`;
                    });
                    csvRows.push(values.join(';'));
                }

                const csvString = csvRows.join('\n');
                // UTF-8 BOM hinzuf√ºgen f√ºr korrekte Darstellung in Excel
                const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvString], { type: 'text/csv;charset=utf-8;' }); 
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showToast(`Daten erfolgreich als ${filename} exportiert.`, 'success');
            }


            /* --- SUPABASE AUTH LOGIK --- */
            
            /** √úberpr√ºft den Login-Status beim Start */
            async function checkLogin() {
                const { data: { session } } = await window.appSupabaseClient.auth.getSession();
                document.getElementById('loadingAuth').style.display = 'none';
                document.getElementById('authForm').style.display = 'block';

                if (session) {
                    await handleLoginSuccess(session.user.id, session.user.email);
                } else {
                    switchView('loginView');
                }
            }

            /** Schaltet zwischen Anmelde- und Registrierungsmodus um. */
            function toggleAuthMode() {
                isRegisterMode = !isRegisterMode;
                const title = document.getElementById('authTitle');
                const submitButton = document.getElementById('authSubmitButton');
                const toggleLink = document.getElementById('registerToggle');

                if (isRegisterMode) {
                    title.innerText = "Registrieren";
                    submitButton.innerText = "Registrieren";
                    toggleLink.innerText = "Bereits registriert? Anmelden";
                } else {
                    title.innerText = "Anmelden";
                    submitButton.innerText = "Anmelden";
                    toggleLink.innerText = "Noch keinen Account? Registrieren";
                }
                document.getElementById("authError").innerText = ""; 
            }

            /** Behandelt das Absenden des Auth-Formulars (Login oder Registrierung). */
            async function handleAuthSubmit() {
                const email = document.getElementById('authEmail').value;
                const password = document.getElementById('authPassword').value;
                const submitButton = document.getElementById('authSubmitButton');
                document.getElementById("authError").innerText = "";

                if (!email || !password) {
                    document.getElementById("authError").innerText = "Bitte E-Mail und Passwort eingeben.";
                    return;
                }

                submitButton.disabled = true;
                submitButton.innerText = (isRegisterMode ? "Registriere..." : "Melde an...");
                let error;

                if (isRegisterMode) {
                    const { error: signUpError } = await window.appSupabaseClient.auth.signUp({
                        email: email,
                        password: password,
                    });
                    error = signUpError;
                    if (!error) {
                        document.getElementById("authError").innerText = "";
                        showToast("Registrierung erfolgreich! Bitte E-Mail best√§tigen.", 'success', 5000);
                        // Nach der Registrierung zum Login-Modus wechseln
                        isRegisterMode = false;
                        toggleAuthMode();
                    }
                } else {
                    const { data, error: signInError } = await window.appSupabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password,
                    });
                    error = signInError;
                    if (!error && data.session) {
                        await handleLoginSuccess(data.session.user.id, data.session.user.email);
                        submitButton.disabled = false;
                        submitButton.innerText = "Anmelden";
                        return;
                    }
                }

                if (error) {
                    document.getElementById("authError").innerText = error.message;
                    showToast(`Auth Fehler: ${error.message}`, 'error', 5000);
                }
                submitButton.disabled = false;
                submitButton.innerText = (isRegisterMode ? "Registrieren" : "Anmelden");
            }

            /** Behandelt den erfolgreichen Login und bestimmt die Rolle. */
            async function handleLoginSuccess(userId, email) {
                currentUserId = userId;
                let userRole = 'user'; // Standardrolle
                let isBlocked = false; 

                // Rollenbestimmung und Sperrstatus
                const { data, error } = await window.appSupabaseClient
                    .from('user_roles')
                    .select('role, is_blocked')
                    .eq('id', userId)
                    .single();

                if (data) {
                    userRole = data.role || 'user';
                    isBlocked = data.is_blocked || false;
                }

                if (isBlocked) {
                    // Benutzer ist gesperrt, sofort abmelden/Session beenden
                    await window.appSupabaseClient.auth.signOut();
                    document.getElementById("authError").innerText = "Ihr Konto ist gesperrt. Bitte wenden Sie sich an den Administrator.";
                    showToast("Login fehlgeschlagen: Konto gesperrt.", 'error', 7000);
                    return;
                }
                
                if (error && error.code !== 'PGRST116') {
                    console.error("Fehler beim Laden der Benutzerrolle (RLS-Policy pr√ºfen):", error);
                    showToast("Login erfolgreich, aber Rollenpr√ºfung fehlgeschlagen. Nur als USER angemeldet.", 'info');
                }

                window.currentUserRole = userRole; 
                // Anpassung der Anzeige
                const roleDisplay = (userRole === 'admin' ? "ADMIN" : "USER");
                document.getElementById("userDisplay").innerText = `${email.split('@')[0]} (${roleDisplay})`;

                switchView('appView');
                changeTab('scannerTab');
                showToast(`Willkommen als ${roleDisplay}!`, 'success');
            }
            
            async function logout() {
                stopScanner();
                
                // Supabase Logout
                const { error } = await window.appSupabaseClient.auth.signOut();
                
                if (error) {
                    showToast("Fehler beim Abmelden.", 'error');
                    console.error("Logout Fehler:", error);
                }
                
                // Zur Login-Ansicht zur√ºck
                switchView('loginView');
                window.currentUserRole = null; 
                showToast("Erfolgreich abgemeldet.", 'info');
                lastCode = "";
                
                document.getElementById("userDisplay").innerText = ""; 
                document.getElementById("authEmail").value = "";
                document.getElementById("authPassword").value = "";
                document.getElementById("authError").innerText = "";
            }


            /* --- CAMERA & SCANNER LOGIK --- */
            
            function activateCamera() {
                document.getElementById('preScan').style.display = 'none';
                document.getElementById('scanFrame').style.display = 'block';

                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode("reader");
                }

                // Starte den Scanner, wenn er nicht l√§uft
                if (!html5QrCode.isScanning) {
                    const config = {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        disableFlip: false,
                        // Bevorzugte Kamera
                        // useFrontCamera: false, // Normalerweise die R√ºckkamera f√ºr Barcodes
                    };
                    
                    // Suche nach der besten Kamera (R√ºckkamera)
                    Html5Qrcode.getCameras().then(devices => {
                        let cameraId = devices[0].id;
                        if (devices.length > 1) {
                             // Versuch, die R√ºckkamera zu finden
                            const backCamera = devices.find(device => device.label.toLowerCase().includes('back') || device.label.toLowerCase().includes('rear'));
                            if (backCamera) {
                                cameraId = backCamera.id;
                            } else {
                                // Verwende die letzte Kamera in der Liste (oft die R√ºckkamera)
                                cameraId = devices[devices.length - 1].id;
                            }
                        }
                        
                        html5QrCode.start(
                            cameraId,
                            config,
                            (decodedText, decodedResult) => {
                                handleScan(decodedText);
                            },
                            (errorMessage) => {
                                // Fehlerbehandlung f√ºr das Scannen
                            }
                        ).catch((err) => {
                            document.getElementById('preScan').style.display = 'flex';
                            document.getElementById('scanFrame').style.display = 'none';
                            showToast(`Kamerafehler: ${err}`, 'error', 5000);
                        });
                    }).catch(err => {
                        document.getElementById('preScan').style.display = 'flex';
                        document.getElementById('scanFrame').style.display = 'none';
                        showToast("Keine Kamera gefunden oder Zugriff verweigert.", 'error', 5000);
                    });
                }
            }
            
            function stopScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {
                        // Scanner erfolgreich gestoppt
                        document.getElementById('scanFrame').style.display = 'none';
                    }).catch(err => {
                        console.error("Fehler beim Stoppen des Scanners:", err);
                    });
                }
            }


            /* --- SCANNER & INVENTORY LOGIC (Feature 1 & 3) --- */
            
            /**
             * Zeigt die Result Card mit Inventar-Aktionen an.
             * @param {object} article - Der gescannte Artikel (kann null sein).
             * @param {string} barcode - Der gescannte Barcode.
             */
            function showInventoryResultCard(article, barcode) {
                currentScannedBarcode = barcode;
                const card = document.getElementById('result-card');
                const cardTitleText = document.getElementById('cardTitleText');
                const cardStatusIcon = document.getElementById('cardStatusIcon');
                const cardContent = document.getElementById('cardContent');
                
                // Button Gruppen
                const inventoryButtonGroup = document.getElementById('inventoryButtonGroup');
                const adminButtonGroup = document.getElementById('adminButtonGroup');

                // Reset visibility
                inventoryButtonGroup.style.display = 'flex';
                document.getElementById('registerButton').style.display = 'none';
                document.getElementById('depositButton').style.display = 'none';
                document.getElementById('withdrawButton').style.display = 'none';
                adminButtonGroup.style.display = 'none';

                cardContent.innerHTML = '';
                
                if (article) {
                    articleToEdit = article; // F√ºr Admin Edit/Umbuchung

                    cardStatusIcon.innerHTML = '‚úÖ';
                    cardTitleText.innerText = article.name || "Artikel gefunden";

                    cardContent.innerHTML = `
                        <p><strong>Aktueller Bestand:</strong> ${article.quantity} St√ºck</p>
                        <p><strong>Stellplatz:</strong> ${article.platz}</p>
                        <p><strong>Barcode:</strong> ${barcode}</p>
                    `;

                    // Buttons f√ºr Bestandstransaktionen anzeigen
                    document.getElementById('depositButton').style.display = 'block';
                    
                    // Auslagern nur anzeigen, wenn Bestand > 0
                    if (article.quantity > 0) {
                        document.getElementById('withdrawButton').style.display = 'block';
                    } else {
                        cardContent.innerHTML += `<p style="color: var(--color-error-red);">‚ö†Ô∏è Bestand ist 0. Nur Einlagerung m√∂glich.</p>`;
                    }
                    
                    // Admin Button anzeigen
                    if (currentUserRole === 'admin') {
                        adminButtonGroup.style.display = 'flex';
                    }

                } else {
                    // Artikel nicht gefunden -> Registrierungsmodus
                    articleToEdit = null;
                    cardStatusIcon.innerHTML = '‚ùå';
                    cardTitleText.innerText = "Artikel nicht gefunden";
                    cardContent.innerHTML = `<p>Der Barcode <strong>${barcode}</strong> ist nicht registriert.</p>`;
                    
                    // Nur Registrieren-Button anzeigen
                    inventoryButtonGroup.style.display = 'flex';
                    document.getElementById('registerButton').style.display = 'block';
                    document.getElementById('depositButton').style.display = 'none';
                    document.getElementById('withdrawButton').style.display = 'none';
                }

                card.classList.add('active');
            }

            function hideResultCard() {
                document.getElementById('result-card').classList.remove('active');
                articleToEdit = null;
                // Scanner im normalen Modus wieder starten, wenn er nicht im Umbuchungsmodus ist
                if (!isRelocationMode) {
                    lastCode = ""; // Reset debouncing
                    activateCamera(); 
                }
            }

            /** √ñffnet das Popup f√ºr Ein- oder Ausbuchen (Feature 1) */
            function showInventoryQuantityPopup(type) {
                activeTransactionType = type;
                const title = document.getElementById('inventoryQuantityTitle');
                const nameDisplay = document.getElementById('inventoryQuantityArticleName');
                const submitButton = document.getElementById('inventoryQuantitySubmitButton');
                const quantityInput = document.getElementById('inventoryQuantityInput');
                
                nameDisplay.innerText = articleToEdit.name;
                quantityInput.value = 1;
                document.getElementById('inventoryQuantityPlatz').value = articleToEdit.platz; // Aktuellen Platz √ºbernehmen
                
                if (type === 'deposit') {
                    title.innerText = "Artikel Einlagern";
                    submitButton.innerText = "Einlagern";
                    submitButton.classList.remove('delete');
                    submitButton.classList.add('register');
                    quantityInput.max = ''; // Keine Max-Grenze beim Einlagern
                } else {
                    title.innerText = "Artikel Auslagern";
                    submitButton.innerText = "Auslagern";
                    submitButton.classList.remove('register');
                    submitButton.classList.add('delete');
                    // Max-Wert setzen
                    quantityInput.max = articleToEdit.quantity;
                    if (articleToEdit.quantity === 0) {
                        showToast("Bestand ist 0. Auslagerung nicht m√∂glich.", 'error');
                        return;
                    }
                }
                document.getElementById('inventoryQuantityPopupOverlay').classList.add('show');
                hideResultCard();
            }

            /** Schlie√üt das Mengen-Popup */
            function hideInventoryQuantityPopup() {
                document.getElementById('inventoryQuantityPopupOverlay').classList.remove('show');
                activeTransactionType = null;
                document.getElementById('inventoryQuantityInput').max = '';
            }

            /** Verarbeitet die Inventartransaktion (Ein-/Ausbuchen) (Feature 1) */
            async function processInventoryTransaction() {
                const quantity = parseInt(document.getElementById('inventoryQuantityInput').value);
                const newPlatz = document.getElementById('inventoryQuantityPlatz').value.trim();

                if (isNaN(quantity) || quantity <= 0) {
                    showToast("Menge muss eine positive Zahl sein.", 'error');
                    return;
                }
                
                if (activeTransactionType === 'withdraw' && quantity > articleToEdit.quantity) {
                    showToast(`Es k√∂nnen maximal ${articleToEdit.quantity} St√ºck ausgelagert werden.`, 'error');
                    return;
                }
                
                // Logik f√ºr Platz√§nderung w√§hrend der Transaktion
                const oldPlatz = articleToEdit.platz;
                let logMessagePrefix = "";
                
                if (newPlatz !== oldPlatz) {
                    logMessagePrefix = `Platzwechsel von ${oldPlatz} zu ${newPlatz}. `;
                }

                if (activeTransactionType === 'deposit') {
                    await handleInventoryUpdate(quantity, newPlatz, 'inbound', logMessagePrefix + `Einlagerung von ${quantity} St√ºck.`);
                } else if (activeTransactionType === 'withdraw') {
                    await handleInventoryUpdate(-quantity, newPlatz, 'outbound', logMessagePrefix + `Auslagerung von ${quantity} St√ºck.`);
                }
                
                hideInventoryQuantityPopup();
                // Nach der Transaktion den Scanner wieder aktivieren
                lastCode = ""; // Reset debouncing
                activateCamera(); 
            }

            /** Zentrale Funktion zur Aktualisierung des Bestands und des Log-Eintrags (Feature 1) */
            async function handleInventoryUpdate(quantityChange, newPlatz, type, logMessage) {
                const newQuantity = articleToEdit.quantity + quantityChange;
                const oldPlatz = articleToEdit.platz;
                
                // 1. Artikelbestand aktualisieren
                const { error: articleError } = await window.appSupabaseClient
                    .from('artikel')
                    .update({ 
                        quantity: newQuantity,
                        platz: newPlatz, 
                        last_updated: new Date().toISOString()
                    })
                    .eq('id', articleToEdit.id);

                if (articleError) {
                    console.error("Fehler bei Bestandsaktualisierung:", articleError);
                    showToast("Fehler bei der Bestandsaktualisierung.", 'error');
                    return;
                }
                
                // 2. Log-Eintrag erstellen
                const logData = {
                    user_id: currentUserId,
                    user_email: document.getElementById("userDisplay").innerText.split(' ')[0],
                    action: logMessage,
                    barcode: articleToEdit.barcode,
                    artikel_id: articleToEdit.id,
                    quantity_change: quantityChange, 
                    current_quantity: newQuantity,
                    article_name: articleToEdit.name,
                    log_type: type 
                };
                
                const { error: logError } = await window.appSupabaseClient
                    .from('log')
                    .insert(logData);
                
                if (logError) {
                    console.error("Fehler beim Log-Eintrag:", logError);
                    showToast("Bestand aktualisiert, aber Log-Eintrag fehlgeschlagen.", 'warning');
                } else {
                    showToast(`Bestand von ${articleToEdit.name} erfolgreich auf ${newQuantity} aktualisiert!`, 'success');
                }
                
                // UI global aktualisieren
                articleToEdit.quantity = newQuantity;
                articleToEdit.platz = newPlatz;
            }


            /** Schaltet den Umbuchungsmodus (Doppel-Scan) ein/aus (Feature 3). */
            function toggleRelocationMode() {
                isRelocationMode = !isRelocationMode;
                const toggleButton = document.getElementById('relocationToggle');
                const statusText = document.getElementById('relocationStatus');
                
                relocationArticleId = null;
                relocationArticleName = null;
                statusText.style.display = 'none';

                if (isRelocationMode) {
                    toggleButton.innerText = "‚úÖ Modus: Umbuchen (Artikel scannen)";
                    showToast("Umbuchungsmodus aktiviert. Scannen Sie zuerst den Artikel-Barcode.", 'info', 5000);
                } else {
                    toggleButton.innerText = "üîÑ Modus: Normal";
                    showToast("Normaler Scan-Modus aktiviert.", 'info');
                }
                hideResultCard();
                lastCode = ""; // Reset debouncing
                activateCamera();
            }

            /**
             * Kernfunktion zur Verarbeitung des Barcodes.
             * Unterscheidet zwischen Normal-Scan, Registrierung und Umbuchungs-Scan (Feature 3).
             */
            async function handleScan(decodedText) {
                if (decodedText === lastCode) return;
                lastCode = decodedText;

                stopScanner(); // Scanner pausieren
                
                // 1. Suche in der Datenbank
                const { data: articleData, error: dbError } = await window.appSupabaseClient
                    .from('artikel')
                    .select('*')
                    .eq('barcode', decodedText)
                    .limit(1)
                    .single();
                    
                if (dbError && dbError.code !== 'PGRST116') { 
                    console.error("DB Fehler:", dbError);
                    showToast("Fehler bei der Datenbankabfrage.", 'error');
                    lastCode = ""; // Muss bei Fehler zur√ºckgesetzt werden, damit es erneut versucht werden kann
                    activateCamera(); 
                    return;
                }
                
                const article = articleData;
                
                // --- Logik f√ºr Umbuchungsmodus (Feature 3) ---
                if (isRelocationMode) {
                    if (!relocationArticleId) {
                        // ERSTER SCAN: Artikel-Barcode
                        if (article) {
                            relocationArticleId = article.id;
                            relocationArticleName = article.name;
                            
                            document.getElementById('relocationArticleNameDisplay').innerText = article.name;
                            document.getElementById('relocationStatus').style.display = 'block';
                            document.getElementById('relocationToggle').innerText = "‚úÖ Modus: Umbuchen (Stellplatz scannen)";
                            
                            showToast(`Artikel "${article.name}" zum Umzug ausgew√§hlt. Jetzt den ZIEL-Stellplatz scannen.`, 'warning', 7000);
                            lastCode = ""; // Zur√ºcksetzen, damit der n√§chste Scan anders ist
                            activateCamera(); // Scanner wieder aktivieren f√ºr den 2. Scan
                        } else {
                            showToast("Artikel nicht gefunden. Scannen Sie einen g√ºltigen ARTIKEL-Barcode.", 'error');
                            lastCode = ""; 
                            activateCamera();
                        }
                    } else {
                        // ZWEITER SCAN: Stellplatz-QR-Code
                        const oldArticleData = await window.appSupabaseClient
                            .from('artikel')
                            .select('*')
                            .eq('id', relocationArticleId)
                            .single();
                            
                        if (oldArticleData.error) {
                            showToast("Fehler beim Abrufen des Artikels f√ºr die Umbuchung.", 'error');
                            toggleRelocationMode(); // Modus zur√ºcksetzen
                            return;
                        }
                        
                        articleToEdit = oldArticleData.data;
                        
                        // Logik: Artikel verschieben (quantityChange = 0)
                        await handleInventoryUpdate(0, decodedText, 'relocation', `Umbuchung von ${relocationArticleName} von ${articleToEdit.platz} nach ${decodedText} durchgef√ºhrt.`);

                        // Modus zur√ºcksetzen
                        toggleRelocationMode(); 
                    }
                    return;
                }

                // --- Logik f√ºr Normalen Scan (Feature 1) ---
                showInventoryResultCard(article, decodedText);
            }
            
            /** Zeigt das Registrier-Popup */
            function showPopup() {
                document.getElementById('popupBarcode').value = currentScannedBarcode;
                document.getElementById('popupBaseName').value = '';
                document.getElementById('popupSize').value = '';
                document.getElementById('popupPlatz').value = '';
                document.getElementById('popupBlocklager').value = 'false';
                
                document.getElementById('popupQuantity').value = 1; // NEU: Initialwert 1
                
                document.getElementById('popupOverlay').classList.add('show');
                hideResultCard();
            }

            function hidePopup() {
                document.getElementById('popupOverlay').classList.remove('show');
                lastCode = "";
                activateCamera(); // Scanner reaktivieren
            }

            /** Speichert einen neuen Artikel (Feature 1 - Quantity) */
            async function saveArticle() {
                const baseName = document.getElementById('popupBaseName').value.trim();
                const size = document.getElementById('popupSize').value.trim();
                const platz = document.getElementById('popupPlatz').value.trim();
                const blocklager = document.getElementById('popupBlocklager').value === 'true';
                const quantity = parseInt(document.getElementById('popupQuantity').value); 
                
                if (!baseName || !platz) {
                    showToast("Bitte Name und Stellplatz eingeben.", 'error');
                    return;
                }
                
                if (isNaN(quantity) || quantity <= 0) {
                    showToast("Startbestand muss eine positive Zahl sein.", 'error');
                    return;
                }

                const fullName = baseName + (size ? ` (${size}L)` : '');
                
                const { error } = await window.appSupabaseClient
                    .from('artikel')
                    .insert({
                        barcode: currentScannedBarcode,
                        name: fullName,
                        size: size || null,
                        platz: platz,
                        blocklager: blocklager,
                        quantity: quantity, 
                        last_updated: new Date().toISOString()
                    });

                if (error) {
                    console.error(error);
                    showToast(`Fehler beim Speichern: ${error.message}`, 'error');
                } else {
                    // Log-Eintrag
                    await logAction('register', `Artikel "${fullName}" mit Bestand ${quantity} auf Platz ${platz} registriert.`, currentScannedBarcode, null, quantity, quantity, fullName);
                    
                    showToast(`Artikel "${fullName}" erfolgreich registriert!`, 'success');
                    hidePopup();
                }
            }


            /* --- ADMIN ARTIKEL VERWALTUNG (Feature 1 - Quantity & Stellplatzwechsel) --- */

            /** Zeigt das Admin Edit Popup */
            async function showAdminEditPopup() {
                if (!articleToEdit || currentUserRole !== 'admin') return;
                
                // Holen Sie die neuesten Daten (k√∂nnte sich in der Liste ver√§ndert haben)
                const { data: latestArticle, error } = await window.appSupabaseClient
                    .from('artikel')
                    .select('*')
                    .eq('id', articleToEdit.id)
                    .single();

                if (error) {
                    showToast("Fehler beim Laden der neuesten Artikeldaten.", 'error');
                    return;
                }
                
                articleToEdit = latestArticle; // Aktualisiere den globalen Zustand
                
                document.getElementById('adminEditName').value = articleToEdit.name;
                document.getElementById('adminEditBarcode').value = articleToEdit.barcode;
                document.getElementById('adminEditPlatz').value = articleToEdit.platz;
                document.getElementById('adminEditQuantity').value = articleToEdit.quantity;
                
                document.getElementById('adminEditPopupOverlay').classList.add('show');
                hideResultCard();
            }

            /** √ñffnet das Admin Edit Popup aus der Listenansicht */
            async function showAdminEditPopupFromList(articleId) {
                if (currentUserRole !== 'admin') return;
                
                 const article = articleCache.find(a => a.id === articleId);
                 if (article) {
                     articleToEdit = article;
                     showAdminEditPopup();
                 }
            }

            function hideAdminEditPopup() {
                document.getElementById('adminEditPopupOverlay').classList.remove('show');
                lastCode = ""; 
                activateCamera(); // Scanner reaktivieren
            }

            /** Admin Edit Speichern (Feature 1 - Quantity & Stellplatzwechsel) */
            async function saveAdminEdit() {
                const newPlatz = document.getElementById('adminEditPlatz').value.trim();
                const newQuantity = parseInt(document.getElementById('adminEditQuantity').value); 
                
                if (!articleToEdit || !newPlatz) return;
                
                if (isNaN(newQuantity) || newQuantity < 0) {
                    showToast("Bestand muss 0 oder eine positive Zahl sein.", 'error');
                    return;
                }

                const oldQuantity = articleToEdit.quantity;
                const quantityChange = newQuantity - oldQuantity;
                const oldPlatz = articleToEdit.platz;
                const isRelocation = newPlatz !== oldPlatz;
                
                if (quantityChange === 0 && !isRelocation) {
                    showToast("Keine √Ñnderungen vorgenommen.", 'info');
                    hideAdminEditPopup();
                    return;
                }
                
                let logMessage = `Admin-√Ñnderung an "${articleToEdit.name}" (ID: ${articleToEdit.id}): `;
                if (quantityChange !== 0) {
                    logMessage += `Bestand von ${oldQuantity} auf ${newQuantity} ge√§ndert. `;
                }
                if (isRelocation) {
                    logMessage += `Platz von ${oldPlatz} auf ${newPlatz} ge√§ndert.`;
                }
                
                // F√ºhrt die Aktualisierung durch. handleInventoryUpdate kann auch mit quantityChange=0 und Platz√§nderung arbeiten.
                await handleInventoryUpdate(quantityChange, newPlatz, 'admin_edit', logMessage);
                
                // UI-Update und Abschluss
                hideAdminEditPopup();
                showToast("Admin-√Ñnderung erfolgreich gespeichert.", 'success');
            }

            function deleteArticle() {
                if (!articleToEdit || currentUserRole !== 'admin') return;
                
                document.getElementById('deleteConfirmTitle').innerText = `Artikel unwiderruflich l√∂schen`;
                document.getElementById('deleteConfirmMessage').innerHTML = `Sind Sie sicher, dass Sie den Artikel <strong>"${articleToEdit.name}"</strong> (Barcode: ${articleToEdit.barcode}) dauerhaft l√∂schen m√∂chten?`;
                
                document.getElementById('deleteConfirmPopupOverlay').classList.add('show');
                hideAdminEditPopup();
            }

            function hideDeleteConfirmPopup() {
                document.getElementById('deleteConfirmPopupOverlay').classList.remove('show');
                lastCode = ""; 
                activateCamera(); // Scanner reaktivieren
            }

            async function confirmDeleteArticle() {
                if (!articleToEdit || currentUserRole !== 'admin') return;

                const { error } = await window.appSupabaseClient
                    .from('artikel')
                    .delete()
                    .eq('id', articleToEdit.id);

                if (error) {
                    console.error("Fehler beim L√∂schen:", error);
                    showToast(`Fehler beim L√∂schen: ${error.message}`, 'error');
                } else {
                    // Log-Eintrag
                    await logAction('delete', `Artikel "${articleToEdit.name}" (Bestand: ${articleToEdit.quantity}) von Platz ${articleToEdit.platz} gel√∂scht.`, articleToEdit.barcode, articleToEdit.id, -articleToEdit.quantity, 0, articleToEdit.name);

                    showToast(`Artikel "${articleToEdit.name}" wurde gel√∂scht.`, 'success');
                }

                hideDeleteConfirmPopup();
                articleToEdit = null;
                // Liste aktualisieren, falls wir uns im Listen-Tab befinden
                if (currentTabId === 'listTab') {
                    loadArticleList();
                }
            }


            /* --- ADMIN / USER VERWALTUNG --- */

            /** L√§dt die Benutzerliste (Admin-only) */
            async function loadUserList() {
                const list = document.getElementById('userList');
                list.innerHTML = ''; // Leeren

                if (currentUserRole !== 'admin') {
                    list.innerHTML = '<li style="border-left-color: var(--color-error-red);">Zugriff verweigert. Nur Administratoren k√∂nnen die Benutzerliste einsehen.</li>';
                    return;
                }

                list.innerHTML = '<li>Lade Benutzer...</li>';
                
                // Hole Benutzerdaten aus der user_roles Tabelle (mit RLS)
                const { data: users, error } = await window.appSupabaseClient
                    .from('user_roles')
                    .select('*')
                    .order('email', { ascending: true });

                if (error) {
                    list.innerHTML = `<li>Fehler beim Laden der Benutzer: ${error.message}</li>`;
                    console.error(error);
                    return;
                }

                if (users.length === 0) {
                    list.innerHTML = '<li>Keine Benutzer gefunden.</li>';
                    return;
                }

                list.innerHTML = users.map(user => {
                    const roleClass = user.role === 'admin' ? 'user-role-admin' : '';
                    const blockedClass = user.is_blocked ? 'user-is-blocked' : '';
                    const statusIcon = user.is_blocked ? BLOCKED_ICON_SVG : (user.role === 'admin' ? ADMIN_ICON_SVG : USER_ICON_SVG);
                    const statusLabel = user.is_blocked ? 'GESPERRT' : (user.role === 'admin' ? 'ADMIN' : 'USER');
                    
                    const internalNotes = user.notes ? `<span style="display: block; font-size: 0.75rem; color: var(--color-warning-yellow); margin-top: 5px;">Anmerkung: ${user.notes}</span>` : '';

                    return `
                        <li class="${roleClass} ${blockedClass}" data-role="admin-editable" onclick="showUserEditPopup('${user.id}')">
                            <div class="item-details" style="flex-grow: 1;">
                                <strong>${user.email}</strong>
                                <span>Rolle: ${statusLabel} (ID: ${user.id.substring(0, 8)}...)</span>
                                ${internalNotes}
                            </div>
                            <div class="item-count" style="width: 60px;">
                                ${statusIcon}
                                <span class="item-label">${statusLabel}</span>
                            </div>
                        </li>
                    `;
                }).join('');
            }
            
            /** Zeigt das Benutzer-Edit Popup */
            function showUserEditPopup(userId) {
                if (currentUserRole !== 'admin') return;

                // Suche den Benutzer in den gecachten Daten (vereinfachte Annahme: Benutzer ist in der Liste)
                const user = document.getElementById('userList').querySelector(`li[onclick*="${userId}"]`);
                if (!user) {
                    showToast("Benutzerdaten konnten nicht gefunden werden.", 'error');
                    return;
                }
                
                // Da wir die volle Datenstruktur nicht cachen, m√ºssen wir sie nachladen.
                // In einer realen App w√ºrde die loadUserList Funktion die Daten cachen.
                // Hier machen wir einen Direktaufruf, um die vollen Notizen etc. zu bekommen.
                window.appSupabaseClient
                    .from('user_roles')
                    .select('*')
                    .eq('id', userId)
                    .single()
                    .then(({ data, error }) => {
                        if (error || !data) {
                            showToast("Fehler beim Laden der Benutzerdetails.", 'error');
                            return;
                        }

                        userToEdit = data; // Speichere die vollen Daten

                        document.getElementById('userEditEmail').value = data.email;
                        document.getElementById('userEditRole').value = data.role || 'user';
                        document.getElementById('userEditBlocked').value = data.is_blocked ? 'true' : 'false';
                        document.getElementById('userEditNotes').value = data.notes || '';
                        
                        document.getElementById('userEditPopupOverlay').classList.add('show');
                    });
            }

            function hideUserEditPopup() {
                 document.getElementById('userEditPopupOverlay').classList.remove('show');
            }

            /** Speichert die √Ñnderungen am Benutzer (Admin) */
            async function saveUserEdit() {
                if (!userToEdit || currentUserRole !== 'admin') return;

                const newRole = document.getElementById('userEditRole').value;
                const newBlocked = document.getElementById('userEditBlocked').value === 'true';
                const newNotes = document.getElementById('userEditNotes').value.trim();

                const { error } = await window.appSupabaseClient
                    .from('user_roles')
                    .update({
                        role: newRole,
                        is_blocked: newBlocked,
                        notes: newNotes,
                        last_updated: new Date().toISOString()
                    })
                    .eq('id', userToEdit.id);

                if (error) {
                    console.error("Fehler beim Speichern der Benutzerdaten:", error);
                    showToast(`Fehler beim Speichern der Benutzerdaten.`, 'error');
                } else {
                    showToast(`Benutzer ${userToEdit.email} erfolgreich aktualisiert.`, 'success');
                    hideUserEditPopup();
                    loadUserList(); // Liste neu laden, um √Ñnderungen anzuzeigen
                }
            }


            /* --- ARTIKEL LISTEN & LOG & CSV EXPORT (Feature 4) --- */

            /** L√§dt die Artikelliste */
            async function loadArticleList() {
                const list = document.getElementById('articleList');
                list.innerHTML = '<li>Lade Artikel...</li>';
                
                // Feature 4: Filter-Logik
                const searchInput = document.getElementById('articleSearchInput').value.trim();
                let query = window.appSupabaseClient.from('artikel').select('*');
                
                if (searchInput) {
                    // Suche √ºber Name, Barcode oder Platz
                    query = query.or(`name.ilike.%${searchInput}%,barcode.ilike.%${searchInput}%,platz.ilike.%${searchInput}%`);
                }

                const { data: articles, error } = await query.order('name', { ascending: true });

                if (error) {
                    list.innerHTML = `<li>Fehler beim Laden der Artikel: ${error.message}</li>`;
                    console.error(error);
                    return;
                }
                
                // Feature 2: Caching-Gedanke (Speichern des Abfrageergebnisses f√ºr den CSV-Export)
                articleCache = articles; 

                if (articles.length === 0) {
                    list.innerHTML = '<li>Keine Artikel gefunden.</li>';
                    return;
                }

                list.innerHTML = articles.map(article => {
                    const iconHtml = article.blocklager ? WAREHOUSE_ICON_SVG : SHELF_ICON_SVG;
                    const roleAttribute = currentUserRole === 'admin' ? `data-role="admin-editable" onclick="showAdminEditPopupFromList('${article.id}')"` : '';
                    
                    // Anzeige: Quantity (Feature 1) - Rot bei niedrigem Bestand (z.B. <= 5)
                    const quantityClass = article.quantity <= 5 ? 'style="color: var(--color-error-red);"' : '';
                    const quantityDisplay = `<strong ${quantityClass}>${article.quantity} St√ºck</strong>`;

                    return `
                        <li ${roleAttribute}>
                            <div class="item-details" style="flex-grow: 1;">
                                <strong>${article.name}</strong>
                                <span>Barcode: ${article.barcode}</span>
                                <span>Stellplatz: ${article.platz}</span>
                                <span style="display: block; margin-top: 5px;">${quantityDisplay}</span>
                            </div>
                            <div class="item-count">
                                ${iconHtml}
                                <span class="item-label">${article.blocklager ? 'BLOCK' : 'REGAL'}</span>
                            </div>
                        </li>
                    `;
                }).join('');
            }
            
            /** Exportiert die aktuelle Artikelliste als CSV (Feature 4) */
            function exportArticleListCSV() {
                if (articleCache.length === 0) {
                    showToast("Artikelliste ist leer. Bitte zuerst 'Liste' √∂ffnen und laden.", 'info');
                    return;
                }
                
                // Daten f√ºr CSV aufbereiten: nur notwendige Felder
                const dataToExport = articleCache.map(article => ({
                    ID: article.id,
                    Name: article.name,
                    Barcode: article.barcode,
                    Stellplatz: article.platz,
                    Bestand: article.quantity, 
                    Groesse: article.size,
                    Blocklager: article.blocklager ? 'Ja' : 'Nein',
                    Erstellt_am: article.created_at,
                    Zuletzt_aktualisiert: article.last_updated
                }));
                
                exportToCSV('inventarliste.csv', dataToExport);
            }

            /** L√§dt das Admin Log-Protokoll */
            async function loadAdminLog() {
                const list = document.getElementById('logList');
                
                if (currentUserRole !== 'admin') {
                    list.innerHTML = '<li style="border-left-color: var(--color-error-red);">Zugriff verweigert. Nur Administratoren k√∂nnen das Log einsehen.</li>';
                    return;
                }

                list.innerHTML = '<li>Lade Log-Protokoll...</li>';

                const { data: logEntries, error } = await window.appSupabaseClient
                    .from('log')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    list.innerHTML = `<li>Fehler beim Laden des Logs: ${error.message}</li>`;
                    console.error(error);
                    return;
                }
                
                // Feature 2: Caching des Logs f√ºr Export
                logCache = logEntries; 

                if (logEntries.length === 0) {
                    list.innerHTML = '<li>Keine Log-Eintr√§ge vorhanden.</li>';
                    return;
                }

                list.innerHTML = logEntries.map(log => {
                    const date = new Date(log.created_at).toLocaleDateString() + ' ' + new Date(log.created_at).toLocaleTimeString();
                    let color = 'var(--color-accent-blue)';
                    let icon = '‚ÑπÔ∏è';
                    
                    // Farbe und Icon basierend auf log_type (Feature 1 - Log-Update)
                    switch(log.log_type) {
                        case 'inbound':
                            color = 'var(--color-accent-green)';
                            icon = '‚¨ÜÔ∏è';
                            break;
                        case 'outbound':
                            color = 'var(--color-error-red)';
                            icon = '‚¨áÔ∏è';
                            break;
                        case 'register':
                            color = 'var(--color-accent-blue)';
                            icon = 'üÜï';
                            break;
                        case 'relocation':
                            color = 'var(--color-warning-yellow)';
                            icon = 'üîÑ';
                            break;
                        case 'delete':
                            color = 'var(--color-error-red)';
                            icon = 'üóëÔ∏è';
                            break;
                        case 'admin_edit':
                            color = 'var(--color-warning-yellow)';
                            icon = '‚öôÔ∏è';
                            break;
                        default:
                            color = 'var(--color-accent-blue)';
                            icon = '‚ÑπÔ∏è';
                    }
                    
                    // Detail-Anzeige mit Mengen-Information (Feature 1 - Log-Update)
                    let quantityInfo = '';
                    if (log.quantity_change !== null && log.quantity_change !== 0) {
                        const sign = log.quantity_change > 0 ? '+' : '';
                        quantityInfo = `<span style="display: block; font-weight: 600;">Menge: ${sign}${log.quantity_change}</span>`;
                    }
                    if (log.current_quantity !== null) {
                         quantityInfo += `<span style="display: block;">Bestand: ${log.current_quantity}</span>`;
                    }
                    if (log.log_type === 'relocation' && log.quantity_change === 0) {
                        quantityInfo = `<span style="display: block; font-weight: 600;">Reine Umbuchung</span>`;
                    }

                    return `
                        <li style="border-left-color: ${color};">
                            <div class="item-details" style="flex-grow: 1;">
                                <strong>${log.action}</strong>
                                <span>Von: ${log.user_email} | ${date}</span>
                                <span style="opacity: 0.6; font-size: 0.75rem;">Artikel: ${log.article_name || log.barcode}</span>
                            </div>
                            <div class="item-count" style="width: auto; margin-right: 10px; font-size: 0.9rem;">
                                <div style="font-size: 1.2rem; margin-bottom: 3px;">${icon}</div>
                                ${quantityInfo}
                            </div>
                        </li>
                    `;
                }).join('');
            }

            /** Exportiert die aktuelle Log-Liste als CSV (Feature 4) */
            function exportLogCSV() {
                 if (currentUserRole !== 'admin') {
                    showToast("Zugriff verweigert. Nur Administratoren k√∂nnen das Log exportieren.", 'error');
                    return;
                }
                if (logCache.length === 0) {
                    showToast("Log-Protokoll ist leer. Bitte zuerst 'Log' √∂ffnen und laden.", 'info');
                    return;
                }
                
                // Daten f√ºr CSV aufbereiten
                const dataToExport = logCache.map(log => ({
                    ID: log.id,
                    Zeitstempel: log.created_at,
                    Benutzer_Email: log.user_email,
                    Aktion: log.action,
                    Typ: log.log_type, 
                    Artikel_Name: log.article_name,
                    Artikel_Barcode: log.barcode,
                    Mengen_Aenderung: log.quantity_change, 
                    Bestand_Danach: log.current_quantity, 
                    Artikel_ID: log.artikel_id,
                    Benutzer_ID: log.user_id,
                }));
                
                exportToCSV('admin_log.csv', dataToExport);
            }
            
            
            /* --- TAB NAVIGATION --- */

            function changeTab(targetTabId) {
                if (targetTabId === 'logTab' && currentUserRole !== 'admin') {
                    showToast("Nur Administratoren k√∂nnen das Log einsehen.", 'error');
                    return;
                }
                if (targetTabId === 'usersTab' && currentUserRole !== 'admin') {
                    showToast("Nur Administratoren k√∂nnen die Benutzerverwaltung einsehen.", 'error');
                    return;
                }

                if (currentTabId !== targetTabId) {
                    stopScanner();
                    hideResultCard();
                    hidePopup();
                    hideAdminEditPopup();
                    hideDeleteConfirmPopup();
                    hideUserEditPopup();
                    hideInventoryQuantityPopup(); // NEU: Inventar-Popup schlie√üen
                    
                    // Reset Umbuchungsmodus, wenn der Tab gewechselt wird
                    if (isRelocationMode) {
                        toggleRelocationMode(); 
                    }


                    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                    document.getElementById(targetTabId).classList.add('active');

                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    document.querySelector(`[data-tab="${targetTabId}"]`).classList.add('active');

                    currentTabId = targetTabId;

                    // Inhalt des neuen Tabs laden
                    if (targetTabId === 'listTab') {
                        loadArticleList();
                    } else if (targetTabId === 'logTab') { 
                        loadAdminLog();
                    } else if (targetTabId === 'usersTab') { 
                        loadUserList();
                    } else if (targetTabId === 'scannerTab') {
                        // Scanner Tab gestartet, aber Kamera noch nicht aktiviert
                        if (html5QrCode && !html5QrCode.isScanning) {
                            activateCamera();
                        } else if (!html5QrCode) {
                            document.getElementById('preScan').style.display = 'flex';
                        }
                    }
                }
            }


            // Start der Anwendung
            window.onload = function() {
                checkLogin();
            };
        </script>

    </body>
    </html>