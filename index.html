<!DOCTYPE html>
        <html lang="de">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
            <title>Inventar Scanner Pro</title>

            <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
            <script src="https://unpkg.com/html5-qrcode"></script>

            <script>
                // ---------------------------------------------------------
                // KONFIGURATION
                // ---------------------------------------------------------
                var APP_SUPABASE_URL = "https://sjhyvctidpnttqhenqoy.supabase.co"; 
                var APP_SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHl2Y3RpZHBudHRxaGVucW95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MzU3NTksImV4cCI6MjA4MDAxMTc1OX0.oXUA012J99W8fNNJi8Zxqn-2BUjf1QJOrXGYlPotaS4"; 
                
                // Initialisierung
                (function() {
                    if (window['supabase']) {
                        window.appSupabaseClient = window['supabase'].createClient(APP_SUPABASE_URL, APP_SUPABASE_KEY);
                    } else {
                        window.appSupabaseClient = null;
                        console.error("Supabase-Client konnte nicht initialisiert werden.");
                    }
                    window.lastCode = ""; 
                    window.currentTabId = "scannerTab"; 
                    window.currentUserRole = null; 
                    window.currentClientId = null; // NEU: Tenant-ID
                    window.offlineDB = null; // NEU: IndexedDB-Instanz
                    window.isSyncing = false; // NEU: Synchronisations-Status
                })();
            </script>

            <style>
                /* ... (Der Style-Block bleibt unver√§ndert) ... */
                /* --- GLOBALE STYLES & FONT --- */
                :root {
                    --color-bg-dark: #0a0b10;
                    --color-bg-card: #1d222e;
                    --color-accent-blue: #007aff;
                    --color-accent-green: #34c759;
                    --color-error-red: #ff3b30;
                    --color-border: rgba(255, 255, 255, 0.08);
                    --transition-duration: 0.3s;
                    --color-warning-yellow: #ffcc00; 
                }

                * {
                    box-sizing: border-box;
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                }

                body,
                html {
                    margin: 0;
                    padding: 0;
                    background: var(--color-bg-dark);
                    color: white;
                    height: 100dvh;
                    display: flex;
                    flex-direction: column;
                    overflow: hidden;
                }

                /* --- LAYOUT & TRANSITIONEN --- */

                .app-view-container {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    transition: opacity var(--transition-duration) ease-in-out, transform var(--transition-duration) ease-in-out;
                    opacity: 0;
                    pointer-events: none;
                    display: flex;
                    flex-direction: column;
                }

                .app-view-container.active {
                    opacity: 1;
                    pointer-events: all;
                }

                #loginView {
                    transform: translateY(0);
                }

                #appView {
                    transform: translateY(100vh);
                }

                #loginView.active {
                    transform: translateY(0);
                }

                #appView.active {
                    transform: translateY(0);
                }
                
                #tabContentContainer {
                    flex-grow: 1;
                    position: relative;
                    overflow: hidden; 
                }
                
                .tab-content {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    display: none !important; 
                    flex-direction: column;
                    overflow-y: auto; 
                    background: var(--color-bg-dark); 
                }
                
                .tab-content.active {
                    display: flex !important; 
                }


                /* --- HEADER --- */
                header {
                    height: 55px;
                    background: rgba(30, 30, 40, 0.9);
                    backdrop-filter: blur(8px);
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 0 15px;
                    border-bottom: 1px solid var(--color-border);
                    z-index: 10;
                    flex-shrink: 0; 
                }

                header h1 {
                    font-size: 1.1rem;
                    font-weight: 600;
                    margin: 0;
                }

                .header-button {
                    padding: 5px 10px;
                    font-size: 0.75em;
                    background: rgba(255, 255, 255, 0.1);
                    border: none;
                    border-radius: 8px;
                    color: white;
                    cursor: pointer;
                    transition: background 0.2s;
                }

                /* Icon Button f√ºr Settings */
                .header-icon-btn {
                    background: none; border: none;
                    font-size: 1.5rem; cursor: pointer;
                    padding: 0 10px; margin-right: 5px;
                    transition: transform 0.2s;
                }
                .header-icon-btn:active { transform: scale(0.9); }


                /* --- LOGIN VIEW --- */
                #loginView {
                    justify-content: space-around;
                    align-items: center;
                    padding: 40px 20px;
                    text-align: center;
                }

                .login-header {
                    text-align: center;
                    padding-top: 50px;
                }

                .app-icon {
                    font-size: 3.5em;
                    color: var(--color-accent-blue);
                    margin-bottom: 15px;
                }

                .login-header h2 {
                    font-size: 1.6rem;
                    font-weight: 700;
                    margin: 0;
                }

                #authError {
                    color: var(--color-error-red);
                    margin-top: 10px;
                    height: 1.2em;
                    font-weight: 500;
                }
                
                #loadingAuth {
                    text-align: center;
                    font-size: 1.1rem;
                    opacity: 0.7;
                    display: none; 
                    margin-top: 40px;
                }

                #authForm {
                    width: 100%;
                    max-width: 320px;
                    margin-top: 50px;
                    display: none; 
                }
                
                #authForm .input-group input {
                    width: 100%;
                    padding: 12px;
                    border-radius: 8px;
                    border: 1px solid var(--color-border);
                    background: var(--color-bg-card);
                    color: white;
                    font-size: 1rem;
                    margin-bottom: 15px;
                }
                
                #authForm .input-group label {
                    display: block;
                    font-size: 0.9rem;
                    margin-bottom: 5px;
                    opacity: 0.8;
                    text-align: left;
                }
                
                #authForm button[type="submit"] {
                    width: 100%;
                    padding: 12px;
                    font-size: 1rem;
                    font-weight: 600;
                    background: var(--color-accent-blue);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: background 0.2s;
                }
                
                #authForm button[type="submit"]:active {
                    background: #0066cc;
                }
                
                #registerToggle {
                    margin-top: 20px;
                    color: var(--color-accent-blue);
                    cursor: pointer;
                    font-size: 0.9rem;
                    opacity: 0.8;
                    text-decoration: underline;
                }
                
                #pinIndicators, #keypad {
                    display: none; 
                }


                /* --- APP VIEW / SCANNER --- */
                #scannerTab {
                    position: relative;
                    overflow: hidden;
                }

                #reader-container {
                    flex-grow: 1;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    position: relative;
                    overflow: hidden;
                }

                #reader {
                    width: 100%;
                    height: 100%;
                    background: black;
                    object-fit: cover;
                }
                
                #reader video {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                }


                .scan-frame {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 70%;
                    max-width: 300px;
                    aspect-ratio: 1 / 1;
                    border: 3px solid var(--color-accent-green);
                    border-radius: 12px;
                    box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.7);
                    pointer-events: none;
                }

                #preScan {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: var(--color-bg-dark);
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                    z-index: 5;
                }

                .primary-button {
                    padding: 12px 25px;
                    font-size: 1rem;
                    font-weight: 600;
                    background: var(--color-accent-blue);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: background 0.2s;
                }

                .primary-button:active {
                    background: #0066cc;
                }


                /* --- Result Card --- */
                #result-card {
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    width: 100%;
                    background: var(--color-bg-card);
                    border-top-left-radius: 20px;
                    border-top-right-radius: 20px;
                    padding: 20px;
                    box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.4);
                    transform: translateY(100%);
                    transition: transform var(--transition-duration) ease-out;
                    z-index: 10;
                }

                #result-card.active {
                    transform: translateY(0);
                }

                .card-handle {
                    width: 40px;
                    height: 4px;
                    background: rgba(255, 255, 255, 0.2);
                    border-radius: 2px;
                    margin: 0 auto 15px;
                }

                #cardTitle {
                    font-size: 1.4rem;
                    font-weight: 700;
                    margin-bottom: 10px;
                    display: flex;
                    align-items: center;
                }

                #cardStatusIcon {
                    margin-right: 10px;
                    font-size: 1.1em;
                }

                #cardContent p {
                    margin: 5px 0;
                    font-size: 0.9rem;
                    opacity: 0.8;
                }

                .action-button-group {
                    display: flex;
                    gap: 10px;
                    margin-top: 15px;
                }

                .action-button {
                    flex: 1;
                    padding: 12px;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                }

                .action-button.register {
                    background: var(--color-accent-green);
                    color: var(--color-bg-card);
                }
                .action-button.register:active {
                    background: #2cb74b;
                }
                .action-button.cancel {
                    background: rgba(255, 255, 255, 0.1);
                    color: white;
                }
                .action-button.cancel:active {
                    background: rgba(255, 255, 255, 0.2);
                }
                .action-button.delete {
                    background: var(--color-error-red);
                    color: white;
                }
                .action-button.delete:active {
                    background: #cc2a22;
                }


                /* --- POPUPS --- */
                #popupOverlay, #adminEditPopupOverlay, #deleteConfirmPopupOverlay, #userEditPopupOverlay, #settingsPopupOverlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    backdrop-filter: blur(5px);
                    z-index: 100;
                    display: none;
                    align-items: center;
                    justify-content: center;
                    opacity: 0;
                    transition: opacity 0.2s ease-in-out;
                }

                #popupOverlay.show, #adminEditPopupOverlay.show, #deleteConfirmPopupOverlay.show, #userEditPopupOverlay.show, #settingsPopupOverlay.show {
                    opacity: 1;
                    display: flex; 
                }

                .popup-card {
                    background: var(--color-bg-card);
                    padding: 25px;
                    border-radius: 15px;
                    width: 90%;
                    max-width: 400px;
                    transform: translateY(20px);
                    transition: transform 0.3s ease-in-out;
                }

                #popupOverlay.show .popup-card, #adminEditPopupOverlay.show .popup-card, #deleteConfirmPopupOverlay.show .popup-card, #userEditPopupOverlay.show .popup-card, #settingsPopupOverlay.show .popup-card {
                    transform: translateY(0);
                }

                .popup-card h3 {
                    margin-top: 0;
                    font-size: 1.3rem;
                    border-bottom: 1px solid var(--color-border);
                    padding-bottom: 10px;
                    margin-bottom: 20px;
                }

                .input-group {
                    margin-bottom: 15px;
                }
                
                .input-group textarea {
                    resize: vertical;
                    min-height: 80px;
                }

                .input-group label {
                    display: block;
                    font-size: 0.9rem;
                    margin-bottom: 5px;
                    opacity: 0.8;
                }

                .input-group input[type="text"],
                .input-group input[type="email"],
                .input-group input[type="password"],
                .input-group select,
                .input-group textarea {
                    width: 100%;
                    padding: 10px;
                    border-radius: 8px;
                    border: 1px solid var(--color-border);
                    background: var(--color-bg-dark);
                    color: white;
                    font-size: 1rem;
                }
                .input-group input:focus,
                .input-group select:focus,
                .input-group textarea:focus {
                    outline: none;
                    border-color: var(--color-accent-blue);
                }

                /* --- SETTINGS STYLES --- */
                .setting-row {
                    display: flex; justify-content: space-between; align-items: center;
                    margin-bottom: 20px; padding-bottom: 15px;
                    border-bottom: 1px solid var(--color-border);
                }
                .setting-row:last-child { border-bottom: none; }

                .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
                .switch input { opacity: 0; width: 0; height: 0; }
                .slider {
                    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
                    background-color: #3a3a44; transition: .4s; border-radius: 34px;
                }
                .slider:before {
                    position: absolute; content: ""; height: 20px; width: 20px;
                    left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;
                }
                input:checked + .slider { background-color: var(--color-accent-green); }
                input:checked + .slider:before { transform: translateX(22px); }

                /* Volume Slider */
                input[type=range] { width: 100%; margin-top: 10px; background: transparent; -webkit-appearance: none; }
                input[type=range]::-webkit-slider-thumb {
                    -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
                    background: var(--color-accent-blue); cursor: pointer; margin-top: -8px;
                }
                input[type=range]::-webkit-slider-runnable-track {
                    width: 100%; height: 4px; cursor: pointer; background: #3a3a44; border-radius: 2px;
                }

                /* --- TOASTS --- */
                #toastContainer {
                    position: fixed;
                    top: 15px;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 90%;
                    max-width: 350px;
                    z-index: 200;
                    pointer-events: none;
                }

                .toast {
                    background: var(--color-bg-card);
                    color: white;
                    padding: 10px 15px;
                    border-radius: 10px;
                    margin-bottom: 10px;
                    opacity: 0;
                    transform: translateY(20px);
                    transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
                    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    font-size: 0.95rem;
                    font-weight: 500;
                }

                .toast.show {
                    opacity: 1;
                    transform: translateY(0);
                }

                .toast-icon {
                    margin-right: 10px;
                    font-size: 1.2em;
                }

                .toast.success .toast-icon {
                    color: var(--color-accent-green);
                }

                .toast.error .toast-icon {
                    color: var(--color-error-red);
                }

                .toast.info .toast-icon {
                    color: var(--color-accent-blue);
                }

                /* --- FOOTER / NAVIGATION --- */
                footer {
                    display: flex;
                    height: 70px;
                    background: rgba(30, 30, 40, 0.9);
                    backdrop-filter: blur(8px);
                    border-top: 1px solid var(--color-border);
                    flex-shrink: 0;
                    z-index: 20;
                }

                .nav-item {
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    color: rgba(255, 255, 255, 0.5);
                    font-size: 0.8rem;
                    cursor: pointer;
                    transition: color 0.2s;
                    user-select: none;
                }

                .nav-item.active {
                    color: var(--color-accent-blue);
                }

                .nav-item svg {
                    width: 24px;
                    height: 24px;
                    stroke: currentColor;
                    fill: none;
                    stroke-width: 2;
                    margin-bottom: 2px;
                }
                
                /* --- ARTIKEL LIST VIEW STYLES / REUSABLE LIST STYLES --- */
                /* Padding in .list-content-container, da das Tab-Content nun auch den Search-Header enth√§lt */
                .list-content-container {
                    overflow-y: auto; 
                    padding: 15px 15px 80px 15px; 
                }
                
                /* NEU: Search Container Style */
                .search-container {
                    padding: 15px; 
                    flex-shrink: 0; 
                    background: var(--color-bg-dark);
                    border-bottom: 1px solid var(--color-border);
                }

                .search-container input {
                    width: 100%;
                    padding: 10px 15px;
                    border-radius: 8px;
                    border: 1px solid var(--color-border);
                    background: var(--color-bg-card);
                    color: white;
                    font-size: 1rem;
                }


                /* Alte Paddings entfernt und durch list-content-container ersetzt */
                #listTab, #logTab, #usersTab { 
                    padding: 0; /* Wichtig: Padding hier entfernen */
                }
                
                #articleList, #logList, #userList { 
                    list-style: none;
                    padding: 0;
                    margin: 0;
                }
                
                #articleList li, #logList li, #userList li { 
                    background: var(--color-bg-card);
                    padding: 15px;
                    border-radius: 10px;
                    margin-bottom: 10px;
                    border-left: 5px solid var(--color-accent-blue); 
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    transition: background 0.2s; 
                }
                
                #articleList li[data-role="admin-editable"]:active, #userList li[data-role="admin-editable"]:active {
                    background: #2a303e; 
                }
                
                .user-role-admin { border-left-color: var(--color-warning-yellow) !important; }
                .user-is-blocked { border-left-color: var(--color-error-red) !important; }

                .item-details strong {
                    display: block;
                    font-size: 1.rem;
                    font-weight: 600;
                    margin-bottom: 2px;
                }
                
                .item-details span {
                    font-size: 0.85rem;
                    opacity: 0.7;
                }
                
                .item-count {
                    text-align: center; 
                    width: 50px; 
                    height: 50px; 
                    flex-shrink: 0;
                    margin-left: 10px;
                    display: flex; 
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    font-size: 0.8rem;
                }
                
                .item-count svg {
                    width: 28px; 
                    height: 28px;
                    margin-bottom: 2px; 
                }

                .item-count .item-label {
                    font-size: 0.6rem; 
                    font-weight: 600;
                    line-height: 1;
                }
                
                #logTab {
                    display: flex; 
                    flex-direction: column;
                }
                
                .user-edit-button {
                    background: var(--color-accent-blue);
                    color: white;
                    padding: 8px 15px;
                    border-radius: 8px;
                    font-size: 0.8rem;
                    font-weight: 600;
                    cursor: pointer;
                    transition: background 0.2s;
                }

            </style>
        </head>
        <body>

            <div id="toastContainer"></div>
            
            <div id="popupOverlay">
                <form class="popup-card" onsubmit="event.preventDefault(); saveArticle();">
                    <h3>Artikel Registrieren</h3>
                    <div class="input-group">
                        <label for="popupBarcode">Barcode</label>
                        <input type="text" id="popupBarcode" readonly>
                    </div>
                    
                    <div class="input-group">
                        <label for="popupBaseName">Basis-Name (z.B. T-Shirt, Wasserflasche)</label>
                        <input type="text" id="popupBaseName" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="popupSize">Gr√∂√üe / Volumen (Liter)</label>
                        <select id="popupSize">
                            <option value="">(Optional)</option>
                            <option value="0.33">0,33 Liter</option>
                            <option value="0.5">0,5 Liter</option>
                            <option value="0.7">0,7 Liter</option>
                            <option value="1.0">1,0 Liter</option>
                            <option value="1.5">1,5 Liter</option>
                            <option value="2.0">2,0 Liter</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="popupPlatz">Stellplatz (z.B. A-02-C)</label>
                        <input type="text" id="popupPlatz" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="popupBlocklager">Lagertyp</label>
                        <select id="popupBlocklager">
                            <option value="false">Regal / Fach</option>
                            <option value="true">Blocklager</option>
                        </select>
                    </div>

                    <div class="action-button-group">
                        <button type="button" class="action-button cancel" onclick="hidePopup()">Abbrechen</button>
                        <button type="submit" class="action-button register">Speichern</button>
                    </div>
                </form>
            </div>
            
            <div id="adminEditPopupOverlay">
                <form class="popup-card" onsubmit="event.preventDefault(); saveAdminEdit();">
                    <h3>Artikel Bearbeiten (Admin)</h3>
                    <div class="input-group">
                        <label for="adminEditName">Artikel Name</label>
                        <input type="text" id="adminEditName" readonly>
                    </div>

                    <div class="input-group">
                        <label for="adminEditBarcode">Barcode</label>
                        <input type="text" id="adminEditBarcode" readonly>
                    </div>
                    
                    <div class="input-group">
                        <label for="adminEditPlatz">Neuer Stellplatz</label>
                        <input type="text" id="adminEditPlatz" required>
                    </div>
                    
                    <div class="action-button-group">
                        <button type="button" class="action-button cancel" onclick="hideAdminEditPopup()">Abbrechen</button>
                        <button type="submit" class="action-button register">Speichern</button>
                    </div>

                    <button type="button" class="action-button delete" style="width: 100%; margin-top: 15px;" onclick="deleteArticle()">
                        Artikel l√∂schen...
                    </button>

                    <p style="font-size: 0.75rem; opacity: 0.6; text-align: center; margin-top: 15px;">Sie sind als Administrator angemeldet und k√∂nnen den Stellplatz √§ndern.</p>
                </form>
            </div>

            <div id="deleteConfirmPopupOverlay">
                <div class="popup-card">
                    <h3 id="deleteConfirmTitle">Artikel unwiderruflich l√∂schen</h3>
                    <p id="deleteConfirmMessage" style="margin-bottom: 25px; text-align: center; font-weight: 500; font-size: 1.1rem; line-height: 1.4;"></p>

                    <div class="action-button-group">
                        <button type="button" class="action-button cancel" onclick="hideDeleteConfirmPopup()">Abbrechen</button>
                        <button type="button" class="action-button delete" onclick="confirmDeleteArticle()">Ja, unwiderruflich l√∂schen</button>
                    </div>
                </div>
            </div>
            
            <div id="userEditPopupOverlay">
                <form class="popup-card" onsubmit="event.preventDefault(); saveUserEdit();">
                    <h3>Benutzer bearbeiten (Admin)</h3>
                    <div class="input-group">
                        <label for="userEditEmail">E-Mail</label>
                        <input type="text" id="userEditEmail" readonly>
                    </div>
                    <div class="input-group">
                        <label for="userEditRole">Rolle</label>
                        <select id="userEditRole" required>
                            <option value="user">Benutzer (Standard)</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="userEditBlocked">Sperrstatus</label>
                        <select id="userEditBlocked" required>
                            <option value="false">Nicht gesperrt</option>
                            <option value="true">Gesperrt</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="userEditNotes">Anmerkungen (nur f√ºr Admins sichtbar)</label>
                        <textarea id="userEditNotes" placeholder="Interne Anmerkungen..."></textarea>
                    </div>
                    
                    <div class="action-button-group">
                        <button type="button" class="action-button cancel" onclick="hideUserEditPopup()">Abbrechen</button>
                        <button type="submit" class="action-button register">√Ñnderungen speichern</button>
                    </div>
                </form>
            </div>

            <div id="settingsPopupOverlay">
                <div class="popup-card">
                    <h3>Einstellungen</h3>
                    
                    <div class="setting-row">
                        <label>Sound bei Scan</label>
                        <label class="switch">
                            <input type="checkbox" id="settingSound" onchange="saveSettings()">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-row" style="display:block;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <label>Lautst√§rke</label>
                            <span id="volValue">50%</span>
                        </div>
                        <input type="range" id="settingVolume" min="0" max="100" value="50" oninput="updateVolumeLabel()" onchange="saveSettings()">
                    </div>

                    <div class="setting-row">
                        <label>Vibration bei Scan</label>
                        <label class="switch">
                            <input type="checkbox" id="settingVibrate" onchange="saveSettings()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <h4 style="margin-top: 30px; margin-bottom: 15px; font-weight: 600;">Datenmanagement (Admin)</h4>
                    <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 15px;">Import/Export ist nur f√ºr Administratoren verf√ºgbar.</p>

                    <div class="setting-row" style="border-bottom: none; flex-direction: column; align-items: stretch; padding-bottom: 0;">
                        <label style="margin-bottom: 10px; font-weight: 600;">Daten exportieren (Artikel)</label>
                        <div class="action-button-group" style="margin-top: 0;">
                            <button type="button" class="action-button register" style="flex: 1; background: #2e8b57;" onclick="exportData('json')">Export JSON</button>
                            <button type="button" class="action-button register" style="flex: 1; background: #2e8b57;" onclick="exportData('csv')">Export CSV</button>
                        </div>
                    </div>

                    <div class="setting-row" style="border-bottom: none; flex-direction: column; align-items: stretch; padding-bottom: 0; margin-top: 20px;">
                        <label for="importFile" style="margin-bottom: 10px; font-weight: 600;">Daten importieren (CSV/JSON)</label>
                        <input type="file" id="importFile" accept=".csv, application/json" style="padding: 8px 15px; background: var(--color-bg-dark); border-radius: 8px; border: 1px solid var(--color-border);" onchange="importData()">
                    </div>

                    <div class="action-button-group" style="margin-top: 30px;">
                        <button type="button" class="action-button cancel" onclick="hideSettingsPopup()">Schlie√üen</button>
                        <button type="button" class="action-button register" style="background: var(--color-error-red);" onclick="testFeedback()">Test Feedback</button>
                    </div>
                </div>
            </div>

            <div id="loginView" class="app-view-container active">
                <div class="login-header">
                    <div class="app-icon">üì¶</div>
                    <h2>Inventar Scanner Pro</h2>
                    <p style="opacity: 0.6;">Anmelden, um zu starten.</p>
                </div>
                
                <div id="loadingAuth">
                    <p>Pr√ºfe Sitzung...</p>
                </div>

                <form id="authForm" onsubmit="event.preventDefault(); handleAuthSubmit(this);">
                    <div id="pinIndicators" style="text-align: center; margin-bottom: 30px;">
                        </div>

                    <div class="input-group">
                        <label for="authEmail">E-Mail</label>
                        <input type="email" id="authEmail" required>
                    </div>
                    <div class="input-group">
                        <label for="authPassword">Passwort</label>
                        <input type="password" id="authPassword" required>
                    </div>
                    
                    <div id="authError"></div>
                    
                    <button type="submit" id="authSubmitButton">Anmelden</button>
                    <p id="registerToggle" onclick="toggleAuthMode()">Noch kein Konto? Jetzt registrieren</p>
                </form>
                
                <div style="text-align: center; opacity: 0.4; font-size: 0.7rem; padding-bottom: 20px;">
                    Powered by Supabase & IndexedDB
                </div>
            </div>

            <div id="appView" class="app-view-container">
                <header>
                    <h1>Inventar Scanner</h1>
                    <div style="display:flex; align-items:center;">
                        <span id="userDisplay" style="font-size: 0.85rem; opacity: 0.7; margin-right: 10px;"></span>
                        <button class="header-icon-btn" onclick="showSettingsPopup()">‚öôÔ∏è</button>
                        <button class="header-button" onclick="logout()">Logout</button>
                    </div>
                </header>

                <div id="tabContentContainer">
                    <div id="scannerTab" class="tab-content active">
                        <div id="reader-container">
                            <div id="reader"></div>
                            <div class="scan-frame" id="scanFrame" style="display:none;"></div>
                            <div id="preScan">
                                <div style="font-size: 4em; margin-bottom: 20px;">üì¶</div>
                                <h2>Scanner bereit</h2>
                                <p style="opacity: 0.7; margin-bottom: 30px;">Kamera-Zugriff starten, um loszulegen.</p>
                                <button class="primary-button" style="max-width: 250px;" onclick="activateCamera()">SCAN STARTEN</button>
                            </div>
                        </div>
                        <div id="result-card" class="result-card">
                            <div class="card-handle"></div>
                            <div id="cardTitle"><span id="cardStatusIcon"></span> <span id="cardTitleText"></span></div>
                            <div id="cardContent"></div>
                            <div class="action-button-group">
                                <button class="action-button cancel" onclick="hideResultCard()">Fertig</button>
                                <button class="action-button register" id="registerButton" onclick="showPopup()">Registrieren</button>
                            </div>
                        </div>
                    </div>

                    <div id="listTab" class="tab-content">
                        <div class="search-container">
                            <input type="text" id="articleSearchInput" placeholder="Suche nach Name, Barcode oder Stellplatz..." oninput="debounce(loadArticleList, 300, this.value)">
                        </div>
                        <div class="list-content-container">
                            <ul id="articleList"></ul>
                        </div>
                    </div>

                    <div id="logTab" class="tab-content">
                        <div class="search-container">
                            <input type="text" id="logSearchInput" placeholder="Suche nach Aktion oder Beschreibung..." oninput="loadAdminLog(this.value)">
                        </div>
                        <div class="list-content-container">
                            <ul id="logList"></ul>
                        </div>
                    </div>

                    <div id="usersTab" class="tab-content">
                        <div class="search-container">
                            <input type="text" id="userSearchInput" placeholder="Suche nach E-Mail, Rolle oder Anmerkungen..." oninput="loadUserList(this.value)">
                        </div>
                        <div class="list-content-container">
                            <ul id="userList"></ul>
                        </div>
                    </div>

                </div>

                <footer>
                    <div class="nav-item active" id="navScanner" onclick="changeTab('scannerTab')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 13V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v7"></path><path d="M14 10H6"></path><path d="M14 14H6"></path><path d="M17 19h4"></path><path d="M19 17v4"></path></svg>
                        Scanner
                    </div>
                    <div class="nav-item" id="navList" onclick="changeTab('listTab')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2H2v10l10 10 10-10L12 2z"></path><path d="M7 7h.01"></path></svg>
                        Artikel
                    </div>
                    <div class="nav-item" id="navLog" onclick="changeTab('logTab')" style="display:none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        Log
                    </div>
                    <div class="nav-item" id="navUsers" onclick="changeTab('usersTab')" style="display:none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        Benutzer
                    </div>
                </footer>
            </div>

            <script>
                // --- GLOBALE VARIABLEN ---
                var html5QrCode;
                var lastCode = ""; // H√§lt den zuletzt gescannten Code
                var debounceTimer;
                var appSettings = {
                    sound: true,
                    vibrate: true,
                    volume: 50 // 0-100
                };
                const feedbackAudio = new Audio('data:audio/wav;base64,UklGRl9vT1JXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAAABkYXRhAAAEAAAAAA=='); // Kurzer Piepton (Base64 kodiert)

                // --- HELFER FUNKTIONEN ---
                
                /**
                 * Debounce Funktion zum Begrenzen der Aufrufe von Suchfunktionen.
                 * @param {function} func Die aufzurufende Funktion
                 * @param {number} delay Die Verz√∂gerungszeit in ms
                 * @param {...any} args Die Argumente f√ºr die Funktion
                 */
                function debounce(func, delay, ...args) {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => func(...args), delay);
                }

                // --- EINSTELLUNGEN LOGIK ---
                function initSettings() {
                    const savedSettings = localStorage.getItem('inventoryAppSettings');
                    if (savedSettings) {
                        try {
                            appSettings = JSON.parse(savedSettings);
                        } catch (e) {
                            console.error("Fehler beim Parsen der Einstellungen:", e);
                        }
                    }
                    
                    document.getElementById('settingSound').checked = appSettings.sound;
                    document.getElementById('settingVibrate').checked = appSettings.vibrate;
                    document.getElementById('settingVolume').value = appSettings.volume;
                    updateVolumeLabel(); // Beschriftung setzen
                    feedbackAudio.volume = appSettings.volume / 100;
                }

                function updateVolumeLabel() {
                    document.getElementById('volValue').innerText = `${document.getElementById('settingVolume').value}%`;
                }
                
                function saveSettings() {
                    appSettings.sound = document.getElementById('settingSound').checked;
                    appSettings.vibrate = document.getElementById('settingVibrate').checked;
                    appSettings.volume = parseInt(document.getElementById('settingVolume').value);
                    feedbackAudio.volume = appSettings.volume / 100;
                    localStorage.setItem('inventoryAppSettings', JSON.stringify(appSettings));
                }

                function showSettingsPopup() {
                    document.getElementById('settingsPopupOverlay').style.display = 'flex';
                    setTimeout(() => document.getElementById('settingsPopupOverlay').classList.add('show'), 10);
                }

                function hideSettingsPopup() {
                    document.getElementById('settingsPopupOverlay').classList.remove('show');
                    setTimeout(() => document.getElementById('settingsPopupOverlay').style.display = 'none', 300);
                }

                function triggerScanFeedback() {
                    if (appSettings.sound) {
                        feedbackAudio.currentTime = 0;
                        feedbackAudio.play().catch(e => console.log("Audio blockiert", e));
                    }
                    if (appSettings.vibrate && navigator.vibrate) {
                        navigator.vibrate(200); // 200ms Vibration
                    }
                }

                function testFeedback() {
                    triggerScanFeedback();
                    showToast("Feedback getestet.", 'success');
                }

                // --- AUTHENTIFIZIERUNG LOGIK ---

                function switchView(viewId) {
                    document.querySelectorAll('.app-view-container').forEach(view => {
                        view.classList.remove('active');
                    });
                    document.getElementById(viewId).classList.add('active');
                    // Wenn wir zur App wechseln, Tabs und Admin-Ansichten aktualisieren
                    if (viewId === 'appView') {
                        changeTab(window.currentTabId);
                        updateAdminViews(window.currentUserRole);
                    }
                }

                function updateAdminViews(role) {
                    const isAdmin = role === 'admin';
                    document.getElementById('navLog').style.display = isAdmin ? 'flex' : 'none';
                    document.getElementById('navUsers').style.display = isAdmin ? 'flex' : 'none';
                }

                async function checkLogin() {
                    document.getElementById('loadingAuth').style.display = 'block';
                    document.getElementById('authForm').style.display = 'none';

                    // IndexedDB initialisieren
                    window.offlineDB = new OfflineDB('inventarDB', 1);
                    await window.offlineDB.open();

                    const { data: { user } } = await window.appSupabaseClient.auth.getUser();

                    if (user) {
                        await handleLoginSuccess(user.id, user.email);
                    } else {
                        document.getElementById('loadingAuth').style.display = 'none';
                        document.getElementById('authForm').style.display = 'block';
                        switchView('loginView');
                    }
                }

                let isRegisterMode = false;
                function toggleAuthMode() {
                    isRegisterMode = !isRegisterMode;
                    const submitButton = document.getElementById('authSubmitButton');
                    const toggleLink = document.getElementById('registerToggle');
                    
                    if (isRegisterMode) {
                        submitButton.innerText = "Registrieren";
                        toggleLink.innerText = "Bereits registriert? Jetzt anmelden";
                    } else {
                        submitButton.innerText = "Anmelden";
                        toggleLink.innerText = "Noch kein Konto? Jetzt registrieren";
                    }
                    document.getElementById("authError").innerText = "";
                }

                async function handleAuthSubmit(form) {
                    const email = document.getElementById('authEmail').value;
                    const password = document.getElementById('authPassword').value;
                    const submitButton = document.getElementById('authSubmitButton');
                    document.getElementById("authError").innerText = "";

                    submitButton.disabled = true;
                    submitButton.innerText = "Lade...";

                    try {
                        if (isRegisterMode) {
                            const { error: signUpError } = await window.appSupabaseClient.auth.signUp({ 
                                email: email, 
                                password: password 
                            });
                            
                            if (signUpError) throw signUpError;

                            showToast("Registrierung erfolgreich. Bitte E-Mail best√§tigen.", 'info', 7000);
                            toggleAuthMode(); // Zur√ºck zum Login
                        } else {
                            const { data, error } = await window.appSupabaseClient.auth.signInWithPassword({
                                email: email,
                                password: password,
                            });
                            if (error) throw error;
                            await handleLoginSuccess(data.user.id, data.user.email);
                        }
                    } catch (error) {
                        let errorMessage = "Unbekannter Fehler bei der Authentifizierung.";
                        if (error.message) {
                            errorMessage = error.message;
                        } else if (error.status === 400 && errorMessage.includes('Email not confirmed')) {
                            errorMessage = "E-Mail noch nicht best√§tigt. Bitte √ºberpr√ºfen Sie Ihr Postfach.";
                        }
                        document.getElementById("authError").innerText = errorMessage;
                        showToast("Login fehlgeschlagen.", 'error', 5000);
                    }
                    submitButton.disabled = false;
                    submitButton.innerText = (isRegisterMode ? "Registrieren" : "Anmelden");
                }
                
                let currentUserId; // Globale Variable f√ºr die aktuelle Benutzer-ID

                async function handleLoginSuccess(userId, email) {
                    currentUserId = userId;
                    let userRole = 'user';
                    let isBlocked = false;
                    let clientId = null; // NEU: Variable f√ºr die Client-ID
                    let isOffline = !navigator.onLine;

                    try {
                        // 1. Online-Versuch, Benutzerrolle und Client-ID zu laden
                        const { data, error } = await window.appSupabaseClient
                            .from('user_roles')
                            .select('role, is_blocked, notes, client_id') // NEU: client_id abrufen
                            .eq('id', userId)
                            .single();
                        
                        if (data) {
                            userRole = data.role || 'user';
                            isBlocked = data.is_blocked || false;
                            clientId = data.client_id; // NEU: Client-ID setzen
                            
                            // Lokale Kopie aktualisieren (upsert)
                            await window.offlineDB.upsertData('user_roles', { 
                                id: userId, 
                                email: email, 
                                role: userRole, 
                                is_blocked: isBlocked, 
                                notes: data.notes || '',
                                client_id: clientId // NEU: Client-ID speichern
                            });
                        } else {
                            // Wenn kein Eintrag gefunden wird (neuer Benutzer) oder Fehler auftritt
                            if (error && error.message.includes('Failed to fetch')) {
                                throw new Error("Offline"); 
                            }
                            if (error && !error.message.includes('Row not found')) {
                                console.error("Fehler beim Laden der Benutzerrolle:", error);
                            }
                            // Neuen Benutzer lokal registrieren
                            await window.offlineDB.upsertData('user_roles', { 
                                id: userId, 
                                email: email, 
                                role: 'user', 
                                is_blocked: false, 
                                notes: '',
                                client_id: null
                            });
                            // Wenn online, aber kein user_roles Eintrag: Standardrolle 'user' setzen.
                            if (!isOffline && !error) {
                                await window.appSupabaseClient.from('user_roles').insert({ 
                                    id: userId, 
                                    email: email, 
                                    role: 'user',
                                    is_blocked: false,
                                    client_id: null // Muss sp√§ter vom Admin gesetzt werden
                                });
                            }
                        }

                    } catch (e) {
                        if (e.message === "Offline" || !navigator.onLine) {
                            isOffline = true;
                            showToast("Netzwerkfehler. Lade lokale Benutzerdaten...", 'info');
                            // 2. Offline-Fallback (IndexedDB)
                            try {
                                const localData = await window.offlineDB.getData('user_roles', userId);
                                if (localData) {
                                    userRole = localData.role || 'user';
                                    isBlocked = localData.is_blocked || false;
                                    clientId = localData.client_id;
                                } else {
                                    // Bei Offline und keinem lokalen Eintrag: Login blockieren, da keine Rolle bekannt.
                                    showToast("Login fehlgeschlagen: Keine lokalen Benutzerdaten gefunden.", 'error', 7000);
                                    return;
                                }
                            } catch (localError) {
                                showToast("Login fehlgeschlagen: Fehler beim Laden der lokalen DB.", 'error', 7000);
                                return;
                            }
                        } else {
                            console.error("Login Fehler beim Laden der Rolle:", e);
                        }
                    }

                    document.getElementById('loadingAuth').style.display = 'none';

                    // √úberpr√ºfung auf Mandantenzugeh√∂rigkeit (falls erforderlich)
                    if (!clientId && userRole === 'user') { // Admin kann ohne Client-ID ein Admin-Konto sein
                        await window.appSupabaseClient.auth.signOut();
                        document.getElementById("authError").innerText = "Ihr Konto ist keinem Mandanten zugewiesen. Bitte wenden Sie sich an den Administrator.";
                        showToast("Login fehlgeschlagen: Kein Mandant zugewiesen.", 'error', 7000);
                        return;
                    }
                    if (isBlocked) {
                        await window.appSupabaseClient.auth.signOut();
                        document.getElementById("authError").innerText = "Ihr Konto ist gesperrt. Bitte wenden Sie sich an den Administrator.";
                        showToast("Login fehlgeschlagen: Konto gesperrt.", 'error', 7000);
                        return;
                    }
                    
                    window.currentUserRole = userRole;
                    window.currentClientId = clientId; // Globale Tenant-ID setzen
                    document.getElementById("userDisplay").innerText = email;
                    switchView('appView');
                    syncData(true);
                }

                async function logout() {
                    const { error } = await window.appSupabaseClient.auth.signOut();
                    if (error) {
                        showToast("Fehler beim Abmelden.", 'error');
                        console.error("Logout Fehler:", error);
                    }
                    switchView('loginView');
                    window.currentUserRole = null;
                    window.currentClientId = null; // Client-ID l√∂schen
                    showToast("Erfolgreich abgemeldet.", 'info');
                    lastCode = "";
                    document.getElementById("userDisplay").innerText = "";
                    document.getElementById("authEmail").value = "";
                    document.getElementById("authPassword").value = "";
                    document.getElementById("authError").innerText = "";
                }

                // --- SCANNER LOGIK ---

                async function activateCamera() {
                    if (html5QrCode && html5QrCode.isScanning) return;

                    document.getElementById("preScan").style.display = "none";
                    document.getElementById("scanFrame").style.display = "block";

                    if (!html5QrCode) {
                        html5QrCode = new Html5Qrcode("reader");
                    }

                    const config = {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0
                    };
                    const cameraIdOrConstraints = { facingMode: "environment" };

                    html5QrCode.start(cameraIdOrConstraints, config, onScanSuccess, onScanError)
                        .catch(err => {
                            document.getElementById("preScan").style.display = "flex";
                            document.getElementById("scanFrame").style.display = "none";
                            showToast("Kamera Fehler: Zugriff verweigert oder Ger√§t nicht gefunden.", 'error', 4000);
                            console.error("Kamera Start Fehler:", err);
                        });
                }

                function onScanSuccess(decodedText, decodedResult) {
                    if (decodedText !== lastCode) {
                        lastCode = decodedText;
                        triggerScanFeedback();
                        handleScanResult(decodedText);
                        
                        // Pause des Scanners, bis das Ergebnis verarbeitet ist
                        if (html5QrCode) {
                            html5QrCode.pause(); 
                        }
                    }
                }

                function onScanError(errorMessage) {
                    // console.warn(`Code scan error = ${errorMessage}`);
                }

                async function handleScanResult(code) {
                    let data = null;
                    let isOffline = !navigator.onLine;

                    // 1. Artikel online suchen
                    try {
                        const { data: article, error } = await window.appSupabaseClient
                            .from('artikel')
                            .select('*')
                            .eq('barcode', code)
                            .eq('client_id', window.currentClientId) // <-- NEUE FILTERUNG HINZUGEF√úGT
                            .single();
                        
                        if (error && error.message.includes('Failed to fetch')) {
                            throw new Error("Offline");
                        }
                        if (article) {
                            data = article;
                        }
                    } catch (e) {
                        if (e.message === "Offline" || !navigator.onLine) {
                            isOffline = true;
                            showToast("Netzwerkfehler. Suche lokal...", 'info');
                            // 2. Offline-Fallback (IndexedDB)
                            try {
                                const localData = await window.offlineDB.getArticleByBarcode(code);
                                // Offline: Man muss die Client-ID im Payload √ºberpr√ºfen, falls der Artikel
                                // lokal von einem anderen Mandanten zwischengespeichert wurde (weniger wahrscheinlich,
                                // aber sicherer). Da der Barcode der Key ist, muss er mit der 
                                // aktuellen Client-ID √ºbereinstimmen.
                                if (localData && localData.client_id === window.currentClientId) { 
                                    data = localData;
                                }
                            } catch (dbError) {
                                console.error("Lokaler DB Fehler:", dbError);
                            }
                        } else {
                            console.error("Fehler bei der Artikelsuche:", e);
                        }
                    }

                    if (data) {
                        // Artikel gefunden
                        let newScans = (data.scans || 0) + 1;
                        const content = `
                            <p><strong>Name:</strong> ${data.name}</p>
                            <p><strong>Barcode:</strong> ${data.barcode}</p>
                            <p><strong>Stellplatz:</strong> <span style="font-weight: 600; color: var(--color-accent-blue);">${data.stellplatz}</span></p>
                            <p><strong>Lagertyp:</strong> ${data.blocklager ? 'Blocklager' : 'Regal/Fach'}</p>
                            <p><strong>Gesamte Scans:</strong> ${newScans}</p>
                        `;

                        showResultCard("Artikel gefunden!", content, '‚úÖ');
                        
                        // Register-Button ausblenden
                        document.getElementById("registerButton").style.display = 'none';

                        // Admin-Bearbeiten-Button hinzuf√ºgen, wenn Admin
                        if (window.currentUserRole === 'admin') {
                            const resultCard = document.getElementById('result-card');
                            let adminEditButton = resultCard.querySelector('#adminEditButton');
                            
                            if (!adminEditButton) {
                                adminEditButton = document.createElement('button');
                                adminEditButton.id = 'adminEditButton';
                                adminEditButton.className = 'action-button register';
                                adminEditButton.innerText = 'Bearbeiten (Admin)';
                                
                                // F√ºge den Button zur Action-Button-Group hinzu
                                const actionGroup = resultCard.querySelector('.action-button-group');
                                actionGroup.appendChild(adminEditButton);
                            }
                            
                            // Die Funktion muss die Daten als String-Literal √ºbergeben, 
                            // daher JSON.stringify und das Ersetzen von Anf√ºhrungszeichen.
                            adminEditButton.onclick = () => showAdminEditPopup(JSON.parse(JSON.stringify(data)));
                            adminEditButton.style.display = 'flex'; // Sicherstellen, dass er sichtbar ist
                        } else {
                             // Sicherstellen, dass der Admin-Button ausgeblendet wird, wenn kein Admin
                            const adminEditButton = document.getElementById('result-card').querySelector('#adminEditButton');
                            if(adminEditButton) adminEditButton.style.display = 'none';
                        }


                        // Z√§hlung aktualisieren
                        const updatePayload = { scans: newScans };
                        try {
                            // 1. Online-Update
                            const { error } = await window.appSupabaseClient
                                .from('artikel')
                                .update(updatePayload)
                                .eq('barcode', code)
                                .eq('client_id', window.currentClientId); // <-- NEUE FILTERUNG HINZUGEF√úGT
                            
                            if (error) {
                                if (error.message.includes('Failed to fetch')) {
                                    throw new Error("Offline");
                                }
                                console.error("Fehler beim Z√§hler-Update:", error);
                                showToast(`FEHLER beim Aktualisieren des Z√§hlers.`, "error");
                            } else if (!isOffline) {
                                showToast(`Scan erfolgreich! Neues Z√§hlwerk: ${newScans}`, 'success');
                                // Lokale DB direkt aktualisieren (falls online erfolgreich)
                                await window.offlineDB.updateArticleScans(code, newScans);
                                loadArticleList(document.getElementById('articleSearchInput').value); // Liste aktualisieren
                            }

                        } catch (e) {
                            if (e.message === "Offline" || !navigator.onLine) {
                                isOffline = true;
                                showToast(`Scan lokal gespeichert. Wird bei Verbindung synchronisiert.`, 'info');
                                // Lokale Daten aktualisieren und Outbox-Eintrag erstellen
                                await window.offlineDB.updateArticleScans(code, newScans);
                                await window.offlineDB.addToOutbox({
                                    type: 'UPDATE',
                                    table: 'artikel',
                                    key: code,
                                    payload: { scans: newScans, client_id: window.currentClientId }, // <-- client_id in Payload
                                    timestamp: new Date().toISOString()
                                });
                            } else {
                                console.error("Z√§hler-Update Fehler:", e);
                            }
                        }

                    } else {
                        // Artikel nicht gefunden
                        const content = `
                            <p>Der Barcode <strong>${code}</strong> ist in der Datenbank nicht bekannt.</p>
                            <p>M√∂chten Sie den Artikel neu registrieren?</p>
                        `;
                        showResultCard("Artikel nicht gefunden", content, '‚ùå');
                        document.getElementById("registerButton").style.display = 'flex';
                        window.articleToRegister = { barcode: code };
                        
                        // Sicherstellen, dass Admin-Button ausgeblendet wird
                        const adminEditButton = document.getElementById('result-card').querySelector('#adminEditButton');
                        if(adminEditButton) adminEditButton.style.display = 'none';
                    }
                }

                function showResultCard(title, content, icon) {
                    document.getElementById('cardTitleText').innerText = title;
                    document.getElementById('cardStatusIcon').innerText = icon;
                    document.getElementById('cardContent').innerHTML = content;
                    document.getElementById('result-card').classList.add('active');
                }

                function hideResultCard() {
                    document.getElementById('result-card').classList.remove('active');
                    lastCode = ""; // Letzten Code l√∂schen
                    
                    // Admin-Edit-Button aus dem DOM entfernen/ausblenden, um sauberen Zustand zu gew√§hrleisten
                    const adminEditButton = document.getElementById('result-card').querySelector('#adminEditButton');
                    if(adminEditButton) adminEditButton.remove();

                    // Scanner fortsetzen
                    if (html5QrCode && html5QrCode.isScanning) {
                        html5QrCode.resume();
                    }
                }

                // --- REGISTRIERUNGS LOGIK ---

                function showPopup() {
                    if (!window.articleToRegister || !window.articleToRegister.barcode) {
                        showToast("Kein Barcode zum Registrieren vorhanden.", 'error');
                        return;
                    }

                    document.getElementById('popupBarcode').value = window.articleToRegister.barcode;
                    document.getElementById('popupBaseName').value = '';
                    document.getElementById('popupPlatz').value = '';
                    document.getElementById('popupSize').value = '';
                    document.getElementById('popupBlocklager').value = 'false';

                    document.getElementById('popupOverlay').style.display = 'flex';
                    setTimeout(() => document.getElementById('popupOverlay').classList.add('show'), 10);
                }

                function hidePopup() {
                    document.getElementById('popupOverlay').classList.remove('show');
                    setTimeout(() => document.getElementById('popupOverlay').style.display = 'none', 300);
                    window.articleToRegister = null;
                }

                async function saveArticle() {
                    const barcode = document.getElementById('popupBarcode').value;
                    let baseName = document.getElementById('popupBaseName').value.trim();
                    const platz = document.getElementById('popupPlatz').value.trim().toUpperCase();
                    const size = document.getElementById('popupSize').value;
                    const block = document.getElementById('popupBlocklager').value === 'true';

                    if (size) {
                        baseName = `${baseName} (${size}L)`;
                    }
                    const name = baseName;

                    if (!baseName || !platz) {
                        showToast("Bitte Basis-Name und Stellplatz ausf√ºllen.", "error");
                        return;
                    }

                    const newArticle = {
                        barcode: barcode,
                        name: name,
                        stellplatz: platz,
                        blocklager: block,
                        scans: 1,
                        created_at: new Date().toISOString(),
                        client_id: window.currentClientId // <-- NEUE CLIENT-ID HINZUGEF√úGT
                    };

                    let success = false;
                    let isOffline = !navigator.onLine;

                    try {
                        const { error } = await window.appSupabaseClient
                            .from('artikel')
                            .insert([newArticle]);

                        if (error) {
                            if (error.message.includes('Failed to fetch')) {
                                throw new Error("Offline");
                            }
                            showToast(`FEHLER beim Speichern des Artikels.`, "error");
                            console.error("Speicherfehler:", error);
                        } else {
                            success = true;
                            // Lokale DB direkt aktualisieren (falls online erfolgreich)
                            await window.offlineDB.upsertData('artikel', newArticle);
                        }

                    } catch (e) {
                        if (e.message === "Offline" || !navigator.onLine) {
                            isOffline = true;
                            // Lokale Daten aktualisieren und Outbox-Eintrag erstellen
                            await window.offlineDB.upsertData('artikel', newArticle);
                            await window.offlineDB.addToOutbox({
                                type: 'INSERT',
                                table: 'artikel',
                                key: barcode,
                                payload: newArticle, // Enth√§lt bereits client_id
                                timestamp: new Date().toISOString()
                            });
                            success = true;
                        } else {
                            console.error("Speicherfehler:", e);
                        }
                    }

                    if (success) {
                        const statusMessage = isOffline ? 
                            `Artikel lokal registriert. Wird bei Verbindung synchronisiert.` : 
                            `Artikel "${name}" wurde erfolgreich registriert.`;
                        showToast(statusMessage, isOffline ? "info" : "success");
                        logAdminAction('ARTICLE_REGISTERED', `Neuer Artikel "${name}" (Barcode: ${barcode}) registriert. Stellplatz: ${platz}`);
                        hidePopup();
                        hideResultCard();
                        loadArticleList(document.getElementById('articleSearchInput').value); // Liste aktualisieren
                    }
                }

                // --- ADMIN EDIT LOGIK ---

                function showAdminEditPopup(article) {
                    if (window.currentUserRole !== 'admin') {
                        showToast("Nur Administratoren d√ºrfen Artikel bearbeiten.", 'error');
                        return;
                    }
                    window.articleToEdit = article;
                    document.getElementById('adminEditName').value = article.name;
                    document.getElementById('adminEditBarcode').value = article.barcode;
                    document.getElementById('adminEditPlatz').value = article.stellplatz;

                    document.getElementById('adminEditPopupOverlay').style.display = 'flex';
                    setTimeout(() => document.getElementById('adminEditPopupOverlay').classList.add('show'), 10);
                }

                function hideAdminEditPopup() {
                    document.getElementById('adminEditPopupOverlay').classList.remove('show');
                    setTimeout(() => document.getElementById('adminEditPopupOverlay').style.display = 'none', 300);
                    window.articleToEdit = null;
                }

                async function saveAdminEdit() {
                    if (window.currentUserRole !== 'admin' || !window.articleToEdit) return;

                    const barcode = window.articleToEdit.barcode;
                    const oldPlatz = window.articleToEdit.stellplatz;
                    const newPlatz = document.getElementById('adminEditPlatz').value.trim().toUpperCase();

                    if (!newPlatz) {
                        showToast("Stellplatz darf nicht leer sein.", "error");
                        return;
                    }

                    if (newPlatz === oldPlatz) {
                        showToast("Keine √Ñnderung am Stellplatz vorgenommen.", "info");
                        hideAdminEditPopup();
                        return;
                    }

                    let success = false;
                    let isOffline = !navigator.onLine;
                    const updatePayload = { stellplatz: newPlatz };

                    try {
                        // 1. Online-Update
                        const { error } = await window.appSupabaseClient
                            .from('artikel')
                            .update(updatePayload)
                            .eq('barcode', barcode)
                            .eq('client_id', window.currentClientId); // <-- NEUE FILTERUNG HINZUGEF√úGT

                        if (error) {
                            if (error.message.includes('Failed to fetch')) {
                                throw new Error("Offline");
                            }
                            showToast(`FEHLER beim √Ñndern des Stellplatzes.`, "error");
                            console.error("Speicherfehler:", error);
                        } else {
                            success = true;
                            // Lokale DB direkt aktualisieren (falls online erfolgreich)
                            await window.offlineDB.updateArticleStellplatz(barcode, newPlatz);
                        }

                    } catch (e) {
                        if (e.message === "Offline" || !navigator.onLine) {
                            isOffline = true;
                            // Lokale Daten aktualisieren und Outbox-Eintrag erstellen
                            await window.offlineDB.updateArticleStellplatz(barcode, newPlatz);
                            await window.offlineDB.addToOutbox({
                                type: 'UPDATE',
                                table: 'artikel',
                                key: barcode,
                                payload: { ...updatePayload, client_id: window.currentClientId }, // <-- client_id in Payload
                                timestamp: new Date().toISOString()
                            });
                            success = true;
                        } else {
                            console.error("Speicherfehler:", e);
                        }
                    }

                    if (success) {
                        const statusMessage = isOffline ? 
                            `Stellplatz lokal ge√§ndert. √Ñnderung wird bei Verbindung synchronisiert.` : 
                            `Stellplatz von "${window.articleToEdit.name}" erfolgreich auf ${newPlatz} ge√§ndert.`;
                        showToast(statusMessage, isOffline ? "info" : "success");
                        logAdminAction('ARTICLE_MOVED', `Stellplatz f√ºr "${window.articleToEdit.name}" (Barcode: ${barcode}) von ${oldPlatz} auf ${newPlatz} ge√§ndert.`);
                        window.articleToEdit = null;
                        hideAdminEditPopup();
                        loadArticleList(document.getElementById('articleSearchInput').value); // Liste aktualisieren
                    }
                }

                function deleteArticle() {
                    if (window.currentUserRole !== 'admin' || !window.articleToEdit) return;

                    document.getElementById('adminEditPopupOverlay').classList.remove('show'); // Admin-Edit-Popup ausblenden

                    document.getElementById('deleteConfirmMessage').innerHTML = `Sind Sie sicher, dass Sie den Artikel <strong>"${window.articleToEdit.name}"</strong> mit dem Barcode <strong>${window.articleToEdit.barcode}</strong> unwiderruflich l√∂schen m√∂chten?`;
                    document.getElementById('deleteConfirmPopupOverlay').style.display = "flex";
                    setTimeout(() => document.getElementById('deleteConfirmPopupOverlay').classList.add('show'), 10);
                }

                function hideDeleteConfirmPopup() {
                    document.getElementById('deleteConfirmPopupOverlay').classList.remove('show');
                    setTimeout(() => document.getElementById('deleteConfirmPopupOverlay').style.display = "none", 300);
                }

                async function confirmDeleteArticle() {
                    if (window.currentUserRole !== 'admin' || !window.articleToEdit) return;

                    const barcode = window.articleToEdit.barcode;
                    let success = false;
                    let isOffline = !navigator.onLine;

                    try {
                        // 1. Online-Delete
                        const { error } = await window.appSupabaseClient
                            .from('artikel')
                            .delete()
                            .eq('barcode', barcode)
                            .eq('client_id', window.currentClientId); // <-- NEUE FILTERUNG HINZUGEF√úGT

                        if (error) {
                            if (error.message.includes('Failed to fetch')) {
                                throw new Error("Offline");
                            }
                            showToast(`FEHLER beim L√∂schen des Artikels.`, "error");
                            console.error("L√∂schfehler:", error);
                        } else {
                            success = true;
                            // Lokale DB direkt aktualisieren (falls online erfolgreich)
                            await window.offlineDB.deleteArticle(barcode);
                        }

                    } catch (e) {
                        if (e.message === "Offline" || !navigator.onLine) {
                            isOffline = true;
                            // Lokale Daten l√∂schen und Outbox-Eintrag erstellen
                            await window.offlineDB.deleteArticle(barcode);
                            await window.offlineDB.addToOutbox({
                                type: 'DELETE',
                                table: 'artikel',
                                key: barcode,
                                payload: { barcode: barcode, client_id: window.currentClientId }, // <-- client_id in Payload
                                timestamp: new Date().toISOString()
                            });
                            success = true;
                        } else {
                            console.error("L√∂schfehler:", e);
                        }
                    }

                    if (success) {
                        const statusMessage = isOffline ? 
                            `Artikel lokal gel√∂scht. L√∂schung wird bei Verbindung synchronisiert.` : 
                            `Artikel "${window.articleToEdit.name}" erfolgreich gel√∂scht.`;
                        showToast(statusMessage, isOffline ? "info" : "success");
                        logAdminAction('ARTICLE_DELETED', `Artikel "${window.articleToEdit.name}" (Barcode: ${barcode}) unwiderruflich gel√∂scht.`);
                        window.articleToEdit = null;
                        hideDeleteConfirmPopup();
                        loadArticleList(document.getElementById('articleSearchInput').value); // Liste aktualisieren
                    }
                }

                // --- TAB & NAVIGATION LOGIK ---

                function changeTab(tabId) {
                    if (tabId === window.currentTabId) return;

                    // Scanner Logik
                    if (tabId !== 'scannerTab' && html5QrCode && html5QrCode.isScanning) {
                        html5QrCode.pause(); // Scanner anhalten beim Wechsel
                    } else if (tabId === 'scannerTab' && html5QrCode && html5QrCode.isScanning) {
                        html5QrCode.resume();
                    }

                    window.currentTabId = tabId;

                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');

                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    document.getElementById(`nav${tabId.charAt(0).toUpperCase() + tabId.slice(1).replace('Tab', '')}`).classList.add('active');

                    // Lade Listen neu beim Wechsel
                    if (tabId === 'listTab') {
                        loadArticleList(document.getElementById('articleSearchInput').value);
                    } else if (tabId === 'logTab') {
                        loadAdminLog(document.getElementById('logSearchInput').value);
                    } else if (tabId === 'usersTab') {
                        loadUserList(document.getElementById('userSearchInput').value);
                    }
                }


                /* --- ARTIKEL LISTE LOGIK --- */

                async function loadArticleList(searchTerm = '') {
                    const articleListContainer = document.getElementById('articleList');
                    let data = [];
                    let isOffline = false;

                    // Spinner anzeigen
                    articleListContainer.innerHTML = '<li style="text-align: center; border: none; background: transparent; padding: 20px;">Lade Artikel...</li>';

                    try {
                        // 1. Online-Versuch
                        let query = window.appSupabaseClient
                            .from('artikel')
                            .select('*')
                            .eq('client_id', window.currentClientId); // <-- NEUE FILTERUNG HINZUGEF√úGT
                        
                        if (searchTerm) {
                            const search = `%${searchTerm.toLowerCase()}%`;
                            query = query.or(`name.ilike.${search},barcode.ilike.${search},stellplatz.ilike.${search}`);
                        }

                        const { data: articles, error } = await query.order('name', { ascending: true });

                        if (error) {
                            if (error.message.includes('Failed to fetch')) {
                                throw new Error("Offline");
                            }
                            throw error;
                        }

                        data = articles;

                        // Bei Erfolg: Lokalen Cache aktualisieren
                        if (data.length > 0) {
                            // L√∂schen Sie nur Artikel mit der aktuellen client_id, falls m√∂glich,
                            // aber da IndexedDB keine RLS-Filterung kennt, leeren wir und f√ºgen alle
                            // von Supabase gefilterten Daten hinzu.
                            await window.offlineDB.clearData('artikel');
                            await window.offlineDB.bulkInsertData('artikel', data);
                        } else {
                            await window.offlineDB.clearData('artikel');
                        }

                    } catch (error) {
                        isOffline = true;
                        showToast("Netzwerkfehler. Zeige lokale Artikel...", 'info');

                        // 2. Offline-Fallback (IndexedDB)
                        try {
                            const localData = await window.offlineDB.getAllArticles();
                            data = localData.filter(item => {
                                // Zus√§tzliche Filterung nach client_id im Offline-Modus (Sicherheitsma√ünahme)
                                const matchesClient = item.client_id === window.currentClientId;
                                
                                if (!searchTerm) return matchesClient;
                                
                                const search = searchTerm.toLowerCase();
                                const matchesSearch = (item.name && item.name.toLowerCase().includes(search)) ||
                                                      (item.barcode && item.barcode.toLowerCase().includes(search)) ||
                                                      (item.stellplatz && item.stellplatz.toLowerCase().includes(search));
                                                      
                                return matchesClient && matchesSearch;
                            });
                            
                        } catch (e) {
                            console.error("Lokaler DB Fehler beim Laden der Artikel:", e);
                        }
                    }

                    articleListContainer.innerHTML = ''; // Liste leeren

                    if (data.length === 0) {
                        articleListContainer.innerHTML = `<li style="border-left: 5px solid rgba(255, 255, 255, 0.2); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">${searchTerm ? 'Keine Artikel gefunden, die der Suche entsprechen.' : 'Keine Artikel im Inventar.'}</li>`;
                        return;
                    }

                    data.forEach(article => {
                        const listItem = document.createElement('li');
                        
                        if (window.currentUserRole === 'admin') {
                            listItem.onclick = () => showAdminEditPopup(article);
                            listItem.style.cursor = 'pointer';
                            listItem.setAttribute('data-role', 'admin-editable');
                        }

                        const details = `
                            <div class="item-details" style="flex-grow: 1;">
                                <strong>${article.name}</strong>
                                <span>Platz: ${article.stellplatz} | Barcode: ${article.barcode}</span>
                            </div>
                            <div class="item-count">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                                <span>${article.scans || 0}</span>
                                <span class="item-label">Scans</span>
                            </div>
                        `;
                        listItem.innerHTML = details;
                        articleListContainer.appendChild(listItem);
                    });
                    
                    if (isOffline) {
                        articleListContainer.innerHTML += '<li style="margin-top: 15px; text-align: center; color: var(--color-warning-yellow); border: none; background: transparent; padding: 5px;">Offline-Modus aktiv.</li>';
                    }
                }
                
                
                /* --- ADMIN LOGGING FUNKTION --- */

                async function logAdminAction(actionType, description) {
                    if (window.currentUserRole !== 'admin') {
                        console.warn("Versuch, eine Admin-Aktion ohne Admin-Rechte zu protokollieren.");
                        return;
                    }

                    const logEntry = {
                        action_type: actionType,
                        description: description,
                        user_role: window.currentUserRole,
                        created_at: new Date().toISOString(),
                        client_id: window.currentClientId // <-- NEUE CLIENT-ID HINZUGEF√úGT
                    };

                    let isOffline = !navigator.onLine;

                    try {
                        const { error } = await window.appSupabaseClient
                            .from('audit_log')
                            .insert([logEntry]);

                        if (error) {
                            if (error.message.includes('Failed to fetch')) { // Supabase Netzwerkfehler
                                throw new Error("Offline");
                            }
                            throw error;
                        }

                        // Online: Lokalen Cache aktualisieren
                        // FIX: Entferne den dritten Parameter 'created_at', um den DataError zu vermeiden.
                        // Der Store audit_log hat 'keyPath: created_at' und ben√∂tigt keinen separaten Schl√ºssel.
                        await window.offlineDB.upsertData('audit_log', logEntry); 

                    } catch (e) {
                        if (e.message === "Offline" || !navigator.onLine) {
                            isOffline = true;
                            // Outbox-Eintrag erstellen
                            await window.offlineDB.addToOutbox({
                                type: 'INSERT',
                                table: 'audit_log',
                                key: logEntry.created_at, // Zeitstempel als Schl√ºssel
                                payload: logEntry, // Enth√§lt bereits client_id
                                timestamp: new Date().toISOString()
                            });
                        } else {
                            console.error("Log-Fehler:", e);
                        }
                    }
                }

                async function loadAdminLog(searchTerm = '') {
                    if (window.currentUserRole !== 'admin') {
                        document.getElementById('logList').innerHTML = '<li style="text-align: center; color: var(--color-error-red); border: none; background: transparent; padding: 20px;">Keine Berechtigung.</li>';
                        return;
                    }

                    const logListContainer = document.getElementById('logList');
                    let logData = [];
                    let isOffline = false;

                    // Spinner anzeigen
                    logListContainer.innerHTML = '<li style="text-align: center; border: none; background: transparent; padding: 20px;">Lade Logbuch...</li>';

                    try {
                        // 1. Online-Versuch
                        let query = window.appSupabaseClient
                            .from('audit_log')
                            .select('*')
                            .eq('client_id', window.currentClientId); // <-- NEUE FILTERUNG HINZUGEF√úGT

                        if (searchTerm) {
                            const search = `%${searchTerm.toLowerCase()}%`;
                            query = query.or(`action_type.ilike.${search},description.ilike.${search}`);
                        }

                        const { data: logs, error } = await query.order('created_at', { ascending: false });

                        if (error) {
                            if (error.message.includes('Failed to fetch')) {
                                throw new Error("Offline");
                            }
                            throw error;
                        }

                        logData = logs;

                        // Bei Erfolg: Lokalen Cache aktualisieren
                        await window.offlineDB.clearData('audit_log');
                        await window.offlineDB.bulkInsertData('audit_log', logData);

                    } catch (error) {
                        isOffline = true;
                        showToast("Netzwerkfehler. Zeige lokales Logbuch...", 'info');

                        // 2. Offline-Fallback (IndexedDB)
                        try {
                            const localData = await window.offlineDB.getAllLogs();
                            logData = localData.filter(item => {
                                // Zus√§tzliche Filterung nach client_id im Offline-Modus (Sicherheitsma√ünahme)
                                const matchesClient = item.client_id === window.currentClientId;
                                
                                if (!searchTerm) return matchesClient;
                                
                                const search = searchTerm.toLowerCase();
                                const matchesSearch = (item.action_type && item.action_type.toLowerCase().includes(search)) ||
                                                      (item.description && item.description.toLowerCase().includes(search));
                                                      
                                return matchesClient && matchesSearch;
                            });
                        } catch (e) {
                            console.error("Lokaler DB Fehler beim Laden des Logs:", e);
                        }
                    }

                    logListContainer.innerHTML = ''; // Liste leeren

                    if (logData.length === 0) {
                        logListContainer.innerHTML = `<li style="border-left: 5px solid rgba(255, 255, 255, 0.2); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">${searchTerm ? 'Keine Logbuch-Eintr√§ge gefunden, die der Suche entsprechen.' : 'Keine Logbuch-Eintr√§ge vorhanden.'}</li>`;
                        return;
                    }

                    logData.forEach(item => {
                        const dateSource = item.created_at;
                        const timestamp = new Date(dateSource).toLocaleString('de-DE', { dateStyle: 'short', timeStyle: 'medium' });
                        
                        let color = 'var(--color-accent-blue)';
                        if (item.action_type.includes('DELETE')) {
                            color = 'var(--color-error-red)';
                        } else if (item.action_type.includes('REGISTERED') || item.action_type.includes('IMPORTED')) {
                            color = 'var(--color-accent-green)';
                        } else if (item.action_type.includes('USER') || item.action_type.includes('ADMIN')) {
                            color = 'var(--color-warning-yellow)';
                        }

                        const listItem = document.createElement('li');
                        listItem.style.borderLeftColor = color;
                        
                        const details = `
                            <div class="item-details" style="flex-grow: 1;">
                                <strong>[${item.action_type}]</strong>
                                <span>${item.description}</span>
                            </div>
                            <div style="font-size: 0.75rem; opacity: 0.8; text-align: right; margin-left: 10px; flex-shrink: 0;">
                                ${timestamp}
                            </div>
                        `;
                        listItem.innerHTML = details;
                        logListContainer.appendChild(listItem);
                    });
                    
                    if (isOffline) {
                        logListContainer.innerHTML += '<li style="margin-top: 15px; text-align: center; color: var(--color-warning-yellow); border: none; background: transparent; padding: 5px;">Offline-Modus aktiv.</li>';
                    }
                }


                /* --- BENUTZERLISTE LOGIK (ADMIN) --- */

                async function loadUserList(searchTerm = '') {
                    if (window.currentUserRole !== 'admin') {
                        document.getElementById('userList').innerHTML = '<li style="text-align: center; color: var(--color-error-red); border: none; background: transparent; padding: 20px;">Keine Berechtigung.</li>';
                        return;
                    }
                    
                    const userListContainer = document.getElementById('userList');
                    let users = [];
                    let isOffline = false;

                    userListContainer.innerHTML = '<li style="text-align: center; border: none; background: transparent; padding: 20px;">Lade Benutzer...</li>';

                    try {
                        // 1. Online-Versuch
                        let query = window.appSupabaseClient
                            .from('user_roles')
                            .select('*'); 

                        if (searchTerm) {
                            const search = `%${searchTerm.toLowerCase()}%`;
                            query = query.or(`email.ilike.${search},role.ilike.${search},notes.ilike.${search}`);
                        }

                        const { data: userData, error } = await query.order('email', { ascending: true });

                        if (error) {
                            if (error.message.includes('Failed to fetch')) {
                                throw new Error("Offline");
                            }
                            throw error;
                        }

                        users = userData;
                        
                        // Bei Erfolg: Lokalen Cache aktualisieren
                        await window.offlineDB.clearData('user_roles');
                        await window.offlineDB.bulkInsertData('user_roles', users);

                    } catch (error) {
                        isOffline = true;
                        showToast("Netzwerkfehler. Zeige lokale Benutzer...", 'info');

                        // 2. Offline-Fallback (IndexedDB)
                        try {
                            const localData = await window.offlineDB.getAllUsers();
                            users = localData.filter(item => {
                                // Im Offline-Modus zeigen wir alle lokal gespeicherten Benutzer an,
                                // da die RLS-Policy im Online-Modus die Filterung durchf√ºhrt.
                                if (!searchTerm) return true;
                                
                                const search = searchTerm.toLowerCase();
                                const matchesSearch = (item.email && item.email.toLowerCase().includes(search)) ||
                                                      (item.role && item.role.toLowerCase().includes(search)) ||
                                                      (item.notes && item.notes.toLowerCase().includes(search));
                                                      
                                return matchesSearch;
                            });
                            
                        } catch (e) {
                            console.error("Lokaler DB Fehler beim Laden der Benutzer:", e);
                        }
                    }

                    userListContainer.innerHTML = '';

                    if (users.length === 0) {
                        userListContainer.innerHTML = `<li style="border-left: 5px solid rgba(255, 255, 255, 0.2); padding: 15px; background: var(--color-bg-card); border-radius: 10px;">${searchTerm ? 'Keine Benutzer gefunden, die der Suche entsprechen.' : 'Keine Benutzerkonten vorhanden.'}</li>`;
                        return;
                    }

                    users.forEach(user => {
                        const listItem = document.createElement('li');
                        listItem.onclick = () => showUserEditPopup(user);
                        listItem.style.cursor = 'pointer';
                        listItem.setAttribute('data-role', 'admin-editable');

                        if (user.role === 'admin') {
                            listItem.classList.add('user-role-admin');
                        }
                        if (user.is_blocked) {
                            listItem.classList.add('user-is-blocked');
                        }
                        
                        const status = user.is_blocked ? 'Gesperrt' : 'Aktiv';
                        
                        const details = `
                            <div class="item-details">
                                <strong>${user.email}</strong>
                                <span>Rolle: ${user.role} | Status: ${status}</span>
                            </div>
                            <button class="user-edit-button">Edit</button>
                        `;
                        listItem.innerHTML = details;
                        userListContainer.appendChild(listItem);
                    });
                    
                    if (isOffline) {
                        userListContainer.innerHTML += '<li style="margin-top: 15px; text-align: center; color: var(--color-warning-yellow); border: none; background: transparent; padding: 5px;">Offline-Modus aktiv.</li>';
                    }
                }

                function showUserEditPopup(user) {
                    if (window.currentUserRole !== 'admin') {
                        showToast("Nur Administratoren d√ºrfen Benutzer bearbeiten.", 'error');
                        return;
                    }
                    window.userToEdit = user;
                    document.getElementById('userEditEmail').value = user.email;
                    document.getElementById('userEditRole').value = user.role || 'user';
                    document.getElementById('userEditBlocked').value = user.is_blocked ? 'true' : 'false';
                    document.getElementById('userEditNotes').value = user.notes || '';
                    
                    document.getElementById('userEditPopupOverlay').style.display = 'flex';
                    setTimeout(() => document.getElementById('userEditPopupOverlay').classList.add('show'), 10);
                }
                
                function hideUserEditPopup() {
                    document.getElementById('userEditPopupOverlay').classList.remove('show');
                    setTimeout(() => document.getElementById('userEditPopupOverlay').style.display = 'none', 300);
                    window.userToEdit = null;
                }
                
                async function saveUserEdit() {
                    if (window.currentUserRole !== 'admin' || !window.userToEdit) return;

                    const userId = window.userToEdit.id;
                    const email = window.userToEdit.email;
                    const oldRole = window.userToEdit.role;
                    const oldBlockedStatus = window.userToEdit.is_blocked;
                    
                    const newRole = document.getElementById('userEditRole').value;
                    const newBlockedStatus = document.getElementById('userEditBlocked').value === 'true';
                    const newNotes = document.getElementById('userEditNotes').value.trim();

                    if (newRole === oldRole && newBlockedStatus === oldBlockedStatus && newNotes === (window.userToEdit.notes || '')) {
                        showToast("Keine √Ñnderungen an Benutzerdaten vorgenommen.", "info");
                        hideUserEditPopup();
                        return;
                    }
                    
                    let success = false;
                    let isOffline = !navigator.onLine;
                    const updatePayload = { 
                        role: newRole, 
                        is_blocked: newBlockedStatus, 
                        notes: newNotes,
                        // client_id muss in Payload f√ºr RLS-Policy enthalten sein, falls es sich 
                        // um eine Zuweisung zu einem Client handelt (was in diesem Formular nicht passiert,
                        // aber f√ºr die Konsistenz der Update-Payload wichtig ist, wenn RLS aktiv ist).
                        client_id: window.userToEdit.client_id // Bestehende Client-ID beibehalten
                    };

                    try {
                        // 1. Online-Update
                        const { error } = await window.appSupabaseClient
                            .from('user_roles')
                            .update(updatePayload)
                            .eq('id', userId);

                        if (error) {
                            if (error.message.includes('Failed to fetch')) {
                                throw new Error("Offline");
                            }
                            showToast(`FEHLER beim Speichern der Benutzerdaten.`, "error");
                            console.error("Speicherfehler Benutzer:", error);
                        } else {
                            success = true;
                            // Lokale DB direkt aktualisieren (falls online erfolgreich)
                            await window.offlineDB.upsertData('user_roles', { id: userId, email: email, ...updatePayload });
                        }

                    } catch (e) {
                        if (e.message === "Offline" || !navigator.onLine) {
                            isOffline = true;
                            // Lokale Daten aktualisieren und Outbox-Eintrag erstellen
                            await window.offlineDB.upsertData('user_roles', { id: userId, email: email, ...updatePayload });
                            await window.offlineDB.addToOutbox({
                                type: 'UPDATE',
                                table: 'user_roles',
                                key: userId,
                                payload: { id: userId, email: email, ...updatePayload }, // <-- Ganzer Payload
                                timestamp: new Date().toISOString()
                            });
                            success = true;
                        } else {
                            console.error("Speicherfehler Benutzer:", e);
                        }
                    }

                    if (success) {
                        let logMessage = `Benutzer ${email} aktualisiert.`;
                        if (newRole !== oldRole) logMessage += ` Rolle: ${oldRole} -> ${newRole}.`;
                        if (newBlockedStatus !== oldBlockedStatus) logMessage += ` Status: ${oldBlockedStatus ? 'Gesperrt' : 'Aktiv'} -> ${newBlockedStatus ? 'Gesperrt' : 'Aktiv'}.`;

                        showToast("Benutzerdaten erfolgreich gespeichert.", isOffline ? "info" : "success");
                        logAdminAction('USER_EDITED', logMessage.trim());
                        window.userToEdit = null;
                        hideUserEditPopup();
                        loadUserList(document.getElementById('userSearchInput').value); // Liste aktualisieren
                    }
                }

                /* --- DATEN IMPORT/EXPORT LOGIK (ADMIN) --- */

                // Helferfunktion zum Konvertieren von JSON in CSV
                function convertToCSV(data) {
                    if (data.length === 0) return '';
                    
                    const keys = Object.keys(data[0]).filter(key => key !== 'created_at'); // created_at weglassen
                    const header = keys.join(',');
                    
                    const rows = data.map(obj => 
                        keys.map(key => {
                            let value = obj[key] === null || obj[key] === undefined ? '' : obj[key].toString();
                            // Werte escapen, falls sie Kommas oder Anf√ºhrungszeichen enthalten
                            if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                                value = `"${value.replace(/"/g, '""')}"`;
                            }
                            return value;
                        }).join(',')
                    );
                    
                    return `${header}\n${rows.join('\n')}`;
                }

                async function exportData(format) {
                    if (window.currentUserRole !== 'admin') {
                        showToast("Nur Administratoren d√ºrfen Daten exportieren.", 'error');
                        return;
                    }
                    
                    showToast(`Starte Datenexport im ${format.toUpperCase()}-Format...`, 'info');

                    try {
                        const { data: articles, error } = await window.appSupabaseClient
                            .from('artikel')
                            .select('*')
                            .eq('client_id', window.currentClientId);
                            
                        if (error) throw error;

                        let content;
                        let mimeType;
                        let filename = `inventar_export_${new Date().toISOString().slice(0, 10)}`;

                        if (format === 'json') {
                            content = JSON.stringify(articles, null, 2);
                            mimeType = 'application/json';
                            filename += '.json';
                        } else if (format === 'csv') {
                            content = convertToCSV(articles);
                            mimeType = 'text/csv';
                            filename += '.csv';
                        } else {
                            throw new Error("Ung√ºltiges Exportformat.");
                        }

                        // Download starten
                        const blob = new Blob([content], { type: mimeType });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        showToast(`Export von ${articles.length} Artikeln erfolgreich!`, 'success');
                        logAdminAction('DATA_EXPORTED', `${articles.length} Artikel im ${format.toUpperCase()}-Format exportiert.`);

                    } catch (e) {
                        showToast("FEHLER beim Export. √úberpr√ºfen Sie die Verbindung und Berechtigungen.", 'error', 7000);
                        console.error("Export Fehler:", e);
                    }
                }

                async function importData() {
                    if (window.currentUserRole !== 'admin') {
                        showToast("Nur Administratoren d√ºrfen Daten importieren.", 'error');
                        return;
                    }

                    const fileInput = document.getElementById('importFile');
                    const file = fileInput.files[0];
                    if (!file) {
                        showToast("Bitte w√§hlen Sie eine Datei aus.", 'error');
                        return;
                    }

                    const filename = file.name;
                    const reader = new FileReader();

                    reader.onload = async (event) => {
                        try {
                            const content = event.target.result;
                            let articles;

                            if (filename.endsWith('.json')) {
                                articles = JSON.parse(content);
                                if (!Array.isArray(articles)) throw new Error("Ung√ºltiges JSON-Format. Erwarte Array.");
                            } else if (filename.endsWith('.csv')) {
                                articles = parseCSV(content);
                            } else {
                                throw new Error("Ung√ºltiges Dateiformat. Erwarte CSV oder JSON.");
                            }
                            
                            await processImportData(articles, filename);

                        } catch (e) {
                            showToast(`FEHLER beim Import: ${e.message}`, 'error', 10000);
                            console.error("Import Fehler:", e);
                        } finally {
                            fileInput.value = ''; // Input zur√ºcksetzen
                        }
                    };

                    reader.onerror = () => {
                        showToast("Fehler beim Lesen der Datei.", 'error');
                        fileInput.value = '';
                    };

                    reader.readAsText(file);
                }

                function parseCSV(csvText) {
                    const lines = csvText.trim().split('\n');
                    if (lines.length === 0) return [];
                    
                    // Header (Schl√ºssel)
                    const header = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, '').toLowerCase()); 
                    
                    const articles = [];
                    for (let i = 1; i < lines.length; i++) {
                        const currentLine = lines[i].trim();
                        if (!currentLine) continue;
                        
                        // Einfache Split-Logik f√ºr nicht-komplexe CSVs. 
                        // F√ºr robuste Implementierungen w√§re eine spezialisierte CSV-Bibliothek n√∂tig.
                        const values = currentLine.split(','); 
                        
                        const article = {};
                        header.forEach((key, index) => {
                            let value = values[index] ? values[index].trim().replace(/^"|"$/g, '').replace(/""/g, '"') : '';
                            article[key] = value;
                        });
                        articles.push(article);
                    }
                    return articles;
                }

                async function processImportData(articles, filename) {
                    const validFields = ['barcode', 'name', 'stellplatz', 'blocklager', 'scans', 'client_id'];

                    const upsertData = articles.map(article => {
                        const item = {};
                        // Nur erlaubte Felder √ºbernehmen
                        validFields.forEach(field => {
                            if (article.hasOwnProperty(field)) {
                                item[field] = article[field];
                            }
                        });
                        
                        // Sicherstellen, dass Pflichtfelder vorhanden und Typen korrekt sind
                        if (typeof item.blocklager !== 'boolean') item.blocklager = item.blocklager === true || item.blocklager === 'true'; // JSON kann boolsche Werte haben
                        if (typeof item.scans !== 'number') item.scans = parseInt(item.scans) || 0;
                        
                        item.client_id = window.currentClientId; // NEU: client_id hinzuf√ºgen
                        
                        return item;
                    }).filter(item => item.barcode && item.name && item.stellplatz); // Nur Artikel mit allen Pflichtfeldern importieren

                    if (upsertData.length === 0) {
                        showToast("Keine Artikel mit g√ºltigem Barcode, Name und Stellplatz zum Importieren gefunden.", 'error', 7000);
                        return;
                    }

                    showToast(`Starte Import von ${upsertData.length} g√ºltigen Artikeln...`, 'info', 10000);

                    // Supabase upsert (batch insert/update)
                    // Wichtig: 'onConflict: 'barcode'' f√ºr UPSERT
                    const { error } = await window.appSupabaseClient
                        .from('artikel')
                        .upsert(upsertData, { onConflict: 'barcode' });

                    if (error) {
                        showToast("FEHLER beim Import. √úberpr√ºfen Sie die Daten und RLS-Policies.", 'error', 10000);
                        console.error("Import Fehler:", error);
                    } else {
                        logAdminAction('DATA_IMPORTED', `${upsertData.length} Artikel erfolgreich aus Datei ${filename} importiert/aktualisiert.`);
                        showToast(`Import von ${upsertData.length} Artikeln erfolgreich abgeschlossen!`, 'success');
                        loadArticleList(document.getElementById('articleSearchInput').value); // Liste aktualisieren
                    }
                }


                /* --- TOAST & NAVIGATION LOGIK --- */

                function showToast(message, type = 'info', duration = 3000) {
                    const container = document.getElementById('toastContainer');
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    
                    let icon = '‚ÑπÔ∏è';
                    if (type === 'success') icon = '‚úÖ';
                    else if (type === 'error') icon = '‚ùå';

                    toast.innerHTML = `<span class="toast-icon">${icon}</span> ${message}`;
                    
                    container.appendChild(toast);
                    
                    // Zeigen
                    setTimeout(() => {
                        toast.classList.add('show');
                    }, 10);

                    // Ausblenden
                    setTimeout(() => {
                        toast.classList.remove('show');
                        // Entfernen nach der Transition
                        setTimeout(() => {
                            container.removeChild(toast);
                        }, 300);
                    }, duration);
                }


                /* --- INDEXEDDB OFFLINE LOGIK --- */

                class OfflineDB {
                    constructor(dbName, dbVersion) {
                        this.dbName = dbName;
                        this.dbVersion = dbVersion;
                        this.db = null;
                    }

                    async open() {
                        return new Promise((resolve, reject) => {
                            if (this.db) {
                                resolve();
                                return;
                            }

                            const request = indexedDB.open(this.dbName, this.dbVersion);

                            request.onupgradeneeded = (event) => {
                                const db = event.target.result;
                                
                                // Artikel-Speicher (Schl√ºssel: barcode)
                                if (!db.objectStoreNames.contains('artikel')) {
                                    db.createObjectStore('artikel', { keyPath: 'barcode' });
                                }

                                // Benutzerrollen-Speicher (Schl√ºssel: id/uuid)
                                if (!db.objectStoreNames.contains('user_roles')) {
                                    db.createObjectStore('user_roles', { keyPath: 'id' });
                                }
                                
                                // Logbuch-Speicher (Schl√ºssel: created_at)
                                if (!db.objectStoreNames.contains('audit_log')) {
                                    db.createObjectStore('audit_log', { keyPath: 'created_at' });
                                }

                                // Outbox f√ºr Offline-√Ñnderungen (Schl√ºssel: Inkrementeller Index)
                                if (!db.objectStoreNames.contains('outbox')) {
                                    const outboxStore = db.createObjectStore('outbox', { keyPath: 'id', autoIncrement: true });
                                    outboxStore.createIndex('timestamp', 'timestamp', { unique: false });
                                }
                            };

                            request.onsuccess = (event) => {
                                this.db = event.target.result;
                                resolve();
                            };

                            request.onerror = (event) => {
                                console.error("IndexedDB Fehler:", event.target.error);
                                reject(event.target.error);
                            };
                        });
                    }

                    // Generische CRUD Helfer
                    async upsertData(storeName, data) {
                        await this.open();
                        return new Promise((resolve, reject) => {
                            const transaction = this.db.transaction(storeName, 'readwrite');
                            const store = transaction.objectStore(storeName);
                            let request;

                            // Korrektur des DataError: Wenn der Store einen 'keyPath' verwendet (wie 'artikel', 'audit_log'),
                            // darf KEIN separater Key im 'put'-Aufruf √ºbergeben werden.
                            // store.put(data) ist f√ºr alle unsere Stores (mit keyPath oder autoIncrement) korrekt.
                            request = store.put(data); 

                            request.onsuccess = () => resolve(request.result);
                            request.onerror = (event) => reject(event.target.error);
                        });
                    }

                    async getData(storeName, key) {
                        await this.open();
                        return new Promise((resolve, reject) => {
                            const transaction = this.db.transaction(storeName, 'readonly');
                            const store = transaction.objectStore(storeName);
                            const request = store.get(key);
                            request.onsuccess = () => resolve(request.result);
                            request.onerror = (event) => reject(event.target.error);
                        });
                    }

                    async getAllData(storeName) {
                        await this.open();
                        return new Promise((resolve, reject) => {
                            const transaction = this.db.transaction(storeName, 'readonly');
                            const store = transaction.objectStore(storeName);
                            const request = store.getAll();
                            request.onsuccess = () => resolve(request.result);
                            request.onerror = (event) => reject(event.target.error);
                        });
                    }
                    
                    async deleteData(storeName, key) {
                        await this.open();
                        return new Promise((resolve, reject) => {
                            const transaction = this.db.transaction(storeName, 'readwrite');
                            const store = transaction.objectStore(storeName);
                            const request = store.delete(key);
                            request.onsuccess = () => resolve();
                            request.onerror = (event) => reject(event.target.error);
                        });
                    }

                    async clearData(storeName) {
                        await this.open();
                        return new Promise((resolve, reject) => {
                            const transaction = this.db.transaction(storeName, 'readwrite');
                            const store = transaction.objectStore(storeName);
                            const request = store.clear();
                            request.onsuccess = () => resolve();
                            request.onerror = (event) => reject(event.target.error);
                        });
                    }

                    async bulkInsertData(storeName, dataArray) {
                        await this.open();
                        return new Promise((resolve, reject) => {
                            const transaction = this.db.transaction(storeName, 'readwrite');
                            const store = transaction.objectStore(storeName);
                            
                            for (const data of dataArray) {
                                // Verwenden Sie 'put' f√ºr Upsert, um bei vorhandenen Keys zu aktualisieren (z.B. bei Artikel oder Userrollen).
                                // Bei 'audit_log' mit 'created_at' als KeyPath ist dies ebenfalls korrekt.
                                store.put(data); 
                            }

                            transaction.oncomplete = () => resolve();
                            transaction.onerror = (event) => reject(event.target.error);
                        });
                    }

                    // Artikel Helfer
                    async getArticleByBarcode(barcode) {
                        return this.getData('artikel', barcode);
                    }

                    async getAllArticles() {
                        return this.getAllData('artikel');
                    }

                    async deleteArticle(barcode) {
                        return this.deleteData('artikel', barcode);
                    }

                    async updateArticleScans(barcode, newScans) {
                        const article = await this.getArticleByBarcode(barcode);
                        if (article) {
                            article.scans = newScans;
                            await this.upsertData('artikel', article);
                        }
                    }

                    async updateArticleStellplatz(barcode, newPlatz) {
                        const article = await this.getArticleByBarcode(barcode);
                        if (article) {
                            article.stellplatz = newPlatz;
                            await this.upsertData('artikel', article);
                        }
                    }
                    
                    // Log Helfer
                    async getAllLogs() {
                        // Logs sind chronologisch sortiert, daher nur getAll
                        return this.getAllData('audit_log');
                    }

                    // User Helfer
                    async getAllUsers() {
                        return this.getAllData('user_roles');
                    }
                    
                    // Outbox Helfer
                    async addToOutbox(operation) {
                        // Outbox ist autoIncrement, upsertData f√ºhrt hier einen Insert durch, wenn keine ID im Payload
                        return this.upsertData('outbox', operation);
                    }

                    async getOutboxOperations() {
                        await this.open();
                        return new Promise((resolve, reject) => {
                            const transaction = this.db.transaction('outbox', 'readonly');
                            const store = transaction.objectStore('outbox');
                            const index = store.index('timestamp'); // Index nach Zeitstempel
                            const request = index.getAll();
                            request.onsuccess = () => resolve(request.result);
                            request.onerror = (event) => reject(event.target.error);
                        });
                    }
                }

                async function initOfflineSync() {
                    // Wird in checkLogin initialisiert
                    if (!window.offlineDB) {
                        window.offlineDB = new OfflineDB('inventarDB', 1);
                        await window.offlineDB.open();
                    }

                    // F√ºhre Sync alle 30 Sekunden durch, wenn online und nicht bereits gesynct wird
                    setInterval(() => {
                        if (navigator.onLine && !window.isSyncing) {
                            syncData();
                        }
                    }, 30000); 

                    // F√ºhre Sync bei Wiederherstellung der Verbindung durch
                    window.addEventListener('online', syncData);
                }

                async function syncData(isInitialSync = false) {
                    if (window.isSyncing) return;
                    if (!navigator.onLine) return;

                    // Nur synchronisieren, wenn ein Benutzer eingeloggt ist (Client-ID ist gesetzt)
                    if (!window.currentClientId) { 
                        // Ausnahme: Admin-Aktionen (USER_EDITED, etc.) haben keine Client-ID, 
                        // aber user_roles und audit_log d√ºrfen trotzdem synchronisiert werden.
                        // Wir synchronisieren nur, wenn wir sicher sind, dass wir eine Rolle haben.
                        if (!window.currentUserRole) return;
                    }


                    window.isSyncing = true;
                    if (!isInitialSync) {
                        showToast("Starte Datensynchronisation...", 'info', 2000);
                    }

                    try {
                        const operations = await window.offlineDB.getOutboxOperations();
                        
                        if (operations.length === 0) {
                            if (!isInitialSync) {
                                showToast("Synchronisation abgeschlossen. Keine ausstehenden √Ñnderungen.", 'success', 2000);
                            }
                            return;
                        }
                        
                        let successfulOperations = 0;

                        for (const op of operations) {
                            // Wenn der Eintrag eine client_id im Payload hat (artikel, audit_log), muss sie mit der 
                            // aktuellen Client-ID √ºbereinstimmen. Nur 'user_roles' kann null sein (Admin).
                            if (op.payload.client_id !== window.currentClientId && op.table !== 'user_roles') {
                                console.warn(`√úberspringe Outbox-Aktion f√ºr falschen Mandanten (${op.payload.client_id} != ${window.currentClientId}).`);
                                await window.offlineDB.deleteData('outbox', op.id);
                                continue;
                            }
                            
                            try {
                                const { type, table, key, payload } = op;
                                let error;

                                // 1. Supabase Operation durchf√ºhren
                                switch (type) {
                                    case 'INSERT':
                                        ({ error } = await window.appSupabaseClient.from(table).insert([payload]));
                                        break;
                                    case 'UPDATE':
                                        ({ error } = await window.appSupabaseClient.from(table).update(payload).eq(table === 'user_roles' ? 'id' : 'barcode', key).eq('client_id', payload.client_id));
                                        break;
                                    case 'DELETE':
                                        ({ error } = await window.appSupabaseClient.from(table).delete().eq(table === 'user_roles' ? 'id' : 'barcode', key).eq('client_id', payload.client_id));
                                        break;
                                    default:
                                        console.warn(`Unbekannter Outbox-Typ: ${type}`);
                                        await window.offlineDB.deleteData('outbox', op.id);
                                        continue;
                                }

                                if (error) {
                                    if (error.code === '23505') { // Duplikat Key Error (oft bei re-INSERT)
                                        console.warn(`Duplikat Key Fehler f√ºr ${type} ${table}. Wahrscheinlich bereits online. Wird gel√∂scht.`);
                                    } else {
                                        // Bei echtem Fehler den Eintrag NICHT l√∂schen und den Sync abbrechen (falls Netzwerk)
                                        if (error.message.includes("Failed to fetch")) {
                                            throw new Error("Netzwerkfehler");
                                        }
                                        console.error(`Outbox DB Fehler f√ºr ${type} ${table}:`, error);
                                        showToast(`Fehler beim Synchronisieren von ${type} (${table}). Aktion √ºbersprungen.`, 'error', 7000);
                                        continue; // N√§chste Operation versuchen, aber diese nicht l√∂schen
                                    }
                                }
                                
                                // 2. Erfolg (oder Duplikat): Operation aus der Outbox l√∂schen
                                await window.offlineDB.deleteData('outbox', op.id); 
                                successfulOperations++;

                            } catch (e) {
                                if (e.message.includes("Netzwerkfehler")) {
                                    // Breche ab, um beim n√§chsten Sync erneut zu versuchen
                                    break;
                                }
                                // Bei anderen Fehlern wird mit der n√§chsten Operation fortgefahren, 
                                // aber die fehlerhafte Operation nicht gel√∂scht (sollte im try-Block behandelt werden).
                            }
                        }

                        if (successfulOperations > 0 && !isInitialSync) {
                            showToast(`Synchronisation erfolgreich! ${successfulOperations} Aktionen √ºbertragen.`, 'success', 3000);
                            // Aktualisiere die Listen, falls wir uns darauf befinden
                            if (window.currentTabId === 'listTab') loadArticleList(document.getElementById('articleSearchInput').value);
                            if (window.currentTabId === 'logTab') loadAdminLog(document.getElementById('logSearchInput').value);
                            if (window.currentTabId === 'usersTab') loadUserList(document.getElementById('userSearchInput').value);
                        }

                    } catch (e) {
                        console.error("Gesamtfehler beim Sync:", e);
                    } finally {
                        window.isSyncing = false;
                    }
                }


                window.onload = function() {
                    initSettings(); // Einstellungen laden
                    initOfflineSync(); // Offline-Logik initialisieren
                    checkLogin();
                };
            </script>

        </body>
        </html>