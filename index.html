<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventar Scanner Pro FIX</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script>
        // ---------------------------------------------------------
        // KONFIGURATION & INITIALISIERUNG
        // ---------------------------------------------------------
        // BITTE HIER IHRE EIGENEN KEYS EINFÜGEN!
        const APP_SUPABASE_URL = "https://sjhyvctidpnttqhenqoy.supabase.co"; 
        const APP_SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqaHl2Y3RpZHBudHRxaGVucW95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MzU3NTksImV4cCI6MjA4MDAxMTc1OX0.oXUA012J99W8fNNJi8Zxqn-2BUjf1QJOrXGYlPotaS4"; 
        
        // Globale Variablen & Supabase-Client Initialisierung
        (function() {
            if (window.supabase) {
                window.appSupabaseClient = window.supabase.createClient(APP_SUPABASE_URL, APP_SUPABASE_KEY);
            } else {
                window.appSupabaseClient = null;
                console.error("Supabase-Client konnte nicht initialisiert werden.");
            }
            window.lastCode = ""; 
            window.currentTabId = localStorage.getItem('last_tab') || "scannerTab"; 
            window.currentUserRole = null; 
            window.currentClientId = null;
            window.companyEmailBase = localStorage.getItem('company_email_base');
            window.offlineDB = null; 
            window.isSyncing = false; 
            window.articleToEdit = null; 
            window.employeeToEdit = null; 
            window.currentAuthMode = localStorage.getItem('auth_mode') || 'employee'; 
            window.isRegisterMode = false;
            window.appSettings = {
                sound: localStorage.getItem('settingSound') === 'true',
                vibrate: localStorage.getItem('settingVibrate') === 'true',
                volume: parseFloat(localStorage.getItem('settingVolume')) || 0.5
            };
        })();

        // ---------------------------------------------------------
        // *** FUNKTIONSDEFINITIONEN ***
        // ---------------------------------------------------------

        /* --- UTILITY FUNKTIONEN --- */

        function switchView(viewId) {
            document.querySelectorAll('.app-view-container').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
        }

        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            const icon = type === 'success' ? '✔' : type === 'error' ? '✖' : 'ℹ';
            toast.innerHTML = `<span class="toast-icon">${icon}</span> ${message}`;
            
            toastContainer.prepend(toast); 
            
            setTimeout(() => { toast.classList.add('show'); }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function playFeedback(success) {
            if (window.appSettings.vibrate) {
                navigator.vibrate(success ? 100 : [100, 50, 100]);
            }
            if (window.appSettings.sound) {
                // FIX: Verwenden Sie eine Standard-Sound-URL oder lokale Datei. Hier Platzhalter.
                const audio = new Audio(success ? 'success.mp3' : 'error.mp3'); 
                audio.volume = window.appSettings.volume; 
                audio.play().catch(e => console.log("Sound-Fehler:", e));
            }
        }
        
        async function logAdminAction(actionType, description) {
            if (!window.currentClientId) return; 

            const logPayload = {
                action_type: actionType,
                description: description,
                user_role: window.currentUserRole,
                client_id: window.currentClientId,
                created_at: new Date().toISOString()
            };

            let isOffline = !navigator.onLine;

            try {
                if (window.appSupabaseClient && !isOffline) {
                    const { error } = await window.appSupabaseClient
                        .from('audit_log')
                        .insert([logPayload]);
                    
                    if (error) {
                        if (error.message.includes('Failed to fetch')) throw new Error("Offline");
                        console.error("Fehler beim Loggen:", error);
                    }
                }
            } catch (e) {
                if (e.message === "Offline" || !navigator.onLine) {
                    isOffline = true;
                    if (window.offlineDB) {
                         await window.offlineDB.addToOutbox({
                            type: 'INSERT',
                            table: 'audit_log',
                            key: logPayload.created_at, 
                            payload: logPayload,
                            timestamp: logPayload.created_at
                        });
                    }
                } else {
                    console.error("Unbekannter Fehler beim Loggen:", e);
                }
            }
            
            if (window.offlineDB) {
                try {
                    // Verwende created_at als keyPath
                    await window.offlineDB.upsertData('audit_log', logPayload, 'created_at'); 
                } catch (e) {
                    console.error("Lokaler Log-Fehler:", e);
                }
            }
        }

        function initSettings() {
            const volValueEl = document.getElementById('volValue');
            const volRangeEl = document.getElementById('settingVolume');
            const soundEl = document.getElementById('settingSound');
            const vibrateEl = document.getElementById('settingVibrate');

            if (volRangeEl) {
                 volRangeEl.value = window.appSettings.volume * 100;
                 volValueEl.innerText = `${Math.round(window.appSettings.volume * 100)}%`;
            }
            if (soundEl) soundEl.checked = window.appSettings.sound;
            if (vibrateEl) vibrateEl.checked = window.appSettings.vibrate;
        }

        function saveSettings() {
            const sound = document.getElementById('settingSound').checked;
            const vibrate = document.getElementById('settingVibrate').checked;
            const volume = parseInt(document.getElementById('settingVolume').value) / 100;
            
            window.appSettings.sound = sound;
            window.appSettings.vibrate = vibrate;
            window.appSettings.volume = volume;
            
            localStorage.setItem('settingSound', sound);
            localStorage.setItem('settingVibrate', vibrate);
            localStorage.setItem('settingVolume', volume);

            document.getElementById('volValue').innerText = `${Math.round(volume * 100)}%`;
            showToast("Einstellungen gespeichert.", 'success', 1500);
        }

        /* --- OFFLINE-SYNCHRONISIERUNG (IndexedDB) --- */

        const offlineDB = {
            db: null,
            DB_NAME: 'InventarScannerDB_v1', // Versionswechsel zur Sicherheit
            DB_VERSION: 1,
            STORE_NAMES: ['inventar', 'audit_log', 'employees', 'outbox'],

            open: () => new Promise((res, rej) => {
                const request = indexedDB.open(offlineDB.DB_NAME, offlineDB.DB_VERSION);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('inventar')) db.createObjectStore('inventar', { keyPath: 'barcode' });
                    // FIX: Verwendet 'id' als KeyPath für employees, da es die Supabase-ID ist
                    if (!db.objectStoreNames.contains('employees')) db.createObjectStore('employees', { keyPath: 'id' }); 
                    if (!db.objectStoreNames.contains('audit_log')) db.createObjectStore('audit_log', { keyPath: 'created_at' });
                    if (!db.objectStoreNames.contains('outbox')) db.createObjectStore('outbox', { keyPath: 'id', autoIncrement: true });
                };

                request.onsuccess = (event) => {
                    offlineDB.db = event.target.result;
                    window.offlineDB = offlineDB; 
                    res(offlineDB);
                };

                request.onerror = (event) => {
                    rej(event.target.error);
                };
            }),

            upsertData: (storeName, data, keyPath = 'barcode') => new Promise((res, rej) => {
                const transaction = offlineDB.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                // Setze den richtigen KeyPath, falls der Store-Name bekannt ist und der KeyPath abweicht
                if (storeName === 'employees') keyPath = 'id'; 
                else if (storeName === 'audit_log') keyPath = 'created_at';
                else if (storeName === 'outbox') keyPath = 'id';
                else keyPath = 'barcode';

                // Ensure data object contains the keyPath property
                if (!data.hasOwnProperty(keyPath)) {
                    return rej(new Error(`Data object is missing keyPath: ${keyPath} for store: ${storeName}`));
                }

                const request = store.put(data); 

                request.onsuccess = () => res();
                request.onerror = (e) => rej(e.target.error);
            }),
            
            bulkInsertData: (storeName, dataArray) => new Promise((res, rej) => {
                if (dataArray.length === 0) return res();
                const transaction = offlineDB.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                let count = 0;

                dataArray.forEach(data => {
                    const request = store.put(data);
                    request.onsuccess = () => { count++; if (count === dataArray.length) res(); };
                    request.onerror = (e) => { 
                        console.error(`Fehler beim Bulk-Insert in ${storeName}:`, e.target.error);
                        count++;
                        if (count === dataArray.length) res();
                    };
                });
            }),

            getData: (storeName, key) => new Promise((res, rej) => {
                const transaction = offlineDB.db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                request.onsuccess = (event) => res(event.target.result);
                request.onerror = (e) => rej(e.target.error);
            }),

            deleteData: (storeName, key) => new Promise((res, rej) => {
                const transaction = offlineDB.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(key);
                request.onsuccess = () => res();
                request.onerror = (e) => rej(e.target.error);
            }),

            // Convenience functions
            getArticleByBarcode: (barcode) => offlineDB.getData('inventar', barcode),
            getAllArticles: () => new Promise((res, rej) => {
                const transaction = offlineDB.db.transaction(['inventar'], 'readonly');
                const store = transaction.objectStore('inventar');
                const request = store.getAll();
                request.onsuccess = (event) => res(event.target.result);
                request.onerror = (e) => rej(e.target.error);
            }),
            getEmployeeByPN: (personnel_number) => new Promise((res, rej) => {
                 // FIX: IndexedDB kann nicht direkt nach PN suchen, wenn id der KeyPath ist. 
                 // Müssen alle laden und filtern. (Das ist der Trade-off für eine robuste Supabase-ID-Verwendung).
                 const transaction = offlineDB.db.transaction(['employees'], 'readonly');
                 const store = transaction.objectStore('employees');
                 const request = store.getAll();
                 request.onsuccess = (event) => {
                     const employee = event.target.result.find(e => e.personnel_number === personnel_number);
                     res(employee || null);
                 };
                 request.onerror = (e) => rej(e.target.error);
            }),
            getAllEmployees: () => new Promise((res, rej) => {
                const transaction = offlineDB.db.transaction(['employees'], 'readonly');
                const store = transaction.objectStore('employees');
                const request = store.getAll();
                request.onsuccess = (event) => res(event.target.result);
                request.onerror = (e) => rej(e.target.error);
            }),

            // Outbox
            addToOutbox: (operation) => new Promise((res, rej) => {
                const transaction = offlineDB.db.transaction(['outbox'], 'readwrite');
                const store = transaction.objectStore('outbox');
                const request = store.add(operation); 
                request.onsuccess = () => res(request.result);
                request.onerror = (e) => rej(e.target.error);
            }),

            getOutbox: () => new Promise((res, rej) => {
                const transaction = offlineDB.db.transaction(['outbox'], 'readonly');
                const store = transaction.objectStore('outbox');
                const request = store.getAll();
                request.onsuccess = (event) => res(event.target.result);
                request.onerror = (e) => rej(e.target.error);
            }),
            
            // Artikel-Updates
            updateArticleQuantity: async (barcode, newQuantity) => {
                const article = await offlineDB.getArticleByBarcode(barcode);
                if (!article) throw new Error("Artikel nicht gefunden.");
                article.quantity = newQuantity;
                await offlineDB.upsertData('inventar', article);
            },
            updateArticleLocation: async (barcode, newLocation) => {
                const article = await offlineDB.getArticleByBarcode(barcode);
                if (!article) throw new Error("Artikel nicht gefunden.");
                article.location = newLocation;
                await offlineDB.upsertData('inventar', article);
            },
        };

        async function initOfflineSync() {
            try {
                await offlineDB.open();
                console.log("IndexedDB initialisiert.");
            } catch (e) {
                console.error("Fehler bei IndexedDB-Initialisierung:", e);
                showToast("Offline-Funktionen sind nicht verfügbar.", 'error', 3000);
            }
        }

        async function syncData(isInitialSync = false) {
            if (window.isSyncing || !navigator.onLine || !window.currentClientId) return;

            window.isSyncing = true;
            console.log("Starte Daten-Synchronisation...");

            try {
                const outbox = await window.offlineDB.getOutbox();

                if (outbox.length > 0) {
                    showToast(`Synchronisiere ${outbox.length} Offlinedaten...`, 'info', 7000);
                    
                    for (const op of outbox) {
                        const { type, table, key, payload } = op;
                        let error = null;
                        
                        try {
                            let apiCall;
                            
                            // 1. Online-API-Aufruf
                            switch (type) {
                                case 'INSERT':
                                    // Payload enthält client_id
                                    apiCall = await window.appSupabaseClient.from(table).insert([payload]);
                                    error = apiCall.error;
                                    break;
                                case 'UPDATE':
                                    // Generischer Update. 'key' ist der Primärschlüssel (barcode oder id)
                                    apiCall = await window.appSupabaseClient.from(table)
                                        .update(payload)
                                        .eq(table === 'inventar' ? 'barcode' : 'id', key)
                                        .eq('client_id', window.currentClientId);
                                    error = apiCall.error;
                                    break;
                                case 'DELETE':
                                    // Key ist barcode
                                    apiCall = await window.appSupabaseClient.from(table)
                                        .delete()
                                        .eq('barcode', key)
                                        .eq('client_id', window.currentClientId);
                                    error = apiCall.error;
                                    break;
                                case 'INCREMENT_QUANTITY':
                                    // Spezialfall: Zähler-Update
                                    const { quantity: newQuantity } = payload;
                                    apiCall = await window.appSupabaseClient.from(table)
                                        .update({ quantity: newQuantity })
                                        .eq('barcode', key)
                                        .eq('client_id', window.currentClientId);
                                    error = apiCall.error;
                                    if (!error) {
                                        // Update des lokalen Wertes nur nach erfolgreichem Online-Sync
                                        await window.offlineDB.updateArticleQuantity(key, newQuantity); 
                                    }
                                    break;
                                case 'UPDATE_EMPLOYEE':
                                    // Key ist personnel_number, aber Supabase-Update verwendet 'id'
                                    // FIX: Müsste die Supabase-ID des Mitarbeiters aus dem Payload/lokalem Cache verwenden
                                    // Simplifikation: Verwenden den generischen UPDATE-Case und setzen den Key auf die 'id' des Mitarbeiters
                                    const employeeId = payload.id; 
                                    apiCall = await window.appSupabaseClient.from(table)
                                        .update(payload)
                                        .eq('id', employeeId)
                                        .eq('client_id', window.currentClientId);
                                    error = apiCall.error;
                                    break;
                                default:
                                    console.warn(`Unbekannter Outbox-Typ: ${type}. Aktion wird gelöscht.`);
                                    await window.offlineDB.deleteData('outbox', op.id); 
                                    continue;
                            }

                            if (error) {
                                if (error.message.includes('Failed to fetch') || error.message.includes('Network Error')) {
                                    throw new Error("Netzwerkfehler");
                                } else {
                                    // Fehler wie RLS oder Constraint: Operation löschen, um Blockade zu vermeiden
                                    console.error(`Outbox DB Fehler für ${type} ${table}:`, error);
                                    await window.offlineDB.deleteData('outbox', op.id); 
                                    continue;
                                }
                            }
                            
                            // Erfolg: Operation aus der Outbox löschen
                            await window.offlineDB.deleteData('outbox', op.id); 
                            console.log(`Outbox-Aktion erfolgreich synchronisiert und gelöscht: ${type} ${table}`);
                        } catch (e) {
                            if (e.message.includes("Netzwerkfehler") || e.message.includes("Failed to fetch")) {
                                window.isSyncing = false;
                                return;
                            }
                        }
                    }
                    showToast("Synchronisation abgeschlossen.", 'success');
                } else if (isInitialSync) {
                     showToast("Anmeldung erfolgreich. Keine Offlinedaten gefunden.", 'info');
                }
                
                // Nach Sync: Gesamtdaten neu laden und lokalen Cache aktualisieren (Admin nur Logs/User, User nur Inventar)
                if (window.currentUserRole === 'admin') {
                    await loadEmployeeList(document.getElementById('employeeSearchInput')?.value || '');
                    await loadLogList(document.getElementById('logSearchInput')?.value || '');
                    // Auch Inventar für Admins neu laden, falls die Liste offen ist
                    if (window.currentTabId === 'listTab') {
                         await loadArticleList(document.getElementById('articleSearchInput')?.value || '');
                    }
                } else if (window.currentUserRole === 'user') {
                    await loadArticleList(document.getElementById('articleSearchInput')?.value || ''); 
                }

            } catch (e) {
                console.error("Fehler im Sync-Prozess:", e);
                showToast("Fehler bei der Synchronisation.", 'error');
            }

            window.isSyncing = false;
        }

        /* --- AUTHENTIFIZIERUNG & OFFLINE-LOGIN --- */

        function initLoginSettings() {
            window.companyEmailBase = localStorage.getItem('company_email_base');
            const emailGroup = document.getElementById('companyEmailGroup');
            const companyEmailInput = document.getElementById('authCompanyEmail');
            
            if (window.companyEmailBase) {
                emailGroup.style.display = 'none';
                companyEmailInput.removeAttribute('required');
                companyEmailInput.value = window.companyEmailBase;
            } else {
                emailGroup.style.display = 'block';
                companyEmailInput.setAttribute('required', 'required');
                companyEmailInput.value = '';
            }
            updateAuthForm();
        }

        function updateAuthForm() {
            const isEmployee = window.currentAuthMode === 'employee';
            const isRegister = window.isRegisterMode; 
            
            document.getElementById('authModeToggle').innerText = isEmployee ? "Als Admin anmelden" : "Als Mitarbeiter anmelden";
            
            const companyEmailGroup = document.getElementById('companyEmailGroup');
            const personnelNumberGroup = document.getElementById('personnelNumberGroup');
            const adminEmailGroup = document.getElementById('adminEmailGroup');
            const authPasswordGroup = document.getElementById('authPasswordGroup');
            const registerToggle = document.getElementById('registerToggle');
            const authTitle = document.getElementById('authTitle');
            const authSubmitButton = document.querySelector('#authForm button[type="submit"]');

            const personnelNumberInput = document.getElementById('authPersonnelNumber');
            const adminEmailInput = document.getElementById('authAdminEmail');
            const passwordInput = document.getElementById('authPassword');
            const companyEmailInput = document.getElementById('authCompanyEmail');

            // Setze disabled States für korrekte Formularvalidierung
            if (personnelNumberInput) personnelNumberInput.disabled = !isEmployee;
            if (adminEmailInput) adminEmailInput.disabled = isEmployee;
            // Company Email nur aktivieren, wenn es Employee ist UND noch nicht gespeichert
            if (companyEmailInput) companyEmailInput.disabled = !(isEmployee && !window.companyEmailBase); 

            // Admin-Modus
            if (!isEmployee) {
                companyEmailGroup.style.display = 'none';
                personnelNumberGroup.style.display = 'none';
                adminEmailGroup.style.display = 'block';
                authPasswordGroup.style.display = 'block';
            } 
            // Mitarbeiter-Modus
            else {
                personnelNumberGroup.style.display = 'block';
                adminEmailGroup.style.display = 'none';
                authPasswordGroup.style.display = 'block';

                if (window.companyEmailBase) {
                    companyEmailGroup.style.display = 'none';
                } else {
                    companyEmailGroup.style.display = 'block';
                }
            }

            // Registrierungs-Logik
            if (isRegister) {
                authTitle.innerText = isEmployee ? "Mitarbeiter registrieren" : "Admin registrieren";
                authSubmitButton.innerText = "Registrieren";
                registerToggle.innerText = "Ich habe bereits ein Konto";
            } else {
                authTitle.innerText = "Anmelden";
                authSubmitButton.innerText = "Anmelden";
                registerToggle.innerText = "Ich benötige ein neues Konto";
            }
        }
        
        function toggleAuthMode() {
            window.currentAuthMode = window.currentAuthMode === 'employee' ? 'admin' : 'employee';
            localStorage.setItem('auth_mode', window.currentAuthMode);
            window.isRegisterMode = false;
            updateAuthForm();
        }

        function toggleRegisterMode() {
            window.isRegisterMode = !window.isRegisterMode;
            updateAuthForm();
        }

        // Hauptfunktion zur Überprüfung des Login-Status beim Laden der Seite
        async function checkLogin() {
            document.getElementById("authError").innerText = "";
            document.getElementById("loadingAuth").style.display = "block";
            
            try {
                const { data: { session }, error } = await window.appSupabaseClient.auth.getSession();
                
                if (error) throw error;

                if (session) {
                    await loadUserData(session);
                    switchView('appView');
                    await initialDataLoadAndSync();
                } else {
                    switchView('loginView');
                }
            } catch (e) {
                console.error("Fehler bei checkLogin (Online-Prüfung fehlgeschlagen):", e);
                
                // Offline-Fallback, wenn kein Netzwerk verfügbar ist UND lokale Daten existieren
                if (!navigator.onLine && localStorage.getItem('localUserRole')) {
                    window.currentUserRole = localStorage.getItem('localUserRole');
                    window.currentClientId = localStorage.getItem('localClientId');
                    window.companyEmailBase = localStorage.getItem('localCompanyEmailBase');
                    
                    showToast("Offline-Modus. Anmeldung nicht überprüft.", 'info', 5000);
                    updateUIAfterLogin(localStorage.getItem('localUserName') || "Inventar Scanner Pro");
                    switchView('appView');
                    await initialDataLoadAndSync(true); // Lade lokale Daten
                } else {
                    showToast("Sitzungsprüfung fehlgeschlagen. Bitte melden Sie sich an.", 'error', 3000);
                    switchView('loginView');
                }
            } finally {
                document.getElementById("loadingAuth").style.display = "none";
            }
        }
        
        // Helferfunktion für den ersten Datenabruf nach dem Login
        async function initialDataLoadAndSync(isOffline = false) {
             if (window.currentUserRole === 'admin') {
                loadEmployeeList(); 
                loadLogList();
            }
            // Artikel auch für Admin laden, da ListTab die Standard-Admin-Ansicht sein kann.
            loadArticleList(); 
            
            if (!isOffline) {
                syncData(true);
            }
        }
        
        function updateUIAfterLogin(name) {
             document.getElementById('headerTitle').innerText = name;
             document.getElementById('userRoleDisplay').innerText = `Rolle: ${window.currentUserRole.charAt(0).toUpperCase() + window.currentUserRole.slice(1)}`;
             updateNavBar();
        }


        // KORRIGIERTE loadUserData: Lädt die Benutzerrolle und Client-ID nach erfolgreicher Auth
        async function loadUserData(authData) {
            let user = authData.user || authData.session.user;
            
            let userRole = 'user'; 
            let clientId = null;
            let isBlocked = false;
            let employeeName = user.email;
            
            try {
                // 1. Online-Versuch: Mitarbeiter- und Client-Daten laden (RLS wird angewandt)
                const { data, error } = await window.appSupabaseClient
                    .from('employees') 
                    .select('id, name, personnel_number, role, is_active, client_id')
                    .eq('id', user.id) 
                    .single();

                if (data) {
                    userRole = data.role;
                    isBlocked = !data.is_active;
                    clientId = data.client_id;
                    employeeName = data.name;
                    
                    // Lokalen Cache aktualisieren/einfügen
                    await window.offlineDB.upsertData('employees', data); 
                } else if (error) {
                    if (error.message.includes('Failed to fetch')) {
                        throw new Error("Offline"); 
                    } else if (error.code === 'PGRST116') {
                        // Benutzer wurde authentifiziert, aber Datensatz fehlt. Nur Admin-Registrierung erlaubt.
                        if (user.email.includes(window.companyEmailBase)) {
                            // Mitarbeiter ohne Datensatz: Abmelden
                             throw new Error("Mitarbeiterdatensatz fehlt. Bitte an Admin wenden.");
                        } else {
                             // Admin-Konto ohne employees-Eintrag (typisch für RLS-Admins oder initiale Admins)
                             // Setze Standardwerte, damit Admin-RLS funktionieren kann.
                             // Dies setzt voraus, dass Admins die RLS-Regel `is_admin()` verwenden.
                             console.warn("Admin-Eintrag in 'employees' fehlt. Setze Standard-Admin-Rolle.");
                             userRole = 'admin'; 
                             clientId = 'admin_default'; // Muss bei erster Aktion gesetzt werden
                        }
                    } else {
                         // Generischer Fehler (z.B. RLS-Regel verweigert Zugriff)
                        throw error;
                    }
                }

            } catch (error) {
                if (error.message === "Offline" || !navigator.onLine) {
                    // 2. Offline-Fallback (IndexedDB)
                    let personalNumber = null;
                    if (window.currentAuthMode === 'employee' && window.companyEmailBase) {
                         personalNumber = user.email.substring(0, user.email.indexOf('@'));
                    }
                    
                    if (personalNumber) {
                        const localEmployee = await window.offlineDB.getEmployeeByPN(personalNumber);

                        if (localEmployee) {
                            userRole = localEmployee.role;
                            isBlocked = !localEmployee.is_active;
                            clientId = localEmployee.client_id;
                            employeeName = localEmployee.name;
                        } else {
                            throw new Error("Lokaler Benutzer nicht gefunden.");
                        }
                    } else {
                         // Admin-Offline-Login ohne lokalen Datensatz (nicht unterstützt)
                        throw new Error("Offline-Login nur für registrierte Mitarbeiter möglich.");
                    }
                } else {
                    console.error("Fehler beim Laden der Benutzerdaten:", error);
                    showToast(`Laden der Benutzerdaten fehlgeschlagen: ${error.message.substring(0, 50)}...`, 'error', 7000);
                    await logout(true);
                    throw error;
                }
            }
            
            // Globale Variablen setzen
            window.currentUserRole = userRole;
            window.currentClientId = clientId;
            
            // Lokalen Status speichern
            localStorage.setItem('localUserRole', userRole);
            localStorage.setItem('localClientId', clientId);
            localStorage.setItem('localUserName', employeeName);
            localStorage.setItem('localCompanyEmailBase', window.companyEmailBase); 
            
            if (isBlocked) {
                showToast(`Konto gesperrt. Bitte Admin kontaktieren.`, 'error', 5000);
                await logout(true);
                throw new Error("Konto gesperrt.");
            }
            
            // UI aktualisieren
            updateUIAfterLogin(employeeName);
        }
        
        async function performLogin(email, password, isRegisterMode) {
            if (!window.appSupabaseClient) {
                document.getElementById("authError").innerText = "Supabase-Client nicht verfügbar.";
                throw new Error("Supabase-Client nicht verfügbar.");
            }

            let authResponse;
            if (isRegisterMode) {
                authResponse = await window.appSupabaseClient.auth.signUp({ email, password });
            } else {
                authResponse = await window.appSupabaseClient.auth.signInWithPassword({ email, password });
            }

            if (authResponse.error) {
                document.getElementById("authError").innerText = authResponse.error.message;
                throw authResponse.error;
            }

            return authResponse;
        }


        // FIX: handleAuthSubmit überarbeitet, um die Validierung und den Ablauf zu klären
        async function handleAuthSubmit(event) {
             event.preventDefault(); // Verhindert das Standard-Senden des Formulars

            document.getElementById("authError").innerText = "";
            const form = document.getElementById('authForm');
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            document.getElementById("loadingAuth").style.display = "block";

            const isRegisterMode = window.isRegisterMode;
            let fullEmail = '';
            let password = '';
            let isEmployee = window.currentAuthMode === 'employee';

            try {
                if (isEmployee) {
                    const personalNumber = document.getElementById('authPersonnelNumber').value.trim();
                    let companyEmailBaseInput = document.getElementById('authCompanyEmail').value.trim();
                    const finalEmailBase = window.companyEmailBase || companyEmailBaseInput;

                    if (!finalEmailBase) {
                        document.getElementById("authError").innerText = "Bitte Firmen E-Mail Basis angeben.";
                        return;
                    }
                    if (!personalNumber) {
                         document.getElementById("authError").innerText = "Bitte Personalnummer angeben.";
                        return;
                    }
                    
                    fullEmail = `${personalNumber}@${finalEmailBase}`;
                    password = document.getElementById('authPassword').value;
                    
                    // Speichere die E-Mail-Basis lokal nach erfolgreicher Anmeldung/Registrierung
                    if (!window.companyEmailBase) {
                        localStorage.setItem('company_email_base', finalEmailBase);
                        window.companyEmailBase = finalEmailBase;
                        initLoginSettings(); // UI aktualisieren, um das Feld auszublenden
                    }

                } else {
                    fullEmail = document.getElementById('authAdminEmail').value.trim();
                    password = document.getElementById('authPassword').value;
                }
                
                if (!password) {
                     document.getElementById("authError").innerText = "Bitte Passwort angeben.";
                    return;
                }

                const authResponse = await performLogin(fullEmail, password, isRegisterMode);
                
                if (isRegisterMode) {
                    showToast("Registrierung erfolgreich. Bitte E-Mail bestätigen.", 'success', 5000);
                    window.isRegisterMode = false;
                    updateAuthForm();
                    // FIX: Bei Registrierung keine weitere Aktion (Warten auf Bestätigung)
                    return;
                }
                
                // Beim Login: Lade Benutzerdaten
                await loadUserData(authResponse.data); 

                // Ansicht wechseln und Sync starten
                switchView('appView');
                showToast("Anmeldung erfolgreich.", 'success');
                await initialDataLoadAndSync();
                
            } catch (error) {
                console.error("Authentifizierungsfehler:", error);
                if (!document.getElementById("authError").innerText) {
                    document.getElementById("authError").innerText = error.message || "Anmeldefehler. Prüfen Sie Ihre Eingaben.";
                }
            } finally {
                document.getElementById("loadingAuth").style.display = "none";
                submitButton.disabled = false;
                updateAuthForm(); // Setzt Button-Text korrekt
            }
        }

        async function logout(isErrorLogout = false) {
            await stopScanner(); 
            
            localStorage.removeItem('localUserRole');
            localStorage.removeItem('localClientId');
            localStorage.removeItem('localUserName');
            // FIX: companyEmailBase wird NICHT gelöscht, damit Mitarbeiter es nicht jedes Mal eingeben müssen.

            window.currentUserRole = null;
            window.currentClientId = null;
            window.articleToEdit = null;
            window.employeeToEdit = null;
            window.currentTabId = "scannerTab"; 
            localStorage.setItem('last_tab', 'scannerTab');

            try {
                if (window.appSupabaseClient) {
                    await window.appSupabaseClient.auth.signOut();
                }
            } catch (e) {
                console.error("Fehler beim Abmelden:", e);
            }

            switchView('loginView');
            if (!isErrorLogout) {
                showToast("Erfolgreich abgemeldet.", 'info');
            }
            initLoginSettings(); 
            updateNavBar(); 
        }

        /* --- SCANNER LOGIK --- */ 
        let html5QrCode = null;

        async function activateCamera() {
             if (window.currentTabId !== 'scannerTab') return;

             // FIX: Stoppen und Freigeben, falls es schon lief, aber in einem fehlerhaften Zustand war
             await stopScanner(false); 
             
             document.getElementById("preScan").style.display = "none";
             document.getElementById("scanFrame").style.display = "block";
             document.getElementById("scanFrame").innerHTML = ''; // Reinigen

             if (!html5QrCode) {
                 html5QrCode = new Html5Qrcode("scanFrame");
             }

             const config = { 
                 fps: 10, 
                 qrbox: { width: 250, height: 250 }, 
                 disableFlip: false 
             }; 
             const successCallback = (decodedText, decodedResult) => { 
                 if (decodedText && decodedText !== window.lastCode) { 
                     window.lastCode = decodedText; 
                     processBarcode(decodedText); 
                     playFeedback(true);
                     // Optional: Scanner nach erfolgreichem Scan stoppen
                     // stopScanner(); 
                 } 
             }; 

             try { 
                 await html5QrCode.start( 
                      { facingMode: "environment" }, 
                      config, 
                      successCallback 
                 ); 
             } catch (err) { 
                 console.error("Kamera-Startfehler:", err); 
                 showToast("Kamera konnte nicht gestartet werden. (Prüfen Sie Berechtigungen)", 'error', 5000); 
                 document.getElementById("preScan").style.display = "block"; 
                 document.getElementById("scanFrame").style.display = "none"; 
             } 
         } 

         async function stopScanner(clearLastCode = true) { 
             if (html5QrCode && html5QrCode.isScanning) { 
                 try { 
                     await html5QrCode.stop(); 
                     html5QrCode.clear(); 
                     document.getElementById("preScan").style.display = "block"; 
                     document.getElementById("scanFrame").style.display = "none"; 
                 } catch (err) { 
                     console.error("Kamera-Stoppfehler:", err); 
                 } 
             } 
             if (clearLastCode) window.lastCode = ""; 
         }

        async function processBarcode(code) { 
            if (!window.currentClientId) { showToast("Bitte melden Sie sich zuerst an.", 'error'); return; } 

            const resultCard = document.getElementById('resultCard');
            const resultContent = document.getElementById('resultContent');

            resultCard.classList.remove('active');
            resultContent.innerHTML = `<p style="text-align: center; color: var(--color-text-medium);">Suche nach Barcode: <strong>${code}</strong>...</p>`;
            resultCard.classList.add('active');

            let data = null;
            let isOffline = !navigator.onLine;

            try {
                // 1. Online-Versuch
                if (window.appSupabaseClient && !isOffline) {
                    const { data: article, error } = await window.appSupabaseClient
                        .from('inventar')
                        .select('*')
                        .eq('barcode', code)
                        .eq('client_id', window.currentClientId)
                        .single();

                    if (error && error.message.includes('Failed to fetch')) throw new Error("Offline");
                    if (error && error.code !== 'PGRST116') throw error; // PGRST116 = keine Zeile gefunden

                    if (article) {
                         data = article;
                         // Lokalen Cache aktualisieren
                         await window.offlineDB.upsertData('inventar', data);
                    }
                }
            } catch (e) {
                if (e.message === "Offline" || !navigator.onLine) {
                    isOffline = true;
                    showToast("Netzwerkfehler. Suche in lokalen Daten.", 'info');
                    // 2. Offline-Fallback (IndexedDB)
                    data = await window.offlineDB.getArticleByBarcode(code);
                    // Prüfen, ob Artikel zum richtigen Mandanten gehört (wichtig bei Multitenancy)
                    if (data && data.client_id !== window.currentClientId) {
                        data = null; 
                    }
                } else {
                    console.error("Fehler beim Abruf des Barcodes:", e);
                    showToast(`FEHLER beim Laden des Barcodes: ${e.message.substring(0, 50)}...`, "error");
                }
            }

            // UI-Update
            let html = '';
            if (data) {
                const quantity = data.quantity || 0;
                const location = data.location || 'N/A';
                html += `<h3>${data.name}</h3>`;
                html += `<p class="result-meta">Barcode: <strong>${data.barcode}</strong></p>`;
                html += `<div class="result-stats">`;
                html += `<div class="stat-item primary"><span>${quantity}</span><span class="label">BESTAND</span></div>`;
                html += `<div class="stat-item secondary"><span>${location}</span><span class="label">ORT</span></div>`;
                html += `</div>`;
                
                // Aktions-Buttons
                html += `<div class="action-button-group" id="actionButtonGroup">`;
                // FIX: updateQuantity gibt immer den Barcode mit, was robust ist
                html += `<button onclick="updateQuantity('${data.barcode}', -1)" class="action-button minus" ${quantity <= 0 ? 'disabled' : ''}>-</button>`;
                html += `<button onclick="updateQuantity('${data.barcode}', 1)" class="action-button plus">+</button>`;
                if (window.currentUserRole === 'admin') {
                     // FIX: JSON.stringify verwenden und escapen, um Probleme mit Sonderzeichen zu vermeiden
                    html += `<button onclick='showAdminEditPopup(${JSON.stringify(data).replace(/'/g, '&#39;').replace(/"/g, '&quot;')})' class="action-button edit">Bearbeiten</button>`;
                }
                html += `</div>`;

            } else {
                html += `<h3 style="color: var(--color-error-red);">Artikel nicht gefunden</h3>`;
                html += `<p>Der Barcode <strong>${code}</strong> ist unbekannt.</p>`;
                if (window.currentUserRole === 'admin') {
                    html += `<div class="action-button-group" id="actionButtonGroup">`;
                    html += `<button onclick="showRegisterPopup('${code}')" class="action-button register">Artikel registrieren</button>`;
                    html += `</div>`;
                }
            }
            resultContent.innerHTML = html;
        }

        async function updateQuantity(barcode, delta) { 
            if (!window.currentClientId) { showToast("Bitte melden Sie sich zuerst an.", 'error'); return; }

            let article;
            try {
                article = await window.offlineDB.getArticleByBarcode(barcode);
                if (!article) throw new Error("Artikel nicht lokal gefunden.");
            } catch(e) {
                 showToast("Artikel nicht lokal gefunden.", 'error'); return;
            }
            
            const oldQuantity = article.quantity || 0;
            const newQuantity = oldQuantity + delta;

            if (newQuantity < 0) {
                 showToast("Bestand kann nicht negativ sein.", 'error'); return;
            }
            
            let isOffline = !navigator.onLine;
            let success = false;
            
            try {
                // 1. Online-Update
                if (window.appSupabaseClient && !isOffline) {
                    const { data: updatedData, error } = await window.appSupabaseClient.rpc('increment_quantity', {
                        article_barcode: barcode,
                        amount: delta,
                        client_uuid: window.currentClientId // Wird in der DB-Funktion verwendet
                    });

                    if (error) {
                        if (error.message.includes('Failed to fetch')) throw new Error("Offline");
                         // Bei RLS-Fehler hier nicht abbrechen, da die DB-Funktion den Client-Kontext prüft
                        console.error("Fehler bei increment_quantity RPC:", error);
                        throw error;
                    }
                    // Wenn RPC erfolgreich, aktualisiere den lokalen Cache mit dem neuen Wert
                    await window.offlineDB.updateArticleQuantity(barcode, newQuantity); 
                    success = true;
                } else {
                    throw new Error("Offline");
                }
                
            } catch (e) {
                if (e.message.includes("Offline") || !navigator.onLine) {
                    isOffline = true;
                    // 2. Offline-Fallback: Lokales Speichern und zur Outbox hinzufügen
                    try {
                        await window.offlineDB.updateArticleQuantity(barcode, newQuantity);
                        
                        // FIX: Nutze INCREMENT_QUANTITY für robusten Sync, 
                        // der nur die Menge übermittelt und den Key (barcode) verwendet.
                        await window.offlineDB.addToOutbox({
                            type: 'INCREMENT_QUANTITY',
                            table: 'inventar',
                            key: barcode,
                            payload: { quantity: newQuantity, client_id: window.currentClientId },
                            timestamp: new Date().toISOString()
                        });
                        success = true;
                    } catch (err) {
                        console.error("Offline-Update fehlgeschlagen:", err);
                    }
                } else {
                    console.error("Online-Update fehlgeschlagen:", e);
                    showToast(`FEHLER: Update fehlgeschlagen: ${e.message.substring(0, 50)}...`, "error");
                }
            }

            if (success) {
                const action = delta > 0 ? 'erhöht' : 'reduziert';
                const statusMessage = isOffline ? 
                    `Lokal: Bestand ${action} (${delta}). Wird synchronisiert.` : 
                    `Bestand erfolgreich ${action} (${delta}).`;
                    
                showToast(statusMessage, isOffline ? "info" : "success");
                
                logAdminAction('QUANTITY_UPDATE', `Bestand für "${article.name}" (Barcode: ${barcode}) von ${oldQuantity} auf ${newQuantity} geändert.`);

                // UI aktualisieren (Result Card und Liste neu laden)
                await processBarcode(barcode);
                if (window.currentTabId === 'listTab') { loadArticleList(document.getElementById('articleSearchInput').value); }
            } else {
                 // Fehlerbehandlung: UI zurücksetzen
                await processBarcode(barcode);
            }
        } 


        /* --- UI & NAVIGATION LOGIK --- */ 

        function updateNavBar() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
                const tabId = item.getAttribute('data-tab-id'); // Verwenden von data-tab-id
                
                const isAdminTab = ['listTab', 'logTab', 'usersTab', 'settingsTab'].includes(tabId);
                const isUserTab = ['scannerTab', 'listTab', 'settingsTab'].includes(tabId);
                
                item.style.display = 'none';

                if (window.currentUserRole === 'admin' && isAdminTab) {
                    item.style.display = 'flex';
                } else if (window.currentUserRole === 'user' && isUserTab) {
                    item.style.display = 'flex';
                } else if (!window.currentUserRole && tabId === 'scannerTab') { 
                     // Nur Scanner-Tab im abgemeldeten Zustand sichtbar
                    item.style.display = 'flex';
                }

                if (tabId === window.currentTabId) {
                    item.classList.add('active');
                }
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                if (content.id === window.currentTabId) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });

            if (window.currentTabId !== 'scannerTab') {
                stopScanner();
            } else if (window.currentUserRole) {
                // Bei Rückkehr zum Scanner die Kamera starten, wenn man eingeloggt ist
                activateCamera();
            }
        }

        function navigate(tabId) {
            window.currentTabId = tabId;
            localStorage.setItem('last_tab', tabId);
            updateNavBar();
            hideResultCard();
            
            // Daten bei Wechsel neu laden
            switch(tabId) {
                case 'listTab':
                    loadArticleList();
                    break;
                case 'usersTab':
                    loadEmployeeList();
                    break;
                case 'logTab':
                    loadLogList();
                    break;
                case 'settingsTab':
                    initSettings();
                    showSettingsPopup();
                    break;
            }
        }

        /* --- DATEN-LADEN LOGIK --- */

        async function loadArticleList(searchTerm = '') { 
            if (!window.currentClientId) return; 

            const articleListContainer = document.getElementById('articleList');
            articleListContainer.innerHTML = '<li style="text-align: center; border: none; background: transparent; padding: 20px;">Lade Artikel...</li>';
            
            let data = [];
            let isOffline = !navigator.onLine;

            try {
                if (window.appSupabaseClient && !isOffline) {
                    let query = window.appSupabaseClient
                        .from('inventar')
                        .select('barcode, name, location, quantity');

                    if (window.currentClientId) {
                         query = query.eq('client_id', window.currentClientId);
                    }

                    if (searchTerm) {
                        const search = `%${searchTerm.toLowerCase()}%`;
                        query = query.or(`name.ilike.${search},barcode.ilike.${search},location.ilike.${search}`);
                    }

                    const { data: articles, error } = await query.order('name', { ascending: true });

                    if (error && error.message.includes('Failed to fetch')) throw new Error("Offline");
                    if (error) throw error;
                    
                    data = articles;
                    // Lokalen Cache mit frischen Daten überschreiben
                    await window.offlineDB.bulkInsertData('inventar', data); 
                } else {
                    throw new Error("Offline");
                }
            } catch (e) {
                isOffline = true;
                showToast("Netzwerkfehler. Zeige lokale Artikel...", 'info');
                
                try {
                    const localData = await window.offlineDB.getAllArticles();
                    // FIX: Client-Filter muss auch lokal angewandt werden
                    data = localData.filter(item => {
                        if (item.client_id !== window.currentClientId) return false;
                        if (!searchTerm) return true;
                        const search = searchTerm.toLowerCase();
                        return item.name.toLowerCase().includes(search) || item.barcode.toLowerCase().includes(search) || item.location.toLowerCase().includes(search);
                    });
                } catch (e) {
                    console.error("Lokaler Artikel-Ladefehler:", e);
                    articleListContainer.innerHTML = '<li style="text-align: center; color: var(--color-error-red); border: none; background: transparent; padding: 20px;">Fehler beim Laden lokaler Daten.</li>';
                    return;
                }
            }

            articleListContainer.innerHTML = '';
            if (data.length === 0) {
                articleListContainer.innerHTML = '<li style="text-align: center; border: none; background: transparent; padding: 20px;">Keine Artikel gefunden.</li>';
                return;
            }

            data.forEach(article => {
                const listItem = document.createElement('li');
                listItem.classList.add('list-item');
                if (window.currentUserRole === 'admin') {
                    listItem.setAttribute('onclick', `showAdminEditPopup(${JSON.stringify(article).replace(/'/g, '&#39;').replace(/"/g, '&quot;')})`);
                }
                const locationHtml = article.location ? `<span class="item-location">${article.location}</span>` : '';
                listItem.innerHTML = `
                    <div class="item-details">
                        <span class="item-name">${article.name}</span>
                        <span class="item-barcode">${article.barcode}</span>
                        ${locationHtml}
                    </div>
                    <div class="item-count" style="border: 2px solid var(--color-accent-blue); border-radius: 8px;">
                        <span style="font-size: 1.4rem; font-weight: 700; color: var(--color-accent-blue); line-height: 1;">${article.quantity || 0}</span>
                        <span class="item-label">BESTAND</span>
                    </div>
                `;
                articleListContainer.appendChild(listItem);
            });
        }

        async function loadLogList(searchTerm = '') {
            if (window.currentUserRole !== 'admin' || !window.currentClientId) return;

            const logListContainer = document.getElementById('logList');
            logListContainer.innerHTML = '<li style="text-align: center; border: none; background: transparent; padding: 20px;">Lade Logbuch...</li>';
            
            let logData = [];
            let isOffline = !navigator.onLine;

            try {
                if (window.appSupabaseClient && !isOffline) {
                    let query = window.appSupabaseClient
                        .from('audit_log')
                        .select('action_type, description, created_at')
                        .eq('client_id', window.currentClientId);

                    if (searchTerm) {
                        const search = `%${searchTerm.toLowerCase()}%`;
                        query = query.or(`description.ilike.${search},action_type.ilike.${search}`);
                    }

                    const { data: logs, error } = await query.order('created_at', { ascending: false });

                    if (error && error.message.includes('Failed to fetch')) throw new Error("Offline");
                    if (error) throw error;

                    logData = logs;
                    // Lokalen Cache aktualisieren
                    await window.offlineDB.bulkInsertData('audit_log', logData); 
                } else {
                    throw new Error("Offline");
                }

            } catch (e) {
                isOffline = true;
                showToast("Netzwerkfehler. Zeige lokales Logbuch...", 'info');

                try {
                    const localData = await window.offlineDB.db.transaction(['audit_log'], 'readonly').objectStore('audit_log').getAll();
                    // Sortiere und Filter nach Client/Search
                     logData = localData
                        .filter(item => item.client_id === window.currentClientId)
                        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                     if (searchTerm) {
                        const search = searchTerm.toLowerCase();
                        logData = logData.filter(log => log.description.toLowerCase().includes(search) || log.action_type.toLowerCase().includes(search));
                    }

                } catch (e) {
                    console.error("Lokaler Log-Ladefehler:", e);
                    logListContainer.innerHTML = '<li style="text-align: center; color: var(--color-error-red); border: none; background: transparent; padding: 20px;">Fehler beim Laden lokaler Daten.</li>';
                    return;
                }
            }

            logListContainer.innerHTML = '';
            if (logData.length === 0) {
                logListContainer.innerHTML = '<li style="text-align: center; border: none; background: transparent; padding: 20px;">Keine Log-Einträge gefunden.</li>';
                return;
            }

            logData.forEach(log => {
                const listItem = document.createElement('li');
                listItem.classList.add('list-item', 'log-item');
                const date = new Date(log.created_at).toLocaleString('de-DE', { dateStyle: 'short', timeStyle: 'short' });
                listItem.innerHTML = `
                    <div class="item-details">
                        <span class="item-name">${log.description}</span>
                        <span class="item-barcode">${date}</span>
                    </div>
                    <div class="item-count log-type">
                        <span class="item-label">${log.action_type.replace('_', ' ')}</span>
                    </div>
                `;
                logListContainer.appendChild(listItem);
            });
        }

        async function loadEmployeeList(searchTerm = '') {
            if (window.currentUserRole !== 'admin' || !window.currentClientId) return;

            const employeeListContainer = document.getElementById('employeeList');
            employeeListContainer.innerHTML = '<li style="text-align: center; border: none; background: transparent; padding: 20px;">Lade Mitarbeiter...</li>';
            
            let data = [];
            let isOffline = !navigator.onLine;

            try {
                if (window.appSupabaseClient && !isOffline) {
                    let query = window.appSupabaseClient
                        .from('employees')
                        .select('id, name, personnel_number, role, is_active, client_id')
                        .eq('client_id', window.currentClientId);

                    if (searchTerm) {
                        const search = `%${searchTerm.toLowerCase()}%`;
                        query = query.or(`name.ilike.${search},personnel_number.ilike.${search}`);
                    }

                    const { data: employees, error } = await query.order('name', { ascending: true });

                    if (error && error.message.includes('Failed to fetch')) throw new Error("Offline");
                    if (error) throw error;

                    data = employees;
                    // Lokalen Cache aktualisieren
                    await window.offlineDB.bulkInsertData('employees', data); 
                } else {
                    throw new Error("Offline");
                }

            } catch (e) {
                isOffline = true;
                showToast("Netzwerkfehler. Zeige lokale Mitarbeiterdaten...", 'info');
                
                try {
                    const localData = await window.offlineDB.getAllEmployees();
                    data = localData.filter(item => {
                         if (item.client_id !== window.currentClientId) return false;
                        if (!searchTerm) return true;
                        const search = searchTerm.toLowerCase();
                        return item.name.toLowerCase().includes(search) || item.personnel_number.toLowerCase().includes(search);
                    });
                } catch (e) {
                    console.error("Lokaler Mitarbeiter-Ladefehler:", e);
                    employeeListContainer.innerHTML = '<li style="text-align: center; color: var(--color-error-red); border: none; background: transparent; padding: 20px;">Fehler beim Laden lokaler Daten.</li>';
                    return;
                }
            }

            employeeListContainer.innerHTML = '';
            if (data.length === 0) {
                employeeListContainer.innerHTML = '<li style="text-align: center; border: none; background: transparent; padding: 20px;">Keine Mitarbeiter gefunden.</li>';
                return;
            }

            data.forEach(employee => {
                const listItem = document.createElement('li');
                listItem.classList.add('list-item', 'employee-item');
                listItem.setAttribute('onclick', `showEmployeeEditPopup(${JSON.stringify(employee).replace(/'/g, '&#39;').replace(/"/g, '&quot;')})`);
                
                const roleColor = employee.role === 'admin' ? 'var(--color-accent-green)' : 'var(--color-accent-blue)';
                const activeColor = employee.is_active ? 'var(--color-accent-green)' : 'var(--color-error-red)';
                
                listItem.innerHTML = `
                    <div class="item-details">
                        <span class="item-name">${employee.name}</span>
                        <span class="item-barcode">PN: ${employee.personnel_number}</span>
                    </div>
                    <div class="item-count employee-status">
                        <span class="item-label" style="color: ${roleColor};">${employee.role.toUpperCase()}</span>
                        <span class="item-label" style="color: ${activeColor};">STATUS: ${employee.is_active ? 'Aktiv' : 'Gesperrt'}</span>
                    </div>
                `;
                employeeListContainer.appendChild(listItem);
            });
        }


        // --- Import Logik (unverändert) ---
        function parseCSV(csvText) { 
             const lines = csvText.split('\n').filter(line => line.trim() !== '');
            const headers = lines[0].split(';').map(h => h.trim().toLowerCase());
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const currentLine = lines[i].split(';');
                if (currentLine.length !== headers.length) continue;
                let obj = { client_id: window.currentClientId, quantity: 0, location: '' };

                for (let j = 0; j < headers.length; j++) {
                    const header = headers[j];
                    const value = currentLine[j] ? currentLine[j].trim() : ''; 
                    if (header === 'barcode') obj.barcode = value;
                    else if (header === 'name') obj.name = value;
                    else if (header === 'location') obj.location = value;
                    else if (header === 'quantity') obj.quantity = parseInt(value) || 0;
                }

                if (obj.barcode && obj.name) { 
                    data.push(obj);
                }
            } 
            return data; 
        } 

        async function handleImport() { 
            if (window.currentUserRole !== 'admin') return;
            const fileInput = document.getElementById('csvFileInput');
            if (!fileInput.files.length) { showToast("Bitte wählen Sie eine CSV-Datei aus.", 'error'); return; }

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async (e) => { 
                const csvText = e.target.result;
                const articlesToImport = parseCSV(csvText);

                if (articlesToImport.length === 0) { showToast("Keine gültigen Artikel zum Import gefunden. Prüfen Sie das Format (barcode;name;location;quantity)", 'error', 7000); return; }

                showToast(`Starte Import von ${articlesToImport.length} Artikeln...`, 'info', 10000);
                
                let isOffline = !navigator.onLine;

                try {
                    if (window.appSupabaseClient && !isOffline) {
                        // 1. Online-Import (upsert für Aktualisierungen)
                         const { error } = await window.appSupabaseClient
                            .from('inventar')
                            .upsert(articlesToImport, { onConflict: 'barcode' }); 
                            // Verwende upsert, um bestehende Artikel zu aktualisieren
                        
                        if (error) {
                             if (error.message.includes('Failed to fetch')) throw new Error("Offline");
                            throw error;
                        }
                        showToast(`Online-Import von ${articlesToImport.length} Artikeln abgeschlossen.`, 'success', 3000);
                        await window.offlineDB.bulkInsertData('inventar', articlesToImport); // Lokalen Cache aktualisieren
                        logAdminAction('BULK_IMPORT', `Online-Import von ${articlesToImport.length} Artikeln.`);
                        
                    } else {
                        throw new Error("Offline");
                    }
                } catch (e) {
                     isOffline = true;
                    if (e.message === "Offline" || !navigator.onLine) {
                        showToast(`Offline-Import gestartet. ${articlesToImport.length} Artikel werden lokal gespeichert.`, 'warning', 7000);
                        
                        // 2. Offline-Import: Nur in IndexedDB speichern
                        await window.offlineDB.bulkInsertData('inventar', articlesToImport);
                        
                        // FIX: Füge Bulk-Operation zur Outbox hinzu (als INSERT/UPDATE). 
                        // Simplifikation: Füge jede upsert-Operation einzeln zur Outbox hinzu (robust)
                        articlesToImport.forEach(article => {
                             window.offlineDB.addToOutbox({
                                type: 'INSERT_OR_UPDATE', // Spezial-Typ für den Sync
                                table: 'inventar',
                                key: article.barcode,
                                payload: article,
                                timestamp: new Date().toISOString()
                            });
                        });

                        logAdminAction('BULK_IMPORT_OFFLINE', `Lokaler Import von ${articlesToImport.length} Artikeln.`);
                        showToast("Lokaler Import erfolgreich. Synchronisation startet bei Verbindung.", 'info', 5000);

                    } else {
                        console.error("Importfehler:", e);
                        showToast(`Schwerwiegender Fehler beim Import: ${e.message.substring(0, 50)}...`, 'error', 7000);
                    }
                }

                if (window.currentTabId === 'listTab') { loadArticleList(document.getElementById('articleSearchInput').value); }
            }; 
            reader.readAsText(file); 
        }

        // --- Artikel Management Popups (Admin) --- 
        function hideResultCard() { document.getElementById('resultCard').classList.remove('active'); }

        function showRegisterPopup(barcode) {
            if (window.currentUserRole !== 'admin') return;
            document.getElementById('popupBarcode').value = barcode;
            document.getElementById('popupBaseName').value = '';
            document.getElementById('popupLocation').value = '';
            document.getElementById('popupOverlay').classList.add('show');
            hideResultCard();
        }

        function hidePopup() { document.getElementById('popupOverlay').classList.remove('show'); }

        async function saveArticle() { 
            if (window.currentUserRole !== 'admin') return;
            const barcode = document.getElementById('popupBarcode').value.trim();
            const name = document.getElementById('popupBaseName').value.trim();
            const location = document.getElementById('popupLocation').value.trim();

            if (!barcode || !name || !location) { showToast("Bitte alle Felder ausfüllen.", 'error', 2000); return; }

            const newArticle = { barcode, name, location, quantity: 0, client_id: window.currentClientId };
            let success = false;
            let isOffline = !navigator.onLine;

            try {
                if (window.appSupabaseClient && !isOffline) {
                    const { error } = await window.appSupabaseClient.from('inventar').insert([newArticle]);
                    
                    if (error) {
                         if (error.message.includes('Failed to fetch')) throw new Error("Offline");
                        throw error;
                    }
                    success = true;
                    await window.offlineDB.upsertData('inventar', newArticle);
                } else {
                    throw new Error("Offline");
                }
            } catch (e) {
                if (e.message === "Offline" || !navigator.onLine) {
                    isOffline = true;
                    // Lokales Speichern und zur Outbox hinzufügen
                    await window.offlineDB.upsertData('inventar', newArticle);
                    await window.offlineDB.addToOutbox({
                        type: 'INSERT',
                        table: 'inventar',
                        key: barcode,
                        payload: newArticle,
                        timestamp: new Date().toISOString()
                    });
                    success = true;
                } else {
                    console.error("Speicherfehler:", e);
                    showToast(`FEHLER beim Registrieren: ${e.message.substring(0, 50)}...`, "error");
                }
            }

            if (success) {
                const statusMessage = isOffline ? `Artikel lokal registriert. Wird bei Verbindung synchronisiert.` : `Artikel erfolgreich registriert.`;
                showToast(statusMessage, isOffline ? "info" : "success");
                logAdminAction('ARTICLE_REGISTERED', `Artikel "${name}" (Barcode: ${barcode}) registriert.`);
                hidePopup();
                loadArticleList(barcode);
            }
        }

        function showAdminEditPopup(articleData) { 
            if (window.currentUserRole !== 'admin') return;
            window.articleToEdit = articleData;
            document.getElementById('adminEditBarcode').value = articleData.barcode;
            document.getElementById('adminEditName').value = articleData.name;
            document.getElementById('adminEditLocation').value = articleData.location;
            document.getElementById('adminEditPopupOverlay').classList.add('show');
            hideResultCard();
        } 

        function hideAdminEditPopup() { 
            document.getElementById('adminEditPopupOverlay').classList.remove('show');
            window.articleToEdit = null;
        }

        async function saveArticleEdit() { 
            if (window.currentUserRole !== 'admin' || !window.articleToEdit) return;
            const barcode = document.getElementById('adminEditBarcode').value.trim();
            const newName = document.getElementById('adminEditName').value.trim();
            const newLocation = document.getElementById('adminEditLocation').value.trim();
            const oldArticle = window.articleToEdit;

            if (!newName || !newLocation) { showToast("Bitte alle Felder ausfüllen.", 'error', 2000); return; }

            const isNameChanged = newName !== oldArticle.name;
            const isLocationChanged = newLocation !== oldArticle.location;

            if (!isNameChanged && !isLocationChanged) {
                 showToast("Keine Änderungen erkannt.", 'info', 2000);
                 hideAdminEditPopup();
                 return;
            }

            let success = false;
            let isOffline = !navigator.onLine;
            const updatePayload = { name: newName, location: newLocation };

            try {
                if (window.appSupabaseClient && !isOffline) {
                    const { error } = await window.appSupabaseClient
                        .from('inventar')
                        .update(updatePayload)
                        .eq('barcode', barcode)
                        .eq('client_id', window.currentClientId);

                    if (error) {
                         if (error.message.includes('Failed to fetch')) throw new Error("Offline");
                        throw error;
                    }
                    success = true;
                    // Lokalen Cache aktualisieren
                    await window.offlineDB.upsertData('inventar', {...oldArticle, ...updatePayload}); 
                } else {
                    throw new Error("Offline");
                }
            } catch (e) {
                if (e.message === "Offline" || !navigator.onLine) {
                    isOffline = true;
                    // Lokales Speichern und zur Outbox hinzufügen
                    const offlinePayload = { ...oldArticle, ...updatePayload, client_id: window.currentClientId };
                    await window.offlineDB.upsertData('inventar', offlinePayload); 

                    await window.offlineDB.addToOutbox({
                        type: 'UPDATE',
                        table: 'inventar',
                        key: barcode,
                        payload: offlinePayload,
                        timestamp: new Date().toISOString()
                    });
                    success = true;
                } else {
                    console.error("Speicherfehler:", e);
                    showToast(`FEHLER beim Speichern: ${e.message.substring(0, 50)}...`, "error");
                }
            }

            if (success) {
                const statusMessage = isOffline ? `Änderungen lokal gespeichert. Werden bei Verbindung synchronisiert.` : `Artikel erfolgreich gespeichert.`;
                showToast(statusMessage, isOffline ? "info" : "success");
                logAdminAction('ARTICLE_EDITED', `Artikel "${oldArticle.name}" (Barcode: ${barcode}) bearbeitet.`);
                hideAdminEditPopup();
                loadArticleList(document.getElementById('articleSearchInput').value); 
            }
        }

        let articleToDeleteBarcode = null;
        function showDeleteConfirmPopup(barcode) {
            articleToDeleteBarcode = barcode;
            document.getElementById('deleteConfirmText').innerHTML = `Sind Sie sicher, dass Sie den Artikel mit Barcode <strong>${barcode}</strong> löschen möchten?`;
            document.getElementById('deleteConfirmPopupOverlay').classList.add('show');
        }

        function hideDeleteConfirmPopup() {
            document.getElementById('deleteConfirmPopupOverlay').classList.remove('show');
            articleToDeleteBarcode = null;
        }

        async function deleteArticle() {
             if (window.currentUserRole !== 'admin' || !articleToDeleteBarcode) return;
             const barcode = articleToDeleteBarcode;
             let success = false;
             let isOffline = !navigator.onLine;

             try {
                 if (window.appSupabaseClient && !isOffline) {
                     const { error } = await window.appSupabaseClient
                         .from('inventar')
                         .delete()
                         .eq('barcode', barcode)
                         .eq('client_id', window.currentClientId);

                     if (error) {
                         if (error.message.includes('Failed to fetch')) throw new Error("Offline");
                         throw error;
                     }
                     success = true;
                     await window.offlineDB.deleteData('inventar', barcode);
                 } else {
                    throw new Error("Offline");
                 }
             } catch (e) {
                 if (e.message === "Offline" || !navigator.onLine) {
                     isOffline = true;
                     await window.offlineDB.deleteData('inventar', barcode);
                     await window.offlineDB.addToOutbox({
                         type: 'DELETE',
                         table: 'inventar',
                         key: barcode,
                         payload: null, // Payload nicht nötig für DELETE
                         timestamp: new Date().toISOString()
                     });
                     success = true;
                 } else {
                     console.error("Löschfehler:", e);
                     showToast(`FEHLER beim Löschen: ${e.message.substring(0, 50)}...`, "error");
                 }
             }

             hideDeleteConfirmPopup();
             hideAdminEditPopup();

             if (success) {
                 const statusMessage = isOffline ? `Artikel lokal zum Löschen markiert. Wird bei Verbindung synchronisiert.` : `Artikel erfolgreich gelöscht.`;
                 showToast(statusMessage, isOffline ? "info" : "success");
                 logAdminAction('ARTICLE_DELETED', `Artikel (Barcode: ${barcode}) gelöscht.`);
                 if (window.lastCode === barcode) { window.lastCode = ""; hideResultCard(); }
                 loadArticleList(document.getElementById('articleSearchInput').value);
             }
         }


        // --- Mitarbeiter Management Popups (Admin) --- 

        function showEmployeeEditPopup(employeeData) { 
            if (window.currentUserRole !== 'admin') return;
            window.employeeToEdit = employeeData;
            document.getElementById('employeeEditName').value = employeeData.name;
            document.getElementById('employeeEditPN').value = employeeData.personnel_number;
            document.getElementById('employeeEditRole').value = employeeData.role;
            document.getElementById('employeeEditActive').checked = employeeData.is_active;
            document.getElementById('employeeEditPopupOverlay').classList.add('show');
        }

        function hideEmployeeEditPopup() { 
            document.getElementById('employeeEditPopupOverlay').classList.remove('show');
            window.employeeToEdit = null;
        }

        async function saveEmployeeEdit() { 
            if (window.currentUserRole !== 'admin' || !window.employeeToEdit) return;
            const personnel_number = document.getElementById('employeeEditPN').value.trim();
            const newName = document.getElementById('employeeEditName').value.trim();
            const newRole = document.getElementById('employeeEditRole').value;
            const newIsActive = document.getElementById('employeeEditActive').checked;
            const employeeId = window.employeeToEdit.id;

            if (!newName) { showToast("Bitte Namen angeben.", 'error', 2000); return; }

            let success = false;
            let isOffline = !navigator.onLine;
            const updatePayload = { 
                id: employeeId, // Wichtig für lokale Speicherung
                name: newName, 
                role: newRole, 
                is_active: newIsActive,
                client_id: window.currentClientId, // Wichtig für Outbox
                personnel_number: personnel_number // Wichtig für lokale Speicherung
            };
            
            try {
                if (window.appSupabaseClient && !isOffline) {
                    const { error } = await window.appSupabaseClient
                        .from('employees')
                        .update(updatePayload)
                        .eq('id', employeeId)
                        .eq('client_id', window.currentClientId);

                    if (error) {
                        if (error.message.includes('Failed to fetch')) throw new Error("Offline");
                        throw error;
                    }
                    success = true;
                    await window.offlineDB.upsertData('employees', updatePayload, 'id');
                } else {
                    throw new Error("Offline");
                }
            } catch (e) {
                if (e.message === "Offline" || !navigator.onLine) {
                    isOffline = true;
                    await window.offlineDB.upsertData('employees', updatePayload, 'id');
                    
                    // FIX: Verwende UPDATE_EMPLOYEE Typ für klare Unterscheidung
                    await window.offlineDB.addToOutbox({
                        type: 'UPDATE_EMPLOYEE',
                        table: 'employees',
                        key: employeeId, 
                        payload: updatePayload,
                        timestamp: new Date().toISOString()
                    });
                    success = true;
                } else {
                    console.error("Mitarbeiter-Speicherfehler:", e);
                    showToast(`FEHLER beim Speichern: ${e.message.substring(0, 50)}...`, "error");
                }
            }

            if (success) {
                const statusMessage = isOffline ? `Mitarbeiter lokal gespeichert. Wird bei Verbindung synchronisiert.` : `Mitarbeiter erfolgreich gespeichert.`;
                showToast(statusMessage, isOffline ? "info" : "success");
                logAdminAction('EMPLOYEE_EDITED', `Mitarbeiter "${newName}" (PN: ${personnel_number}) bearbeitet.`);
                hideEmployeeEditPopup();
                loadEmployeeList(document.getElementById('employeeSearchInput').value); 
            }
        }

        // --- Settings Popups ---
        function showSettingsPopup() { document.getElementById('settingsPopupOverlay').classList.add('show'); }
        function hideSettingsPopup() { document.getElementById('settingsPopupOverlay').classList.remove('show'); }

        // --- Initialisierung beim Laden der Seite --- 
        window.onload = async () => {
            initOfflineSync(); 
            initLoginSettings();
            initSettings();
            await checkLogin();
            updateNavBar();
        };

    </script>

    <style>
        /* --- GRUNDLAGEN / THEME --- */
        :root {
            --color-bg-dark: #1e1e28;
            --color-bg-medium: #272733;
            --color-bg-light: #30303c;
            --color-border: #444455;
            --color-text-light: #f0f0f0;
            --color-text-medium: #a0a0a0;
            --color-text-dark: #606060;
            --color-accent-blue: #4a90e2;
            --color-accent-green: #7ed321;
            --color-error-red: #d0021b;
            --color-warning-yellow: #f8e71c;
            --color-bg-card: #2f2f3e;
            --color-bg-card-hover: #3a3a4c;
            --transition-duration: 0.3s;
        }
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--color-text-light);
        }
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: var(--color-bg-dark);
            user-select: none;
        }

        /* --- HAUPT LAYOUT --- */
        #appContainer {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            max-width: 500px; /* Handy-Breite */
            margin: 0 auto;
            position: relative;
        }

        .app-view-container {
            display: none;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        .app-view-container.active {
            display: flex;
            flex-direction: column;
        }

        /* --- LOGIN VIEW --- */
        #loginView {
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .login-card {
            background: var(--color-bg-medium);
            padding: 30px;
            border-radius: 12px;
            width: 100%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            max-width: 400px;
        }
        .login-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .app-icon {
            font-size: 3rem;
            color: var(--color-accent-blue);
            margin-bottom: 10px;
        }
        .login-header h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
        }
        .login-header p {
            color: var(--color-error-red);
            margin-top: 10px;
            min-height: 20px;
            font-size: 0.9rem;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: var(--color-text-medium);
        }
        .input-group input[type="text"], 
        .input-group input[type="password"], 
        .input-group input[type="email"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background: var(--color-bg-light);
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        .input-group input:focus {
            outline: none;
            border-color: var(--color-accent-blue);
        }
        .login-card button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: var(--color-accent-blue);
            color: var(--color-text-light);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 10px;
        }
        .login-card button:hover:not(:disabled) {
            background: #397ad0;
        }
        .login-card button:disabled {
            background: var(--color-text-dark);
            cursor: not-allowed;
        }
        .toggle-button {
            background: none !important;
            color: var(--color-text-medium) !important;
            font-size: 0.9rem !important;
            padding: 10px 0 !important;
            margin-top: 5px !important;
        }

        #loadingAuth {
            display: none;
            text-align: center;
            margin-top: 10px;
            color: var(--color-accent-blue);
        }
        
        /* --- APP VIEW --- */
        #header {
            background: var(--color-bg-medium);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-border);
            flex-shrink: 0;
        }
        #header-info h1 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
        }
        #header-info p {
            margin: 0;
            font-size: 0.8rem;
            color: var(--color-text-medium);
        }
        .logout-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--color-text-medium);
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        #content {
            flex-grow: 1;
            overflow-y: auto;
            position: relative; /* Für absolute Tab-Contents */
            padding-bottom: 70px; /* Platz für Navbar */
        }
        .tab-content {
            display: none;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            overflow-y: auto;
            padding: 20px 15px;
        }
        .tab-content.active {
            display: block;
        }

        /* --- SCANNER TAB --- */
        #scannerTab {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 50px;
        }
        #preScan {
            text-align: center;
            margin-bottom: 30px;
        }
        .scan-icon {
             font-size: 5rem;
             color: var(--color-accent-blue);
             margin-bottom: 20px;
        }
        #startScanButton {
            background: var(--color-accent-green);
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        #startScanButton:active {
            background: #6aaa1e;
        }

        #scanFrame {
             width: 100%;
             max-width: 400px;
             height: 300px;
             margin-bottom: 20px;
             /* FIX: Stellt sicher, dass das Video im Frame korrekt angezeigt wird */
             text-align: center;
        }
        #scanFrame video {
             width: 100% !important;
             height: 100% !important;
             object-fit: cover;
        }
        
        #resultCard {
            background: var(--color-bg-card);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            margin-bottom: 20px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        }
        #resultCard.active {
            opacity: 1;
            transform: translateY(0);
        }
        #resultCard h3 {
            margin-top: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-text-light);
        }
        .result-meta {
            font-size: 0.9rem;
            color: var(--color-text-medium);
            margin-bottom: 15px;
        }
        .result-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .stat-item {
            padding: 10px;
            border-radius: 8px;
            min-width: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .stat-item.primary {
            background: rgba(74, 144, 226, 0.1); /* Blau-Hauch */
        }
        .stat-item.secondary {
            background: rgba(160, 160, 160, 0.1); /* Grau-Hauch */
        }
        .stat-item span:first-child {
            font-size: 1.8rem;
            font-weight: 800;
        }
        .stat-item .label {
            font-size: 0.7rem;
            color: var(--color-text-medium);
            margin-top: 3px;
        }
        .action-button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .action-button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            flex-grow: 1;
        }
        .action-button.plus { background: var(--color-accent-green); }
        .action-button.minus { background: var(--color-error-red); }
        .action-button.edit { background: var(--color-accent-blue); }
        .action-button.register { background: var(--color-accent-blue); }
        .action-button:disabled { background: var(--color-text-dark); cursor: not-allowed; }

        /* --- LISTEN TABS (LISTE, LOGS, USERS) --- */
        .list-container {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .list-item {
            background: var(--color-bg-card);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background 0.2s;
            cursor: pointer;
        }
        .list-item:hover {
            background: var(--color-bg-card-hover);
        }
        .item-details {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            margin-right: 10px;
        }
        .item-name {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .item-barcode {
            font-size: 0.8rem;
            color: var(--color-text-medium);
        }
        .item-location {
            font-size: 0.75rem;
            color: var(--color-accent-blue);
            margin-top: 3px;
            font-weight: 500;
        }
        .item-count {
            text-align: right;
            padding: 5px 10px;
            border-radius: 6px;
        }
        .log-item .item-count {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-text-medium);
        }
        .employee-status {
             text-align: right;
        }
        .employee-status .item-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .search-bar {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            background: var(--color-bg-medium);
            font-size: 1rem;
        }
        .search-bar:focus {
             outline: none;
             border-color: var(--color-accent-blue);
        }
        
        /* --- IMPORT BEREICH --- */
        .import-section {
            background: var(--color-bg-medium);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .import-section h4 {
            margin-top: 0;
            color: var(--color-text-light);
        }
        .file-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .file-input-group input[type="file"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            background: var(--color-bg-light);
        }
        .import-button {
             padding: 10px 15px;
             border: none;
             border-radius: 8px;
             background: var(--color-accent-green);
             color: var(--color-text-light);
             font-weight: 600;
             cursor: pointer;
        }


        /* --- FOOTER / NAVBAR --- */
        #navbar {
            background: var(--color-bg-medium);
            height: 60px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            position: absolute;
            bottom: 0;
            border-top: 1px solid var(--color-border);
            flex-shrink: 0;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 5px;
            width: 20%;
            color: var(--color-text-medium);
            transition: color 0.2s;
            border-radius: 4px;
        }
        .nav-item i {
            font-size: 1.4rem;
            margin-bottom: 3px;
        }
        .nav-item span {
            font-size: 0.7rem;
            font-weight: 500;
        }
        .nav-item.active {
            color: var(--color-accent-blue);
        }
        .nav-item.active i, .nav-item.active span {
             color: var(--color-accent-blue);
        }

        /* --- POPUPS / OVERLAYS --- */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .popup-card {
            background: var(--color-bg-medium);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .popup-overlay.show .popup-card {
            transform: scale(1);
        }
        .popup-card h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: var(--color-accent-blue);
            font-size: 1.5rem;
        }
        .checkbox-group {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 15px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* --- TOASTS --- */
        #toastContainer {
            position: fixed;
            bottom: 70px; /* Über der Navbar */
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            z-index: 2000;
            pointer-events: none;
        }
        .toast {
            background: var(--color-bg-card);
            color: var(--color-text-light);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s, transform 0.3s;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { background: var(--color-accent-green); }
        .toast.error { background: var(--color-error-red); }
        .toast.info { background: var(--color-accent-blue); }
        .toast.warning { background: var(--color-warning-yellow); color: var(--color-bg-dark); }
        .toast-icon {
            margin-right: 10px;
            font-weight: bold;
        }
        
        /* --- SETTINGS STYLING --- */
        .settings-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .settings-section h4 {
            color: var(--color-accent-blue);
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px dashed var(--color-border);
            padding-bottom: 5px;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .setting-item label {
            font-size: 1rem;
            color: var(--color-text-light);
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        .volume-control input[type="range"] {
            flex-grow: 1;
        }
        #volValue {
            min-width: 40px;
            text-align: right;
            font-weight: bold;
        }

    </style>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <div id="appContainer">

        <div id="loginView" class="app-view-container active">
            <div class="login-card">
                <form id="authForm" onsubmit="handleAuthSubmit(event); return false;">
                    <div class="login-header">
                        <i class="material-icons app-icon">qr_code_scanner</i>
                        <h2 id="authTitle">Anmelden</h2>
                        <p id="authError"></p>
                    </div>

                    <div id="personnelNumberGroup" class="input-group">
                        <label for="authPersonnelNumber">Personalnummer</label>
                        <input type="text" id="authPersonnelNumber" placeholder="Ihre Personalnummer" required>
                    </div>

                    <div id="adminEmailGroup" class="input-group" style="display: none;">
                        <label for="authAdminEmail">E-Mail (Admin)</label>
                        <input type="email" id="authAdminEmail" placeholder="admin@firma.de" required>
                    </div>
                    
                    <div id="companyEmailGroup" class="input-group" style="display: none;">
                        <label for="authCompanyEmail">Firmen E-Mail Basis (z.B. firma.de)</label>
                        <input type="text" id="authCompanyEmail" placeholder="firma.de" required>
                    </div>

                    <div id="authPasswordGroup" class="input-group">
                        <label for="authPassword">Passwort</label>
                        <input type="password" id="authPassword" placeholder="Passwort" required>
                    </div>

                    <div id="loadingAuth" style="display: none;">
                         <p>Lade...</p>
                    </div>

                    <button type="submit">Anmelden</button>
                    
                    <button type="button" class="toggle-button" id="authModeToggle" onclick="toggleAuthMode()">Als Admin anmelden</button>
                    <button type="button" class="toggle-button" id="registerToggle" onclick="toggleRegisterMode()">Ich benötige ein neues Konto</button>
                </form>
            </div>
        </div>

        <div id="appView" class="app-view-container">

            <div id="header">
                <div id="header-info">
                    <h1 id="headerTitle">Inventar Scanner Pro</h1>
                    <p id="userRoleDisplay">Rolle: N/A</p>
                </div>
                <button class="logout-button" onclick="logout()">
                    <i class="material-icons">exit_to_app</i>
                </button>
            </div>

            <div id="content">
                
                <div id="scannerTab" class="tab-content active">
                    
                    <div id="preScan">
                        <i class="material-icons scan-icon">camera_alt</i>
                        <p style="color: var(--color-text-medium);">Tippen Sie, um den Scanner zu starten.</p>
                        <button id="startScanButton" onclick="activateCamera()">Scanner Starten</button>
                    </div>
                    
                    <div id="scanFrame" style="display: none;">
                        </div>

                    <div id="resultCard" class="result-card">
                        <div id="resultContent">
                            <p style="text-align: center; color: var(--color-text-medium);">Scan-Ergebnis erscheint hier.</p>
                        </div>
                    </div>
                </div>

                <div id="listTab" class="tab-content">
                    <input type="text" id="articleSearchInput" class="search-bar" placeholder="Artikel, Barcode oder Ort suchen..." oninput="loadArticleList(this.value)">
                    <ul id="articleList" class="list-container">
                        </ul>
                </div>

                <div id="logTab" class="tab-content">
                    <input type="text" id="logSearchInput" class="search-bar" placeholder="Aktion oder Beschreibung suchen..." oninput="loadLogList(this.value)">
                    <ul id="logList" class="list-container">
                        </ul>
                </div>

                <div id="usersTab" class="tab-content">
                    <input type="text" id="employeeSearchInput" class="search-bar" placeholder="Name oder PN suchen..." oninput="loadEmployeeList(this.value)">
                    <ul id="employeeList" class="list-container">
                         </ul>
                </div>
                
                <div id="importTab" class="tab-content">
                    <div class="import-section">
                        <h4>Inventar CSV Import</h4>
                        <p style="font-size: 0.8rem; color: var(--color-text-medium); margin-bottom: 10px;">Format: barcode;name;location;quantity</p>
                        <div class="file-input-group">
                            <input type="file" id="csvFileInput" accept=".csv">
                            <button type="button" class="import-button" onclick="handleImport()">Import starten</button>
                        </div>
                    </div>
                    </div>


            </div>

            <div id="navbar">
                <div class="nav-item" data-tab-id="scannerTab" onclick="navigate('scannerTab')">
                    <i class="material-icons">qr_code_scanner</i>
                    <span>Scan</span>
                </div>
                <div class="nav-item" data-tab-id="listTab" onclick="navigate('listTab')">
                    <i class="material-icons">list_alt</i>
                    <span>Inventar</span>
                </div>
                <div class="nav-item" data-tab-id="usersTab" onclick="navigate('usersTab')">
                    <i class="material-icons">people</i>
                    <span>Mitarbeiter</span>
                </div>
                <div class="nav-item" data-tab-id="logTab" onclick="navigate('logTab')">
                    <i class="material-icons">history</i>
                    <span>Logbuch</span>
                </div>
                <div class="nav-item" data-tab-id="settingsTab" onclick="showSettingsPopup()">
                    <i class="material-icons">settings</i>
                    <span>Settings</span>
                </div>
            </div>

        </div>

        <div id="popupOverlay" class="popup-overlay">
            <div class="popup-card">
                <h3>Artikel Registrieren</h3>
                <form onsubmit="saveArticle(); return false;">
                    <div class="input-group">
                        <label for="popupBarcode">Barcode</label>
                        <input type="text" id="popupBarcode" readonly required>
                    </div>
                     <div class="input-group">
                        <label for="popupBaseName">Name</label>
                        <input type="text" id="popupBaseName" placeholder="Artikelbezeichnung" required>
                    </div>
                    <div class="input-group">
                        <label for="popupLocation">Lagerort</label>
                        <input type="text" id="popupLocation" placeholder="Lagerort (z.B. A12)" required>
                    </div>
                    <div class="action-button-group">
                        <button type="button" class="action-button cancel" onclick="hidePopup()">Abbrechen</button>
                        <button type="submit" class="action-button register">Registrieren</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="adminEditPopupOverlay" class="popup-overlay">
            <div class="popup-card">
                <h3>Artikel Bearbeiten</h3>
                <form onsubmit="saveArticleEdit(); return false;">
                    <div class="input-group">
                        <label for="adminEditBarcode">Barcode</label>
                        <input type="text" id="adminEditBarcode" readonly>
                    </div>
                    <div class="input-group">
                        <label for="adminEditName">Name</label>
                        <input type="text" id="adminEditName" required>
                    </div>
                    <div class="input-group">
                        <label for="adminEditLocation">Lagerort</label>
                        <input type="text" id="adminEditLocation" required>
                    </div>
                    <div class="action-button-group">
                        <button type="button" class="action-button cancel" onclick="showDeleteConfirmPopup(document.getElementById('adminEditBarcode').value)">Löschen</button>
                        <button type="button" class="action-button cancel" onclick="hideAdminEditPopup()">Abbrechen</button>
                        <button type="submit" class="action-button register">Speichern</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="employeeEditPopupOverlay" class="popup-overlay">
            <div class="popup-card">
                <h3>Mitarbeiter Bearbeiten</h3>
                <form onsubmit="saveEmployeeEdit(); return false;">
                    <div class="input-group">
                        <label for="employeeEditPN">Personalnummer</label>
                        <input type="text" id="employeeEditPN" readonly>
                    </div>
                    <div class="input-group">
                        <label for="employeeEditName">Name</label>
                        <input type="text" id="employeeEditName" required>
                    </div>
                    <div class="input-group">
                        <label for="employeeEditRole">Rolle</label>
                        <select id="employeeEditRole" required>
                            <option value="user">Mitarbeiter (user)</option>
                            <option value="admin">Administrator (admin)</option>
                        </select>
                    </div>
                    <div class="checkbox-group">
                        <label for="employeeEditActive">Konto Aktiv / Deaktiviert</label>
                        <input type="checkbox" id="employeeEditActive">
                    </div>
                    <div class="action-button-group">
                        <button type="button" class="action-button cancel" onclick="hideEmployeeEditPopup()">Abbrechen</button>
                        <button type="submit" class="action-button register">Speichern</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="deleteConfirmPopupOverlay" class="popup-overlay">
            <div class="popup-card">
                <h3>Achtung!</h3>
                <p id="deleteConfirmText" style="color: var(--color-error-red); margin-bottom: 20px;">Sind Sie sicher, dass Sie diesen Artikel löschen möchten?</p>
                <div class="action-button-group">
                    <button type="button" class="action-button register" onclick="hideDeleteConfirmPopup()">Abbrechen</button>
                    <button type="button" class="action-button minus" onclick="deleteArticle()">Löschen</button>
                </div>
            </div>
        </div>

        <div id="settingsPopupOverlay" class="popup-overlay" onclick="if(event.target === this) hideSettingsPopup();">
            <div class="popup-card" onclick="event.stopPropagation()">
                <h3>Einstellungen</h3>
                <div class="settings-content">
                    <div class="settings-section">
                        <h4>Allgemein</h4>
                        <div class="setting-item">
                            <label for="settingVibrate">Vibrieren bei Feedback</label>
                            <input type="checkbox" id="settingVibrate" onchange="saveSettings();">
                        </div>
                        <div class="setting-item">
                            <label for="settingSound">Sound-Feedback</label>
                            <input type="checkbox" id="settingSound" onchange="saveSettings();">
                        </div>
                        <div class="setting-item">
                            <label>Lautstärke</label>
                            <div class="volume-control">
                                <input type="range" id="settingVolume" min="0" max="100" step="1" oninput="saveSettings();">
                                <span id="volValue">50%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>Aktionen</h4>
                        <div class="setting-item">
                            <label style="color: var(--color-error-red);">Lokale Daten löschen</label>
                            <button class="action-button minus" onclick="indexedDB.deleteDatabase('InventarScannerDB_v1'); localStorage.clear(); showToast('Lokaler Speicher gelöscht. Bitte neu anmelden.', 'error', 5000); logout();">Löschen</button>
                        </div>
                        <div class="setting-item">
                            <label>Abmelden</label>
                            <button class="action-button cancel" onclick="logout()">Abmelden</button>
                        </div>
                    </div>
                </div>
                <div class="action-button-group" style="margin-top: 20px;">
                    <button type="button" class="action-button register" onclick="hideSettingsPopup()">Schließen</button>
                </div>
            </div>
        </div>

        <div id="toastContainer"></div>

    </div>
</body>
</html>